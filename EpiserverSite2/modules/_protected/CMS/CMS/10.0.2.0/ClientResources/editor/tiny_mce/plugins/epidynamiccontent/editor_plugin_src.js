(function(e,t){e.dom.Event,e.PluginManager.requireLangPack("epidynamiccontent"),e.create("tinymce.plugins.epidynamiccontent",{_onInitCalled:!1,init:function(t,n){var i=this;if("undefined"!=typeof EPi&&"function"==typeof EPi.ResolveUrlFromUI){if("undefined"==typeof epiContentBlockUtilities){var o=e.baseURI.toAbsolute("plugins/epipersonalizedcontent/epicontentblockutilities.js");e.ScriptLoader.load(o,function(){this._init(t,n)},this),e.ScriptLoader.loadQueue()}else this._init(t,n);t.addButton("epidynamiccontent",{title:"epidynamiccontent.desc",cmd:"mceEPiDynamicContent"}),t.onInit.add(function(){i._onInitCalled=!0}),t.onPreInit.addToTop(function(){var n=e.trim(t.getParam("noneditable_noneditable_class","mceNonEditable"));t.parser.addAttributeFilter("class",function(e){for(var t=e.length;t--;)i._convertDCToMceNonEditable(e[t],n)})})}},_init:function(n,i){t.extend(this,epiContentBlockUtilities);var o=this;o._url=i,o.ed=n,o._disabled=!1,o._dynamicContentClass=n.getParam("epidynamiccontent_cssclass","epi_dc"),o._enabledControls=n.getParam("epidynamiccontent_enabledcontrols",""),n.addCommand("mceEPiDynamicContent",function(){var e=t.extend({},n.settings.epi_page_context);t(document).trigger("epi.loading.page_context",e);var i=EPi.ResolveUrlFromUI("Editor/Dialogs/DynamicContent.aspx")+"?"+t.param(e),a=null,r=function(e){var t=n.selection;return e?(a&&t.select(a),n.execCommand("mceInsertRawHTML",!1,e),o._onContentChanged(),n.windowManager.onClose.dispatch(),void 0):(n.windowManager.onClose.dispatch(),void 0)},s=n.selection;a=o._getParentContentBlock(s.getStart());var l={width:600,height:640},c=o._getAllContentGroups(n);if(a){var d=EPi.ResolveUrlFromUtil("../App_Themes/Default/Styles/system.css"),u=a.getAttribute("data-groups"),m=u?u.replace(/"/g,"&quot;"):"",p=a.getAttribute("data-contentgroup"),g=p?p.replace(/"/g,"&quot;"):"",h='<html xmlns="http://www.w3.org/1999/xhtml"><head><link href="'+d+'" type="text/css" rel="stylesheet" /><title></title></head><body>'+'<form action="'+i+'" method="post">'+'<input name="state" type="hidden" value="'+a.getAttribute("data-state").replace(/"/g,"&quot;")+'" />'+'<input name="hash" type="hidden" value="'+a.getAttribute("data-hash").replace(/"/g,"&quot;")+'" />'+'<input name="dynamicclass" type="hidden" value="'+a.getAttribute("data-dynamicclass").replace(/"/g,"&quot;")+'" />'+'<input name="groups" type="hidden" value="'+m+'" />'+'<input name="contentgroup" type="hidden" value="'+g+'" />'+'<input name="allcontentgroups" type="hidden" value="'+c+'" />'+"</form></body></html>",v=function(e){if(e){var t=e.wrapper,n=t.containerIframe.contentWindow;n.document.write(h),n.document.close(),n.document.forms[0].submit()}};n.windowManager.open({url:"",width:l.width,height:l.height,onCallback:r,onReady:v})}else i+="&allcontentgroups="+c,n.windowManager.open({url:i,width:l.width,height:l.height,onCallback:r})});var a=function(t){var n=e.dom.Event.add(e.DOM.doc,"mousedown",o._handleButtonsClick,o),i=e.dom.Event.add(t.dom.doc,"click",o._handleButtonsClick,o);t.onRemove.add(function(t){e.dom.Event.remove(t.dom.doc,"click",i),e.dom.Event.remove(e.DOM.doc,"mousedown",n)}),t.onNodeChange.add(function(e,t,n,i){var a=e.selection,r=null;r=a.isCollapsed()?o._getParentContentBlock(a.getNode()):o._getParentContentBlock(a.getStart())||o._getParentContentBlock(a.getEnd()),r?(o._updateCommandState(!1),o._showButton(e,t,!0,!0)):(o._updateCommandState(!0),o._showButton(e,t,i,!1))})};o._onInitCalled?a(n):n.onInit.add(a)},_showButton:function(e,t,n,i){var o=e.dom.isHidden(e.container);t.setDisabled("epidynamiccontent",o||!n),t.setActive("epidynamiccontent",!o&&i)},_handleButtonsClick:function(n){return this.ed.dom.hasClass(n.target,"epi_dc_editBtn")&&0===n.button?(this._hidePreview(n),tinyMCE.execCommand("mceEPiDynamicContent"),e.dom.Event.cancel(n)):t(n.target).is(".epi_dc_previewBtn")&&0===n.button?(this._showPreview(n),e.dom.Event.cancel(n)):(this._hidePreview(n),void 0)},_getParentContentBlock:function(e){return this._getParentNode(e,this._dynamicContentClass)},_convertDCToMceNonEditable:function(e,t){var n=e.attr("class")+" ";-1===n.indexOf("epi_dc ")||n.indexOf(t)>=0||(e.attr("contenteditable",null),e.attr("class",n+t))},_url:null,_previewedDynamicContent:null,_previewVisible:!1,_lastSelection:null,_showPreview:function(e){var n=e.target;this._hidePreview(e)&&t(window["epi-dcPreview"].document.documentElement).remove();var i=t("<div/>",this.ed.contentDocument).append(t(n).closest(".epi_dc").clone()),o=t(i).html();this._previewedDynamicContent=o;var a=this;setTimeout(function(){if(o!==a._previewedDynamicContent)return t(i).remove(),void 0;a._previewVisible=!0,a._lastSelection=n;var e=t("iframe",a.ed.container),r=a._getPositionInParentFrame(n,a.ed.contentWindow,e,window),s=a.ed.settings.editorwidth||a.ed.contentAreaContainer.clientWidth+"px",l=a._createPopupIframe(r,"epi-dcPreview",s,[{onclick:function(){a._openEditDialog(a.ed),a._hidePreview()},text:a.ed.translate("epidynamiccontent.edit")},{onclick:function(){a._hidePreview()},text:a.ed.translate("epidynamiccontent.close")}]),c=a._getPreviewUrl(),d={DynamicContent:o};a._postFrameTo(l,c,d),t(i).remove(),t(window).bind("resize.dynamicContent",function(){var i=a._getPositionInParentFrame(n,a.ed.contentWindow,e,window),o=t("#epi-dcPreview");o.css(i)})},250)},_getPreviewUrl:function(){var e="Editor/Dialogs/DynamicContentPreview.aspx",n=jQuery.extend({content_css:this.ed.settings.content_css},this.ed.settings.epi_page_context);return t(document).trigger("epi.loading.page_context",n),EPi.ResolveUrlFromUI(e+"?"+jQuery.param(n))},_openEditDialog:function(){this.ed.focus();var e=this._getParentContentBlock(this._lastSelection);this.ed.selection.select(e),tinyMCE.execCommand("mceEPiDynamicContent")},_hidePreview:function(e){return this._previewedDynamicContent=null,e&&this._isChildOfDCPreview(e.target)||!this._previewVisible?!1:(this._previewVisible=!1,this._lastSelection=null,t("#epi-dcPreview").hide(),t(window).unbind("resize.dynamicContent"),!0)},_getPositionInParentFrame:function(n,i,o,a){var r=t(o).offset(),s=t(n).position(),l={y:t(a).scrollTop(),x:t(a).scrollLeft()},c={y:Math.max(t(i.document.body).scrollTop(),t(i.document.documentElement).scrollTop()),x:t(i.document.body).scrollLeft()},d={top:r.top+s.top-l.y-c.y,left:r.left+s.left+Math.min(t(n).width()+10,t(o).width())-l.x-c.x};l.y>0&&(e.isGecko||e.isWebKit)&&(d.top+=c.y),e.isIE&&(d.top+=l.y);var u=t(a),m=d.top+300,p=l.y+u.height();m>p&&(d.top=Math.max(l.y,d.top-m+p));var g=this.ed.settings.editorwidth?this.ed.settings.editorwidth:this.ed.settings.width;m=d.left+parseInt(g,10)+24;var h=l.x+u.width();return m>h&&(d.left=Math.max(l.x,d.left-m+h)),d},_createPopupIframe:function(e,n,i,o){var a=this,r=t("#"+n).show();if(0===r.length&&(r=t("<div id='"+n+"' class='epi-dcPreviewBorder'><iframe frameborder='0' style='height:300px;' class='episystemiframe' name='"+n+"' src=''></iframe><div id='epi-dcPreviewButtons'></div><div id='epi-dcPreviewDescription'></div></div>").appendTo(window.document.body),t(window.document.body).click(function(e){a._hidePreview(e)})),r.css({position:"absolute",top:e.top,left:e.left,width:i}).children("iframe").css({height:"250px",width:"100%"}),o){t("#epi-dcPreviewButtons").html("");for(var s in o)t("<span class='epi-cmsButton'><input type='button' value='"+o[s].text+"'/></span>").appendTo("#epi-dcPreviewButtons").click(o[s].onclick)}var l=window[n];return l},_isChildOfDCPreview:function(e){var n=t(e),i=".epi-dcPreviewBorder";return n.is(i)||n.parents().is(i)},_postFrameTo:function(e,t,n){var i='<html xmlns="http://www.w3.org/1999/xhtml" style="height:100%;background:#fff url('+EPi.ResolveUrlFromUtil("../App_Themes/Default/Images/General/AjaxLoader.gif")+') no-repeat 50% 50%"><head><title></title></head><body>';i+='<form action="'+t+'" method="post">';var o;for(o in n)i+='<input name="'+o+'" id="'+o+'" type="hidden" />';i+="</form></body></html>",e.document.write(i);for(o in n)e.document.getElementById(o).value=n[o];e.document.forms[0].submit()},getInfo:function(){return{longname:"Dynamic content plugin",author:"EPiServer AB",authorurl:"http://www.episerver.com",infourl:"http://www.episerver.com",version:1.1}}}),e.PluginManager.add("epidynamiccontent",e.plugins.epidynamiccontent)})(tinymce,epiJQuery);