(function(e,t){e.create("tinymce.plugins.epilink",{init:function(n){"undefined"!=typeof EPi&&"function"==typeof EPi.ResolveUrlFromUI&&(n.addCommand("mceEPiLink",function(){var i="",o=n.selection,a=n.dom,r={},s=o.getRng(),l=[{text:"",value:""}],c=o.getStart()===o.getEnd()?o.getStart():o.getNode(),d=a.getParent(c,"A");if(!o.isCollapsed()||d){d&&(i=a.getAttrib(d,"href")),i.length&&(r.href=i,r.targetName=a.getAttrib(d,"target"),r.title=a.getAttrib(d,"title"));var u=t("a[id],a[name]",n.getDoc());u.each(function(e,t){var n=t.id||t.name;""!==n&&""===t.href&&l.push({text:n,value:"#"+n})}),l=l.sort(function(e,t){return e.text.toLowerCase()>t.text.toLowerCase()?1:-1});var m=function(t){var i,r;if(t&&t.href){if("-1"==t&&d)i=d.innerHTML,a.setOuterHTML(d,i),n.undoManager.add();else if(0!==t){var l={href:t.href,title:t.title,target:t.target?t.target:null};if(d)a.setAttribs(d,l),n.undoManager.add();else{o.setRng(s),n.getDoc().execCommand("unlink",!1,null),n.execCommand("mceInsertLink",!1,"#mce_temp_url#",{skip_undo:1}),r=e.grep(a.select("a"),function(e){return"#mce_temp_url#"==a.getAttrib(e,"href")});for(var c=0;r.length>c;c++)a.setAttribs(r[c],l);if(r.length>0){var u=n.dom.createRng();u.selectNodeContents(r[0]),n.selection.setRng(u)}n.undoManager.add()}}}else d&&(i=d.innerHTML,a.setOuterHTML(d,i),n.undoManager.add())};require(["dojo/_base/lang","dojo/_base/array","dojo/on","dojo/when","dojo/dom-style","epi/dependency","epi/Url","epi/shell/widget/dialog/Dialog","epi-cms/ApplicationSettings","epi-cms/widget/LinkEditor","epi/i18n!epi/cms/nls/episerver.cms.widget.editlink"],function(e,t,i,o,a,s,c,u,p,g,h){var f=s.resolve("epi.storeregistry"),v=(f.get("epi.cms.content.light"),p.frames),y=function(e,n){var i=t.filter(e,function(e){return e.id==n});return i&&i.length>0?i[0].name:""},b=function(e,n){var i=t.filter(e,function(e){return e.name==n});return i&&i.length>0?i[0].id:""};r.target=b(v,r.targetName);var w=new g({baseClass:"epi-link-item",modelType:n.getParam("epilinkmodel_type"),hiddenFields:["text"]}),_=function(e){return t.filter(e,function(e){return"Anchor"==e.name})};w.on("fieldCreated",function(e,t){if("href"===e){var n=t,i=null,o=_(n.get("wrappers"));o&&o.length>0&&(i=o[0]),i&&i.inputWidget?i.inputWidget.set("selections",l):t.on("selectorsCreated",function(e){var t=_(e.get("wrappers"));t&&t.length>0&&t[0].inputWidget&&(t[0].inputWidget.set("selections",l),a.set(t[0].domNode,{display:"block"}))}),i&&a.set(i.domNode,{display:"block"})}});var C=e.replace(d?h.title.template.edit:h.title.template.create,h.title.action),P=new u({title:C,dialogClass:"epi-dialog-portrait",content:w,defaultActionsVisible:!1});P.startup(),w.set("value",r),P.show(),n.windowManager.onOpen.dispatch(),P.on("execute",function(){var t=w.get("value"),n=e.clone(t);n&&n.target&&(n.target=y(v,n.target)),w.destroy(),w=null,m(n)}),P.on("hide",function(){n.windowManager.onClose.dispatch()})})}}),n.addButton("epilink",{title:"epilink.desc",cmd:"mceEPiLink","class":"mce_epilink"}),n.addShortcut("ctrl+k","epilink.desc","mceEPiLink"),n.onNodeChange.add(function(e,t,n,i){var o=e.dom.getParent(n,"a",e.getBody())||("A"===n.tagName?n:null);o&&o.innerHTML===e.selection.getContent()&&e.selection.select(o),t.setDisabled("epilink",i&&null===o),t.setActive("epilink",null!==o&&!o.name)}))},getInfo:function(){return{longname:"Link plugin",author:"EPiServer AB",authorurl:"http://www.episerver.com",infourl:"http://www.episerver.com",version:"1.0"}}}),e.PluginManager.add("epilink",e.plugins.epilink)})(tinymce,epiJQuery);