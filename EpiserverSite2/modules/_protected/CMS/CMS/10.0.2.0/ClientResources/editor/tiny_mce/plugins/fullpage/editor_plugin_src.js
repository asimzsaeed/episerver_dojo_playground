(function(){var e=tinymce.each,t=tinymce.html.Node;tinymce.create("tinymce.plugins.FullPagePlugin",{init:function(e,t){var n=this;n.editor=e,e.addCommand("mceFullPageProperties",function(){e.windowManager.open({file:t+"/fullpage.htm",width:430+tinymce.parseInt(e.getLang("fullpage.delta_width",0)),height:495+tinymce.parseInt(e.getLang("fullpage.delta_height",0)),inline:1},{plugin_url:t,data:n._htmlToData()})}),e.addButton("fullpage",{title:"fullpage.desc",cmd:"mceFullPageProperties"}),e.onBeforeSetContent.add(n._setContent,n),e.onGetContent.add(n._getContent,n)},getInfo:function(){return{longname:"Fullpage",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/fullpage",version:tinymce.majorVersion+"."+tinymce.minorVersion}},_htmlToData:function(){function t(e,t){var n=e.attr(t);return n||""}var n,i,o=this._parseHeader(),a={},r=this.editor;return a.fontface=r.getParam("fullpage_default_fontface",""),a.fontsize=r.getParam("fullpage_default_fontsize",""),n=o.firstChild,7==n.type&&(a.xml_pi=!0,i=/encoding="([^"]+)"/.exec(n.value),i&&(a.docencoding=i[1])),n=o.getAll("#doctype")[0],n&&(a.doctype="<!DOCTYPE"+n.value+">"),n=o.getAll("title")[0],n&&n.firstChild&&(a.metatitle=n.firstChild.value),e(o.getAll("meta"),function(e){var t,n=e.attr("name"),i=e.attr("http-equiv");n?a["meta"+n.toLowerCase()]=e.attr("content"):"Content-Type"==i&&(t=/charset\s*=\s*(.*)\s*/gi.exec(e.attr("content")),t&&(a.docencoding=t[1]))}),n=o.getAll("html")[0],n&&(a.langcode=t(n,"lang")||t(n,"xml:lang")),n=o.getAll("link")[0],n&&"stylesheet"==n.attr("rel")&&(a.stylesheet=n.attr("href")),n=o.getAll("body")[0],n&&(a.langdir=t(n,"dir"),a.style=t(n,"style"),a.visited_color=t(n,"vlink"),a.link_color=t(n,"link"),a.active_color=t(n,"alink")),a},_dataToHtml:function(n){function i(e,t,n){e.attr(t,n?n:void 0)}function o(e){r.firstChild?r.insert(e,r.firstChild):r.append(e)}var a,r,s,l,d,c=this.editor.dom;a=this._parseHeader(),r=a.getAll("head")[0],r||(l=a.getAll("html")[0],r=new t("head",1),l.firstChild?l.insert(r,l.firstChild,!0):l.append(r)),l=a.firstChild,n.xml_pi?(d='version="1.0"',n.docencoding&&(d+=' encoding="'+n.docencoding+'"'),7!=l.type&&(l=new t("xml",7),a.insert(l,a.firstChild,!0)),l.value=d):l&&7==l.type&&l.remove(),l=a.getAll("#doctype")[0],n.doctype?(l||(l=new t("#doctype",10),n.xml_pi?a.insert(l,a.firstChild):o(l)),l.value=n.doctype.substring(9,n.doctype.length-1)):l&&l.remove(),l=a.getAll("title")[0],n.metatitle&&(l||(l=new t("title",1),l.append(new t("#text",3)).value=n.metatitle,o(l))),n.docencoding&&(l=null,e(a.getAll("meta"),function(e){"Content-Type"==e.attr("http-equiv")&&(l=e)}),l||(l=new t("meta",1),l.attr("http-equiv","Content-Type"),l.shortEnded=!0,o(l)),l.attr("content","text/html; charset="+n.docencoding)),e("keywords,description,author,copyright,robots".split(","),function(e){var i,r,s=a.getAll("meta"),d=n["meta"+e];for(i=0;s.length>i;i++)if(r=s[i],r.attr("name")==e)return d?r.attr("content",d):r.remove(),void 0;d&&(l=new t("meta",1),l.attr("name",e),l.attr("content",d),l.shortEnded=!0,o(l))}),l=a.getAll("link")[0],l&&"stylesheet"==l.attr("rel")?n.stylesheet?l.attr("href",n.stylesheet):l.remove():n.stylesheet&&(l=new t("link",1),l.attr({rel:"stylesheet",text:"text/css",href:n.stylesheet}),l.shortEnded=!0,o(l)),l=a.getAll("body")[0],l&&(i(l,"dir",n.langdir),i(l,"style",n.style),i(l,"vlink",n.visited_color),i(l,"link",n.link_color),i(l,"alink",n.active_color),c.setAttribs(this.editor.getBody(),{style:n.style,dir:n.dir,vLink:n.visited_color,link:n.link_color,aLink:n.active_color})),l=a.getAll("html")[0],l&&(i(l,"lang",n.langcode),i(l,"xml:lang",n.langcode)),s=new tinymce.html.Serializer({validate:!1,indent:!0,apply_source_formatting:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(a),this.head=s.substring(0,s.indexOf("</body>"))},_parseHeader:function(){return new tinymce.html.DomParser({validate:!1,root_name:"#document"}).parse(this.head)},_setContent:function(t,n){function i(e){return e.replace(/<\/?[A-Z]+/g,function(e){return e.toLowerCase()})}var o,a,r,s,l=this,d=n.content,c="",u=l.editor.dom;"raw"==n.format&&l.head||n.source_view&&t.getParam("fullpage_hide_in_source_view")||(d=d.replace(/<(\/?)BODY/gi,"<$1body"),o=d.indexOf("<body"),-1!=o?(o=d.indexOf(">",o),l.head=i(d.substring(0,o+1)),a=d.indexOf("</body",o),-1==a&&(a=d.length),n.content=d.substring(o+1,a),l.foot=i(d.substring(a))):(l.head=this._getDefaultHeader(),l.foot="\n</body>\n</html>"),r=l._parseHeader(),e(r.getAll("style"),function(e){e.firstChild&&(c+=e.firstChild.value)}),s=r.getAll("body")[0],s&&u.setAttribs(l.editor.getBody(),{style:s.attr("style")||"",dir:s.attr("dir")||"",vLink:s.attr("vlink")||"",link:s.attr("link")||"",aLink:s.attr("alink")||""}),u.remove("fullpage_styles"),c&&(u.add(l.editor.getDoc().getElementsByTagName("head")[0],"style",{id:"fullpage_styles"},c),s=u.get("fullpage_styles"),s.styleSheet&&(s.styleSheet.cssText=c)))},_getDefaultHeader:function(){var e,t="",n=this.editor,i="";return n.getParam("fullpage_default_xml_pi")&&(t+='<?xml version="1.0" encoding="'+n.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'),t+=n.getParam("fullpage_default_doctype",'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">'),t+="\n<html>\n<head>\n",(e=n.getParam("fullpage_default_title"))&&(t+="<title>"+e+"</title>\n"),(e=n.getParam("fullpage_default_encoding"))&&(t+='<meta http-equiv="Content-Type" content="text/html; charset='+e+'" />\n'),(e=n.getParam("fullpage_default_font_family"))&&(i+="font-family: "+e+";"),(e=n.getParam("fullpage_default_font_size"))&&(i+="font-size: "+e+";"),(e=n.getParam("fullpage_default_text_color"))&&(i+="color: "+e+";"),t+="</head>\n<body"+(i?' style="'+i+'"':"")+">\n"},_getContent:function(e,t){var n=this;t.source_view&&e.getParam("fullpage_hide_in_source_view")||(t.content=tinymce.trim(n.head)+"\n"+tinymce.trim(t.content)+"\n"+tinymce.trim(n.foot))}}),tinymce.PluginManager.add("fullpage",tinymce.plugins.FullPagePlugin)})();