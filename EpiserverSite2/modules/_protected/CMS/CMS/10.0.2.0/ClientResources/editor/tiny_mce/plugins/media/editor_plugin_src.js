(function(){function e(e){return"string"==typeof e?e.replace(/[^0-9%]/g,""):e}function t(e){var t,n;if(e&&!e.splice){for(t=[],n=0;!0&&e[n];n++)t[n]=e[n];return t}return e}var n,i,o=tinymce.explode("id,name,width,height,style,align,class,hspace,vspace,bgcolor,type"),a=tinymce.makeMap(o.join(",")),r=tinymce.html.Node,s=tinymce.util.JSON;n=[["Flash","d27cdb6e-ae6d-11cf-96b8-444553540000","application/x-shockwave-flash","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["ShockWave","166b1bca-3f9c-11cf-8075-444553540000","application/x-director","http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0"],["WindowsMedia","6bf52a52-394a-11d3-b153-00c04f79faa6,22d6f312-b0f6-11d0-94ab-0080c74c7e95,05589fa1-c356-11ce-bf01-00aa0055595a","application/x-mplayer2","http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"],["QuickTime","02bf25d5-8c17-4b23-bc80-d3488abddc6b","video/quicktime","http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0"],["RealMedia","cfcdaa03-8be4-11cf-b84b-0020afbbccfa","audio/x-pn-realaudio-plugin","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["Java","8ad9c840-044e-11d1-b3e9-00805f499d93","application/x-java-applet","http://java.sun.com/products/plugin/autodl/jinstall-1_5_0-windows-i586.cab#Version=1,5,0,0"],["Silverlight","dfeaf541-f3e1-4c24-acac-99c30715084a","application/x-silverlight-2"],["Iframe"],["Video"],["EmbeddedAudio"],["Audio"]],tinymce.create("tinymce.plugins.MediaPlugin",{init:function(e,t){function a(t){return t&&"IMG"===t.nodeName&&e.dom.hasClass(t,"mceItemMedia")}var r,l,d,c,u=this,m={};for(u.editor=e,u.url=t,i="",r=0;n.length>r;r++){for(c=n[r][0],d={name:c,clsids:tinymce.explode(n[r][1]||""),mimes:tinymce.explode(n[r][2]||""),codebase:n[r][3]},l=0;d.clsids.length>l;l++)m["clsid:"+d.clsids[l]]=d;for(l=0;d.mimes.length>l;l++)m[d.mimes[l]]=d;m["mceItem"+c]=d,m[c.toLowerCase()]=d,i+=(i?"|":"")+c}tinymce.each(e.getParam("media_types","video=mp4,m4v,ogv,webm;silverlight=xap;flash=swf,flv;shockwave=dcr;quicktime=mov,qt,mpg,mpeg;shockwave=dcr;windowsmedia=avi,wmv,wm,asf,asx,wmx,wvx;realmedia=rm,ra,ram;java=jar;audio=mp3,ogg").split(";"),function(e){var t,n,i;for(e=e.split(/=/),n=tinymce.explode(e[1].toLowerCase()),t=0;n.length>t;t++)i=m[e[0].toLowerCase()],i&&(m[n[t]]=i)}),i=RegExp("write("+i+")\\(([^)]+)\\)"),u.lookup=m,e.onPreInit.add(function(){e.schema.addValidElements("object[id|style|width|height|classid|codebase|*],param[name|value],embed[id|style|width|height|type|src|*],video[*],audio[*],source[*]"),e.parser.addNodeFilter("object,embed,video,audio,script,iframe",function(e){for(var t=e.length;t--;)u.objectToImg(e[t])}),e.serializer.addNodeFilter("img",function(e,t,n){for(var i,o=e.length;o--;)i=e[o],-1!==(i.attr("class")||"").indexOf("mceItemMedia")&&u.imgToObject(i,n)})}),e.onInit.add(function(){e.theme&&e.theme.onResolveName&&e.theme.onResolveName.add(function(t,n){"img"===n.name&&e.dom.hasClass(n.node,"mceItemMedia")&&(n.name="media")}),e&&e.plugins.contextmenu&&e.plugins.contextmenu.onContextMenu.add(function(e,t,n){"IMG"===n.nodeName&&-1!==n.className.indexOf("mceItemMedia")&&t.add({title:"media.edit",icon:"media",cmd:"mceMedia"})})}),e.addCommand("mceMedia",function(){var n,i;i=e.selection.getNode(),a(i)&&(n=e.dom.getAttrib(i,"data-mce-json"),n&&(n=s.parse(n),tinymce.each(o,function(t){var o=e.dom.getAttrib(i,t);o&&(n[t]=o)}),n.type=u.getType(i.className).name.toLowerCase())),n||(n={type:"flash",video:{sources:[]},params:{}}),e.windowManager.open({file:t+"/media.htm",width:430+tinymce.parseInt(e.getLang("media.delta_width",0)),height:500+tinymce.parseInt(e.getLang("media.delta_height",0)),inline:1},{plugin_url:t,data:n})}),e.addButton("media",{title:"media.desc",cmd:"mceMedia"}),e.onNodeChange.add(function(e,t,n){t.setActive("media",a(n))})},convertUrl:function(e,t){var n=this,i=n.editor,o=i.settings,a=o.url_converter,r=o.url_converter_scope||n;return e?t?i.documentBaseURI.toAbsolute(e):a.call(r,e,"src","object"):e},getInfo:function(){return{longname:"Media",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media",version:tinymce.majorVersion+"."+tinymce.minorVersion}},dataToImg:function(n,i){var o,a,r,l,d=this,c=d.editor;if(c.documentBaseURI,n.params.src=d.convertUrl(n.params.src,i),a=n.video.attrs,a&&(a.src=d.convertUrl(a.src,i)),a&&(a.poster=d.convertUrl(a.poster,i)),o=t(n.video.sources))for(l=0;o.length>l;l++)o[l].src=d.convertUrl(o[l].src,i);return r=d.editor.dom.create("img",{id:n.id,style:n.style,align:n.align,hspace:n.hspace,vspace:n.vspace,src:d.editor.theme.url+"/img/trans.gif","class":"mceItemMedia mceItem"+d.getType(n.type).name,"data-mce-json":s.serialize(n,"'")}),r.width=n.width=e(n.width||("audio"==n.type?"300":"320")),r.height=n.height=e(n.height||("audio"==n.type?"32":"240")),r},dataToHtml:function(e,t){return this.editor.serializer.serialize(this.dataToImg(e,t),{forced_root_block:"",force_absolute:t})},htmlToData:function(e){var t,n,i;return i={type:"flash",video:{sources:[]},params:{}},t=this.editor.parser.parse(e),n=t.getAll("img")[0],n&&(i=s.parse(n.attr("data-mce-json")),i.type=this.getType(n.attr("class")).name.toLowerCase(),tinymce.each(o,function(e){var t=n.attr(e);t&&(i[e]=t)})),i},getType:function(e){var t,n,i;for(n=tinymce.explode(e," "),t=0;n.length>t;t++)if(i=this.lookup[n[t]])return i},imgToObject:function(n,i){function a(e,t){var n,i,o,a,r;r=E.getParam("flash_video_player_url",P.convertUrl(P.url+"/moxieplayer.swf")),r&&(n=E.documentBaseURI,p.params.src=r,E.getParam("flash_video_player_absvideourl",!0)&&(e=n.toAbsolute(e||"",!0),t=n.toAbsolute(t||"",!0)),o="",i=E.getParam("flash_video_player_flashvars",{url:"$url",poster:"$poster"}),tinymce.each(i,function(n,i){n=n.replace(/\$url/,e||""),n=n.replace(/\$poster/,t||""),n.length>0&&(o+=(o?"&":"")+i+"="+escape(n))}),o.length&&(p.params.flashvars=o),a=E.getParam("flash_video_player_params",{allowfullscreen:!0,allowscriptaccess:!0}),tinymce.each(a,function(e,t){p.params[t]=""+e}))}var l,d,c,u,m,p,g,h,f,v,y,_,b,w,C,k,P=this,E=P.editor;if(p=n.attr("data-mce-json")){if(p=s.parse(p),v=this.getType(n.attr("class")),C=n.attr("data-mce-style"),C||(C=n.attr("style"),C&&(C=E.dom.serializeStyle(E.dom.parseStyle(C,"img")))),p.width=n.attr("width")||p.width,p.height=n.attr("height")||p.height,"Iframe"===v.name){b=new r("iframe",1),tinymce.each(o,function(e){var t=n.attr(e);"class"==e&&t&&(t=t.replace(/mceItem.+ ?/g,"")),t&&t.length>0&&b.attr(e,t)});for(u in p.params)b.attr(u,p.params[u]);return b.attr({style:C,src:p.params.src}),n.replace(b),void 0}if(this.editor.settings.media_use_script)return b=new r("script",1).attr("type","text/javascript"),m=new r("#text",3),m.value="write"+v.name+"("+s.serialize(tinymce.extend(p.params,{width:n.attr("width"),height:n.attr("height")}))+");",b.append(m),n.replace(b),void 0;if("Video"===v.name&&p.video.sources[0]){for(l=new r("video",1).attr(tinymce.extend({id:n.attr("id"),width:e(n.attr("width")),height:e(n.attr("height")),style:C},p.video.attrs)),p.video.attrs&&(w=p.video.attrs.poster),h=p.video.sources=t(p.video.sources),y=0;h.length>y;y++)/\.mp4$/.test(h[y].src)&&(_=h[y].src);for(h[0].type||(l.attr("src",h[0].src),h.splice(0,1)),y=0;h.length>y;y++)g=new r("source",1).attr(h[y]),g.shortEnded=!0,l.append(g);_?(a(_,w),v=P.getType("flash")):p.params.src=""}if("Audio"===v.name&&p.video.sources[0]){for(k=new r("audio",1).attr(tinymce.extend({id:n.attr("id"),width:e(n.attr("width")),height:e(n.attr("height")),style:C},p.video.attrs)),p.video.attrs&&(w=p.video.attrs.poster),h=p.video.sources=t(p.video.sources),h[0].type||(k.attr("src",h[0].src),h.splice(0,1)),y=0;h.length>y;y++)g=new r("source",1).attr(h[y]),g.shortEnded=!0,k.append(g);p.params.src=""}if("EmbeddedAudio"===v.name){c=new r("embed",1),c.shortEnded=!0,c.attr({id:n.attr("id"),width:e(n.attr("width")),height:e(n.attr("height")),style:C,type:n.attr("type")});for(u in p.params)c.attr(u,p.params[u]);tinymce.each(o,function(e){p[e]&&"type"!=e&&c.attr(e,p[e])}),p.params.src=""}if(p.params.src){/\.flv$/i.test(p.params.src)&&a(p.params.src,""),i&&i.force_absolute&&(p.params.src=E.documentBaseURI.toAbsolute(p.params.src)),d=new r("object",1).attr({id:n.attr("id"),width:e(n.attr("width")),height:e(n.attr("height")),style:C}),tinymce.each(o,function(e){var t=p[e];"class"==e&&t&&(t=t.replace(/mceItem.+ ?/g,"")),t&&"type"!=e&&d.attr(e,t)});for(u in p.params)f=new r("param",1),f.shortEnded=!0,m=p.params[u],"src"===u&&"WindowsMedia"===v.name&&(u="url"),f.attr({name:u,value:m}),d.append(f);if(this.editor.getParam("media_strict",!0))d.attr({data:p.params.src,type:v.mimes[0]});else{d.attr({classid:"clsid:"+v.clsids[0],codebase:v.codebase}),c=new r("embed",1),c.shortEnded=!0,c.attr({id:n.attr("id"),width:e(n.attr("width")),height:e(n.attr("height")),style:C,type:v.mimes[0]});for(u in p.params)c.attr(u,p.params[u]);tinymce.each(o,function(e){p[e]&&"type"!=e&&c.attr(e,p[e])}),d.append(c)}p.object_html&&(m=new r("#text",3),m.raw=!0,m.value=p.object_html,d.append(m)),l&&l.append(d)}l&&p.video_html&&(m=new r("#text",3),m.raw=!0,m.value=p.video_html,l.append(m)),k&&p.video_html&&(m=new r("#text",3),m.raw=!0,m.value=p.video_html,k.append(m));var x=l||k||d||c;x?n.replace(x):n.remove()}},objectToImg:function(t){function n(e){return new tinymce.html.Serializer({inner:!0,validate:!1}).serialize(e)}function l(e,t){return B[(e.attr(t)||"").toLowerCase()]}function d(e){var t=e.replace(/^.*\.([^.]+)$/,"$1");return B[t.toLowerCase()||""]}var c,u,m,p,g,h,f,v,y,_,b,w,C,k,P,E,x,M,I,A,S,L,T,N,B=this.lookup,D=this.editor.settings.url_converter,z=this.editor.settings.url_converter_scope;if(t.parent){if("script"===t.name){if(t.firstChild&&(I=i.exec(t.firstChild.value)),!I)return;M=I[1],x={video:{},params:s.parse(I[2])},v=x.params.width,y=x.params.height}if(x=x||{video:{},params:{}},g=new r("img",1),g.attr({src:this.editor.theme.url+"/img/trans.gif"}),h=t.name,"video"===h||"audio"==h){m=t,c=t.getAll("object")[0],u=t.getAll("embed")[0],v=m.attr("width"),y=m.attr("height"),f=m.attr("id"),x.video={attrs:{},sources:[]},A=x.video.attrs;for(h in m.attributes.map)A[h]=m.attributes.map[h];for(P=t.attr("src"),P&&x.video.sources.push({src:D.call(z,P,"src",t.name)}),E=m.getAll("source"),b=0;E.length>b;b++)P=E[b].remove(),x.video.sources.push({src:D.call(z,P.attr("src"),"src","source"),type:P.attr("type"),media:P.attr("media")});A.poster&&(A.poster=D.call(z,A.poster,"poster",t.name))}if("object"===t.name&&(c=t,u=t.getAll("embed")[0]),"embed"===t.name&&(u=t),"iframe"===t.name&&(p=t,M="Iframe"),c){for(v=v||c.attr("width"),y=y||c.attr("height"),_=_||c.attr("style"),f=f||c.attr("id"),S=S||c.attr("hspace"),L=L||c.attr("vspace"),T=T||c.attr("align"),N=N||c.attr("bgcolor"),x.name=c.attr("name"),k=c.getAll("param"),b=0;k.length>b;b++)C=k[b],h=C.remove().attr("name"),a[h]||(x.params[h]=C.attr("value"));x.params.src=x.params.src||c.attr("data")}if(u){v=v||u.attr("width"),y=y||u.attr("height"),_=_||u.attr("style"),f=f||u.attr("id"),S=S||u.attr("hspace"),L=L||u.attr("vspace"),T=T||u.attr("align"),N=N||u.attr("bgcolor");for(h in u.attributes.map)a[h]||x.params[h]||(x.params[h]=u.attributes.map[h])}if(p){v=e(p.attr("width")),y=e(p.attr("height")),_=_||p.attr("style"),f=p.attr("id"),S=p.attr("hspace"),L=p.attr("vspace"),T=p.attr("align"),N=p.attr("bgcolor"),tinymce.each(o,function(e){g.attr(e,p.attr(e))});for(h in p.attributes.map)a[h]||x.params[h]||(x.params[h]=p.attributes.map[h])}x.params.movie&&(x.params.src=x.params.src||x.params.movie,delete x.params.movie),x.params.src&&(x.params.src=D.call(z,x.params.src,"src","object")),m&&("video"===t.name?M=B.video.name:"audio"===t.name&&(M=B.audio.name)),c&&!M&&(M=(l(c,"clsid")||l(c,"classid")||l(c,"type")||{}).name),u&&!M&&(M=(l(u,"type")||d(x.params.src)||{}).name),u&&"EmbeddedAudio"==M&&(x.params.type=u.attr("type")),t.replace(g),u&&u.remove(),c&&(w=n(c.remove()),w&&(x.object_html=w)),m&&(w=n(m.remove()),w&&(x.video_html=w)),x.hspace=S,x.vspace=L,x.align=T,x.bgcolor=N,g.attr({id:f,"class":"mceItemMedia mceItem"+(M||"Flash"),style:_,width:v||("audio"==t.name?"300":"320"),height:y||("audio"==t.name?"32":"240"),hspace:S,vspace:L,align:T,bgcolor:N,"data-mce-json":s.serialize(x,"'")})}}}),tinymce.PluginManager.add("media",tinymce.plugins.MediaPlugin)})();