(function(){function e(e){function n(e){var t;if(1===e.nodeType){if(t=e.getAttribute(i),t&&"inherit"!==t)return t;if(t=e.contentEditable,"inherit"!==t)return t}return null}function a(e){for(var t;e;){if(t=n(e))return"false"===t?e:null;e=e.parentNode}}function r(e){for(var t;e;){if(t=n(e))return"true"===t?e:null;e=e.parentNode}}function s(e){for(;e;){if(e.id===_)return e;e=e.parentNode}}function l(e){var n;if(e)for(n=new t(e,e),e=n.current();e;e=n.next())if(3===e.nodeType)return e}function d(t,i){var o,a;return"false"===n(t)&&v.isBlock(t)?(y.select(t),void 0):(a=v.createRng(),"true"===n(t)&&(t.firstChild||t.appendChild(e.getDoc().createTextNode(" ")),t=t.firstChild,i=!0),o=v.create("span",{id:_,"data-mce-bogus":!0},g),i?t.parentNode.insertBefore(o,t):v.insertAfter(o,t),a.setStart(o.firstChild,1),a.collapse(!0),y.setRng(a),o)}function c(e){var t,n,i;if(e)rng=y.getRng(!0),rng.setStartBefore(e),rng.setEndBefore(e),t=l(e),t&&t.nodeValue.charAt(0)==g&&(t=t.deleteData(0,1)),v.remove(e,!0),y.setRng(rng);else for(n=s(y.getStart());(e=v.get(_))&&e!==i;)n!==e&&(t=l(e),t&&t.nodeValue.charAt(0)==g&&(t=t.deleteData(0,1)),v.remove(e,!0)),i=e}function u(e,i){function s(e,i){var o,a,r,s,l;if(o=g.startContainer,a=g.startOffset,3==o.nodeType){if(l=o.nodeValue.length,a>0&&l>a||(i?a==l:0==a))return}else{if(!(o.childNodes.length>a))return i?null:e;var d=!i&&a>0?a-1:a;o=o.childNodes[d],o.hasChildNodes()&&(o=o.firstChild)}for(r=new t(o,e);s=r[i?"prev":"next"]();){if(3===s.nodeType&&s.nodeValue.length>0)return;"true"===n(s)}return e}function l(e){var n,i,o=new t(e,e);for(i=o.next();i&&!(3!==i.nodeType||i.length>0);i=o.next());n=a(i),n&&d(n,!0)}var u,m,p,g,v,_,w;h=i?i.keyCode==o.LEFT||i.keyCode==o.UP:!1,c(),p=y.isCollapsed(),_=y.getStart(),w=y.getEnd(),u=a(_),m=a(w),u||m||!i||i.keyCode!==o.ENTER||l(_),u||m?(g=y.getRng(!0),p?(u=u||m,y.getStart(),(v=s(u,!0))?d(v,!0):(v=s(u,!1))?d(v,!1):y.select(u)):(g=y.getRng(!0),u&&g.setStartBefore(u),m&&g.setEndAfter(m),y.setRng(g))):f=void 0!==e&&p&&r(y.getStart())!==e.getBody()}function m(e,r){function l(e,t){for(;e=e[t?"previousSibling":"nextSibling"];)if(3!==e.nodeType||e.nodeValue.length>0)return e}function m(e,t){y.select(e),y.collapse(t)}function p(t){function i(t){for(var n=l;n;){if(n===t)return;n=n.parentNode}v.remove(t),e.undoManager.add(),u()}function o(){var o,r,s=e.schema.getNonEmptyElements();for(r=new tinymce.dom.TreeWalker(l,e.getBody());(o=t?r.prev():r.next())&&!s[o.nodeName.toLowerCase()]&&!(3===o.nodeType&&tinymce.trim(o.nodeValue).length>0);)if("false"===n(o))return i(o),!0;return a(o)?!0:!1}var r,l,d,c;if(y.isCollapsed()){if(r=y.getRng(!0),l=r.startContainer,d=r.startOffset,l=s(l)||l,c=a(l))return i(c),!1;if(3==l.nodeType&&(t?d>0:l.nodeValue.length>d))return!0;if(1==l.nodeType&&(l=l.childNodes[d]||l),o())return!1;if(3!=l.nodeType&&(l=l.lastChild,o()))return!1}return!0}var w,b,C,k,E=r.keyCode;if(C=y.getStart(),k=y.getEnd(),w=a(C)||a(k),w&&(112>E||E>124||E===o.ENTER)){if((tinymce.isMac?r.metaKey:r.ctrlKey)&&(67==E||88==E||86==E))return;if(r.preventDefault(),E==o.LEFT||E==o.UP||E==o.RIGHT||E==o.DOWN){var x=E==o.LEFT||E==o.UP;if(e.dom.isBlock(w)){var M,P,I,A=!f&&h===x;if(A&&w.childNodes.length)for(P=new t(w.firstChild,w);I=P.next();)if("true"===e.dom.getAttrib(I,i)){M=I;break}M?f=!0:(M=x?w.previousSibling:w.nextSibling,f=!1),P=new t(M,M);var T=x?P.prev():P.next();m(T,!x)}else d(w,x)}else(E===o.DELETE||E===o.BACKSPACE||E===o.ENTER)&&v.remove(w)}else if(E==o.LEFT||E==o.RIGHT||E==o.BACKSPACE||E==o.DELETE){if(b=s(C)){if(E==o.LEFT||E==o.BACKSPACE)if(w=l(b,!0),w&&"false"===n(w)){if(r.preventDefault(),E!=o.LEFT)return v.remove(w),void 0;m(w,!0)}else{if(E==o.BACKSPACE){var S=v.create("span",{id:_,"data-mce-bogus":!0},g);v.insertAfter(S,b.nextSibling)}c(b)}if(E==o.RIGHT||E==o.DELETE)if(w=l(b),w&&"false"===n(w)){if(r.preventDefault(),E!=o.RIGHT)return v.remove(w),void 0;m(w,!1)}else c(b)}if((E==o.BACKSPACE||E==o.DELETE)&&!p(E==o.BACKSPACE))return r.preventDefault(),!1}}function p(t){var n=t.srcElement||t.originalTarget;return n===e.getBody()&&(n=e.selection.isCollapsed()?e.selection.getNode():n),a(n)?(e.dom.events.cancel(t),!1):void 0}var g,h,f,v=e.dom,y=e.selection,_="mce_noneditablecaret",g="﻿";e.onMouseDown.addToTop(function(e,t){var i=e.selection.getNode();"false"===n(i)&&i==t.target&&u()}),e.onMouseUp.addToTop(u),e.onKeyDown.addToTop(m),e.onKeyUp.addToTop(u),e.dom.bind(e.getBody(),"drop",p),e.dom.bind(e.getBody(),"paste",p);var w=e.getDoc();w.attachEvent&&w.attachEvent("oncontrolselect",function(e){return a(e.srcElement)?!1:void 0});var b=e.selection.normalize;e.selection.normalize=function(){var t=e.selection.getRng(),n=v.getRoot();if(t.startContainer!==n||t.endContainer!==n)return b.apply(this,arguments);var i=t.startContainer,o=t.startOffset,r=i.childNodes[Math.min(o,i.childNodes.length-1)];if(!a(r))return b.apply(this,arguments)},e.onBeforeExecCommand.add(function(e,t,n,i,o){if("mceInsertContent"===t&&e.selection.isCollapsed()){var r=e.selection.getNode();a(r)&&(o.terminate=!0)}})}var t=tinymce.dom.TreeWalker,n="contenteditable",i="data-mce-"+n,o=tinymce.VK;tinymce.create("tinymce.plugins.NonEditablePlugin",{init:function(t){function o(e,t){var n=s.length,i=t.content,o=tinymce.trim(r);if("raw"!=t.format){for(;n--;)i=i.replace(s[n],function(t){var n=arguments,a=n[n.length-2];return a>0&&'"'==i.charAt(a-1)?t:'<span class="'+o+'" data-mce-content="'+e.dom.encode(n[0])+'">'+e.dom.encode("string"==typeof n[1]?n[1]:n[0])+"</span>"});t.content=i}}var a,r,s;a=" "+tinymce.trim(t.getParam("noneditable_editable_class","mceEditable"))+" ",r=" "+tinymce.trim(t.getParam("noneditable_noneditable_class","mceNonEditable"))+" ",s=t.getParam("noneditable_regexp"),s&&!s.length&&(s=[s]),t.onPreInit.add(function(){e(t),s&&(t.selection.onBeforeSetContent.add(o),t.onBeforeSetContent.add(o)),t.parser.addAttributeFilter("class",function(e){for(var t,n,o=e.length;o--;)n=e[o],t=" "+n.attr("class")+" ",-1!==t.indexOf(a)?n.attr(i,"true"):-1!==t.indexOf(r)&&n.attr(i,"false")}),t.serializer.addAttributeFilter(i,function(e){for(var t,o=e.length;o--;)t=e[o],s&&t.attr("data-mce-content")?(t.name="#text",t.type=3,t.raw=!0,t.value=t.attr("data-mce-content")):(t.attr(n,null),t.attr(i,null))}),t.parser.addAttributeFilter(n,function(e){for(var t,o=e.length;o--;)t=e[o],t.attr(i,t.attr(n)),t.attr(n,null)})})},getInfo:function(){return{longname:"Non editable elements",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/noneditable",version:tinymce.majorVersion+"."+tinymce.minorVersion}}}),tinymce.PluginManager.add("noneditable",tinymce.plugins.NonEditablePlugin)})();