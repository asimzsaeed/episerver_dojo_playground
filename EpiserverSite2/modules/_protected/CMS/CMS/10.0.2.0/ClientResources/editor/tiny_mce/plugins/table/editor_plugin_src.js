(function(e){function t(e,t){var n,i=t.ownerDocument,o=i.createRange();return o.setStartBefore(t),o.setEnd(e.endContainer,e.endOffset),n=i.createElement("body"),n.appendChild(o.cloneContents()),0==n.innerHTML.replace(/<(br|img|object|embed|input|textarea)[^>]*>/gi,"-").replace(/<[^>]+>/g,"").length}function n(e,t){return parseInt(e.getAttribute(t)||1)}function o(t,o,r){function l(e,t){return e=e.cloneNode(t),e.removeAttribute("id"),e}function s(){var e=0;B=[],a(["thead","tbody","tfoot"],function(i){var r=o.select("> "+i+" tr",t);a(r,function(t,r){r+=e,a(o.select("> td, > th",t),function(e,t){var o,a,l,s;if(B[r])for(;B[r][t];)t++;for(l=n(e,"rowspan"),s=n(e,"colspan"),a=r;r+l>a;a++)for(B[a]||(B[a]=[]),o=t;t+s>o;o++)B[a][o]={part:i,real:a==r&&o==t,elm:e,rowspan:l,colspan:s}})}),e+=r.length})}function c(e,t){var n;return n=B[t],n?n[e]:void 0}function d(e,t,n){e&&(n=parseInt(n),1===n?e.removeAttribute(t,1):e.setAttribute(t,n,1))}function u(e){return e&&(o.hasClass(e.elm,"mceSelected")||e==D)}function m(){var e=[];return a(t.rows,function(t){a(t.cells,function(n){return o.hasClass(n,"mceSelected")||n==D.elm?(e.push(t),!1):void 0})}),e}function p(){var e=o.createRng();e.setStartAfter(t),e.setEndAfter(t),r.setRng(e),o.remove(t)}function g(t){var n;return e.walk(t,function(i){var r;return 3==i.nodeType?(a(o.getParents(i.parentNode,null,t).reverse(),function(e){e=l(e,!1),n?r&&r.appendChild(e):n=r=e,r=e}),r&&(r.innerHTML=e.isIE&&!e.isIE11?"&nbsp;":'<br data-mce-bogus="1" />'),!1):void 0},"childNodes"),t=l(t,!1),d(t,"rowSpan",1),d(t,"colSpan",1),n?t.appendChild(n):(!e.isIE||e.isIE11)&&(t.innerHTML='<br data-mce-bogus="1" />'),t}function f(){var e=o.createRng();return a(o.select("tr",t),function(e){0==e.cells.length&&o.remove(e)}),0==o.select("tr",t).length?(e.setStartAfter(t),e.setEndAfter(t),r.setRng(e),o.remove(t),void 0):(a(o.select("thead,tbody,tfoot",t),function(e){0==e.rows.length&&o.remove(e)}),s(),row=B[Math.min(B.length-1,N.y)],row&&(r.select(row[Math.min(row.length-1,N.x)].elm,!0),r.collapse(!0)),void 0)}function h(e,t,n,i){var a,r,l,s,c;for(a=B[t][e].elm.parentNode,l=1;n>=l;l++)if(a=o.getNext(a,"tr")){for(r=e;r>=0;r--)if(c=B[t+l][r].elm,c.parentNode==a){for(s=1;i>=s;s++)o.insertAfter(g(c),c);break}if(-1==r)for(s=1;i>=s;s++)a.insertBefore(g(a.cells[0]),a.cells[0])}}function _(){a(B,function(e,t){a(e,function(e,i){var a,r,l;if(u(e)&&(e=e.elm,a=n(e,"colspan"),r=n(e,"rowspan"),a>1||r>1)){for(d(e,"rowSpan",1),d(e,"colSpan",1),l=0;a-1>l;l++)o.insertAfter(g(e),e);h(i,t,r-1,a)}})})}function v(t,n,i){var r,l,m,p,g,h,y,v,t,b,w;if(t?(pos=S(t),r=pos.x,l=pos.y,m=r+(n-1),p=l+(i-1)):(N=L=null,a(B,function(e,t){a(e,function(e,n){u(e)&&(N||(N={x:n,y:t}),L={x:n,y:t})})}),r=N.x,l=N.y,m=L.x,p=L.y),y=c(r,l),v=c(m,p),y&&v&&y.part==v.part){for(_(),s(),y=c(r,l).elm,d(y,"colSpan",m-r+1),d(y,"rowSpan",p-l+1),h=l;p>=h;h++)for(g=r;m>=g;g++)B[h]&&B[h][g]&&(t=B[h][g].elm,t!=y&&(b=e.grep(t.childNodes),a(b,function(e){y.appendChild(e)}),b.length&&(b=e.grep(y.childNodes),w=0,a(b,function(e){"BR"==e.nodeName&&o.getAttrib(e,"data-mce-bogus")&&w++<b.length-1&&y.removeChild(e)})),o.remove(t)));f()}}function b(e){var t,i,r,s,c,m,p,f,h;for(a(B,function(n,i){return a(n,function(n){return u(n)&&(n=n.elm,c=n.parentNode,m=l(c,!1),t=i,e)?!1:void 0}),e?!t:void 0}),s=0;B[0].length>s;s++)if(B[t][s]&&(i=B[t][s].elm,i!=r)){if(e){if(t>0&&B[t-1][s]&&(f=B[t-1][s].elm,h=n(f,"rowSpan"),h>1)){d(f,"rowSpan",h+1);continue}}else if(h=n(i,"rowspan"),h>1){d(i,"rowSpan",h+1);continue}p=g(i),d(p,"colSpan",i.colSpan),m.appendChild(p),r=i}m.hasChildNodes()&&(e?c.parentNode.insertBefore(m,c):o.insertAfter(m,c))}function w(e){var t,i;a(B,function(n){return a(n,function(n,i){return u(n)&&(t=i,e)?!1:void 0}),e?!t:void 0}),a(B,function(a,r){var l,s,c;a[t]&&(l=a[t].elm,l!=i&&(c=n(l,"colspan"),s=n(l,"rowspan"),1==c?e?(l.parentNode.insertBefore(g(l),l),h(t,r,s-1,c)):(o.insertAfter(g(l),l),h(t,r,s-1,c)):d(l,"colSpan",l.colSpan+1),i=l))})}function C(){var t=[];a(B,function(i){a(i,function(i,r){u(i)&&-1===e.inArray(t,r)&&(a(B,function(e){var t,i=e[r].elm;t=n(i,"colSpan"),t>1?d(i,"colSpan",t-1):o.remove(i)}),t.push(r))})}),f()}function k(){function e(e){var t,i,r;t=o.getNext(e,"tr"),a(e.cells,function(e){var t=n(e,"rowSpan");t>1&&(d(e,"rowSpan",t-1),i=S(e),h(i.x,i.y,1,1))}),i=S(e.cells[0]),a(B[i.y],function(e){var t;e=e.elm,e!=r&&(t=n(e,"rowSpan"),1>=t?o.remove(e):d(e,"rowSpan",t-1),r=e)})}var t;t=m(),a(t.reverse(),function(t){e(t)}),f()}function P(){var e=m();return o.remove(e),f(),e}function M(){var e=m();return a(e,function(t,n){e[n]=l(t,!0)}),e}function E(e,t){if(e){var n=m(),r=n[t?0:n.length-1],l=r.cells.length;a(B,function(e){var t;return l=0,a(e,function(e){e.real&&(l+=e.colspan),e.elm.parentNode==r&&(t=1)}),t?!1:void 0}),t||e.reverse(),a(e,function(e){var n,a=e.cells.length;for(i=0;a>i;i++)n=e.cells[i],d(n,"colSpan",1),d(n,"rowSpan",1);for(i=a;l>i;i++)e.appendChild(g(e.cells[a-1]));for(i=l;a>i;i++)o.remove(e.cells[i]);t?r.parentNode.insertBefore(e,r):o.insertAfter(e,r)}),o.removeClass(o.select("td.mceSelected,th.mceSelected"),"mceSelected")}}function S(e){var t;return a(B,function(n,i){return a(n,function(n,o){return n.elm==e?(t={x:o,y:i},!1):void 0}),!t}),t}function I(e){N=S(e)}function T(){var e,t;return e=t=0,a(B,function(n,i){a(n,function(n,o){var a,r;u(n)&&(n=B[i][o],o>e&&(e=o),i>t&&(t=i),n.real&&(a=n.colspan-1,r=n.rowspan-1,a&&o+a>e&&(e=o+a),r&&i+r>t&&(t=i+r)))})}),{x:e,y:t}}function A(e){var t,n,i,a,r,l,s,c;if(L=S(e),N&&L){for(t=Math.min(N.x,L.x),n=Math.min(N.y,L.y),i=Math.max(N.x,L.x),a=Math.max(N.y,L.y),r=i,l=a,y=n;l>=y;y++)e=B[y][t],e.real||t>t-(e.colspan-1)&&(t-=e.colspan-1);for(x=t;r>=x;x++)e=B[n][x],e.real||n>n-(e.rowspan-1)&&(n-=e.rowspan-1);for(y=n;a>=y;y++)for(x=t;i>=x;x++)e=B[y][x],e.real&&(s=e.colspan-1,c=e.rowspan-1,s&&x+s>r&&(r=x+s),c&&y+c>l&&(l=y+c));for(o.removeClass(o.select("td.mceSelected,th.mceSelected"),"mceSelected"),y=n;l>=y;y++)for(x=t;r>=x;x++)B[y][x]&&o.addClass(B[y][x].elm,"mceSelected")}}var B,N,L,D;s(),D=o.getParent(r.getStart(),"th,td"),D&&(N=S(D),L=T(),D=c(N.x,N.y)),e.extend(this,{deleteTable:p,split:_,merge:v,insertRow:b,insertCol:w,deleteCols:C,deleteRows:k,cutRows:P,copyRows:M,pasteRows:E,getPos:S,setStartCell:I,setEndCell:A})}var a=e.each;e.create("tinymce.plugins.TablePlugin",{init:function(i,r){function l(e){var t=i.selection,n=i.dom.getParent(e||t.getNode(),"table");return n?new o(n,i.dom,t):void 0}function s(){i.getBody().style.webkitUserSelect="",u&&(i.dom.removeClass(i.dom.select("td.mceSelected,th.mceSelected"),"mceSelected"),u=!1)}var c,d,u=!0;a([["table","table.desc","mceInsertTable",!0],["delete_table","table.del","mceTableDelete"],["delete_col","table.delete_col_desc","mceTableDeleteCol"],["delete_row","table.delete_row_desc","mceTableDeleteRow"],["col_after","table.col_after_desc","mceTableInsertColAfter"],["col_before","table.col_before_desc","mceTableInsertColBefore"],["row_after","table.row_after_desc","mceTableInsertRowAfter"],["row_before","table.row_before_desc","mceTableInsertRowBefore"],["row_props","table.row_desc","mceTableRowProps",!0],["cell_props","table.cell_desc","mceTableCellProps",!0],["split_cells","table.split_cells_desc","mceTableSplitCells",!0],["merge_cells","table.merge_cells_desc","mceTableMergeCells",!0]],function(e){i.addButton(e[0],{title:e[1],cmd:e[2],ui:e[3]})}),e.isIE||i.onClick.add(function(e,t){t=t.target,"TABLE"===t.nodeName&&(e.selection.select(t),e.nodeChanged())}),i.onPreProcess.add(function(e,t){var n,i,o,a,r=e.dom;for(n=r.select("table",t.node),i=n.length;i--;)o=n[i],r.setAttrib(o,"data-mce-style",""),(a=r.getAttrib(o,"width"))&&(r.setStyle(o,"width",a),r.setAttrib(o,"width","")),(a=r.getAttrib(o,"height"))&&(r.setStyle(o,"height",a),r.setAttrib(o,"height",""))}),i.onNodeChange.add(function(e,t,n){var i;n=e.selection.getStart(),i=e.dom.getParent(n,"td,th,caption"),t.setActive("table","TABLE"===n.nodeName||!!i),i&&"CAPTION"===i.nodeName&&(i=0),t.setDisabled("delete_table",!i),t.setDisabled("delete_col",!i),t.setDisabled("delete_table",!i),t.setDisabled("delete_row",!i),t.setDisabled("col_after",!i),t.setDisabled("col_before",!i),t.setDisabled("row_after",!i),t.setDisabled("row_before",!i),t.setDisabled("row_props",!i),t.setDisabled("cell_props",!i),t.setDisabled("split_cells",!i),t.setDisabled("merge_cells",!i)}),i.onInit.add(function(i){function o(e,t,n,i){var o,a,r,l=3,s=e.dom.getParent(t.startContainer,"TABLE");return s&&(o=s.parentNode),a=t.startContainer.nodeType==l&&0==t.startOffset&&0==t.endOffset&&i&&("TR"==n.nodeName||n==o),r=("TD"==n.nodeName||"TH"==n.nodeName)&&!i,a||r}function r(t){if(e.isWebKit){var n=t.selection.getRng(),i=t.selection.getNode(),a=t.dom.getParent(n.startContainer,"TD,TH");if(o(t,n,i,a)){a||(a=i);for(var r=a.lastChild;r.lastChild;)r=r.lastChild;n.setEnd(r,r.nodeValue.length),t.selection.setRng(n)}}}function m(t,i){function o(n,i,o){var a=n?"previousSibling":"nextSibling",l=t.dom.getParent(i,"tr"),d=l[a];if(d)return h(t,i,d,n),e.dom.Event.cancel(o),!0;var u=t.dom.getParent(l,"table"),m=l.parentNode,p=m.nodeName.toLowerCase();if("tbody"===p||p===(n?"tfoot":"thead")){var g=r(n,u,m,"tbody");if(null!==g)return s(n,g,i,o)}return c(n,l,a,u,o)}function r(e,n,i,o){var a=t.dom.select(">"+o,n),r=a.indexOf(i);if(e&&0===r||!e&&r===a.length-1)return l(e,n);if(-1===r){var s="thead"===i.tagName.toLowerCase()?0:a.length-1;return a[s]}return a[r+(e?-1:1)]}function l(e,n){var i=e?"thead":"tfoot",o=t.dom.select(">"+i,n);return 0!==o.length?o[0]:null}function s(n,i,o,a){var r=d(i,n);return r&&h(t,o,r,n),e.dom.Event.cancel(a),!0}function c(n,i,a,r,l){var s=r[a];if(s)return u(s),!0;var c=t.dom.getParent(r,"td,th");if(c)return o(n,c,l);var m=d(i,!n);return u(m),e.dom.Event.cancel(l)}function d(e,n){var i=e&&e[n?"lastChild":"firstChild"];return i&&"BR"===i.nodeName?t.dom.getParent(i,"td,th"):i}function u(e){t.selection.setCursorLocation(e,0)}function m(){return b==v.UP||b==v.DOWN}function p(e){var t=e.selection.getNode(),n=e.dom.getParent(t,"tr");return null!==n}function g(e){for(var t=0,i=e;i.previousSibling;)i=i.previousSibling,t+=n(i,"colspan");return t}function f(e,t){var i=0,o=0;return a(e.children,function(e,a){return i+=n(e,"colspan"),o=a,i>t?!1:void 0}),o}function h(e,t,n,i){var o=g(e.dom.getParent(t,"td,th")),a=f(n,o),r=n.childNodes[a],l=d(r,i);u(l||r)}function _(e){var n=t.selection.getNode(),i=t.dom.getParent(n,"td,th"),o=t.dom.getParent(e,"td,th");return i&&i!==o&&y(i,o)}function y(e,n){return t.dom.getParent(e,"TABLE")===t.dom.getParent(n,"TABLE")}var v=e.VK,b=i.keyCode;if(m()&&p(t)){var w=t.selection.getNode();setTimeout(function(){_(w)&&o(!i.shiftKey&&b===v.UP,w,i)},0)}}function p(){var t;for(t=i.getBody().lastChild;t&&3==t.nodeType&&!t.nodeValue.length;t=t.previousSibling);t&&"TABLE"==t.nodeName&&(i.settings.forced_root_block?i.dom.add(i.getBody(),i.settings.forced_root_block,null,e.isIE&&!e.isIE11?"&nbsp;":'<br data-mce-bogus="1" />'):i.dom.add(i.getBody(),"br",{"data-mce-bogus":"1"}))}var g,f,h,_=i.dom;c=i.windowManager,i.onMouseDown.add(function(e,t){2!=t.button&&(s(),f=_.getParent(t.target,"td,th"),g=_.getParent(f,"table"))}),_.bind(i.getDoc(),"mouseover",function(e){var t,n,o=e.target;if(f&&(h||o!=f)&&("TD"==o.nodeName||"TH"==o.nodeName)){n=_.getParent(o,"table"),n==g&&(h||(h=l(n),h.setStartCell(f),i.getBody().style.webkitUserSelect="none"),h.setEndCell(o),u=!0),t=i.selection.getSel();try{t.removeAllRanges?t.removeAllRanges():t.empty()}catch(a){}e.preventDefault()}}),i.onMouseUp.add(function(t){function n(t,n){var o=new e.dom.TreeWalker(t,t);do{if(3==t.nodeType&&0!=e.trim(t.nodeValue).length)return n?i.setStart(t,0):i.setEnd(t,t.nodeValue.length),void 0;if("BR"==t.nodeName)return n?i.setStartBefore(t):i.setEndBefore(t),void 0}while(t=n?o.next():o.prev())}var i,o,a,r,l,s,c=t.selection;if(c.getSel(),f){if(h&&(t.getBody().style.webkitUserSelect=""),o=_.select("td.mceSelected,th.mceSelected"),o.length>0){i=_.createRng(),r=o[0],s=o[o.length-1],i.setStartBefore(r),i.setEndAfter(r),n(r,1),a=new e.dom.TreeWalker(r,_.getParent(o[0],"table"));do if("TD"==r.nodeName||"TH"==r.nodeName){if(!_.hasClass(r,"mceSelected"))break;l=r}while(r=a.next());n(l),c.setRng(i)}t.nodeChanged(),f=h=g=null}}),i.onKeyUp.add(function(){s()}),i.onKeyDown.add(function(e){r(e)}),i.onMouseDown.add(function(e,t){2!=t.button&&r(e)}),i.plugins.table.fixTableCellSelection=r,i&&i.plugins.contextmenu&&i.plugins.contextmenu.onContextMenu.add(function(e,t,n){var o,a=i.selection,r=a.getNode()||i.getBody();i.dom.getParent(n,"td")||i.dom.getParent(n,"th")||i.dom.select("td.mceSelected,th.mceSelected").length?(t.removeAll(),"A"!=r.nodeName||i.dom.getAttrib(r,"name")||(t.add({title:"advanced.link_desc",icon:"link",cmd:i.plugins.advlink?"mceAdvLink":"mceLink",ui:!0}),t.add({title:"advanced.unlink_desc",icon:"unlink",cmd:"UnLink"}),t.addSeparator()),"IMG"==r.nodeName&&-1==r.className.indexOf("mceItem")&&(t.add({title:"advanced.image_desc",icon:"image",cmd:i.plugins.advimage?"mceAdvImage":"mceImage",ui:!0}),t.addSeparator()),t.add({title:"table.desc",icon:"table",cmd:"mceInsertTable",value:{action:"insert"}}),t.add({title:"table.props_desc",icon:"table_props",cmd:"mceInsertTable"}),t.add({title:"table.del",icon:"delete_table",cmd:"mceTableDelete"}),t.addSeparator(),o=t.addMenu({title:"table.cell"}),o.add({title:"table.cell_desc",icon:"cell_props",cmd:"mceTableCellProps"}),o.add({title:"table.split_cells_desc",icon:"split_cells",cmd:"mceTableSplitCells"}),o.add({title:"table.merge_cells_desc",icon:"merge_cells",cmd:"mceTableMergeCells"}),o=t.addMenu({title:"table.row"}),o.add({title:"table.row_desc",icon:"row_props",cmd:"mceTableRowProps"}),o.add({title:"table.row_before_desc",icon:"row_before",cmd:"mceTableInsertRowBefore"}),o.add({title:"table.row_after_desc",icon:"row_after",cmd:"mceTableInsertRowAfter"}),o.add({title:"table.delete_row_desc",icon:"delete_row",cmd:"mceTableDeleteRow"}),o.addSeparator(),o.add({title:"table.cut_row_desc",icon:"cut",cmd:"mceTableCutRow"}),o.add({title:"table.copy_row_desc",icon:"copy",cmd:"mceTableCopyRow"}),o.add({title:"table.paste_row_before_desc",icon:"paste",cmd:"mceTablePasteRowBefore"}).setDisabled(!d),o.add({title:"table.paste_row_after_desc",icon:"paste",cmd:"mceTablePasteRowAfter"}).setDisabled(!d),o=t.addMenu({title:"table.col"}),o.add({title:"table.col_before_desc",icon:"col_before",cmd:"mceTableInsertColBefore"}),o.add({title:"table.col_after_desc",icon:"col_after",cmd:"mceTableInsertColAfter"}),o.add({title:"table.delete_col_desc",icon:"delete_col",cmd:"mceTableDeleteCol"})):t.add({title:"table.desc",icon:"table",cmd:"mceInsertTable"})}),e.isWebKit&&i.onKeyDown.add(m),e.isGecko&&i.onKeyDown.add(function(e,n){var i,o,a=e.dom;(37==n.keyCode||38==n.keyCode)&&(i=e.selection.getRng(),o=a.getParent(i.startContainer,"table"),o&&e.getBody().firstChild==o&&t(i,o)&&(i=a.createRng(),i.setStartBefore(o),i.setEndBefore(o),e.selection.setRng(i),n.preventDefault()))}),i.onKeyUp.add(p),i.onSetContent.add(p),i.onVisualAid.add(p),i.onPreProcess.add(function(e,t){var n=t.node.lastChild;n&&("BR"==n.nodeName||1==n.childNodes.length&&("BR"==n.firstChild.nodeName||" "==n.firstChild.nodeValue))&&n.previousSibling&&"TABLE"==n.previousSibling.nodeName&&e.dom.remove(n)}),p(),i.startContent=i.getContent({format:"raw"})}),a({mceTableSplitCells:function(e){e.split()},mceTableMergeCells:function(t){var n,o,a;a=i.dom.getParent(i.selection.getNode(),"th,td"),a&&(n=a.rowSpan,o=a.colSpan),i.dom.select("td.mceSelected,th.mceSelected").length?t.merge():c.open({url:r+"/merge_cells.htm",width:240+e.parseInt(i.getLang("table.merge_cells_delta_width",0)),height:110+e.parseInt(i.getLang("table.merge_cells_delta_height",0)),inline:1},{rows:n,cols:o,onaction:function(e){t.merge(a,e.cols,e.rows)},plugin_url:r})},mceTableInsertRowBefore:function(e){e.insertRow(!0)},mceTableInsertRowAfter:function(e){e.insertRow()},mceTableInsertColBefore:function(e){e.insertCol(!0)},mceTableInsertColAfter:function(e){e.insertCol()},mceTableDeleteCol:function(e){e.deleteCols()},mceTableDeleteRow:function(e){e.deleteRows()},mceTableCutRow:function(e){d=e.cutRows()},mceTableCopyRow:function(e){d=e.copyRows()},mceTablePasteRowBefore:function(e){e.pasteRows(d,!0)},mceTablePasteRowAfter:function(e){e.pasteRows(d)},mceTableDelete:function(e){e.deleteTable()}},function(e,t){i.addCommand(t,function(){var t=l();t&&(e(t),i.execCommand("mceRepaint"),s())})}),a({mceInsertTable:function(t){c.open({url:r+"/table.htm",width:400+e.parseInt(i.getLang("table.table_delta_width",0)),height:320+e.parseInt(i.getLang("table.table_delta_height",0)),inline:1},{plugin_url:r,action:t?t.action:0})},mceTableRowProps:function(){c.open({url:r+"/row.htm",width:400+e.parseInt(i.getLang("table.rowprops_delta_width",0)),height:295+e.parseInt(i.getLang("table.rowprops_delta_height",0)),inline:1},{plugin_url:r})},mceTableCellProps:function(){c.open({url:r+"/cell.htm",width:400+e.parseInt(i.getLang("table.cellprops_delta_width",0)),height:295+e.parseInt(i.getLang("table.cellprops_delta_height",0)),inline:1},{plugin_url:r})}},function(e,t){i.addCommand(t,function(t,n){e(n)})})}}),e.PluginManager.add("table",e.plugins.TablePlugin)})(tinymce);