//>>built
define("epi-cms/CMSModule",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/when","epi","epi/_Module","epi/dependency","epi/shell/request/mutators","epi/routes","epi/shell/conversion/ObjectConverterRegistry","epi/shell/store/JsonRest","epi/shell/store/Throttle","epi/shell/TypeDescriptorManager","epi/shell/ViewSettings","epi-cms/ApplicationSettings","epi-cms/BackContextHistory","epi-cms/ContextSynchronizer","epi-cms/conversion/ContentFragmentConverter","epi-cms/conversion/ContentLightUriConverter","epi-cms/conversion/ContentReferenceConverter","epi-cms/conversion/PropertyDateConverter","epi-cms/core/ContentReference","epi-cms/store/configurableQueryEngine","epi-cms/store/PageVersionQueryEngine","epi-cms/project/ProjectActivitiesQueryEngine","epi-cms/component/command/GlobalToolbarCommandProvider","epi-cms/compare/command/CompareCommandProvider","epi-cms/notification/command/NotificationCommandProvider","epi-cms/command/ViewSettingsCommandProvider","epi-cms/contentediting/EditorFactory","epi-cms/contentediting/InUseNotificationManager","epi-cms/contentediting/ViewSettingsManager","epi-cms/project/ProjectService","epi-cms/project/ActivityService","epi-cms/notification/NotificationService","epi-cms/project/request/projectMode","epi-cms/request/contentLanguage","epi-cms/project/ProjectModeRequestInterceptor","epi-cms/project/ProjectItemQueryEngine","epi-cms/contentediting/command/Editing","epi-cms/contentediting/commandproviders/ContentDetails","epi-cms/contentediting/commandproviders/PublishMenu","epi-cms/contentediting/commandproviders/PublishMenuGlobal","epi-cms/contentediting/viewsettings/ChannelViewSetting","epi-cms/contentediting/viewsettings/ResolutionViewSetting","epi-cms/contentediting/viewsettings/ViewLanguageViewSetting","epi-cms/contentediting/viewsettings/VisitorGroupViewSetting","epi-cms/project/ProjectViewSetting","epi-cms/widget/ContentTypeService","epi-cms/Profile"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f,_20,_21,_22,_23,_24,_25,_26,_27,_28,_29,_2a,_2b,_2c,_2d,_2e,_2f,_30,_31,_32){return _2([_6],{_settings:null,_hashWrapper:null,_firstTimeHashUpdated:false,constructor:function(_33){this._settings=_33;},initialize:function(){this.inherited(arguments);_8.add(_24);_8.add(_25);_2.safeMixin(_f,this._settings);var _34=_7.resolve("epi.shell.Profile");return _4(_34.getContentLanguage()).then(_3.hitch(this,function(_35){_f.currentContentLanguage=_34.contentLanguage=_35;this.registerDependency("epi.cms.BackContextHistory",new _10());this.registerDependency("epi.cms.ContextSynchronizer",new _11(),undefined,function(_36){_36.destroy();});this.registerDependency("epi.cms.contentEditing.command.Editing",_28);this._hashWrapper=_7.resolve("epi.shell.HashWrapper");var _37=this.resolveDependency("epi.shell.ContextService");this.registerDependency("epi.cms.contentRepositoryDescriptors",this._settings.contentRepositoryDescriptors);_37.registerRoute("epi.cms.contentdata",_3.hitch(this,this._redirectContentDataContext));_37.registerRoute("epi.cms.project",_3.hitch(this,this._redirectProjectContext));this._initializeEditorFactory();this._initializeStores();this.registerDependency("epi.cms.ProjectService",new _21());this.registerDependency("epi.cms.ActivityService",new _22());this.registerDependency("epi.cms.NotificationService",new _23());this._projectModeRequestInterceptor=new _26();this.registerDependency("epi.cms.ContentTypeService",new _31());this._setupConverters(_7);this._setupViewSettings(_37);var _38=_7.resolve("epi.globalcommandregistry");_38.registerProvider("epi.cms.publishmenu",new _2b());_38.registerProvider("epi.cms.globalToolbar",new _1a());_38.registerProvider("epi.cms.globalToolbar",new _1b());_38.registerProvider("epi.cms.globalToolbar",new _1d());_38.registerProvider("epi.cms.globalToolbar",new _1c());this._setupInUseNotificationManager(_38);}));},_redirectContentDataContext:function(_39,_3a,uri){if(_e.viewName==="/episerver/dashboard"){var _3b=_9.getActionPath({moduleArea:"CMS",controller:"Home",action:""});_3b=_3b.substring(0,_3b.length-1);var _3c=_3b+"#"+this._hashWrapper.extractHash(_39,_3a);this._redirect(_3c);}else{if(_39.hasSiteChanged){var _3d=_39.fullHomeUrl+"#"+this._hashWrapper.extractHash(_39,_3a);this._redirect(_3d);}else{if(_3a&&_3a.trigger==="internal"&&this._firstTimeHashUpdated){return;}this._firstTimeHashUpdated=true;this._hashWrapper.onContextChange(_39,_3a);}}},_redirectProjectContext:function(_3e,_3f){this._hashWrapper.onContextChange(_3e,_3f);},_redirect:function(url){window.location=url;},_setupConverters:function(_40){var _41=new _13(),_42=new _14(),_43=new _12(),_44=new _15(),_45=this.resolveDependency("epi.cms.contentRepositoryDescriptors"),key;for(key in _45){var _46=_45[key];if(_46.linkableTypes){_46.linkableTypes.forEach(function(_47){_a.registerConverter(_47,_47+".link",_41);_a.registerConverter(_47+".fragment",_47+".link",_41);_a.registerConverter(_47,"link",_41);});}}for(key in _d._uiDescriptors){var _48=_d._uiDescriptors[key].descriptor;_a.registerConverter(_48.typeIdentifier,_48.typeIdentifier+".reference",_42);_a.registerConverter(_48.typeIdentifier+".fragment",_48.typeIdentifier+".reference",_42);_a.registerConverter(_48.typeIdentifier,_48.typeIdentifier+".light",_41);_a.registerConverter(_48.typeIdentifier,_48.typeIdentifier+".fragment",_43);}_41.registerDefaultConverters(_a);_44.registerDefaultConverters(_a);},_setupViewSettings:function(_49){var _4a=new _20({viewSettings:[new _2d(),new _2f(),new _2c(),new _30(_49),new _2e(_49)]});this.registerDependency("epi.viewsettingsmanager",_4a);},_initializeStores:function(){var _4b=this.resolveDependency("epi.storeregistry"),_4c,_4d,_4e;_4c=_4b.create("epi.cms.contentdata",this._getRestPath("contentdata"),{idProperty:"contentLink"});_4d=_4b.create("epi.cms.content.light",this._getRestPath("contentstructure"),{idProperty:"contentLink",queryEngine:_17});_4e=_4b.create("epi.cms.contentversion",this._getRestPath("contentversion"),{idProperty:"contentLink",queryEngine:_18});_4b.create("epi.cms.displayoptions",this._getRestPath("displayoptions"));_4b.create("epi.cms.category",this._getRestPath("categories"));_4b.create("epi.cms.inusenotification",this._getRestPath("inusenotification")).addDependentStore(_4c);_4b.create("epi.cms.visitorgroup",this._getRestPath("visitorgroup"));_4b.create("epi.cms.language",this._getRestPath("language"),{idProperty:"languageId"});_4b.create("epi.cms.sitestructure",this._getRestPath("sitestructure"),{idProperty:"url"});_4b.create("epi.cms.displaychannels",this._getRestPath("channel"));_4b.create("epi.cms.wastebasket",this._getRestPath("wastebasket"));_4b.create("epi.cms.xform",this._getRestPath("xform"));_4b.create("epi.cms.project",this._getRestPath("project"),{queryEngine:_17,realtimeInfo:{subscriptionKey:"/episerver/cms/project"}});_4b.create("epi.cms.project.item",this._getRestPath("project-item"),{queryEngine:_27,realtimeInfo:{subscriptionKey:"/episerver/cms/project-item"}});_4b.create("epi.cms.activities",this._getRestPath("activities"),{queryEngine:_19,realtimeInfo:{subscriptionKey:"/episerver/cms/activity"}});_4b.create("epi.cms.activities.comments",this._getRestPath("activities-comments"),{realtimeInfo:{subscriptionKey:"/episerver/cms/activity-comment"}});_4b.create("epi.cms.contenttype",this._getRestPath("contenttype")).query();_4b.create("epi.cms.notification",this._getRestPath("notification"),{queryEngine:_17,realtimeInfo:{subscriptionKey:"/episerver/cms/notification"}});_4b.create("epi.cms.notification.users",this._getRestPath("notification-users"),{idProperty:"userName"});_4b.add("epi.cms.contentreferences",new _c(new _b({target:this._getRestPath("contentreferences"),idProperty:"contentLink",preventCache:true})));_4b.add("epi.cms.content.search",new _c(new _b({target:this._getRestPath("contentstructure"),idProperty:"contentLink"})));_4c.addDependentStore(_4d,{refreshOnPatch:true,refresh:function(_4f){var id=_4c.getIdentity(_4f);var _50=new _16(id).createVersionUnspecificReference().toString();_4d.refresh(_50);}});_4c.addDependentStore(_4e,{transformDelegate:function(_51){if(_51.capabilities&&!_51.capabilities.versionable){return null;}if(!_51.properties){return null;}var _52={pageChangedBy:"savedBy",pageSaved:"savedDate",pageLanguageBranch:"language",pageName:"name",name:"name",icontent_name:"name"};var _53=_3.mixin({},_51);for(var p in _52){if(p in _53.properties){_53[_52[p]]=_53.properties[p];}}return _53;}});},_getRestPath:function(_54){return _9.getRestPath({moduleArea:"cms",storeName:_54});},_initializeEditorFactory:function(){this.registerDependency("epi.cms.contentediting.EditorFactory",function(){var _55=new _1e();_55.registerEditorWrapper("inline","epi-cms/contentediting/InlineEditorWrapper",function(_56,_57){});_55.registerEditorWrapper("richtextinline","epi-cms/contentediting/RichTextInlineEditorWrapper",function(_58,_59){});_55.registerEditorWrapper("flyout","epi-cms/contentediting/FlyoutEditorWrapper",function(_5a,_5b){});_55.registerEditorWrapper("floating","epi-cms/contentediting/FloatingEditorWrapper",function(_5c,_5d){});_55.registerEditorWrapper("contenteditable","epi-cms/contentediting/ContentEditableWrapper",function(_5e,_5f){});_55.registerEditorWrapper("legacyProperty","epi-cms/contentediting/DialogEditorWrapper",function(_60,_61){_60.closeOnChange=true;_60.showButtons=false;});return _55;});},_setupInUseNotificationManager:function(_62){var _63=new _1f();this.registerDependency("epi.cms.contentediting.inUseNotificationManager",_63);_62.registerProvider("epi.cms.publishmenu",new _2a());_62.registerProvider("epi.cms.contentdetailsmenu",new _29());}});});