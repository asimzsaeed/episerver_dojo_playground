//>>built
define("epi-cms/compare/viewmodels/CompareViewModel",["dojo/_base/declare","dojo/aspect","dojo/topic","dojo/_base/lang","dojo/Stateful","dojo/when","epi/shell/DestroyableByKey","epi/dependency","epi-cms/core/ContentReference","epi-cms/compare/viewmodels/CompareToolbarViewModel"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _1([_5,_7],{contentLink:null,languages:null,typeIdentifier:null,leftVersion:null,rightVersion:null,leftVersionUri:null,rightVersionUrl:null,hasAccess:true,contentDataStore:null,contentVersionStore:null,orientation:"vertical",compareToolbarViewModel:null,postscript:function(){this.inherited(arguments);this.contentDataStore=this.contentDataStore||_8.resolve("epi.storeregistry").get("epi.cms.contentdata");this.contentVersionStore=this.contentVersionStore||_8.resolve("epi.storeregistry").get("epi.cms.contentversion");this._setupCompareToolbarViewModel();this.own(_3.subscribe("/epi/cms/content/statuschange/",_4.hitch(this,"_refresh")));},_refresh:function(){var _b=this.contentVersionStore;_6(_b.refresh(this.leftVersion.contentLink),_4.hitch(this,function(_c){this.set("leftVersion",_c);}));if(this.rightVersion){_6(_b.refresh(this.rightVersion.contentLink),_4.hitch(this,function(_d){this.set("rightVersion",_d);}));}},_contentLinkSetter:function(_e){this.contentLink=_e;var _f=this.contentVersionStore;_6(_f.get(_e),_4.hitch(this,function(_10){this.set("leftVersion",_10);if(!this.rightVersion||!_9.compareIgnoreVersion(this.leftVersion.contentLink,this.rightVersion.contentLink)){var _11={contentLink:_e,language:this.leftVersion.language,query:"getcompareversion"};var _12=_f.query(_11);_6(_12,_4.hitch(this,function(_13){this.set("hasAccess",true);this.set("rightVersion",_13&&_13.length?_13[0]:null);}),_4.hitch(this,function(_14){this.set("hasAccess",_14.status!==403);this.set("rightVersion",null);}));}}));},_leftVersionSetter:function(_15){this.leftVersion=_15;if(this.compareToolbarViewModel){if(this.compareToolbarViewModel.leftVersion!==_15){this.compareToolbarViewModel.set("leftVersion",_15);}}this.set("leftVersionUri",_15.uri);},_rightVersionSetter:function(_16){var _17="removeAfter";this.rightVersion=_16;this.destroyByKey(_17);if(_16){this.ownByKey(_17,_2.after(this.contentVersionStore,"remove",_4.hitch(this,function(_18){if(_16.contentLink===_18){this.set("rightVersion",null);}}),true));}if(this.compareToolbarViewModel){if(this.compareToolbarViewModel.rightVersion!==_16){this.compareToolbarViewModel.set("rightVersion",_16);}}if(_16===null){this.set("rightVersionUrl","about:blank");return;}_6(this.contentDataStore.get(_16.contentLink),_4.hitch(this,function(_19){if(this.leftVersion===this.rightVersion){this.set("rightVersionUrl","about:blank");}this.set("rightVersionUrl",_19.editablePreviewUrl);}));},_typeIdentifierSetter:function(_1a){this.typeIdentifier=_1a;if(this.compareToolbarViewModel){this.compareToolbarViewModel.set("typeIdentifier",_1a);}},_languagesSetter:function(_1b){this.languages=_1b;if(this.compareToolbarViewModel){this.compareToolbarViewModel.set("languages",_1b);}},_hasAccessSetter:function(_1c){this.hasAccess=_1c;if(this.compareToolbarViewModel){this.compareToolbarViewModel.set("hasAccess",_1c);}},_setupCompareToolbarViewModel:function(){this.compareToolbarViewModel=this.compareToolbarViewModel||new _a({contentVersionStore:this.contentVersionStore,leftVersion:this.leftVersion,rightVersion:this.rightVersion,typeIdentifier:this.typeIdentifier,hasAccess:this.hasAccess,languages:this.languages});this.own(this.compareToolbarViewModel.watch("leftVersion",_4.hitch(this,function(_1d,_1e,_1f){if(this.leftVersion!==_1f){this.set("leftVersion",_1f);}})));this.own(this.compareToolbarViewModel.watch("rightVersion",_4.hitch(this,function(_20,_21,_22){if(this.rightVersion!==_22){this.set("rightVersion",_22);}})));}});});