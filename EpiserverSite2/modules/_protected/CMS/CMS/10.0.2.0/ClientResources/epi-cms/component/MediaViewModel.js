//>>built
define("epi-cms/component/MediaViewModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/when","epi","epi/shell/widget/dialog/Dialog","epi-cms/core/ContentReference","epi-cms/widget/viewmodel/HierarchicalListViewModel","epi-cms/widget/viewmodel/MultipleFileUploadViewModel","epi-cms/widget/MultipleFileUpload","epi-cms/command/UploadContent","epi-cms/command/EditImage","epi-cms/command/DownloadMedia","epi/i18n!epi/cms/nls/episerver.cms.components.media"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f){return _2([_9],{_dialog:null,_getTypesToCreate:function(){return [];},_setupCommands:function(){this.inherited(arguments);var _10={selection:this.selection,model:this};var _11={uploadDefault:{command:new _c(_3.mixin({iconClass:"epi-iconPlus",label:_f.command.label,resources:_f,viewModel:this},_10))},upload:{command:new _c(_3.mixin({category:"context",iconClass:"epi-iconUpload",label:_f.linktocreateitem,viewModel:this},_10)),isAvailable:this.menuType.ROOT|this.menuType.TREE,order:2},editImage:{command:new _d(_3.mixin({category:"context",forceContextChange:true,label:_f.command.openineditor},_10)),isAvailable:this.menuType.LIST,order:3},download:{command:new _e(_3.mixin({category:"context",label:_f.command.download},_10)),isAvailable:this.menuType.LIST,order:4}};this._commandRegistry=_3.mixin(this._commandRegistry,_11);this.pseudoContextualCommands.push(this._commandRegistry.uploadDefault.command);this.pseudoContextualCommands.push(this._commandRegistry.upload.command);},_updateTreeContextCommandModels:function(_12){this.inherited(arguments);this._commandRegistry.uploadDefault.command.set("model",_12);this._commandRegistry.upload.command.set("model",_12);},upload:function(_13,_14,_15){var _16=new _b({model:new _a({store:this.get("store"),query:this.get("listQuery")})});_16.on("beforeUploaderChange",_3.hitch(this,function(){this._uploading=true;}));_16.on("close",_3.hitch(this,function(_17){this._dialog&&(_17?this._dialog.hide():this._dialog.destroy());}));_16.on("uploadComplete",_3.hitch(this,function(_18){if(_16.createAsLocalAsset){_5(this.treeStoreModel&&typeof this.treeStoreModel.refreshRoots==="function"&&this.treeStoreModel.refreshRoots(this),_3.hitch(this,function(){_16.set("createAsLocalAsset",false);_16.set("uploadDirectory",this.get("currentTreeItem").id);_16.model.set("query",this.get("listQuery"));}));}else{this.onListItemUpdated(_18);this.set("currentTreeItem",this.get("currentTreeItem"));}if(this._dialog&&!this._dialog.open){this._dialog.destroy();}this._uploading=false;}));this._dialog=new _7({title:_f.linktocreateitem,dialogClass:"epi-dialog-upload",content:_16,autofocus:true,defaultActionsVisible:false,closeIconVisible:false,destroyOnHide:false});this._dialog.definitionConsumer.add({name:"close",label:_6.resources.action.close,action:function(){_16.close();}});this._dialog.resize({w:700});this._dialog.show();var _19=_15?this.selection.data[0].data:this.store.get(_14);_5(_19,_3.hitch(this,function(_1a){this._buildBreadcrumb(_1a,_16);_16.set("uploadDirectory",_14||this.get("currentTreeItem").id);_16.set("createAsLocalAsset",_15);_16.upload(_13);}));},onListItemUpdated:function(_1b){var _1c=this.store;return _5(this.getCurrentContext(),function(_1d){var _1e=(new _8(_1d.id)).createVersionUnspecificReference().toString();return _5(_1c.get(_1e),function(_1f){var _20=_1.filter(_1b,function(_21){return _1f.name.toLowerCase()===_21.fileName.toLowerCase();})[0];return _20?_1f:null;});});},_buildBreadcrumb:function(_22,_23){if(!_23){return;}if(this.treeStoreModel.isTypeOfRoot(_22)){_23.set("breadcrumb",[_22]);return;}this.treeStoreModel.getAncestors(_22.contentLink,_3.hitch(this,function(_24){var _25,_26=[_22];for(var i=_24.length-1;i>=0;i--){_25=_24[i];_26.unshift(_25);if(this.treeStoreModel.isTypeOfRoot(_25)){break;}}_23.set("breadcrumb",_26);}));},getContextualParentLink:function(_27,_28){var _29=this.inherited(arguments);var _2a=this.treeStoreModel.get("previousSelection");if(_2a&&_2a.selectedContent){var _2b=_2a.selectedContent.tree.getNodesByItem(_29)[0];if(_2b===undefined){_29=this.roots[this.roots.length-1];}}return _29;}});});