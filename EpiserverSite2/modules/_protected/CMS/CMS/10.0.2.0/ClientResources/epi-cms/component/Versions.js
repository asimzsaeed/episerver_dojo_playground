//>>built
define("epi-cms/component/Versions",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/dom-class","dojo/string","dojo/topic","dojo/when","dojox/html/entities","dgrid/OnDemandGrid","dgrid/Selection","epi-cms/dgrid/formatters","epi","epi/dependency","epi/shell/TypeDescriptorManager","epi/shell/command/_WidgetCommandProviderMixin","epi/shell/command/withConfirmation","epi/shell/widget/_FocusableMixin","epi/shell/widget/dialog/Alert","epi-cms/_MultilingualMixin","epi-cms/ApplicationSettings","epi-cms/core/ContentReference","epi-cms/component/command/DeleteVersion","epi-cms/component/command/DeleteLanguageBranch","epi-cms/component/command/SetCommonDraft","epi-cms/command/ShowAllLanguages","epi-cms/contentediting/ContentActionSupport","epi-cms/widget/_GridWidgetBase","epi/i18n!epi/cms/nls/episerver.cms.components.versions"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d){return _2([_1c,_10,_12,_14],{showAllLanguages:true,isMultilingual:false,postMixInProperties:function(){this._commonDrafts={};this.storeKeyName="epi.cms.contentversion";this.ignoreVersionWhenComparingLinks=false;this.inherited(arguments);this._currentContentLanguage=_15.currentContentLanguage;var _1e=_e.resolve("epi.storeregistry");this._contentStore=_1e.get("epi.cms.contentdata");},buildRendering:function(){this.inherited(arguments);var _1f=_2([_a,_b]);this.grid=new _1f({columns:{language:{label:_d.resources.header.language},status:{label:_d.resources.header.status,renderCell:_c.commonDraft},savedDate:{label:_d.resources.header.saved,formatter:this._localizeDate},savedBy:{label:_d.resources.header.by,formatter:this._createUserFriendlyUsername}},selectionMode:"single",selectionEvents:"click,dgrid-cellfocusin",sort:[{attribute:"savedDate",descending:true}]},this.domNode);},postCreate:function(){this.inherited(arguments);this.add("commands",new _1a({model:this}));this._commonDraftCommand=new _19();this._deleteVersionCommand=new _17();this._deleteLanguageBranchCommand=new _18();this.own(_4.after(this._commonDraftCommand,"execute",_3.hitch(this,function(_20){_20.then(_3.hitch(this,this.fetchData),_3.hitch(this,this._onSetCommonDraftFailure));})),_4.after(this._deleteVersionCommand,"execute",_3.hitch(this,function(_21){_21.then(_3.hitch(this,this._onDeleteVersionSuccess),_3.hitch(this,this._onDeleteVersionFailure));})),_4.after(this._deleteLanguageBranchCommand,"execute",_3.hitch(this,function(_22){_22.then(_3.hitch(this,this._onDeleteLanguageBranchSuccess),_3.hitch(this,this._onDeleteVersionFailure));})));this.add("commands",this._commonDraftCommand);this.add("commands",_11(this._deleteVersionCommand,null,{title:_1d.deletemenuitemtitle,heading:_1d.deleteversion.note,description:_1d.deleteversion.confirmquestion}));this._deleteLanguageBranchSettings={cancelActionText:_d.resources.action.cancel,setFocusOnConfirmButton:false};this.add("commands",_11(this._deleteLanguageBranchCommand,null,this._deleteLanguageBranchSettings));},startup:function(){if(this._started){return;}this.inherited(arguments);this.own(_4.around(this.grid,"renderRow",_3.hitch(this,this._aroundRenderRow)));this._toggleLanguage(this.showAllLanguages);this.fetchData();},_setShowAllLanguagesAttr:function(_23){this._set("showAllLanguages",_23);this._toggleFilterByLanguage(_23);},contextChanged:function(_24,_25){this.inherited(arguments);!this._isContentContext(_24)&&this.grid.set("store",null);},fetchData:function(){_8(this.getCurrentContent(),_3.hitch(this,function(_26){if(!_26){return;}this._setQuery(_26.contentLink,this._showAllLanguages);this.set("isMultilingual",true);}));},_aroundRenderRow:function(_27){return _3.hitch(this,function(_28){if(_28.isCommonDraft){var _29=this._commonDrafts[_28.language];if(_29&&_29!==_28.contentLink){this._removeCommonDraft(_29);}this._commonDrafts[_28.language]=_28.contentLink;}this._versionsByLanguage[_28.language]=this._versionsByLanguage[_28.language]||[];if(_1.every(this._versionsByLanguage[_28.language],function(ver){return ver!==_28.contentLink;})){this._versionsByLanguage[_28.language].push(_28.contentLink);}var row=_27.apply(this.grid,arguments);_5.toggle(row,"dgrid-row-published",_28.status===_1b.versionStatus.Published);return row;});},_onError:function(e){if(e.error&&e.error.status===403){_8(this.getCurrentContent(),_3.hitch(this,function(_2a){this._showErrorMessage(_d.resources.messages.nopermissiontoviewdata);this.set("isMultilingual",false);this._updateMenu(_2a);}));}else{this.inherited(arguments);}},_onSelect:function(e){var _2b=e.rows[0].data;this._updateMenu(_2b);this.inherited(arguments);},_updateMenu:function(_2c){this._commonDraftCommand.set("model",_2c);this._deleteVersionCommand.set("model",_2c);_8(this._contentStore.get(_2c.contentLink),_3.hitch(this,function(_2d){if(_2d&&_2d.currentLanguageBranch){var _2e=_3.replace(_1d.deletelanguagebranch.label,[_2d.currentLanguageBranch.name]),_2f=_f.getResourceValue(_2d.typeIdentifier,"deletelanguagebranchdescription");_3.mixin(this._deleteLanguageBranchSettings,{confirmActionText:_2e,description:_3.replace(_2f,[_9.encode(_2d.name),_2d.currentLanguageBranch.name]),title:_2e});this._deleteLanguageBranchCommand.set("label",_2e);}this._deleteLanguageBranchCommand.set("model",_2d);}));},_showNotificationMessage:function(_30){var _31=new _13({title:_1d.notificationtitle,description:_30});_31.show();},_selectCommonDraftVersion:function(uri,_32){var _33={sender:this};if(_32){_33.forceReload=_32;}_7.publish("/epi/shell/context/request",{uri:uri},_33);},_onDeleteLanguageBranchSuccess:function(){return _8(this._onDeleteVersionSuccess(arguments),_3.hitch(this,function(){var _34=this._deleteLanguageBranchCommand.model.currentLanguageBranch.languageId;_1.forEach(this._versionsByLanguage[_34],_3.hitch(this,function(ver){this.store.notify(undefined,new _16(ver));}));}));},_onDeleteVersionSuccess:function(){var _35=this;return _8(this.getCurrentContent(),function(_36){var _37=new _16(_36.contentLink);var _38=_37.createVersionUnspecificReference().toString();_35._selectCommonDraftVersion("epi.cms.contentdata:///"+_38,true);});},_onDeleteVersionFailure:function(_39){if(!_39||!_39.status){return;}else{if(_39.status===403){this._showNotificationMessage(_1d.deleteversion.cannotdeletepublished);}else{this._showNotificationMessage(_1d.deleteversion.cannotdelete);}}},_onSetCommonDraftFailure:function(){this._showNotificationMessage(_1d.setcommondraft.failuremessage);},_removeCommonDraft:function(_3a){if(_3a){var _3b=this.grid.row(_3a).data;if(_3b){_3b.isCommonDraft=false;}}},_toggleFilterByLanguage:function(_3c){_8(this.getCurrentContext(),_3.hitch(this,function(_3d){if(!this._isContentContext(_3d)){this.grid.set("store",null);}else{this._setQuery(_3d.id,_3c);this._toggleLanguage(_3c);this._showAllLanguages=_3c;}}));},_setQuery:function(_3e,_3f){var _40={contentLink:new _16(_3e).createVersionUnspecificReference().toString()};if(!_3f){_40.language=this._currentContentLanguage;}this.grid.set("query",_40);if(!this.grid.store){this.grid.set("store",this.store);}this._versionsByLanguage={};},_toggleLanguage:function(_41){var _42=_41?"table-cell":"none";this.grid.styleColumn("language",_6.substitute("display:${0};",[_42]));}});});