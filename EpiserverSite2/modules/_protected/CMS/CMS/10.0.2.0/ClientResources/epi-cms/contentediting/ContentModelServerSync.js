//>>built
define("epi-cms/contentediting/ContentModelServerSync",["dojo/_base/array","dojo/_base/declare","dojo/Deferred","dojo/when","dojo/_base/json","dojo/_base/lang","dojo/Stateful","epi/datetime","epi/string"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){return _2([_7],{_queue:null,_isSynchronizing:false,hasPendingChanges:false,contentLink:null,contentDataStore:null,processInterval:200,_processIntervalId:0,_saveDeferred:null,constructor:function(_a){_2.safeMixin(this,_a);this._queue=[];},scheduleForSync:function(_b,_c){if(_c===undefined){return;}this.set("hasPendingChanges",true);_c=_8.transformDate(_c);var _d=this._propertyIndexInQueue(_b);if(_d<0){this._queue.push({name:_b,value:_c});}else{this._queue[_d].value=_c;}},saveAndPublishProperty:function(_e,_f){this.scheduleForSync(_e,_f);return this._startSynchronizeInterval({delay:0,publish:true});},_propertyIndexInQueue:function(_10){var _11=-1;_1.some(this._queue,function(_12,i){if(_12.name===_10){_11=i;return true;}});return _11;},save:function(){return this._startSynchronizeInterval();},_startSynchronizeInterval:function(_13){var _14;if(!this._saveDeferred){this._saveDeferred=new _3();_14=_13&&_13.delay||this.processInterval;setTimeout(this._synchronizeItem.bind(this,_13),_14);}return this._saveDeferred.promise;},_synchronizeItem:function(_15){var _16=this._queue,_17=this.contentLink,_18=this._saveDeferred;this._queue=[];this._saveDeferred=null;this.set("hasPendingChanges",false);var _19=function(_1a){var _1b={},_1c;if(_1a){_1.forEach(_1a.properties,_6.hitch(this,function(_1d){_1d.name=_9.pascalToCamel(_1d.name);}));_1c=_1a.savedContentLink;_1b=_6.mixin({successful:false,contentLink:_1a.savedContentLink,hasContentLinkChanged:_1a.savedContentLink&&_1c!==this.contentLink},_1a);if(_1c&&_1c!==this.contentLink){_1b.oldContentLink=this.contentLink;this.contentLink=_1c;}_18.resolve(_1b);}else{_18.reject({contentLink:_17,properties:_16,error:"Unexpected result returned from the server."});}}.bind(this);var _1e=function(_1f){var _20={contentLink:_17,properties:_16,error:_1f};_18.reject(_20);}.bind(this);if(_16.length===0){_18.resolve();return;}_4(this._saveProperties(_16,_15)).then(_19).otherwise(_1e);},pendingSync:function(_21){return this._propertyIndexInQueue(_21)!==-1;},_saveProperties:function(_22,_23){var _24=this.contentLink,_25={},_26=!!_23&&_23.publish;_1.forEach(_22,_6.hitch(this,function(_27){_25[_27.name]=_5.toJson(_27.value);}));var _28={id:_24,properties:_25,publishChanges:_26};return this.contentDataStore.patch(_28,{id:_28.id});}});});