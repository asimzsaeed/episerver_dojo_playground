//>>built
require({cache:{"url:epi-cms/contentediting/templates/PageDataController.html":"<div style=\"width: 100%; height: 100%;\">\r\n    <div data-dojo-attach-point=\"mainLayoutContainer\" data-dojo-type=\"epi/shell/layout/PreserveRatioBorderContainer\" data-dojo-props=\"gutters: false, livesplitters: false\" style=\"width: 100%; height: 100%\">\r\n        <div data-dojo-attach-point=\"toolbar\" data-dojo-type=\"epi-cms/contentediting/EditToolbar\" data-dojo-props=\"region:'top'\"></div>\r\n        <div data-dojo-attach-point=\"notificationBar\" data-dojo-type=\"epi-cms/contentediting/NotificationBar\" data-dojo-props=\"region:'top', layoutPriority: 99\"></div>\r\n        <div data-dojo-attach-point=\"editLayoutContainer\" data-dojo-type=\"epi/shell/layout/CardContainer\" data-dojo-props=\"region: 'center', layoutPriority: 100\">\r\n            <div data-dojo-attach-point=\"iframeWithOverlay\" data-dojo-type=\"epi/shell/widget/IframeWithOverlay\" data-dojo-props=\"fitContainer: true\">\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n"}});define("epi-cms/contentediting/PageDataController",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/dom-style","dojo/Deferred","dojo/topic","dojo/when","dijit/_TemplatedMixin","dijit/_Widget","dijit/_WidgetsInTemplateMixin","dijit/layout/BorderContainer","epi/dependency","epi/Url","epi/shell/layout/CardContainer","epi/shell/layout/PreserveRatioBorderContainer","epi/shell/widget/IframeWithOverlay","epi-cms/_ContentContextMixin","epi-cms/contentediting/EditNotifications","epi-cms/contentediting/ContentViewModel","epi-cms/contentediting/EditToolbar","epi-cms/contentediting/NotificationBar","epi-cms/contentediting/ShortcutNotification","epi-cms/contentediting/ViewSettingsNotification","epi-cms/project/ProjectNotification","epi-cms/contentediting/command/Editing","epi/i18n!epi/cms/nls/episerver.cms.contentediting","dojo/text!./templates/PageDataController.html"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,res,_1b){return _2([_a,_9,_b,_12],{templateString:_1b,contextTypeName:"epi.cms.contentdata",pendingNotificationTimeOutId:null,isActive:true,defaultEditCssRules:[{selector:".epi-injected-minSize",css:"min-height: 30px;"},{selector:".epi-injected-minSize-inline",css:"min-height: 30px; min-width: 100px; display: inline-block !important;"},{selector:"[contenteditable=true]:focus",css:"outline: 3px #b4c600 solid;"}],_currentViewComponent:null,_viewModels:null,_notificationHandlerId:null,_messageService:null,_editingCommands:null,_currentViewModel:null,_pageDataStore:null,_shortcutNotification:null,_projectNotification:null,_availableViews:null,_previewQueryParameters:null,_viewSettingsManager:null,_inUseNotificationManager:null,_ensurePreviewReadyPromise:null,postMixInProperties:function(){this.inherited(arguments);var _1c=_d.resolve("epi.storeregistry");this._viewSettingsManager=_d.resolve("epi.viewsettingsmanager");this._messageService=this._messageService||_d.resolve("epi.shell.MessageService");this._profile=this._profile||_d.resolve("epi.shell.Profile");this._pageDataStore=_1c.get("epi.cms.contentdata");this._editingCommands=_1a;if(!this._viewModels){this._viewModels=[];}this._inUseNotificationManager=this.inUseNotificationManager||_d.resolve("epi.cms.contentediting.inUseNotificationManager");this._shortcutNotification=new _17();this._viewSettingsNotification=new _18();this._projectNotification=new _19();this._editNotifications=this._editNotifications||new _13();this.own(this._editNotifications,this._editNotifications.on("changed",function(e){this._defaultNotificationWatchHandler("",e.oldValue,e.newValue);}.bind(this)));},postCreate:function(){var cs;this.inherited(arguments);this.subscribe("/epi/cms/action/switcheditmode",_3.hitch(this,this._switchEditMode));cs=_d.resolve("epi.shell.ContextService");this._interceptorHandle=cs.registerRequestInterceptor(_3.hitch(this,this._interceptRequestContext));this.notificationBar.on("notificationsChanged",_3.hitch(this,function(){this.mainLayoutContainer.layout();}));this.own(_7.subscribe("/epi/cms/action/undo",this._undoAction.bind(this)),_7.subscribe("/epi/cms/action/redo",this._redoAction.bind(this)),_7.subscribe("/epi/cms/action/save",this._saveAction.bind(this)),this._shortcutNotification.watch("notification",_3.hitch(this,this._defaultNotificationWatchHandler)),this._viewSettingsNotification.watch("notification",_3.hitch(this,this._defaultNotificationWatchHandler)),this._projectNotification.watch("notification",_3.hitch(this,this._projectNotificationWatchHandler)));},startup:function(){if(this._started){return;}this.inherited(arguments);var url=new _e(window.location.href),_1d=url.getQueryParameterValue("view");this.iFrame=this.iframeWithOverlay.iframe;this.connect(this.iFrame,"onLoad","_iFrameLoaded");this.connect(this.iFrame,"onUnload","_iFrameUnLoaded");_4.add(this.toolbar.domNode,"epi-localToolbar epi-viewHeaderContainer");this._injectCssRules();_8(this.getCurrentContext(),_3.hitch(this,function(_1e){this.contextChanged(_1e);}));},destroy:function(){this._interceptorHandle.remove();this._destroyCurrentViewComponent();this._viewModels=null;this.inherited(arguments);},_defaultNotificationWatchHandler:function(_1f,_20,_21){if(_20){this.notificationBar.remove(_20);}if(_21&&_21.content){this.notificationBar.add(_21);}},_projectNotificationWatchHandler:function(_22,_23,_24){if(_23){this.notificationBar.remove(_23);}if(_24&&_24.content){this.notificationBar.add(_24,"first");}},_switchEditMode:function(_25,_26){var _27,_28=this._currentViewModel.viewName,_29=false,_2a="view",_2b="onpageedit",_2c="formedit";if(!this.isActive){return;}if(_28===_2a){_7.publish("/epi/cms/action/disablepreview");}if(_28===_2c){_27=_2b;_29=true;}else{_27=_2c;}return this._ensurePreviewReady(this.setView(_27,_26),_29,true,_27);},_iFrameLoaded:function(url,_2d){if(!!url&&!_2d){this._requestContextChangeByUrl(url,true,true);}},_iFrameUnLoaded:function(url){this.iframeWithOverlay.overlay.set("enabled",false);},_destroyCurrentViewComponent:function(){if(this._currentViewComponentReloadRequireHandle){this._currentViewComponentReloadRequireHandle.remove();this._currentViewComponentReloadRequireHandle=null;}if(this._currentViewComponent){this._currentViewComponent.destroyRecursive();this._currentViewComponent=null;}},_getViewModelIndex:function(id){var _2e=-1;_1.some(this._viewModels,function(_2f,idx){if(_2f.contentLink===id){_2e=idx;return true;}});return _2e;},_getViewModel:function(id){var _30=this._getViewModelIndex(id);if(_30>=0){return this._viewModels[_30];}else{return null;}},_removeViewModel:function(id){var _31=this._getViewModelIndex(id);if(_31>=0){var _32=this._viewModels.splice(_31,1)[0];_32.clear();}},_createViewModel:function(_33,ctx){var _34=new _14({contentLink:_33.contentLink,contextTypeName:this.contextTypeName});_34.set("contentData",_33);_34.set("languageContext",ctx.languageContext);this._viewModels.push(_34);return _34;},contentContextUpdated:function(ctx,_35){var _36=ctx.id;this._pageDataStore.refresh(_36).then(_3.hitch(this,function(_37){if(this._currentViewModel){this._updateContentViewModel(_37,ctx.languageContext);this._refreshModel(_37,ctx);this._onViewRequireReload();}}));},updateView:function(_38,ctx,_39){_8(this._ensurePreviewReadyPromise,_3.hitch(this,function(){if(_38&&_38.skipUpdateView&&_38.viewName===this._currentViewModel.viewName){return;}if(_39&&_39.widgetResumed){_5.set(this.domNode,"visibility","hidden");}if(_38&&_38.contextIdSyncChange){this._pageDataStore.refresh(ctx.id).then(_3.hitch(this,function(_3a){var _3b=this._currentViewModel.contentData.contentLink;this._updateContentViewModel(_3a,ctx.languageContext);this._currentViewComponent.onContentLinkSyncChange(_3b,_3a.contentLink);this._refreshModel(_3a,ctx);}));}else{if(this._currentViewModel){this._currentViewModel.suspend();}var _3c;if(_38&&_38.viewName){if(_38.availableViews){this._availableViewsLookup={};_1.forEach(_38.availableViews,_3.hitch(this,function(_3d){this._availableViewsLookup[_3d.key]=_3d;}));}_3c=_38.viewName;}this.toolbar.update({currentContext:ctx,viewConfigurations:{availableViews:_38.availableViews,viewName:_38.viewName}});if(this._currentViewComponent&&this._currentViewComponent.isSticky){_3c=this._currentViewModel.viewName;}var _3e=this._getPreviewUrl(ctx,_3c);return this._ensurePreviewReady(this._loadContentDataAndSetView(ctx.id,_3c,ctx),true,_38.forceReload,_3c);}}));},_getPreviewUrl:function(_3f){return _8(this.getCurrentContext(),function(_40){return (_3f==="view"&&_40.previewUrl)?_40.previewUrl:_40.editablePreviewUrl;});},_ensurePreviewReady:function(_41,_42,_43,_44){var def=new _6();if(_41){def=_41;}else{def.resolve();}if(_42&&_44!=="formedit"){def=def.then(_3.hitch(this,function(_45){return _8(this._getPreviewUrl(_44),_3.hitch(this,function(url){return _8(this._changeUrl(url,_43),function(){return _45;});}));}));}this._ensurePreviewReadyPromise=_8(def,_3.hitch(this,function(_46){var doc=this.iframeWithOverlay.iframe.getDocument();var _47=this.connect(this._currentViewComponent,"onPrepareOverlayComplete",function(){this.disconnect(_47);_47=null;this.iframeWithOverlay.overlay.set("enabled",this._currentViewModel.get("showOverlay")&&this.iframeWithOverlay.iframe.isInspectable());if(this._viewSettingsManager.get("enabled")&&this._viewSettingsManager.getSettingProperty("project")){this.iframeWithOverlay.overlay.set("enabled",false);}this.iframeWithOverlay.layout(true);});_5.set(this.domNode,"visibility","visible");this._viewSettingsManager.onPreviewReady(this.iframeWithOverlay);this._currentViewComponent.onPreviewReady(this._currentViewModel,doc,!!_46);this._viewSettingsNotification.set("value",{viewModel:this._currentViewModel,viewSetting:this._viewSettingsManager});}));return this._ensurePreviewReadyPromise;},_loadContentDataAndSetView:function(_48,_49,ctx){var def=new _6();_8(this._pageDataStore.refresh(_48),_3.hitch(this,function(_4a){if(!_4a){return;}if(this._currentViewModel&&this._currentViewModel.contentLink!==_48){this.notificationBar.clear();}this._currentViewModel=this._getViewModel(_4a.contentLink);if(!this._currentViewModel){this._currentViewModel=this._createViewModel(_4a,ctx);}else{this._updateContentViewModel(_4a,ctx.languageContext);}this._currentViewModel.set("viewLanguage",this._viewSettingsManager.get("enabled")?this._viewSettingsManager.getSettingProperty("viewlanguage"):null);this._refreshModel(_4a,ctx);_8(this.setView(_49),function(){def.resolve(true);},function(){def.cancel();});}),function(){def.reject();});return def;},_updateContentViewModel:function(_4b,_4c){this._currentViewModel.wakeUp();this._currentViewModel.set("contentData",_4b);this._currentViewModel.set("languageContext",_4c);},_refreshModel:function(_4d,_4e){var _4f=this._currentViewModel;if(_4f){this.toolbar.set("contentViewModel",_4f);this._inUseNotificationManager.updateCommandModel(_4f);this._editingCommands.set("model",_4f);this._shortcutNotification.set("value",_4f);this._projectNotification.set("value",_4f);this._editNotifications.update(_4d,_4e);}},itemChanged:function(id,_50){},setView:function(_51,_52){var def=new _6();if(_51==="onpageedit"&&(!this._currentViewModel.contentData.hasTemplate||!(_51 in this._availableViewsLookup))){_51="formedit";}if(_51&&!(_51 in this._availableViewsLookup)){return;}var _53=_3.hitch(this,function(){_8(this._setView(_51,_52),function(){def.resolve();},function(){def.cancel();});});var _54=_3.hitch(this,function(){_7.publish("/epi/cms/action/showerror");def.cancel();});_8(this._savePendingChanges(),_53,_54);return def;},_setView:function(_55,_56){var def=new _6(),_57=this._currentViewComponent,_58=_57&&_57.viewModel&&_57.viewModel.viewName===_55;var _59=_3.hitch(this,function(def){if(this.editLayoutContainer.leftOver&&!this._currentViewComponent.canHandleLeftOver){_8(this.editLayoutContainer.selectedChildWidget===this.editLayoutContainer.leftOver?this.editLayoutContainer.selectChild(this.iframeWithOverlay):null,_3.hitch(this,function(){this.editLayoutContainer.removeChild(this.editLayoutContainer.leftOver);this.editLayoutContainer.leftOver.destroyRecursive();this.editLayoutContainer.leftOver=null;}));}def.resolve();});_7.publish("/epi/shell/action/changeview/updatestate",{viewName:_55});if(_58){this._currentViewModel.viewName=_55;this.toolbar.set("contentViewModel",this._currentViewModel);_59(def);}else{this._destroyCurrentViewComponent();var _5a=this._availableViewsLookup[_55].viewType;require([_5a],_3.hitch(this,function(_5b){this._currentViewComponent=new _5b(_3.mixin({mainLayoutContainer:this.mainLayoutContainer,editLayoutContainer:this.editLayoutContainer,iframeWithOverlay:this.iframeWithOverlay,contextTypeName:this.contextTypeName,toolbar:this.toolbar},_56));this._currentViewComponentReloadRequireHandle=this.connect(this._currentViewComponent,"onReloadRequired",this._onViewRequireReload);this._currentViewComponent.startup();this._currentViewModel.viewName=_55;this.toolbar.set("contentViewModel",this._currentViewModel);_59(def);}));}return def;},_onViewRequireReload:function(){return this._ensurePreviewReady(null,true,true,this._currentViewModel.viewName);},resize:function(_5c){this.inherited(arguments);this.mainLayoutContainer.resize(_5c);},onShow:function(){this.iframeWithOverlay.overlay.set("enabled",true);this.iframeWithOverlay.overlay.set("readOnly",false);},onHide:function(){this.iframeWithOverlay.overlay.set("enabled",false);if(this._currentViewModel){this._currentViewModel.resetNotifications();}},_requestContextChangeByUrl:function(url,_5d,_5e,_5f,_60){var _61=new _e(url,_5f,_60),_62={url:_61.toString()},_63={sender:this,forceContextChange:_5d,suppressFailure:_5e,viewName:this._currentViewModel&&this._currentViewModel.viewName};_7.publish("/epi/shell/context/request",_62,_63);},_changeUrl:function(url,_64){var _65=_3.mixin(this._previewQueryParameters,this._viewSettingsManager.get("previewParams"));return this.iframeWithOverlay.iframe.load(url,{query:_65},true,_64);},_interceptRequestContext:function(_66,_67){if(!(_67&&_67.sender&&_67.sender===this)){return this._savePendingChanges();}else{var def=new _6();def.resolve();return def;}},_savePendingChanges:function(){if(this._saveDeferred&&!this._saveDeferred.isFulfilled()){return this._saveDeferred.promise;}else{this._saveDeferred=new _6();}if(this._currentViewModel&&this._currentViewModel.get("hasPendingChanges")){var _68=this._currentViewModel.watch("hasPendingChanges",_3.hitch(this,function(_69,_6a,_6b){if(!_6b){_68.remove();_68=null;this._saveDeferred.resolve();}}));this._currentViewModel.save();}else{this._saveDeferred.resolve();}return this._saveDeferred.promise;},savePendingChanges:function(){return this._savePendingChanges();},_injectCssRules:function(){this.iFrame.addCssRules(this.defaultEditCssRules);},_undoAction:function(){if(this.get("isActive")&&this._currentViewModel){this._currentViewModel.undo();}},_redoAction:function(){if(this.get("isActive")&&this._currentViewModel){this._currentViewModel.redo();}},_saveAction:function(){if(this.get("isActive")&&this._currentViewModel){this._currentViewModel.save();}},_setIsActiveAttr:function(_6c){this._set("isActive",_6c);if(_6c){this._currentViewModel&&this._currentViewModel.wakeUp();this._editNotifications.wakeUp();}else{this._viewModels.forEach(function(_6d){_6d.suspend();});this._editNotifications.suspend();}}});});