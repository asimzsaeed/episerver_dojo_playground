//>>built
require({cache:{"url:epi-cms/contentediting/editors/templates/ContentAreaEditor.html":"<div class=\"dijitInline\" tabindex=\"-1\" role=\"presentation\">\r\n    <div data-dojo-attach-point=\"treeNode\"></div>\r\n    <div data-dojo-attach-point=\"actionsContainer\" class=\"epi-content-area-actionscontainer\"></div>\r\n</div>\r\n"}});define("epi-cms/contentediting/editors/ContentAreaEditor",["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/dom-style","dojo/on","dojo/topic","dojo/when","dijit/registry","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_CssStateMixin","dijit/_WidgetsInTemplateMixin","epi/shell/dnd/Target","epi/shell/command/_CommandProviderMixin","./_ContentAreaTree","./_ContentAreaTreeModel","./_TextWithActionLinksMixin","epi-cms/_ContentContextMixin","epi-cms/contentediting/viewmodel/ContentAreaViewModel","epi/shell/widget/ContextMenu","epi/shell/widget/_ValueRequiredMixin","epi-cms/widget/overlay/Block","epi-cms/widget/command/CreateContentFromSelector","epi-cms/widget/_HasChildDialogMixin","epi-cms/contentediting/command/BlockRemove","epi-cms/contentediting/command/BlockEdit","epi-cms/contentediting/command/MoveToPrevious","epi-cms/contentediting/command/MoveToNext","epi-cms/contentediting/command/MoveOutsideGroup","epi-cms/contentediting/command/Personalize","epi-cms/contentediting/command/SelectDisplayOption","dojo/text!./templates/ContentAreaEditor.html","epi/i18n!epi/cms/nls/episerver.cms.contentediting.editors.contentarea"],function(_1,_2,_3,_4,on,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f,_20){return _1([_8,_9,_b,_a,_14,_11,_d,_17,_10],{baseClass:"epi-content-area-editor",res:_20,templateString:_1f,value:null,multiple:true,parent:null,overlayItem:null,model:null,intermediateChanges:true,editMode:"onpageedit",_preventOnBlur:false,_dndTarget:null,allowedTypes:null,restrictedTypes:null,constructor:function(){this.allowedDndTypes=[];},onChange:function(_21){},_handleModelChange:function(_22){this.validate();this.onChange(_22);},_onBlur:function(){if(this._preventOnBlur){return;}this.inherited(arguments);},focus:function(){if(this.tree&&this.model.get("value").length>0){this._focusManager.focus(this.tree.domNode);}else{this.textWithLinks.focus();}},postMixInProperties:function(){this.inherited(arguments);this.commands=this._commands||[new _19(),new _1e(),new _1d({category:null}),new _1c(),new _1a(),new _1b(),new _18()];this.own(this.model=this.model||new _12(),this.treeModel=this.treeModel||new _f({model:this.model}),this.model.watch("selectedItem",_2.hitch(this,function(_23,_24,_25){this.updateCommandModel(_25);})),on(this.model,"changed",_2.hitch(this,function(){if(!this._started||this._supressValueChanged){return;}this._set("value",this.model.get("value"));this._handleModelChange(this.value);})));},buildRendering:function(){this.inherited(arguments);this.contextMenu=new _13();this.contextMenu.addProvider(this);this.own(this.contextMenu);this.setupActionLinks(this.actionsContainer);this.own(this._dndTarget=new _c(this.actionsContainer,{accept:this.allowedDndTypes,reject:this.restrictedDndTypes,isSource:false,alwaysCopy:false,insertNodes:function(){}}));this.own(_3.after(this._dndTarget,"onDropData",_2.hitch(this,function(_26,_27,_28,_29){var _2a=_26[0].data;this.model.modify(_2.hitch(this,function(){this.model.addChild(_2a);}));if(!this.tree){this._createTree();}}),true));this.own(_3.after(this._dndTarget,"onDrop",_2.hitch(this,"focus")));},postCreate:function(){this.inherited(arguments);this.set("emptyMessage",_20.emptymessage);if(this.parent&&this.overlayItem){this.connect(this.parent,"onStartEdit",function(){this._selectFromOverlay(this.overlayItem.model);});}this.own(_5.subscribe("/dnd/start",_2.hitch(this,this._startDrag)));},startup:function(){if(this._started){return;}this.inherited(arguments);this.tree&&this.tree.startup();this.contextMenu.startup();},destroy:function(){this.tree&&this.tree.destroyRecursive();this.inherited(arguments);},isCreateLinkVisible:function(){return this.model.canCreateBlock(this.allowedTypes,this.restrictedTypes);},executeAction:function(_2b){if(_2b==="createnewblock"){this._preventOnBlur=true;this.validate(false);var _2c=new _16({creatingTypeIdentifier:"episerver.core.blockdata",createAsLocalAsset:true,autoPublish:true,allowedTypes:this.allowedTypes,restrictedTypes:this.restrictedTypes});_2c.set("model",{save:_2.hitch(this,function(_2d){this._preventOnBlur=false;var _2e=_2.clone(this.get("value"),true)||[];_2e.push(_2d);this.set("value",_2e);this.parent.set("editing",true);this.onChange(_2e);this.onBlur();}),cancel:_2.hitch(this,function(){this._preventOnBlur=false;this.onBlur();})});_2c.execute();}},isValid:function(_2f){return (this._preventOnBlur||!this.required||this.model.get("value").length>0);},_setReadOnlyAttr:function(_30){this._set("readOnly",_30);_4.set(this.actionsContainer,"display",_30?"none":"");if(this._source){this._source.isSource=!this.readOnly;}if(this.model){this.model.set("readOnly",_30);}this.tree&&this.tree.set("readOnly",_30);},_checkAcceptance:function(_31,_32){return this.readOnly?false:this._source.defaultCheckAcceptance(_31,_32);},_createTree:function(){this.tree=new _e({accept:this.allowedDndTypes,reject:this.restrictedDndTypes,contextMenu:this.contextMenu,model:this.treeModel,readOnly:this.readOnly}).placeAt(this.domNode,"first");this.tree.own(_3.after(this.tree.dndController,"onDndEnd",_2.hitch(this,"focus")));},_selectFromOverlay:function(_33){var _34=_33&&_33.selectedItem&&_33.selectedItem.serialize(),_35=this.model,_36=["root"];if(!_34){return;}if(_34.contentGroup){_35=_35.getChild({name:_34.contentGroup});_36.push(_35.id);}_35=_35.getChild(_34);if(!_35){return;}_36.push(_35.id);_35.set("selected",true);_35.set("ensurePersonalization",_33.selectedItem.ensurePersonalization);this.tree&&this.tree.set("path",_36);},_startDrag:function(_37,_38,_39){var _3a=_7.getEnclosingWidget(_38[0]);if(_3a.isInstanceOf(_15)&&this.parent.cancel){this.parent.set("isModified",false);this.parent.cancel();}},_setValueAttr:function(_3b){this.tree&&this.tree.destroyRecursive();this._set("value",_3b||[]);this._supressValueChanged=true;this.model.set("value",_3b);this._supressValueChanged=false;this._createTree();}});});