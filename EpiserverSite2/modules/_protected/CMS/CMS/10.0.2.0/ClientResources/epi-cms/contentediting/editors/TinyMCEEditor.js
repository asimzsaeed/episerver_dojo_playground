//>>built
require({cache:{"url:epi-cms/contentediting/editors/templates/TinyMCEEditor.html":"<div id=\"widget_${id}\">\r\n    <div style=\"display: inline-block\" data-dojo-attach-point=\"stateNode, tooltipNode\">\r\n        <textarea data-dojo-attach-point=\"editorFrame\" id=\"${id}_editorFrame\" style=\"border: none;\"></textarea>\r\n    </div>\r\n    <div data-dojo-attach-point=\"dndOverlay\" style=\"background: rgba(0, 0, 0, 0.01); position: absolute; left: 0; top: 0; right: 0; bottom: 0; display: none\"></div>\r\n</div>\r\n"}});define("epi-cms/contentediting/editors/TinyMCEEditor",["dojo/_base/config","dojo/_base/declare","dojo/_base/lang","dojo/_base/window","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/Deferred","dojo/keys","dojo/on","dojo/when","dojo/sniff","dojox/html/entities","dijit/_TemplatedMixin","dijit/focus","epi/routes","epi/shell/conversion/ObjectConverterRegistry","epi/shell/dnd/Target","epi/shell/layout/_LayoutWidget","epi/shell/TypeDescriptorManager","epi/shell/widget/_ValueRequiredMixin","epi-cms/widget/_DndStateMixin","epi-cms/widget/_HasChildDialogMixin","epi-cms/widget/_UserResizable","epi/shell/widget/dialog/Alert","dojo/text!./templates/TinyMCEEditor.html","epi/i18n!epi/cms/nls/tinymce","epi/i18n!epi/cms/nls/episerver.tinymce"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,on,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b){return _2([_12,_d,_16,_17,_14,_15],{baseClass:"epiTinyMCEEditor",width:null,height:null,value:null,intermediateChanges:true,templateString:_19,settings:null,dirtyCheckInterval:2000,autoResizable:false,isResized:false,tinymceRendered:null,dropTarget:null,readOnly:false,_fullScreenEditor:null,_dirtyCheckTimeout:null,_editorValue:null,postMixInProperties:function(){this.inherited(arguments);if(this.autoResizable){this.height=0;}this.tinymceRendered=new _8();},postCreate:function(){this.own(this.dropTarget=new _11(this.dndOverlay,{accept:this.allowedDndTypes,createItemOnDrop:false,readOnly:this.readOnly}));this.connect(this.dropTarget,"onDropData","onDropData");this.connect(this.dndOverlay,"onmousemove","_onOverlayMouseMove");this.inherited(arguments);},startup:function(){if(this._started){return;}this.inherited(arguments);if(!window.tinymce){require(["tinymce/tiny_mce_src"],_3.hitch(this,function(){var res=_3.mixin({},_1a,_1b);tinymce.addI18n({en:res});this._loadLegacyPlugins().then(_3.hitch(this,this._initTinyMCE));}));}else{this._initTinyMCE();}},destroy:function(){if(_b("trident")){this._refocus();}if(this._destroyed){return;}this._cancelDirtyCheckInterval();var ed=this.getEditor();if(ed&&ed.getParam("fullscreen_is_enabled")){var _1c=tinymce.get(ed.getParam("fullscreen_editor_id"));_1c.plugins.fullscreen.saveState(ed);}ed&&ed.remove();this.inherited(arguments);},_loadLegacyPlugins:function(){var dfd=new _8();this.legacyPlugins.forEach(function(_1d){var url=_f.getActionPath({moduleArea:"Util",path:"Editor/tinymce/plugins/"+_1d+"/"+(_1.isDebug?"editor_plugin_src.js":"editor_plugin.js")});tinymce.PluginManager.load(_1d,url);});tinymce.ScriptLoader.loadQueue(function(){dfd.resolve();});return dfd.promise;},canAccept:function(){return !_6.contains(this.dndOverlay,"dojoDndTargetDisabled");},_onDndStart:function(){_5.set(this.dndOverlay,"display","block");this.inherited(arguments);},_onDndCancel:function(){_5.set(this.dndOverlay,"display","none");this.inherited(arguments);},_onDndDrop:function(){_5.set(this.dndOverlay,"display","none");this.inherited(arguments);},_onOverlayMouseMove:function(evt){this._dragPosition={x:evt.pageX,y:evt.pageY};},onDropData:function(_1e,_1f,_20,_21){var _22=_1e?(_1e.length?_1e[0]:_1e):null;if(!_22){return;}if(this.onDropping){this.onDropping();}this._dropDataProcessor(_22);},_dropDataProcessor:function(_23){_a(_23.data,_3.hitch(this,function(_24){var _25=this,_26=_23.type,ed=this.getEditor();function _27(url){ed.focus();ed.execCommand("CreateLink",false,url);};function _28(_29){ed.focus();if(ed.execCommand("mceInsertContent",false,_29)){_25._onChange(ed.getContent());}};function _2a(_2b){if(!ed.selection.isCollapsed()){_27(_2b.url);}else{var _2c="<a href=\"{0}\" title=\"{1}\">{1}</a>";_28(_3.replace(_2c,[_2b.url,_c.encode(_2b.text)]));}};function _2d(_2e){var _2f="<img alt=\"{alt}\" src=\"{src}\" width=\"{width}\" height=\"{height}\" />";var _30=_2e.previewUrl||_2e.url;var _31=_7.create("img",{src:_30,style:{display:"none;"}},_4.body(),"last");on.once(_31,"load",function(){_28(_3.replace(_2f,{alt:this.alt,width:this.width,height:this.height,src:_30}));_7.destroy(_31);});};if(_26&&_26.indexOf("link")!==-1){_2a(_24);return;}else{if(_26&&_26.indexOf("fileurl")!==-1){_2d(_24);return;}}var _32=_24.typeIdentifier;var _33=_13.getValue(_32,"editorDropBehaviour");if(_33){if(_33===1){var _34="<div data-contentlink=\""+_24.contentLink+"\" data-classid=\"36f4349b-8093-492b-b616-05d8964e4c89\" class=\"mceNonEditable epi-contentfragment\">"+_24.name+"</div>";_28(_34);return;}var _35,_36=_13.getInheritanceChain(_32);for(var i=0;i<_36.length;i++){var _37=_36[i];_35=_10.getConverter(_37,_37+".link");if(_35){break;}}if(!_35){return;}_a(_35.convert(_32,_32+".link",_24),_3.hitch(this,function(_38){if(!_38.url){var _39=new _18({description:_1b.notabletocreatelinkforpage});_39.show();this.own(_39);}else{switch(_33){case 2:_2a(_38);break;case 3:_2d(_38);break;}}}));}}));_5.set(this.dndOverlay,{display:"none"});},_onFocus:function(){this.inherited(arguments);this.focus();},focus:function(){var ed=this.getEditor();if(ed){_a(this.tinymceRendered,_3.hitch(this,function(){_e.focus(ed.contentWindow.frameElement);ed.focus();}));}},getEditor:function(){if(typeof tinymce==="undefined"||tinymce===null){return null;}var ed=this._fullScreenEditor;if(ed&&ed.id==="mce_fullscreen"){return ed;}return tinymce.get(this.editorFrame.id);},getEditorDOM:function(){return (typeof tinymce!=="undefined"&&tinymce!==null)?tinymce.DOM:null;},resizeEditor:function(){var ed=this.getEditor(),_3a=0,_3b=(tinymce.isIE?document.body.clientHeight:window.innerHeight)-200,_3c=(tinymce.isIE?document.body.clientWidth:window.innerWidth)-200,d=ed.getDoc(),b=d.body,DOM=tinymce.DOM,_3d=this.height,_3e=this.width,_3f,_40;_3f=b.scrollHeight;_40=b.scrollWidth;if(_3f>_3a){_3d=_3f;}if(_3f>_3b){_3d=_3b;}if(_40>_3c){_3e=_3c;}DOM.setStyle(ed.contentWindow.frameElement,"height",_3d+80+"px");if(ed.getBody().scrollWidth!==ed.getBody().offsetWidth){var _41=20;if(_3d===_3b){_41=30;}DOM.setStyle(ed.contentWindow.frameElement,"width",ed.getBody().scrollWidth+_41+"px");}this.isResized=true;},_setValueAttr:function(_42){var ed=this.getEditor(),_43=_42||"";this._set("value",_42);if(ed&&ed.initialized){ed.setContent(_43);}else{this.editorFrame.value=_43;}},_updateTinySettings:function(){this.settings=_3.mixin(this.settings,{mode:"exact",width:this.width,height:this.height,relative_urls:false,elements:this.editorFrame.id,readonly:this.readOnly});},_initTinyMCE:function(){this._updateTinySettings();if(this.legacyPlugins&&this.legacyPlugins.length>0){this.settings.plugins=this.settings.plugins+","+this.legacyPlugins.join(",");}if(typeof tinymce!=="undefined"){tinymce.dom.Event.domLoaded=true;this._setupHandle=tinymce.onAddEditor.add(_3.hitch(this,this._onAddEditor));tinymce.init(this.settings);}else{console.error("Couldn't initialize the editor");}},_isFullScreen:function(ed){return ed.editorId==="mce_fullscreen";},_onAddEditor:function(_44,ed){if(this.editorFrame&&ed.id===this.editorFrame.id){this._setupEditorEventHandling(_44,ed);}else{if(this.editorFrame&&ed.settings.fullscreen_editor_id===this.editorFrame.id){this._setupEditorEventHandling(_44,ed);this._fullScreenEditor=ed;}}},_handlePopupWindow:function(ed){ed.windowManager.onOpen.add(_3.hitch(this,function(){this.isShowingChildDialog=true;}));var _45=_3.hitch(this,function(){this.focus();this.isShowingChildDialog=this._isFullScreen(ed);if(!this.isShowingChildDialog){this._onChange(ed.getContent());}});ed.windowManager.onClose.add(_3.hitch(this,function(){setTimeout(_45);}));},_handlePopupMenu:function(ed){var _46;for(var i in ed.controlManager.controls){_46=ed.controlManager.controls[i];if(_46.onRenderMenu){_46.onRenderMenu.add(_3.hitch(this,function(_47,_48){_48.onShowMenu.add(_3.hitch(this,function(){this.isShowingChildDialog=true;}));_48.onHideMenu.add(_3.hitch(this,function(){this.isShowingChildDialog=this._isFullScreen(ed);}));}));}}},_setupEditorEventHandling:function(_49,ed){ed.onInit.add(_3.hitch(this,function(){!this.tinymceRendered.isResolved()&&this.tinymceRendered.resolve();this.own(_e.registerIframe(ed.contentWindow.frameElement));this._handlePopupMenu(ed);this._handlePopupWindow(ed);if(this.autoResizable){setTimeout(_3.hitch(this,this.resizeEditor),200);}else{this.set("isResized",true);}this._startDirtyCheckInterval();if(ed&&ed.selection){ed.selection.onSetContent.add(_3.hitch(this,function(_4a,_4b){var _4c=_4b.set;if(_4c){this._onChange(ed.getContent());}}));}}));ed.onChange.add(_3.hitch(this,function(ed,e){this._onChange(ed.getContent());}));ed.onSetContent.add(_3.hitch(this,"onSetContent"));ed.onRemove.add(_3.hitch(this,"onEditorRemoved"));ed.onRedo.add(_3.hitch(this,"onRedo"));ed.onUndo.add(_3.hitch(this,"onUndo"));ed.onBeforeExecCommand.add(_3.hitch(this,function(ed,cmd,ui,val,a){this._onChange(ed.getContent());if(cmd==="mceFullScreen"&&ed.id!=="mce_fullscreen"){this.isShowingChildDialog=!this._isFullScreen(ed);}else{if(cmd==="mceFullScreen"&&ed.id==="mce_fullscreen"){this._fullScreenEditor=null;}}}));},onSetContent:function(ed,e){var _4d=ed.getContent(),_4e=this.get("_editorValue")!==_4d;e.initial&&this.set("_editorValue",_4d);if(_4e){this.validate();this.onLayoutChanged();}},onEditorRemoved:function(ed){},_isMetaKey:function(e){if(e.keyCode===_9.CTRL||e.keyCode===_9.ALT||e.keyCode===_9.SHIFT||e.keyCode===_9.META){return true;}return false;},_onChange:function(val){var _4f=this.get("_editorValue")!==val;if(_4f){this._set("value",val);this.set("_editorValue",val);if(this.validate()){this.onChange(val);}}},onChange:function(val){},_stopEditing:function(){var ed=this.getEditor(),val=ed.getContent();this.displayMessage(null);if(ed&&ed.undoManager&&ed.undoManager.typing){ed.undoManager.typing=0;ed.undoManager.add();}this._onChange(val);},_onBlur:function(){this._stopEditing();this.inherited(arguments);},_cancelDirtyCheckInterval:function(){if(this._dirtyCheckTimeout){clearTimeout(this._dirtyCheckTimeout);this._dirtyCheckTimeout=null;}},_startDirtyCheckInterval:function(){if(this._destroyed||!this.intermediateChanges){return;}this._cancelDirtyCheckInterval();this._dirtyCheck();this._dirtyCheckTimeout=setTimeout(_3.hitch(this,this._startDirtyCheckInterval),this.dirtyCheckInterval);},_dirtyCheck:function(){var ed=this.getEditor();var _50=_3.getObject("plugins.spellchecker.active",false,ed)||false;if(ed&&!_50){this._onChange(ed.getContent());}},onRedo:function(ed,_51){},onUndo:function(ed,_52){},_refocus:function(){var _53=document.activeElement;var _54=document.createElement("input");_54.type="text";_54.style.position="absolute";_54.style.left="-9000px";_54.style.height="0";_54.style.width="0";document.getElementsByTagName("body")[0].appendChild(_54);_54.focus();if(_53){_53.focus();}else{_54.blur();}_54.parentNode.removeChild(_54);_54=_53=null;}});});