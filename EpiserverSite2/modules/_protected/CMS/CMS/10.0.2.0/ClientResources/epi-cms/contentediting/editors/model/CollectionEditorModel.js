//>>built
define("epi-cms/contentediting/editors/model/CollectionEditorModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/Deferred","dojo/Evented","dojo/Stateful","dojo/when","dojo/promise/all","dijit/Destroyable","dojox/mvc/StatefulArray","epi/dependency","epi/string","epi/shell/command/DelegateCommand","epi-cms/contentediting/editors/model/CollectionEditorItemModel","epi-cms/dgrid/formatters","epi/i18n!epi/nls/episerver.shared"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11){var _12={none:0,add:1,edit:2,remove:4,moveUp:8,moveDown:16};var _13=_2([_7,_6,_a],{data:null,itemType:null,itemModelType:null,itemMetadata:null,metadataManager:null,availableCommands:null,_itemModels:null,_itemsUnchanged:false,postscript:function(){this.inherited(arguments);this.metadataManager=this.metadataManager||_c.resolve("epi.shell.MetadataManager");this.itemModelType=this.itemModelType||_f;},initialize:function(){return _8(this.metadataManager.getMetadataForType(this.itemType),_3.hitch(this,function(_14){this.set("itemMetadata",_14);return this._initData();}));},_initData:function(){this._itemModels=new _b([]);_4.before(this._itemModels,"sort",_3.hitch(this,function(){this._itemsUnchanged=true;},true));this.own(this._itemModels.watchElements(_3.hitch(this,function(){if(!this._itemsUnchanged){this.emit("itemsChanged",this.get("items"));}this._itemsUnchanged=false;})));var _15=_1.map(this.data,function(_16){var _17=new this.itemModelType();return _8(_17.fromItemData(_16,this.itemType),function(){return _17;});},this);return _8(_9(_15),_3.hitch(this,function(_18){this._itemModels.splice.apply(this._itemModels,[0,this._itemModels.length].concat(_18));}));},getListCommands:function(_19){return [new _e({name:"add",tooltip:_11.action.add,iconClass:"epi-iconPlus",canExecute:true,isAvailable:this._commandIsAvailable(_12.add,_19),delegate:_3.hitch(this,this.addItemDelegate)})];},getItemCommands:function(_1a,_1b,_1c){return [new _e({name:"edit",category:_1c,label:_11.action.edit,iconClass:"epi-iconPen",model:_1a,canExecute:true,isAvailable:this._commandIsAvailable(_12.edit,_1b),delegate:_3.hitch(this,this.editItemDelegate)}),new _e({name:"moveUp",category:_1c,label:_11.action.moveup,iconClass:"epi-iconUp",model:_1a,canExecute:this._itemModels.indexOf(_1a)>0,isAvailable:this._commandIsAvailable(_12.moveUp,_1b),delegate:_3.hitch(this,this.moveItemUpDelegate)}),new _e({name:"moveDown",category:_1c,label:_11.action.movedown,iconClass:"epi-iconDown",model:_1a,canExecute:this._itemModels.indexOf(_1a)<this._itemModels.length-1,isAvailable:this._commandIsAvailable(_12.moveDown,_1b),delegate:_3.hitch(this,this.moveItemDownDelegate)}),new _e({name:"remove",category:_1c,label:_11.action.remove,iconClass:"epi-iconTrash",model:_1a,canExecute:true,isAvailable:this._commandIsAvailable(_12.remove,_1b),delegate:_3.hitch(this,this.removeItemDelegate)})];},_commandIsAvailable:function(_1d,_1e){_1e=_1e||this.availableCommands;return !!(_1d&_1e);},generateColumnsDefinition:function(_1f){var _20={};_1.forEach(_1.filter(this.itemMetadata.properties,function(_21){return _1.every(_1f,function(col){return col!==_21.name;});}),function(_22){var _23=_d.pascalToCamel(_22.name);_20[_23]={label:_22.displayName||_22.name};});return _20;},generateFormatters:function(_24){for(var _25 in _24){_1.some(this.itemMetadata.properties,function(_26){if(_25===_d.pascalToCamel(_26.name)){this._setTypeFormatter(_26,_24[_25]);this._setSelectionFactoryFormatter(_26,_24[_25]);this._setWrappingFormatter(_24[_25]);return true;}},this);}return _24;},_typeFormatterMap:{"System.DateTime":_10.localizedDate,"System.Boolean":_10.friendlyBoolean},_wrappingFormatterMap:{SecondaryText:function(_27){if(_27){return function(_28){return _10.secondaryText(_27(_28),true);};}return function(_29){return _10.secondaryText(_29);};},VisibleLink:function(_2a){if(_2a){return function(_2b){return _10.visibleLink(_2a(_2b),true);};}return function(_2c){return _10.visibleLink(_2c);};}},_setTypeFormatter:function(_2d,_2e){for(var _2f in this._typeFormatterMap){if(_2d.modelType.indexOf(_2f)>-1){_2e.formatter=this._typeFormatterMap[_2f];break;}}},_setSelectionFactoryFormatter:function(_30,_31){if(_30.selections&&_30.selections.length>0){var _32=_30.selections;if(_31){_31.formatter=function(_33){var _34=_33;_32.forEach(function(_35){if(_35.value===_33){_34=_35.text;}});return _34;};}}},_setWrappingFormatter:function(_36){if(_36.wrappingFormatter&&this._wrappingFormatterMap[_36.wrappingFormatter]){_36.formatter=this._wrappingFormatterMap[_36.wrappingFormatter](_36.formatter);}},addItemDelegate:function(){this.emit("toggleItemEditor",null);},editItemDelegate:function(cmd){if(this._commandIsAvailable(_12.edit,this.availableCommands)){var _37=cmd.model;var _38=this._itemModels.indexOf(_37);this.emit("toggleItemEditor",_37,_38);}},removeItemDelegate:function(cmd){this.removeItem(cmd.model);},moveItemUpDelegate:function(cmd){var _39=cmd.model;var _3a=this._itemModels.indexOf(_39);var _3b=_3a-1;if(_3b>=0){this.moveItem(_39,this._itemModels[_3b],true);}},moveItemDownDelegate:function(cmd){var _3c=cmd.model;var _3d=this._itemModels.indexOf(_3c);var _3e=_3d+1;if(_3e<this._itemModels.length){this.moveItem(_3c,this._itemModels[_3e],false);}},saveItem:function(_3f,_40){var _41=new this.itemModelType();return _8(_41.fromItemData(_3f,this.itemType),_3.hitch(this,function(){this._itemModels.splice(_40,1,_41);}));},addItem:function(_42,_43,_44){var _45=new this.itemModelType();return _8(_45.fromItemData(_42,this.itemType),_3.hitch(this,function(){var _46;if(!_43){_46=this._itemModels.length;}else{_46=this._itemModels.indexOf(_43);if(!_44){_46++;}}this._itemModels.splice(_46,0,_45);}));},moveItem:function(_47,_48,_49){this._itemsUnchanged=true;var _4a=this._itemModels.indexOf(_47);this._itemModels.splice(_4a,1);var _4b=this._itemModels.indexOf(_48);var _4c=_49?_4b:_4b+1;_4c=_4b===-1?_4a:_4c;this._itemModels.splice(_4c,0,_47);},removeItem:function(_4d){var _4e=this._itemModels.indexOf(_4d);this._itemModels.splice(_4e,1);},_dataSetter:function(_4f){this.data=_4f;this._initData();},_dataGetter:function(){return _1.map(this._itemModels,function(_50){return _50.toItemData();},this);},_itemsGetter:function(){return this._itemModels;}});_13.commandMask=_12;return _13;});