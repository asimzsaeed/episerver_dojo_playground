//>>built
define("epi-cms/contentediting/viewmodel/ContentBlockViewModel",["dojo/_base/declare","dojo/_base/lang","dojo/when","dojo/promise/all","dojox/html/entities","epi","epi/dependency","./_ViewModelMixin","epi-cms/widget/viewmodel/ContentStatusViewModel","epi/i18n!epi/cms/nls/episerver.cms.contentediting.editors.contentarea.personalize"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _1([_9,_8],{label:null,store:null,hasSiblings:true,isVisible:true,settings:{displayOptionsAttributeName:"data-epi-content-display-option",contentGroupAttributeName:"data-contentgroup"},roles:null,constructor:function(){this.roleIdentities=this.roleIdentities||[];this.attributes={};},postscript:function(){this.inherited(arguments);if(!this.store){var _b=_7.resolve("epi.storeregistry");this.store=_b.get("epi.cms.visitorgroup");}this.set("label",this.name);this._reloadRoles();},serialize:function(){return {contentGroup:this.contentGroup,contentLink:this.contentLink,name:this.name,roleIdentities:this.roleIdentities,typeIdentifier:this.typeIdentifier,attributes:this.attributes};},equals:function(_c){for(var _d in _c){if(!_6.areEqual(this[_d],_c[_d])){return false;}}return true;},isRoleSelected:function(_e){if(!this.roleIdentities){return false;}return this.roleIdentities.indexOf(_e)>-1;},hasAnyRoles:function(){if(!this.roleIdentities){return false;}return this.roleIdentities.length>0;},moveNext:function(){var _f=this.parent.indexOf(this);this.parent.modify(function(){this.parent.move(this,_f+1);},this);},movePrevious:function(){var _10=this.parent.indexOf(this);this.parent.modify(function(){this.parent.move(this,_10-1);},this);},moveOutsideGroup:function(){if(!this.contentGroup){return;}this.parent.modify(function(){this.parent.moveOutsideGroup(this);},this);},remove:function(){this.parent.modify(function(){this.parent.removeChild(this);},this);},personalize:function(){this.parent.modify(function(){this.parent.personalize(this);},this);},selectRole:function(_11,_12){var _13=(this.roles||[]).map(function(_14){return _14.id;});var _15=_13.indexOf(_11);if(_15>=0){if(!_12){_13.splice(_15,1);}}else{if(_12){_13.push(_11);}}this.set("roleIdentities",_13);},resetRoleIdentities:function(){this.set("visible",true);this.set("roleIdentities",null);},_displayOptionSetter:function(_16){this.attributes[this.settings.displayOptionsAttributeName]=_16;},_displayOptionGetter:function(){return this.attributes[this.settings.displayOptionsAttributeName];},_roleIdentitiesSetter:function(_17){this.roleIdentities=_17||[];this._reloadRoles();},_parentSetter:function(_18){this.parent=_18;this.set("contentGroup",this.parent.name);},_contentGroupSetter:function(_19){if(_19===undefined){_19="";}this.contentGroup=_19;this.attributes[this.settings.contentGroupAttributeName]=_19;this._reloadRoles();},_reloadRoles:function(){var _1a=this.store;if(!_1a){return;}var _1b=_4(this.roleIdentities.map(function(id){return _3(_1a.get(id)).otherwise(function(){console.warn("Could not load visitor group with id: "+id);});}));_1b.then(_2.hitch(this,"set","roles"));return _1b;},_hasSiblingsSetter:function(_1c){this.hasSiblings=_1c;this._updateRolesString();},_selectedSetter:function(_1d){this.selected=_1d;if(_1d){this.emit("selected",this);}},_updateRolesString:function(){if(!this.contentGroup||this.roles===null){this.set("rolesString","");return;}if(!this.hasAnyRoles()){if(this.hasSiblings){this.set("rolesString",_a.everyoneelsesee);}else{this.set("rolesString",_a.everyonesees);}return;}if(!this.roles.length){this.set("rolesString",_a.groupcannotsees);return;}var _1e=this.roles.map(function(r){return "<em>"+_5.encode(r.name)+"</em>";}).sort().join(", ");var _1f=_1e.replace(/, (?=[^,]+$)/," "+_a.groupsand);var _20="";if(this.roles.length>1){_20=_2.replace(_a.groupssee,{groupNames:_1f});}else{_20=_2.replace(_a.groupsees,{groupName:_1f});}this.set("rolesString",_20);},_rolesSetter:function(_21){this.roles=_21.filter(function(_22){return !!_22;});this._updateRolesString();}});});