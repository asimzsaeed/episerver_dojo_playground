//>>built
define("epi-cms/contentediting/viewmodel/CreateContentViewModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/_base/json","dojo/Stateful","dojo/string","dojo/when","dojo/Evented","epi/dependency","epi/shell/TypeDescriptorManager","epi-cms/core/ContentReference","epi-cms/contentediting/ContentEditingValidator","epi/i18n!epi/shell/ui/nls/episerver.shared.messages","epi/i18n!epi/cms/nls/episerver.cms.components.requiredproperties"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){return _2([_5,_8],{_topLevelContainerType:"epi/shell/layout/SimpleContainer",_groupContainerType:"epi-cms/layout/CreateContentGroupContainer",contentDataStore:null,metadataManager:null,typeIdentifierManager:null,validator:null,parent:null,contentTypeId:null,requestedType:null,createAsLocalAsset:null,autoPublish:false,addToDestination:null,wizardStep:0,startWizardStep:0,contentName:null,ignoreDefaultNameWarning:null,properties:null,headingText:null,contentNameHelpText:"",createAsLocalAssetHelpText:null,namePanelIsVisible:null,headingPanelIsVisible:null,seamlessTopPanel:null,saveButtonIsVisible:null,saveButtonDisabled:null,showAllProperties:null,showCurrentNodeOnBreadcrumb:null,actualParentLink:null,metadata:null,postscript:function(){this.inherited(arguments);if(!this.contentDataStore){var _f=_9.resolve("epi.storeregistry");this.contentDataStore=_f.get("epi.cms.contentdata");}this.metadataManager=this.metadataManager||_9.resolve("epi.shell.MetadataManager");this.projectService=this.projectService||_9.resolve("epi.cms.ProjectService");this.validator=this.validator||new _c({contextTypeName:"epi.cms.contentdata"});this.set("propertyFilter",_3.hitch(this,this._propertyFilter));},update:function(_10){this.set("ignoreDefaultNameWarning",false);this.set("properties",null);this.set("saveButtonIsVisible",false);this.set("wizardStep",this.startWizardStep);this.set("isContentTypeSelected",false);this.set("namePanelIsVisible",true);this.set("headingPanelIsVisible",true);this.set("showCurrentNodeOnBreadcrumb",true);this.set("seamlessTopPanel",true);if(_10){_1.forEach(["allowedTypes","restrictedTypes","requestedType","parent","createAsLocalAsset","autoPublish","addToDestination","contentTypeId"],function(_11){this.set(_11,_10[_11]);},this);}if(this.parent){var _12=this.parent.contentLink+"_new_content";this.validator.clearErrorsBySource();this.validator.setContextId(_12);this.set("notificationContext",{contextTypeName:"epi.cms.contentdata",contextId:_12});}},save:function(){this.set("saveButtonDisabled",true);if(!this.ignoreDefaultNameWarning&&(!this.contentName||this.contentName===""||this.contentName===this.defaultName)){var _13=this.contentName;if(this.metadata&&this.metadata.additionalValues&&this.metadata.additionalValues.modelTypeIdentifier){_13=_a.getResourceValue(this.metadata.additionalValues.modelTypeIdentifier,"newitemdefaultname");}this._emitSaveEvent("invalidContentName",_13);return;}this.validator.clearErrorsBySource(this.validator.validationSource.server);_7(this.validator.validate(),_3.hitch(this,function(_14){if(_14){this._emitSaveEvent("validationError");return;}var _15=this.buildContentObject();this.projectService.getCurrentProjectId().then(function(_16){_15.autoPublish=_15.autoPublish&&!_16;this.contentDataStore.put(_15).then(_3.hitch(this,this._saveSuccessHandler),_3.hitch(this,this._saveErrorHandler));}.bind(this));}),_3.hitch(this,function(){this._emitSaveEvent("validationError");}));},_emitSaveEvent:function(_17,_18){this.set("saveButtonDisabled",false);this.emit(_17,_18);},cancel:function(){this.addToDestination&&(typeof this.addToDestination.cancel==="function")&&this.addToDestination.cancel();},_propertyFilter:function(_19,_1a){var _1b=_1a.originalGroupName!=="EPiServerCMS_SettingsPanel"&&_1a.originalGroupName!=="Advanced";var _1c=this._isRequiredProperty(_19,_1a);if(this.showAllProperties){return _1b||_1c;}else{return _1c;}},_saveSuccessHandler:function(_1d){var ref=new _b(_1d),_1e=ref.createVersionUnspecificReference(),_1f=_3.hitch(this,function(_20){this._emitSaveEvent("saveSuccess",{newContentLink:_20,changeContext:true});});_7(this.contentDataStore.refresh(_1d),_3.hitch(this,function(_21){if(this.addToDestination){this.addToDestination.save({contentLink:_1e.toString(),name:_21.name,typeIdentifier:this.requestedType});this._emitSaveEvent("saveSuccess",{changeContext:false});}else{_1f(_1e.toString());}}));},_saveErrorHandler:function(err){if(err&&err.responseText){var _22=_4.fromJson(err.responseText);_1.forEach(_22,function(_23){if(_23.propertyName){this.validator.setPropertyErrors(_23.propertyName,[{severity:_23.severity,errorMessage:_23.errorMessage}],this.validator.validationSource.server);}else{this.validator.setGlobalErrors([{severity:_23.severity,errorMessage:_23.errorMessage}],this.validator.validationSource.server);}},this);}else{if(err){this.validator.setGlobalErrors([{severity:this.validator.severity.error,errorMessage:err.message}],this.validator.validationSource.server);}}this._emitSaveEvent("saveError",err);},buildContentObject:function(){return {name:_6.trim(this.contentName+""),parentLink:this._getParentLink(),contentTypeId:this.contentTypeId,properties:this.properties,createAsLocalAsset:this.createAsLocalAsset,autoPublish:this.autoPublish};},addInvalidProperty:function(_24,_25){this.validator.setPropertyErrors(_24,[{severity:this.validator.severity.error,errorMessage:_25}],this.validator.validationSource.client);},removeInvalidProperty:function(_26){this.validator.clearPropertyErrors(_26);},_contentTypeIdSetter:function(_27){this.contentTypeId=_27;if(_27&&this.parent){this.set("isContentTypeSelected",true);this.validator.clearErrorsBySource(this.validator.validationSource.server);_7(this._getMetadata(this.parent.contentLink,_27),_3.hitch(this,function(_28){_28=this._regroupProperties(_28);this.set("metadata",_28);if(this.autoPublish||this._hasRequiredProperties(_28)){this.set("wizardStep",1);this.set("saveButtonIsVisible",true);}else{this.save();}}),_3.hitch(this,function(){this.set("isContentTypeSelected",false);this.validator.setGlobalErrors([{severity:this.validator.severity.error,errorMessage:_d.unexpectederror}],this.validator.validationSource.server);}));}},_createAsLocalAssetSetter:function(_29){this.createAsLocalAsset=_29;if(this.parent){this.set("actualParentLink",this._getParentLink());}},_autoPublishSetter:function(_2a){this.set("showAllProperties",_2a);this.autoPublish=_2a;},_parentSetter:function(_2b){this.parent=_2b;var _2c=this.parent.typeIdentifier,_2d=_a.getResourceValue(this.requestedType,"name"),_2e=_a.getResourceValue(_2c,"name"),_2f=_a.getResourceValue(_2c,"createaslocalassethelptext");if(_2d&&_2e){_2f=_3.replace(_2f,[_2d.toLowerCase(),_2e.toLowerCase()]);}this.set("createAsLocalAssetHelpText",_2f);},_requestedTypeSetter:function(_30){var _31=_a.getResourceValue(_30,"create"),_32=_a.getResourceValue(_30,"newitemdefaultname");this.defaultName=_32;this.set("headingText",_31);this.set("contentName",_32);this.requestedType=_30;},_getParentLink:function(){if(!this.parent){return null;}if(this.createAsLocalAsset){return this.parent.ownerContentLink?this.parent.ownerContentLink:this.parent.contentLink;}return this.parent.contentLink;},_hasRequiredProperties:function(_33){return _1.some(_33.properties,function(_34){return this._isRequiredProperty(_33,_34);},this);},_isRequired:function(_35){return _35.settings&&_35.settings.required;},_isRequiredProperty:function(_36,_37){var _38=!_37.additionalValues.hasValue;var _39=_37.showForEdit&&_1.every(_36.groups,function(_3a){return (_3a.name!==_37.groupName&&_3a.name!==_37.originalGroupName)||_3a.displayUI;});var _3b=_1.some(_37.properties,function(_3c){return this._isRequiredProperty(_37,_3c);},this);return (this._isRequired(_37)||_3b)&&_38&&_39&&(_37.name!=="icontent_name");},_regroupProperties:function(_3d){_3d=_3.clone(_3d);_3d.layoutType=this._topLevelContainerType;_1.forEach(_3d.properties,function(_3e){var _3f=this._isRequiredProperty(_3d,_3e);_3e.originalGroupName=_3e.groupName;_3e.groupName=_3f?"required":"additional";},this);_3d.groups=[{name:"required",displayUI:true,title:_e.groups.required,uiType:this._groupContainerType},{name:"additional",displayUI:true,title:_e.groups.additional,uiType:this._groupContainerType}];return _3d;},_getMetadata:function(_40,_41){return this.metadataManager.getMetadataForType("EPiServer.Core.ContentData",{parentLink:_40,contentTypeId:_41});}});});