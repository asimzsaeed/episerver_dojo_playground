//>>built
define("epi-cms/contentediting/viewmodel/PublishMenuViewModel",["dojo/_base/declare","dojo/_base/lang","dojo/when","dojo/Deferred","dojox/html/entities","epi","epi/datetime","epi/dependency","epi/username","epi-cms/contentediting/ContentActionSupport","epi-cms/contentediting/viewmodel/_ContentViewModelObserver","epi/shell/command/_CommandConsumerMixin","epi/shell/command/_GlobalCommandProviderMixin","epi/i18n!epi/cms/nls/episerver.cms.contentediting.editactionpanel.publishactionmenu"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){return _1([_b,_c,_d],{commandKey:"epi.cms.publishmenu",contentActionSupport:null,inUseNotificationManager:null,_currentUser:null,commands:null,mainButtonCommand:null,lastExecutedCommand:null,mainButtonSectionVisible:null,lastChangeStatus:null,topInfoSectionVisible:null,publishInfoSectionVisible:null,lastPublishedText:null,lastPublishedViewLinkVisible:null,lastPublishedViewLinkHref:null,additionalInfoSectionVisible:null,additionalInfoText:null,isOpen:null,typeIdentifier:null,postscript:function(){this.inherited(arguments);this.res=this.res||_e;this.projectService=this.projectService||_8.resolve("epi.cms.ProjectService");this.contentActionSupport=this.contentActionSupport||_a;this.initializeCommandProviders();},_setDataModelAttr:function(_f){this.updateCommandModel(_f);this.inherited(arguments);},_setIsOpenAttr:function(_10){if(_10){this._setLastChangeStatus(this.dataModel.contentData);}},onDataModelChange:function(_11,_12,_13){var _14=this.dataModel.contentData,_15=(_14.publishedBy!==null&&_14.publishedBy!==undefined);this._updateCommands();this._setLastChangeStatus(this.dataModel.contentData);this.set("topInfoSectionVisible",this._getTopInfoSectionVisible(_14));this.set("publishInfoSectionVisible",this._getPublishInfoSectionVisible(_14));this.set("lastPublishedTitle",this._getLastPublishedTitle(_14));this.set("lastPublishedTitleVisible",_15);this.set("lastPublishedText",this._getLastPublishedText(_14));this.set("lastPublishedViewLinkVisible",this._getLastPublishedViewLinkVisible(_14,_15));this.set("lastPublishedViewLinkHref",_14.publicUrl);this.set("typeIdentifier",_14.typeIdentifier);this._setAdditionalInfo(_14);},_lastChangeStatusSetter:function(_16){this.lastChangeStatus=_16;return _3(_16);},_updateCommands:function(){var _17=this.getCommands(),_18=null;_17.forEach(function(_19){if(_19.canExecute&&_19.options&&_19.options.isMain&&_19.options.priority&&(!_18||_18.options.priority<_19.options.priority)){_18=_19;}});this.set("mainButtonCommand",_18);this.set("commands",_17);this.set("mainButtonSectionVisible",_18!==null);},_getTopInfoSectionVisible:function(_1a){return this.mainButtonCommand||!((_1a.status===_a.versionStatus.Published||_1a.status===_a.versionStatus.Expired)&&!_1a.isCommonDraft);},_getPublishInfoSectionVisible:function(_1b){var _1c=this.inUseNotificationManager.hasInUseNotificationWarning(_1b.inUseNotifications),_1d=this._isOriginallyEditable();return !(_1c&&_1d);},_getLastPublishedViewLinkVisible:function(_1e,_1f){return _1f&&!!_1e.publicUrl;},_setLastChangeStatus:function(_20){var _21,_22,_23=this;_22=_21=this._getTemplatedText(this.res.lastchangestatus,_20.changedBy,_20.saved);if(this.lastExecutedCommand&&this.lastExecutedCommand.options&&this.lastExecutedCommand.options.successStatus){var _24=this.lastExecutedCommand.options.successStatus;this.lastExecutedCommand=this.mainButtonCommand;_22=_24;}if(_20.missingLanguageBranch&&_20.missingLanguageBranch.isTranslationNeeded){_22=_2.replace(this.res.nottranslated,{languageName:_6.resources.language[_20.missingLanguageBranch.languageId],languageId:_20.missingLanguageBranch.languageId});}if(_20.status===_a.versionStatus.Published||_20.status===_a.versionStatus.Expired){_22=this.res.notmodifiedsincelastpublish;}if(_20.status===_a.versionStatus.PreviouslyPublished){_22=this._getTemplatedText(this.res.previouslypublished,_20.versionCreatedBy,_20.versionCreatedTime);}if(_20.status===_a.versionStatus.CheckedIn){_22=this._getTemplatedText(this.res.pendingapproval,_20.versionCreatedBy,_20.versionCreatedTime);}if(_20.status===_a.versionStatus.DelayedPublish){_22=this.projectService.getProjectsForContent(_20.contentLink).then(function(_25){_25=_25.filter(function(_26){return _26.status==="delayedpublished";});if(_25.length){return _2.replace(_23.res.projectdelayedpublish,{date:_7.toUserFriendlyHtml(_20.properties.iversionable_startpublish),project:_5.encode(_25[0].name)});}return _21;});}_3(_22,_2.hitch(this,"set","lastChangeStatus"));},_getLastPublishedTitle:function(_27){return _27.status===_a.versionStatus.PreviouslyPublished?this.res.currentlypublished:this.res.lastpublishedby;},_getLastPublishedText:function(_28){return (_28.publishedBy===null||_28.publishedBy===undefined)?this.res.notpublishedbefore:this._getTemplatedText(this.res.publishedtime,_28.publishedBy,_28.lastPublished,true);},_setAdditionalInfo:function(_29){var _2a=this.inUseNotificationManager.hasInUseNotificationWarning(_29.inUseNotifications),_2b=this._isOriginallyEditable(),_2c=_2a&&_2b;this.set("additionalInfoSectionVisible",_2c);if(_2c){var _2d=this.inUseNotificationManager.getOtherUsersInUseNotifications(_29.inUseNotifications);this.set("additionalInfoText",this._getTemplatedText(this.res.inusewarning,_2d.join(",")));}},_isOriginallyEditable:function(){var _2e=this.inUseNotificationManager.ignoreOthersNotifications;this.inUseNotificationManager.ignoreOthersNotifications=true;var _2f=this.dataModel.canChangeContent();this.inUseNotificationManager.ignoreOthersNotifications=_2e;return _2f;},_getFriendlyUsername:function(_30,_31){return _9.toUserFriendlyHtml(_30,null,_31);},_getTemplatedText:function(_32,_33,_34,_35){var _36=new Date(_34);return _2.replace(_32,{username:this._getFriendlyUsername(_33,_35),time:_7.toUserFriendlyHtml(_36),timepassed:_7.timePassed(_36)});}});});