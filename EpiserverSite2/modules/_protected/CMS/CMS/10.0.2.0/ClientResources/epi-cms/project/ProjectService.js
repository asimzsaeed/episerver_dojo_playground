//>>built
define("epi-cms/project/ProjectService",["dojo/_base/declare","dojo/_base/lang","dojo/when","dojo/Deferred","dojo/promise/all","dojo/Evented","dojo/aspect","dijit/Destroyable","epi/dependency","epi/shell/xhr/errorHandler","epi-cms/ApplicationSettings","epi-cms/core/ContentReference"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _1([_6,_8],{isProjectModeEnabled:false,projectItemStore:null,projectStore:null,_currentProjectProfileKey:"epi.current-project-id",constructor:function(_d){_1.safeMixin(this,_d);this.projectItemStore=this.projectItemStore||_9.resolve("epi.storeregistry").get("epi.cms.project.item");this.projectStore=this.projectStore||_9.resolve("epi.storeregistry").get("epi.cms.project");this.profile=this.profile||_9.resolve("epi.shell.Profile");this.isProjectModeEnabled=_b.isProjectModeEnabled;this.own(this.projectItemStore.on("update",this._onProjectItemUpdated.bind(this)),this.projectItemStore.on("delete",this._onProjectItemRemoved.bind(this)),this.projectStore.on("update",this._onProjectUpdated.bind(this)),this.projectStore.on("delete",this._onProjectRemoved.bind(this)));},hasScheduledProjectItems:function(_e){return _a.wrapXhr(this.projectStore.refresh(_e)).then(function(_f){return _f.itemStatusCount.delayedpublish>0||_f.itemStatusCount.delayedpublish_nopublishaccess>0;}.bind(this));},getProjectItemsForContent:function(_10){if(!(_10 instanceof Array)){_10=[_10];}return _3(this.projectItemStore.query({contentLinks:_10}));},getProjectItemForContent:function(_11){var _12=new _c(_11);if(_12.workId===0){return new _4().reject("The content link needs to be version specific");}return this.getProjectItemsForContent(_11).then(function(_13){for(var i=0;i<_13.length;i++){if(_13[i].contentLink===_11){return _13[i];}}return null;});},getProjectsForContent:function(_14){var _15=this;if(!(_14 instanceof Array)){_14=[_14];}return this.getProjectItemsForContent(_14).then(function(_16){if(_16.length===0){return new _4().resolve([]);}return _15.getProjects(_16);});},canAddContent:function(_17,_18){var _19=_18.filter(function(_1a,pos){return _18.indexOf(_1a)===pos;});return this.projectStore.executeMethod("CanAddContent",_17,{contentReferences:_19});},getProjects:function(_1b){var _1c=this.projectStore;var _1d=_1b.map(function(_1e){return _1c.get(_1e.projectId);});return _5(_1d);},exists:function(_1f){return _a.wrapXhr(this.projectStore.executeMethod("exists",_1f));},addProjectItems:function(_20,_21){_21=_21.filter(function(_22,pos){if(_c.isContentReference(_22)&&_21.indexOf(_22)===pos){return true;}});var _23=this.projectItemStore,_24=_21.map(function(_25){return _23.add({contentLink:_25,projectId:_20});});return _a.wrapXhr(_5(_24));},removeProjectItems:function(_26){var _27=_26.map(function(_28){return _28.id;});return _a.wrapXhr(this.projectItemStore.removeRange(_27));},markAsReadyToPublish:function(_29){return _a.wrapXhr(this.projectItemStore.executeMethod("ReadyToPublish","",_29));},isPartOfDelayedPublishedProject:function(_2a){return this.getProjectsForContent([_2a]).then(function(_2b){return _2b.some(function(_2c){return _2c.status==="delayedpublished";});});},publishProject:function(_2d,_2e){var _2f=this.projectStore;if(isNaN(_2d)){throw new Error("projectId is not a number");}return _a.wrapXhr(_2f.executeMethod("Publish",_2d,{delayPublishUntil:_2e})).then(_2f.patchCache.bind(_2f));},reactivateProject:function(_30){var _31=this.projectStore;if(isNaN(_30)){throw new Error("The given project ID is not a number.");}return _a.wrapXhr(_31.executeMethod("Reactivate",_30)).then(_31.patchCache.bind(_31));},getCurrentProjectId:function(){if(!this.isProjectModeEnabled){return new _4().resolve(null);}return _3(this.profile.get(this._currentProjectProfileKey));},getCurrentProject:function(){var _32=this.projectStore;var _33=this;return this.getCurrentProjectId().then(function(_34){if(!_34){return null;}return _3(_32.get(_34)).otherwise(function(ex){if(ex.status===404){_33.setCurrentProject(null);}return null;});});},setCurrentProject:function(_35){this.emit("currentProjectChanged",_35);return this.profile.set(this._currentProjectProfileKey,_35&&_35.id,{location:"server"});},_onProjectItemUpdated:function(_36){this.emit("project-item-updated",_36.target);},_onProjectItemRemoved:function(_37){this.emit("project-item-removed",_37.id);},_onProjectUpdated:function(_38){this.emit("project-updated",_38.target);},_onProjectRemoved:function(_39){this.emit("project-removed",_39.id);}});});