//>>built
define("epi-cms/project/viewmodels/_ProjectViewModel",["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/Deferred","dojo/Evented","dojo/Stateful","dojo/topic","dojo/dom-class","dojo/promise/all","dojo/when","dojo/string","dijit/Destroyable","epi/epi","epi/datetime","epi/dependency","epi/username","epi/shell/_ContextMixin","epi/shell/xhr/errorHandler","../../contentediting/ContentActionSupport","epi/shell/command/withConfirmation","../command/AddProject","../command/PublishProject","../command/EditProjectItem","../command/ReadyToPublishProjectItem","../command/RefreshProjectItems","../command/RemoveProject","../command/RemoveProjectItem","../command/RemoveProjectScheduling","../command/RenameProject","../command/SortProjectItems","../command/ScheduleProject","epi/i18n!epi/nls/episerver.cms.components.project","epi/i18n!epi/nls/episerver.shared.action"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f,res,_20){return _1([_6,_c,_5,_11],{commands:null,namedCommands:null,created:"",createdBy:"",profile:null,contentLanguage:"",dndEnabled:false,isActivitiesVisible:false,projectStore:null,projectSortOrder:null,projectItemStore:null,projectItemQuery:null,activitiesStore:null,projectItemSortOrder:null,projectStatus:"",projectName:"",notificationMessage:"",selectedProject:null,selectedProjectItems:null,projectItemCountMessage:"",placeholderState:"noProjects",_sortOrderProfileKey:"epi.project-sort-order",_isActivitiesVisibleProfileKey:"epi.project-is-activities-visible",_messages:null,constructor:function(){this.projectItemSortOrder=[];this.projectSortOrder=[{attribute:"created",descending:true}];this.selectedProjectItems=[];},postscript:function(){this.inherited(arguments);this.projectService=this.projectService||_f.resolve("epi.cms.ProjectService");this.projectStore=this.projectStore||_f.resolve("epi.storeregistry").get("epi.cms.project");this.projectItemStore=this.projectItemStore||_f.resolve("epi.storeregistry").get("epi.cms.project.item");this.activitiesStore=this.activitiesStore||_f.resolve("epi.storeregistry").get("epi.cms.activities");this.profile=this.profile||_f.resolve("epi.shell.Profile");this._messages=this.isProjectModeEnabled()?res.status.message:_2.mixin({},res.status.message,res.status["messagelegacy"]);this._createCommands();this.own(this.projectService.on("project-item-updated",_2.hitch(this,this._updateSelectedItems)),this.projectService.on("project-updated",_2.hitch(this,this._projectUpdated)));},initialize:function(){return _9(_a(this.profile.get(this._sortOrderProfileKey),_2.hitch(this,function(_21){var _22=this._findSortOption("key",_21)||this.namedCommands.sortProjectItems.options[0];this._changeAttrValue("projectItemSortOrder",_22.value);})),_a(this._loadSelectedProject(),_2.hitch(this,function(_23){this._updateSelectedProjectDependencies(_23);this._changeAttrValue("selectedProject",_23);})),_a(this.profile.getContentLanguage(),_2.hitch(this,function(_24){this.set("contentLanguage",_24);})),_a(this.profile.get(this._isActivitiesVisibleProfileKey),_2.hitch(this,function(_25){if(typeof _25==="boolean"){this.set("isActivitiesVisible",_25);}})));},isProjectModeEnabled:function(){return this.projectService.isProjectModeEnabled;},getCommands:function(){return this.commands;},addProject:function(_26){this.projectStore.add(_26).then(_2.hitch(this,function(_27){this.set("selectedProject",_27);})).otherwise(_12.forXhr);},updateProject:function(_28){this.projectStore.put(_28).then(_2.hitch(this,"set","selectedProject")).otherwise(_12.forXhr);},publishProject:function(_29,_2a){var _2b=this;return this.projectService.publishProject(_29,_2a).then(function(_2c){return _2b._updateSelectedProjectAndRefreshContextRequest(_2c).then(function(){return _2c;});});},reactivateProject:function(_2d){var _2e=this;if(isNaN(_2d)){throw new Error("The given project ID is not a number.");}return this.projectService.reactivateProject(_2d).then(function(_2f){return _2e._updateSelectedProjectAndRefreshContextRequest(_2f).then(function(){return _2f;});});},refreshActivities:function(){this.emit("refresh-activities");},refreshProject:function(_30){var _31=this;if(_30===undefined){_30=true;}if(this.selectedProject){return this.projectStore.refresh(this.selectedProject.id).then(function(_32){_31.set("selectedProject",_32);if(_30){_31.emit("refresh");}return _32;},function(ex){_31.set("selectedProject",null);});}if(_30){this.emit("refresh");}},removeProject:function(){var _33=this,_34=this.projectStore;if(!this.selectedProject){return new _4().resolve();}return _34.remove(this.selectedProject.id).then(function(){_33.set("selectedProject",null);});},canAddContent:function(_35){var _36=this.get("selectedProject").id;return this.projectService.canAddContent(_36,_35);},canPublishProject:function(_37){var _38;function _39(){return Object.keys(_38).some(function(key){if(key.indexOf("nopublishaccess")>-1){if(_38[key]>0){return true;}}});};function _3a(_3b){return _38[_3b]>0;};_37=_37||this.selectedProject;_38=_37&&_37.itemStatusCount;if(this.isProjectModeEnabled()){return !!_37&&_37.itemStatusCount.checkedin>0;}else{return !!_37&&(_37.status==="active"||_37.status==="publishfailed")&&!_39()&&!_3a("notcreated")&&!_3a("rejected")&&!_3a("checkedout")&&(_3a("checkedin")||_3a("published")||_3a("previouslypublished")||_3a("delayedpublish"));}},addProjectItems:function(_3c,_3d){var _3e=this.get("selectedProject");_3d=_3d||(_3e&&_3e.id);if(!_3d){throw new Error("If no projectId is provided a selectedProject must be set in the context");}return this.projectService.addProjectItems(_3d,_3c);},removeSelectedProjectItems:function(){var _3f=this.projectService.removeProjectItems(this.selectedProjectItems);_3f.then(_2.hitch(this,function(){this.emit("clear-selection");}));return _3f;},markProjectItemsAsReadyToPublish:function(){if(!this.selectedProjectItems.length){return new _4().resolve();}var _40=this;var _41=this.selectedProjectItems.map(function(_42){return _42.id;});return this.projectService.markAsReadyToPublish(_41).then(function(){_a(_40.getCurrentContext()).then(function(ctx){var _43;_40.selectedProjectItems.some(function(_44){if(_44.contentLink===ctx.id){_43=_44;return true;}});if(_43){_40.requestContextChange(_43.contentLink);}});});},requestContextChange:function(_45){var _46=_45.uri?_45:{uri:"epi.cms.contentdata:///"+_45};_7.publish("/epi/shell/context/request",_46,{sender:this});},updateActivityFeed:function(_47){},_projectUpdated:function(_48){if(this.selectedProject&&this.selectedProject.id===_48.id){this.set("selectedProject",_48);}},_updateSelectedItems:function(_49){var _4a=this.selectedProjectItems.length;for(var i=0;i<_4a;i++){if(this.selectedProjectItems[i].id===_49.id){this.selectedProjectItems[i]=_49;this.set("selectedProjectItems",this.selectedProjectItems);this.emit("selected-project-items-updated",this.selectedProjectItems);break;}}},_createCommands:function(){var _4b=_2.mixin(this._createProjectCommands(),this._createProjectItemCommands()),_4c;_4c=Object.keys(_4b).map(function(key){return _4b[key];}).sort(function(a,b){return a.sortOrder-b.sortOrder;});this.own.apply(this,_4c);this.set({commands:_4c,namedCommands:_4b});},_createProjectCommands:function(){return {addProject:new _15({model:this,order:10}),renameProject:new _1d({model:this,order:20}),removeProject:new _1a({model:this,order:30,store:this.projectStore}),publishProject:new _16({model:this,order:40}),scheduleProject:new _1f({model:this,order:50}),removeProjectScheduling:_14(new _1c({model:this,order:60}),null,{title:res.command.removeschedulingprojectitem.title,description:res.command.removeschedulingprojectitem.confirmation,confirmActionText:_20.remove,cancelActionText:_20.cancel})};},_createProjectItemCommands:function(){return {readyToPublishProjectItem:new _18({model:this,order:100}),editProjectItem:new _17({model:this,order:110}),removeProjectItem:_14(new _1b({model:this,order:120}),null,{title:res.command.removeprojectitem.label,description:res.command.removeprojectitem.confirmation,confirmActionText:_20.remove,cancelActionText:_20.cancel}),sortProjectItems:new _1e({model:this,order:130}),refreshProjectItems:new _19({model:this,order:140})};},_loadSelectedProject:function(){return this.projectService.getCurrentProject();},_persistSelectedProject:function(_4d){this.profile.set(this._selectedProjectProfileKey,_4d&&_4d.id,{location:"server"});},_persistSortOrder:function(_4e){var _4f=this._findSortOption("value",_4e),key=_4f&&_4f.key||null;this.profile.set(this._sortOrderProfileKey,key,{location:"server"});},_persistIsActivitiesPanelVisible:function(_50){this.profile.set(this._isActivitiesVisibleProfileKey,_50,{location:"server"});},_findSortOption:function(key,_51){var _52=this.namedCommands.sortProjectItems.options,_53=null;_51&&_52.some(function(_54){if(_51===_54[key]){_53=_54;return true;}});return _53;},_updateSelectedProjectDependencies:function(_55){var _56="",_57="",_58="",_59=false,_5a="",_5b=null,_5c="",_5d="",_5e=this.isProjectModeEnabled();if(_55){_56=_e.toUserFriendlyString(new Date(_55.created));_57=_10.toUserFriendlyString(_55.createdBy,null,true);_59=(_5e&&_55.status!=="publishing")||_55.status==="active"||_55.status==="publishfailed";_5b={projectId:_55.id};_5d=_55.name;if(!this.canPublishProject(_55)||_5e){_5c=this._messages[_55.status]||"";if(_55.status==="delayedpublished"&&!_5e){_58=_e.toUserFriendlyString(_55.delayPublishUntil);_5c=_2.replace(_5c,{date:_58});_5a=_2.replace(res.status.state.delayedpublished,{delayPublishUntil:_58});}}if(_55.status==="publishfailed"){_5a=this._getProjectFailedMessage(_55);}}this.set({created:_56,createdBy:_57,dndEnabled:_59,notificationMessage:_5a,projectItemQuery:_5b,projectStatus:_5c,projectName:_5d});},_getProjectFailedMessage:function(_5f){var _60=0,_61="",_62=res.notifications.publishfailed;_60=this._getUnpublishedItems(_5f.itemStatusCount);if(_60>0){_61=_2.replace(_60>1?_62.notificationtextmultipleitems:_62.notificationtextsingleitem,{failedItemsCount:_60});}return _61;},_getUnpublishedItems:function(_63){var _64=0;Object.keys(_63).forEach(function(key){if(key.indexOf("checkedin")===0){_64+=_63[key];}});return _64;},_isActivitiesVisibleSetter:function(_65){if(_65===this.isActivitiesVisible){return;}this.isActivitiesVisible=_65;this._persistIsActivitiesPanelVisible(_65);},_selectedProjectSetter:function(_66){_66=_2.clone(_66);if(_d.areEqual(this.selectedProject,_66)){return;}if(this.selectedProject&&(!_66||this.selectedProject.id!==_66.id)){this.emit("clear-selection");}this.selectedProject=_66;this._updateSelectedProjectDependencies(_66);},_projectItemSortOrderSetter:function(_67){if(_67&&_67===this.projectItemSortOrder){return;}this.projectItemSortOrder=_67;this._persistSortOrder(_67);},_updateSelectedProjectAndRefreshContextRequest:function(_68){var _69=this;_69.set("selectedProject",_68);return _a(this.getCurrentContext()).then(function(_6a){_69.requestContextChange(_6a);return _6a;});},_selectedProjectItemsSetter:function(_6b){this.selectedProjectItems=_6b;this._updateProjectCountMessage(_6b);},_updateProjectCountMessage:function(_6c){var _6d=_6c&&_6c.length>0?_6c.length:null,_6e="";function _6f(_70,_71){_6e=_b.substitute(res.notifications.selecteditems[_71],{count:_70});};if(_6d){if(_6d===1){_6f(_6d,"singular");}else{if(_6d>1){_6f(_6d,"plural");}}}this.set("projectItemCountMessage",_6e);}});});