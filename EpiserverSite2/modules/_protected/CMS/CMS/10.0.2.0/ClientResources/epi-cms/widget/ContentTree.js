//>>built
define("epi-cms/widget/ContentTree",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/dom-style","dojo/aspect","dojo/Deferred","dojo/Evented","dojo/keys","dojo/promise/all","dojo/query","dojo/sniff","dojo/when","dijit/registry","epi/dependency","epi/shell/dnd/tree/dndSource","epi/shell/TypeDescriptorManager","epi/shell/widget/Tree","epi-cms/core/ContentReference","epi-cms/widget/_ContentTreeNode","epi-cms/widget/ContentTreeModelConfirmation","epi-cms/widget/ContentForestStoreModel","epi/i18n!epi/cms/nls/episerver.shared.header"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18){return _3([_13,_9],{roots:null,expandExtraNodeItems:null,nodeConstructor:null,typeIdentifiers:null,allowManipulation:true,persist:false,expandOnDnd:true,showRoot:false,handleSelection:false,disableRestrictedTypes:false,postMixInProperties:function(){this.inherited(arguments);if(!this.model){this.model=this._createTreeModel();}if(this.allowManipulation){this.dndController=_11;this.accept=this.model.containedTypes||this.containedTypes;}this.checkItemAcceptance=_4.hitch(this,this.checkItemAcceptance);this.nodeConstructor=this.nodeConstructor||_15;if(this.allowedTypes){var _19=_1.some(this.allowedTypes,function(_1a){return _1a==="episerver.core.contentfolder";});if(!_19){this.allowedTypes.push("episerver.core.contentfolder");}}},getItemType:function(_1b){return _12.getAndConcatenateValues(_1b.typeIdentifier,"dndTypes");},buildRendering:function(){this.model=this._wrapModel(this.model);this.inherited(arguments);},_wrapModel:function(_1c){return _16(this.model);},postCreate:function(){this.inherited(arguments);this.own(this.connect(this.model,"onSelect",_4.hitch(this,this._onSelect)),_7.before(this.model,"onToggleContentDisplay",_4.hitch(this,function(_1d,_1e){var _1f=this.getNodesByItem(_1d)[0];if(_1f){_6.set(_1f.domNode,{display:_1e===true?"":"none"});}})));},onLoad:function(){this.inherited(arguments);return _e(this._expandRootNodes(),_4.hitch(this,this._expandExtraNodes));},_expandRootNodes:function(){var _20=this.showRoot?[this.rootNode]:this.rootNode.getChildren();return _b(_1.map(_20,this.tree._expandNode,this));},_expandExtraNodes:function(){if(!this.expandExtraNodeItems){return;}var _21=this.expandExtraNodeItems instanceof Array?this.expandExtraNodeItems:[this.expandExtraNodeItems];var _22=_1.map(_21,function(_23){return this.tree.getNodesByItem(_23)[0];},this);_22=_1.filter(_22,Boolean);return _b(_1.map(_22,this.tree._expandNode,this));},checkItemAcceptance:function(_24,_25,_26){var _27=true;var _28=_f.getEnclosingWidget(_24),_29=_28&&_28.item;if(!_29){return false;}_25.forInSelectedItems(function(_2a){if(!_27){return;}var _2b=_2a.data;if(_2b.dndData){_2b=_2b.dndData;}_27=this.model.canPaste(_2b,_29);},this);return _27;},_setAllowManipulationAttr:function(_2c){this._set("allowManipulation",_2c);if(_2c){this.dndController=_11;}},_createTreeModel:function(){return new _17({roots:this.roots,typeIdentifiers:this.typeIdentifiers});},_onItemDelete:function(_2d,_2e){function _2f(_30,_31){_1.forEach(_30.getChildren(),function(_32){_31.push(_32.item);_2f(_32,_31);});return _31;};if(_2e){var _33=this._itemNodesMap[this.model.getIdentity(_2d)];if(_33){_1.forEach(_33,function(_34){_1.forEach(_2f(_34,[]).reverse(),function(_35){this._onItemDelete(_35);},this);},this);}}this.inherited(arguments);},_setTypeIdentifiersAttr:function(_36){this._set("typeIdentifiers",_36);if(this.model){this.model.typeIdentifiers=_36;}},getTooltip:function(_37){var _38=this.model.getTooltip||this.model.getLabel;var _39=new _14(_37.contentLink),_3a=_38?_38(_37):this.inherited(arguments);return _3a?_3a+", "+_18.id+": "+_39.id+" ("+_18.type+": "+_37.contentTypeName+")":_3a;},buildNodeFromTemplate:function(_3b){return new this.nodeConstructor(_3b);},_createTreeNode:function(_3c){var _3d=_4.mixin({},_3c,{dndData:_3c.item});return this.buildNodeFromTemplate(_3d);},getIconClass:function(_3e,_3f){if(!_3e){return this.inherited(arguments);}var _40=_12.getValue(_3e.typeIdentifier,"iconClass");if(this.model.isTypeOfRoot(_3e)){return this.model.getObjectIconClass(_3e,_40);}var _41=_12.getValue(_3e.typeIdentifier,"supportsOpenCssClass");if(_3f&&!_3e.isSubRoot&&_41){_40=_40+"Open";}return _40+this._getItemDisableStyle(_3e);},getLabelClass:function(_42,_43){return this._getItemDisableStyle(_42);},focus:function(){this.focusNode(this.get("selectedNode")||this.rootNode);},_getItemDisableStyle:function(_44){if(this.disableRestrictedTypes){return this._isItemRestricted(_44)?" is-disabled ":"";}return "";},_isItemRestricted:function(_45){var _46=_12.getValidAcceptedTypes([_45.typeIdentifier],this.allowedTypes,this.restrictedTypes);return !_46.length;},_getTargetPath:function(_47){var _48=this.model,_49=new _8();_48.getAncestors(_47,function(_4a){_4a.push(_47);var _4b=_1.map(_4a,function(_4c){return _48.getIdentity(_4c).toString();});if(typeof _48.filterAncestors==="function"){_4b=_48.filterAncestors(_4b);}_49.resolve(_4b);});return _49.promise;},_isValidTargetContent:function(_4d){if(!_4d){return false;}return !_4d.isDeleted&&!_4d.isWastebasket;},_onSelect:function(id,_4e,_4f){var _50=this.get("selectedNode");this.tree.model.set("previousContextualSelection",{selectedContent:_50});this.selectContent(id,_4e,true,_4f).then(_4.hitch(this,function(){_50=this.get("selectedNode");if(_50&&_50.item&&_50.item.contentLink){this.emit("select",_50.item,_50);}}));},selectContent:function(_51,_52,_53,_54){var _55=this,_56=_55.model,_57=new _8(),_58=function(_59){_55._preparePathNodes(_59);_55._setRecursivePaths(_59,_57,_52,_54);};_e(_56.store.get(_51),function(_5a){if(!_55._isValidTargetContent(_5a)){_55.set("paths",[]);_57.resolve(null);}else{_55._getTargetPath(_5a).then(function(_5b){_55._onSetTargetPath();_58(_5b);});}});return _57.promise;},_onSetTargetPath:function(){this.model.set("handleSelection",this.handleSelection);if(!this.handleSelection){return;}var _5c=this.get("selectedNode");if(_5c){_5c=this.getNodesByItem(_5c.item)[0];if(_5c){this.model.set("previousSelection",{selectedContent:_5c,selectedAncestors:_5c.getTreePath()});}}},_preparePathNodes:function(_5d){},_setRecursivePaths:function(_5e,_5f,_60,_61){if(!_5e||_5e.length===0){return;}this.set("paths",[_5e]).then(_4.hitch(this,function(){var _62=this.get("selectedNode");if(!_62){this._setRecursivePaths(_5e.slice(0,-1),_5f,_60,_61);return;}if(_60){this.focus();}if(_61){_61(_62);}_5f.resolve(_62);},_5f.reject));},_onKeyDown:function(_63,e){this.inherited(arguments);if(!this.allowManipulation){return;}if(_2.isCopyKey(e)){var _64=e.keyCode?String.fromCharCode(e.keyCode).toLowerCase():"";switch(_64){case "c":this.emit("copyOrCut",true);break;case "x":this.emit("copyOrCut",false);break;case "v":this.emit("paste");break;default:break;}}if(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey){return;}if(e.keyCode===_a.DELETE){this.emit("delete");}},_onNodeMouseLeave:function(_65,evt){this.inherited(arguments);if(_d("ie")){_1.forEach(_c(".dijitTreeRow.dijitTreeRowHover",this.tree.domNode),function(_66){_5.remove(_66,"dijitTreeRowHover");});}}});});