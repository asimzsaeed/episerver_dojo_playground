//>>built
define("epi-cms/widget/ContentTreeStoreModel",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/Deferred","dojo/promise/all","dojo/when","dojo/topic","epi","epi/dependency","epi/shell/_StatefulGetterSetterMixin","epi/shell/TypeDescriptorManager","epi/shell/_ContextMixin","epi/shell/ViewSettings","epi-cms/ApplicationSettings","epi-cms/contentediting/ContentActionSupport","epi-cms/core/ContentReference","epi-cms/widget/_HierarchicalModelMixin","epi-cms/widget/viewmodel/_UpdateableStoreModelMixin"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14){return _3([_c,_13,_14,_e],{store:null,root:null,notAllowToDelete:null,notAllowToCopy:null,typeIdentifiers:null,showAllLanguages:true,getChildrenQuery:"getchildren",getRootChildrenQuery:null,_observers:null,_defaultDataStoreName:"epi.cms.content.light",additionalQueryOptions:{},createAsLocalAsset:false,autoSelectPastedItem:true,constructor:function(_15){_3.safeMixin(this,_15);this._observers={};this.store=this.store||_b.resolve("epi.storeregistry").get(this._defaultDataStoreName);this._queryOptions=_4.mixin({ignore:["query"],comparers:{typeIdentifiers:_4.hitch(this,function(_16,_17){return _1.some(_16,_4.hitch(this,function(_18){return _18===_17.typeIdentifier||_d.isBaseTypeIdentifier(_17.typeIdentifier,_18);}));}),referenceId:function(_19,_1a){return _12.compareIgnoreVersion(_19,_1a.parentLink);},allLanguages:function(_1b,_1c){if(_1b||!_1c.currentLanguageBranch){return true;}return _a.areEqual(_10.currentContentLanguage,_1c.currentLanguageBranch.languageId);}},sort:this._getSortSettings(this.typeIdentifiers)},this.additionalQueryOptions);var _1d=_2.subscribe("/epi/cms/contentdata/updated",this,function(_1e){this.store.refresh(_1e.contentLink).then(_4.hitch(this,function(){if(_1e.recursive){this.onItemChildrenReload(_1e);}}));});var _1f=_2.subscribe("/epi/cms/contentdata/childrenchanged",_4.hitch(this,this._childrenChanged));var _20=_2.subscribe("/epi/cms/contentdata/restored",this,function(_21){this._childrenChanged(_21);});var _22=_5.after(this.store,"onItemChanged",_4.hitch(this,function(id,_23){this.onChange(_23);}),true);this._handles=[_1d,_1f,_20,_22];},destroy:function(){for(var id in this._observers){this._observers[id].cancel();this._observers[id]=null;}if(this._handles){_1.forEach(this._handles,function(_24){_24.remove();});this._handles=null;}},isSupportedType:function(_25){return _1.some(this.typeIdentifiers,function(_26){return _26===_25||_d.isBaseTypeIdentifier(_25,_26);});},_setShowAllLanguagesAttr:function(_27){this._set("showAllLanguages",_27);this.onItemChildrenReload(this.root);},getRoot:function(_28,_29){if(_4.isArray(this.root)){_28({});}else{_8(this.store.get(this.root),_28,_29);}},mayHaveChildren:function(_2a){return _2a.hasChildren;},getChildren:function(_2b,_2c){var id=this.getIdentity(_2b),_2d=id===this.root,_2e=_2d&&this.getRootChildrenQuery?this.getRootChildrenQuery:this.getChildrenQuery,_2f=this._createQuery({referenceId:id,query:_2e}),_30=this.store.query(_2f,this._queryOptions),_31=_4.hitch(this,function(_32){this.onChange(_32);_8(this.store.query(_2f,this._queryOptions),_4.hitch(this,function(_33){this.onChildrenChange(_2b,_33);}));});var _34=this._observers[id];if(_34){_34.cancel();delete this._observers[id];}this._observers[id]=_30.observe(_31,true);_8(_30,_2c);},_getSortSettings:function(_35){if(!_35){return {};}if(_35 instanceof String){_35=[_35];}var _36=this,_37,_38=[];_35.map(function(_39){_37=_d.getValue(_39,"sortKey");if(_37){_38.push(_37.sortDescending?{attribute:_37.columnName,descending:true}:{attribute:_37.columnName});}});return _38;},_createQuery:function(_3a,_3b){var _3c=this.typeIdentifiers&&(_4.isArray(this.typeIdentifiers)?this.typeIdentifiers:this.typeIdentifiers.split(","));var _3d=this.showAllLanguages?{allLanguages:true}:{},_3e=_3b?{}:{typeIdentifiers:_3c};var _3f=_4.mixin(_3a,_3e,_3d);return _3f;},_createChildrenQuery:function(_40,_41){var _42=_4.mixin(_40,{query:"getchildren"});return this._createQuery(_42,_41);},move:function(_43,_44){if(!_44.contentLink){_44=this.store.get(_44);}var _45=_1.map(_43,function(_46){return _8(this.store.get(_46.data.parentLink),_4.hitch(this,function(_47){return this.pasteItem(_46.data,_47,_44,false);}));},this);return _7(_45).then(_4.hitch(this,function(_48){if(_44.contentLink===_10.wastebasketPage){var _49=_43.filter(function(i,_4a){return !!_48[_4a];});if(_49.length){this.onDeleted(_49);}}}));},remove:function(_4b){var _4c=_4b.map(function(_4d){return this.store.remove(_4d.data.contentLink);},this);return _7(_4c).then(_4.hitch(this,function(){this.onDeleted(_4b);}));},copy:function(_4e,_4f){var _50=_1.map(_4e,function(_51){return _8(this.store.get(_51.data.parentLink),_4.hitch(this,function(_52){return this.pasteItem(_51.data,_52,_4f,true);}));},this);return _7(_50);},pasteItem:function(_53,_54,_55,_56,_57){var id=this.getIdentity(_53),_58=_55&&_55.isWastebasket,_59=_56?this.store.copy:this.store.move,_5a={targetId:this.getIdentity(_55),createAsLocalAsset:this.createAsLocalAsset,sortIndex:_57};return _59.call(this.store,id,_5a).then(_4.hitch(this,function(_5b){if(_58){this.onDelete(_53,true);}else{_9.publish("/epi/cms/contentdata/childrenchanged",_55.contentLink);}var _5c=_56?_5b.extraInformation:_53.contentLink;var _5d=_12.toContentReference(_5c).createVersionUnspecificReference().toString();return _8(this.store.refresh(_5d),_4.hitch(this,function(_5e){this._onPasteComplete(_5e,_56,_58,_54,_55);return _5b;}));}));},onPasteComplete:function(){},_onPasteComplete:function(_5f,_60,_61,_62,_63){this.onPasteComplete();this._selectItemOnPasteComplete(_5f,_60,_61,_62,_63);this.inherited(arguments);},_selectItemOnPasteComplete:function(_64,_65,_66,_67,_68){if(this.autoSelectPastedItem&&_64&&_64.contentLink&&!_66){this.onSelect(_64.contentLink,true);}},newItem:function(_69,_6a){if(_69.dndData&&_69.dndData.data){var _6b=this.getParentItem(_69.dndData);this._pasteNewItem(_69.dndData.data,_6b,_6a);}},getParentItem:function(_6c){if(_6c&&_6c.data){var _6d=_6c.data["parentLink"];if(_6d){_6d=new _12(_6d).createVersionUnspecificReference().toString();}return {contentLink:_6d};}},_pasteNewItem:function(_6e,_6f,_70){this.pasteItem(_6e,_6f,_70,false);},_updateItemChanged:function(_71){_8(this.store.refresh(_71),_4.hitch(this,function(_72){this._childrenChanged(_72);}));},_childrenChanged:function(_73){var dfd=new _6();this.getChildren(_73,_4.hitch(this,function(_74){this.onChildrenChange(_73,_74);dfd.resolve(_74);}));return dfd;},_isNodeAContextAncestor:function(_75,_76){var dfd=new _6();this.getAncestors(_76,function(arr){var _77=arr.map(function(e){return e.contentLink;});var _78=_77.indexOf(_75)!==-1||_12.compareIgnoreVersion(_75,_76.id);dfd.resolve(_78);});return dfd;},getIdentity:function(_79){if(_4.isObject(_79)){return this.store.getIdentity(_79);}return _79;},getObjectIconClass:function(_7a,_7b){var _7c=_d.getValue(_7a.typeIdentifier,"iconClass");if(!_7c){return _7b;}var _7d="";switch(parseInt(_7a.contentLink,10)){case _10.globalAssetsFolder:_7d="AllSites";break;case _10.siteAssetsFolder:_7d="ThisSite";break;default:break;}return (_7d===""&&_7c===_7b)?_7c:(_7b+" "+_7c+_7d);},getLabel:function(_7e){return _7e.name;},canExpandTo:function(_7f){var _80=new _6();this.getAncestors(_7f,_4.hitch(this,function(_81){_80.resolve(this.getIdentity(_81[0])===this.root.id);}));return _80.promise;},canCopy:function(_82){if(!_82){return false;}var _83=_82.contentLink,_84=_83===this.root||(_1.indexOf(this.notAllowToCopy,_83)>=0);return !_84&&_11.hasAccess(_82.accessMask,_11.accessLevel.Read)&&_11.hasProviderCapability(_82.providerCapabilityMask,_11.providerCapabilities.Copy);},canCut:function(_85){if(!_85){return false;}var _86=_85.contentLink,_87=_86===this.root||(_1.indexOf(this.notAllowToDelete,_86)>=0);return !_87&&_11.isActionAvailable(_85,_11.action.Delete,_11.providerCapabilities.Move,true);},canDelete:function(_88){if(!_88){return false;}var _89=_88.contentLink,_8a=_89===this.root||(_1.indexOf(this.notAllowToDelete,_89)>=0);return !_8a&&_11.isActionAvailable(_88,_11.action.Delete,_11.providerCapabilities.Delete,true);},canPaste:function(_8b,_8c,_8d){if(!_8b||!_8c){return false;}var _8e=_8d&&_8c.isWastebasket,_8f=!_8d&&(this.getIdentity(_8b)===this.getIdentity(_8c)),_90=!_8d&&(_8b.parentLink===this.getIdentity(_8c)),_91=_11.isActionAvailable(_8c,_11.action.Create,_11.providerCapabilities.Create,true);return !_8c.isDeleted&&!_8e&&!_8f&&!_90&&_91;},canEdit:function(_92){if(!_92){return false;}var _93=_92.contentLink,_94=_93===this.root;return !_94&&_11.hasAccess(_92.accessMask,_11.accessLevel.Edit);},onItemChildrenReload:function(_95){},onChange:function(){},onChildrenChange:function(){},onDelete:function(){},onDeleted:function(_96){var _97=_96[0].data;if(_97){_8(this.getCurrentContext(),_4.hitch(this,function(ctx){var _98=_97.capabilities.isPage;_8(this._isNodeAContextAncestor(_97.contentLink,ctx),_4.hitch(this,function(_99){if(_98&&!_99){return;}if(!_98&&_99){_9.publish("/epi/shell/context/request",{uri:_f.settings.defaultContext});return;}this.onSelect(_97.parentLink,true);}));}));}},onSelect:function(_9a,_9b,_9c){}});});