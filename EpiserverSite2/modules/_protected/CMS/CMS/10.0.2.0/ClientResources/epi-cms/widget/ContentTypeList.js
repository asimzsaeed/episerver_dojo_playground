//>>built
define("epi-cms/widget/ContentTypeList",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/Deferred","dojo/promise/all","dojo/when","dijit/layout/_LayoutWidget","epi/dependency","epi/shell/TypeDescriptorManager","epi-cms/widget/ContentTypeGroup","epi/i18n!epi/cms/nls/episerver.cms.widget.contenttypelist"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _2([_8],{store:null,parentLink:null,groups:null,requestedType:null,shouldSkipContentTypeSelection:null,allowedTypes:null,restrictedTypes:null,contentTypeService:null,postMixInProperties:function(){this.inherited(arguments);this.groups={};this.contentTypeService=this.contentTypeService||_9.resolve("epi.cms.ContentTypeService");if(!this.store){var _d=_9.resolve("epi.storeregistry");this.store=_d.get("epi.cms.contenttype");}},buildRendering:function(){this.inherited(arguments);var _e=new _b();this.connect(_e,"onSelect",function(_f){this.onContentTypeSelected(_f);});this.addChild(_e);this._suggestedContentTypes=_e;},refresh:function(){this.clear();this._setupWidgetTemplate();_7(_6({types:this._getSuggestedContentTypes(this.requestedType),groups:this._groupContentTypes()}),_3.hitch(this,function(_10){var _11=_10.types,_12=_10.groups,_13=_12.grouped,_14=_12.contentTypes;if(_11.length<=0){this._suggestedContentTypes.setVisibility(false);}else{_4.add(this._suggestedContentTypes.titleNode,"epi-ribbonHeaderSpecial");this._suggestedContentTypes.set("title",this._suggestedTypesTitle);this._suggestedContentTypes.set("contentTypes",_11);this._suggestedContentTypes.setVisibility(true);}var key,_15;for(key in _13){_15=this._getOrCreateGroup(key);_15.set("contentTypes",_13[key]);}if(_14 instanceof Array&&_14.length===1){this.setVisibility(false);this.set("shouldSkipContentTypeSelection",true);this.onContentTypeSelected(_14[0]);}else{this.set("shouldSkipContentTypeSelection",false);}}));},setVisibility:function(_16){this.getChildren().forEach(function(_17){_17.setVisibility(_16);},this);},_setupWidgetTemplate:function(){this._suggestedTypesTitle=_a.getResourceValue(this.requestedType,"suggestedtypes");this._otherTypesTitle=_a.getResourceValue(this.requestedType,"othertypes");},clear:function(){this._suggestedContentTypes.clear();for(var key in this.groups){this.groups[key].destroyRecursive();delete this.groups[key];}},_getOrCreateGroup:function(_18){var _19=this.groups[_18];if(!_19){_19=new _b({title:_18});this.connect(_19,"onSelect",function(_1a){this.onContentTypeSelected(_1a);});this.addChild(_19);this.groups[_18]=_19;}return _19;},_getAvailableContentTypes:function(_1b){return this.contentTypeService.getAcceptedChildTypes(this.parentLink,this.get("localAsset"),[_1b],this.allowedTypes,this.restrictedTypes);},_getSuggestedContentTypes:function(_1c){var _1d=this.store.query({query:"getsuggestedcontenttypes",localAsset:this.get("localAsset"),parentReference:this.parentLink,requestedTypes:[_1c]});return this.contentTypeService.filterQueryResult(_1d,this.allowedTypes,this.restrictedTypes);},_groupContentTypes:function(){var _1e={},_1f=new _5(),_20=this._otherTypesTitle;_7(this._getAvailableContentTypes(this.requestedType),_3.hitch(this,function(_21){var _22=_21.length;_1.forEach(_21,function(_23){_7(_23,function(_24){var _25=_24.groupName||_20,_26=_1e[_25]||[];_26.push(_24);_1e[_25]=_26;_22--;if(_22===0){_1f.resolve({grouped:_1e,contentTypes:_21});}});});}));return _1f;},_setLocalAssetAttr:function(_27){this._set("localAsset",_27);if(this.requestedType&&this.parentLink){this.refresh();}},_setParentLinkAttr:function(_28){this._set("parentLink",_28);if(this.requestedType){this.refresh();}},onContentTypeSelected:function(){}});});