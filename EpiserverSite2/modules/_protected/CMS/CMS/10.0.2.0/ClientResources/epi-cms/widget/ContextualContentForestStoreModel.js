//>>built
define("epi-cms/widget/ContextualContentForestStoreModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/Deferred","dojo/promise/all","dojo/topic","dojo/when","epi/shell/TypeDescriptorManager","epi-cms/contentediting/_ContextualContentContextMixin","epi-cms/core/ContentReference","epi-cms/widget/ContentForestStoreModel"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _2([_c,_a],{handleSelection:null,previousSelection:null,postscript:function(){this.inherited(arguments);this._handles.push(_7.subscribe("/epi/cms/action/createlocalasset",_3.hitch(this,this.refreshRoots)));this._handles.push(_7.subscribe("/epi/cms/action/togglecreatemode",_3.hitch(this,this._toggleContextualContent)));this._handles.push(_4.around(this,"pasteItem",_3.hitch(this,this._aroundPasteItem)));this._handles.push(_4.after(this.store,"get",_3.hitch(this,this._afterStoreGet)));},contextChanged:function(_d,_e){this.inherited(arguments);this.refreshRoots();},getChildren:function(_f,_10,_11){if(_f===this.root){_8(this._getRootItems(),_10,_11);}else{if(this.isPseudoContextualRoot(_f)){_10([]);return;}this.inherited(arguments);}},getAncestors:function(_12,_13){var _14=this.getInherited(arguments),_15=_13;_8(this.getCurrentContent()).then(_3.hitch(this,function(_16){var _17=this.roots.concat(_16.assetsFolderLink),_18=_3.hitch(this,function(_19){var _1a;for(var i=_19.length-1;i>=0;i--){_1a=_19[i];if(this.isContextualRoot(_1a)){_19[i]=this.getContextualRoot(_1a);}if(_1.indexOf(_17,this.getIdentity(_1a))>=0){_19=_19.slice(i);_19.unshift(this.root);_13(_19);return;}}_13([this.root]);});if(_1.indexOf(_17,this.getIdentity(_12))>=0){_13([this.root]);}_15=_18;})).always(_3.hitch(this,function(){_14.apply(this,[_12,_15]);}));},getObjectIconClass:function(_1b,_1c){var _1d=this._currentContext&&this._currentContext.dataType;if(!_1d){return this.inherited(arguments);}var _1e=_9.getValue(_1d,"iconClass");return this.isContextualContent(_1b)?(_1e?_1c+" "+_1e+"Contextual":_1c):this.inherited(arguments);},onToggleContentDisplay:function(_1f,_20){},onRefreshRoots:function(_21){},refreshRoots:function(_22){if(_22===this){return true;}var _23=this;return _8(_23._getRootItems(),function(_24){_23.onChildrenChange(_23.root,_24);if(_23.get("handleSelection")===true){return _23._setSelection(_3.clone(_24).pop());}});},canCopy:function(_25){return this.isContextualContent(_25)?false:this.inherited(arguments);},canCut:function(_26){return this.isContextualContent(_26)?false:this.inherited(arguments);},canPaste:function(_27,_28,_29){var _2a=this,_2b=this.inherited(arguments),_2c=new _5();if(_29){_2c.resolve(_2b);}else{_2a.getAncestors(_28,function(_2d){var _2e=_2a.isContextualContent(_28)||_2a.hasContextual(_2d);if(_2e){_8(_2a.getCurrentContent()).then(function(_2f){if(_b.compareIgnoreVersion(_27.contentLink,_2f.contentLink)){_2c.resolve(false);}else{_2a.getAncestors(_2f.contentLink,function(_30){var _31=_1.some(_30,function(_32){return _27.contentLink===_32.contentLink;},this);_2c.resolve(_31?false:_2b);});}}).otherwise(function(){_2c.resolve(false);});}else{_2c.resolve(_2b);}});}return _2c.promise;},filterAncestors:function(_33){if(!(_33 instanceof Array)){return _33;}var _34=_33.indexOf(this._getPseudoContextualContent().toString());if(_34!==-1&&_34<_33.length-1){_33.splice(_34,1);}return _33;},_toggleContextualContent:function(_35){_8(this.getCurrentContent(),_3.hitch(this,function(_36){this.onToggleContentDisplay(_36.assetsFolderLink,!_35);this._setSelection(null);}));},_setSelection:function(_37){var _38=this.roots.length>0?this.roots[0].toString():(!_37?null:_37.assetsFolderLink),_39=_37!=null?_37.contentLink:_38,_3a=this.get("previousSelection"),_3b=this.get("previousContextualSelection"),_3c=_3b&&_3b.selectedContent,_3d=new _5();if(!(_39&&_3a)){_3d.resolve();return _3d.promise;}var _3e=false,_3f=_3a.selectedContent,_40=_3a.selectedAncestors,_41=_3f.item&&!_3f.item.contentLink;var _42=function(){_3d.resolve();};if(_41||this.hasContextual(_40)){this.onSelect(_39,_3e,_42);}else{if(_3f.item.contentLink===_38&&_3c&&_3c.item&&_3c.item.contentLink){this.onSelect(_3c.item.contentLink,_3e,_42);}else{_3d.resolve();}}return _3d.promise;},getRoots:function(_43){var def=new _5();var _44=this._getPseudoContextualContent().toString();var _45=function(_46){if(!_43){return true;}return _46!==_44;};var _47=function(_48){return _48.contentLink;};_8(this._getRootItems(),function(_49){def.resolve(_49.map(_47).filter(_45));},def.reject);return def.promise;},_getRootItems:function(){var _4a=this,_4b=_4a.store,_4c=_1.map(_4a.roots,function(_4d){return _4b.get(_4d);});var _4e=_8(_6([_4a.getCurrentContent(),_4a.getCurrentContext()]),function(_4f){var _50=_4f[0],_51=_4f.length>1?_4f[1]:null;var _52=new _b(_50.contentLink).createVersionUnspecificReference().toString();return _8(_4b.get(_52),function(_53){var _54=_51&&_51.currentMode==="create";if((_54&&_4a.get("view")==="contentselector")||!_4a.canHaveContextualContent(_53)){return null;}var _55=_53.assetsFolderLink;if(_55){var _56=function(_57){return _8(_4b.get(_57),function(_58){var _59={id:_58.contentLink,typeIdentifiers:_4a.typeIdentifiers,allLanguages:_4a.showAllLanguages};return _8(_4b.query(_59),function(_5a){if(typeof _4a.isSupportedType==="function"&&!_4a.isSupportedType(_5a.typeIdentifier)){return null;}if(!_4a.isPseudoContextualRoot(_5a)){return _4a.getContextualRoot(_5a);}else{return _8(_4a.onRefreshRoots(_5a),function(){return _4a._modifyContentAccess(_5a,_53);});}});});};if(_55===_4a._getPseudoContextualContent().toString()){return _8(_4b.refresh(_52),function(_5b){return _56(_5b.assetsFolderLink);});}else{return _56(_55);}}return null;});},function(){return null;});_4c.push(_4e);return _8(_6(_4c),function(_5c){return _1.filter(_5c,Boolean);});},_aroundPasteItem:function(_5d){var _5e=this;return function(_5f,_60,_61,_62,_63){var _64=_61,_65=_5e.get("createAsLocalAsset");return _8(_5e.getCurrentContent()).then(function(_66){if(!_65){_65=_5e.isPseudoContextualRoot(_64);_5e.set("createAsLocalAsset",_65);}_65&&(_64=_66);}).always(function(){return _8(_5d.apply(_5e,[_5f,_60,_64,_62,_63]),function(_67){if(_65){_5e.set("createAsLocalAsset",false);return _8(_5e.refreshRoots(),function(){_7.publish("/epi/cms/action/createlocalasset",_5e);return _67;});}else{return _67;}});});};},_afterStoreGet:function(_68){var _69=this;return _8(_68,function(_6a){return _8(_69.getCurrentContent(),function(_6b){return _69._modifyContentAccess(_6a,_6b);},function(_6c){return _6a;});});},_modifyContentAccess:function(_6d,_6e){if(this.isContextualContent(_6d)){var _6f=this.getContextualRoot(_6d);return this.isPseudoContextualRoot(_6d)?_3.mixin(_6f,{isPreferredLanguageAvailable:_6e.isPreferredLanguageAvailable,hasTranslationAccess:_6e.hasTranslationAccess,accessMask:_6e.accessRights}):_6f;}return _6d;}});});