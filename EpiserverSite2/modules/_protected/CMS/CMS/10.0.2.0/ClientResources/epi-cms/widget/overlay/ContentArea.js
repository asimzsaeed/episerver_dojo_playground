//>>built
require({cache:{"url:epi-cms/widget/templates/ContentArea.html":"<div class=\"epi-overlay-blockarea\">\r\n\t<div class=\"epi-overlay-item-container\">\r\n\t\t<div class=\"epi-overlay-bracket\"></div>\r\n\t</div>\r\n\t<div data-dojo-attach-point=\"containerNode\" class=\"epi-overlay-blockarea-container\"></div>\r\n\t<div data-dojo-attach-point=\"actionsNode\" class=\"epi-overlay-blockarea-actionscontainer\">\r\n\t\t<div data-dojo-attach-point=\"actionsNodeControls\" class=\"epi-overlay-blockarea-actions\"></div>\r\n\t</div>\r\n</div>"}});define("epi-cms/widget/overlay/ContentArea",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/dnd/Manager","dojo/dom-attr","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/json","dojo/on","dojo/query","dijit/_Container","dijit/registry","epi","epi/shell/widget/overlay/Item","epi/shell/dnd/Source","epi/shell/dnd/_MarkerSource","epi-cms/core/ContentReference","epi-cms/widget/overlay/Block","epi-cms/contentediting/editors/ContentBlockEditor","epi-cms/widget/command/CreateContentFromSelector","epi-cms/contentediting/viewmodel/ContentAreaViewModel","epi-cms/contentediting/viewmodel/ContentBlockViewModel","epi-cms/contentediting/editors/_TextWithActionLinksMixin","dojo/text!../templates/ContentArea.html"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,on,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19){return _2([_f,_c,_18],{templateString:_19,layout:"",defaultWatchKey:"",allowedDndTypes:null,blockClass:_13,modelClass:_16,dndSourceClass:_2([_10,_11]),dndSourceSettings:null,allowedTypes:null,restrictedTypes:null,_supressValueChanged:false,constructor:function(){this._watches={};},postMixInProperties:function(){this.inherited(arguments);if(!this.model){this.model=new this.modelClass();}this.model.set("value",_3.clone(this.contentModel.get(this.name)));this.own(this.contentModel.watch(this.name,_3.hitch(this,function(_1a,_1b,_1c){if(_e.areEqual(_1c,this.model.get("value"))){return;}this.refresh();})));this._pendingPersonalizations=[];this._ownerContentLink=this.contentModel.get("icontent_contentlink");},buildRendering:function(){this.inherited(arguments);this.setupActionLinks(this.actionsNodeControls);},postCreate:function(){this.inherited(arguments);this.own(on(this.model,"changed",_3.hitch(this,function(){if(!this._started||this._supressValueChanged){return;}this._onChildrenChanged();if(this._pendingPersonalizations.length>0){this._pendingPersonalizations=[];this.onClick(this);}})));this._setupDirectionality();this._setupBlocks();},destroy:function(){this.inherited(arguments);for(var i in this._watches){this._watches[i].remove();}this._watches={};this._source.destroy();if(this.textWithLinks){this.textWithLinks.destroy();this.textWithLinks=null;}},isCreateLinkVisible:function(){return this.model.canCreateBlock(this.allowedTypes,this.restrictedTypes);},_setHasChildrenAttr:function(_1d){this._set("hasChildren",_1d);},_getMinHeightAttr:function(){return _9.get(this.sourceItemNode,"minHeight");},onValueChange:function(_1e){},updatePosition:function(_1f){if(!this.canUpdatePosition()){return false;}var _20=this.inherited(arguments),_21,_22,_23,_24;if(this.hasChildren){this._setupDirectionality();this._positionBlocks();}_23=this.get("minHeight");_9.set(this.sourceItemNode,"minHeight","");_21=Math.floor(_8.position(this.actionsNodeControls,false).h);_22=_21>0?_21:this.get("actionNodeHeight")||0;_24=Math.floor(_8.position(this.sourceItemNode,false).h);if(_22===0){this._clearPosition();return _20;}_22&&(this.set("actionNodeHeight",_22));_9.set(this.sourceItemNode,"minHeight",(_24+_22)+"px");_9.set(this.actionsNodeControls,"marginTop",(_24)+"px");if(_23===_24+_22){return _20;}return true;},refresh:function(){this._actionNodeHeight=null;this.destroyDescendants();this._source.clearItems();if(this._source.anchor){_7.destroy(this._source.anchor);}for(var i in this._watches){this._watches[i].remove();}this._watches={};this._supressValueChanged=true;this.model.set("value",_3.clone(this.contentModel.get(this.name)));this._setupBlocks();this.inherited(arguments);this._supressValueChanged=false;},_setupDnd:function(){var _25=_3.mixin({_skipStartup:true,creator:_3.hitch(this,"_creator"),copyOnly:false,alwaysCopy:false,dropParent:this.containerNode,type:this.allowedDndTypes,accept:this.allowedDndTypes,reject:this.restrictedDndTypes,singular:true,propertyName:this.name},this.dndSourceSettings||{});this._source=new this.dndSourceClass(this.domNode,_25);this._source.defaultCheckAcceptance=this._source.checkAcceptance;this._source.checkAcceptance=_3.hitch(this,this._checkAcceptance);this.own(_4.after(this._source,"onDropData",_3.hitch(this,"_onDrop"),true));this.own(_4.before(this._source,"delItem",_3.hitch(this,"_onDndItemRemoved"),true));},_creator:function(_26){var _27=_7.create("div"),_28;if(typeof _26.getNormalizedData=="function"){_28=_26.getNormalizedData();}_28=_28?_28.data:_26;return {node:_27,type:this.allowedDndTypes,data:_28};},_setupBlocks:function(){var _29=this._getBlockNodes();_1.forEach(_29,this._createBlock,this);this.set("hasChildren",_29.length>0);},_createBlock:function(_2a){var id=_6.get(_2a,"data-epi-block-id"),_2b=_a.parse(_6.get(_2a,"data-epi-block-personalization")),_2c=_2b?_2b.contentGroup:this.defaultWatchKey,_2d=this.model;if(_2c){_2d=_2d.getChild({name:_2c});}var _2e=_2d&&_2d.getChild(_3.mixin({contentLink:new _12(id).createVersionUnspecificReference().toString()},_2b));if(!_2e){return;}var _2f=new this.blockClass({disabled:this.disabled,viewModel:_2e,sourceItemNode:_2a});this.addChild(_2f);this._watches["block_"+id+"_ensurePersonalization"]=_2e.watch("ensurePersonalization",_3.hitch(this,function(_30,_31,_32){var _33=_1.indexOf(this._pendingPersonalizations,_2e);if(_32){if(_33<0){this._pendingPersonalizations.push(_2e);}}else{if(_33>0){this._pendingPersonalizations.splice(_33,1);}}}));_2e.set("visible",true);this._source.setItem(_2f.domNode.id,{name:_2e.name,data:_2e,type:this.allowedDndTypes});},_onChildrenChanged:function(){this.onValueChange({propertyName:this.name,value:this.model.get("value")});},_positionBlocks:function(){var _34=this.getChildren(),_35=[],_36=this.get("position");_1.forEach(_34,function(_37,i){var _38,_39,_3a;if(!_35[i]){_35[i]=_8.position(_37.sourceItemNode,false);}_38=_35[i];_38.x-=_36.x;_38.y-=_36.y;_37.resize(_38);},this);},_checkAcceptance:function(_3b,_3c){if(this.readOnly||_3c===undefined){return false;}var _3d=_d.getEnclosingWidget(_3c[0]);if(_3d.isInstanceOf(_14)){return false;}return this._source.defaultCheckAcceptance(_3b,_3c);},_getBlockNodes:function(){var _3e=_b("[data-epi-block-id]",this.sourceItemNode);var _3f=_b("[data-epi-block-id] [data-epi-block-id]",this.sourceItemNode);return _1.filter(_3e,function(_40){return _3f.indexOf(_40)===-1;});},_setupDirectionality:function(){var _41;if(/vertical|horizontal/.test(this.layout)){_41=this.layout==="horizontal";}else{_41=_1.some(this._getBlockNodes(),function(_42){var _43=_9.getComputedStyle(_42),_44=/left|right/.test(_43.cssFloat),_45=/inline|inline-block/.test(_43.display);return _44||_45;});}this._source.setHorizontal(_41);},executeAction:function(_46){if(_46==="createnewblock"){var _47=new _15({creatingTypeIdentifier:"episerver.core.blockdata",createAsLocalAsset:true,treatAsSecondaryView:true,autoPublish:true,allowedTypes:this.allowedTypes,restrictedTypes:this.restrictedTypes});_47.set("model",{save:_3.hitch(this,function(_48){var _49=_3.clone(this.model.get("value"),true)||[];_49.push(_48);this.onValueChange({propertyName:this._source.propertyName,value:_49});})});_47.execute();}else{this.inherited(arguments);}},_onDrop:function(_4a,_4b,_4c,_4d){var _4e=this.model,_4f=this._source;if(_4f.anchor===_4f.targetAnchor){return;}var _50=_1.indexOf(_4f.getAllNodes(),_4f.targetAnchor)+(_4f.before?-1:1),_51=_1.filter(_4e.getChildren(),function(_52){return _52.get("visible");});_50=_4e.indexOf(_51[_50-1])+1;if(!_3.isArray(_4a)){_4a=[_4a];}if(_4f===_4b&&!_4d){_4e.modify(function(){_1.forEach(_4a,function(_53,i){var _54=_53.data;if(_54.contentGroup){_54=_4e.getChild({name:_54.contentGroup});}_4e.move(_54,_50+i);});});}else{_4e.modify(function(){_1.forEach(_4a,function(_55,i){var _56=new _17(_55.data);_4e.addChild(_56,_50+i);});});}},_onDndItemRemoved:function(key){var _57=this._source.getItem(key);if(!_3.isArray(_57)){_57=[_57];}this.model.modify(function(){_1.forEach(_57,function(_58){this.model.removeChild(_58.data);},this);},this);}});});