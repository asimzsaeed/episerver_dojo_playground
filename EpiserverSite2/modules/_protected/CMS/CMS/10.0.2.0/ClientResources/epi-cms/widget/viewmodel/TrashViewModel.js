//>>built
define("epi-cms/widget/viewmodel/TrashViewModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/lang","dojo/topic","dojo/Stateful","dojo/_base/json","epi/epi","epi/shell/_StatefulGetterSetterMixin","epi/shell/TypeDescriptorManager","epi/dependency","epi/i18n!epi/cms/nls/episerver.cms.components.trash"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _2([_6,_9],{resources:_c,trashes:null,currentTrash:null,queryOptions:null,isEmptyTrash:false,storeRegistry:null,contentStore:null,trashStore:null,showAllLanguages:true,_contentRepositoryDescriptors:null,postscript:function(){this.inherited(arguments);this.storeRegistry=_b.resolve("epi.storeregistry");this.contentStore=this.contentStore||this._getStore();this.trashStore=this.trashStore||this.storeRegistry.get("epi.cms.wastebasket");this._contentRepositoryDescriptors=_b.resolve("epi.cms.contentRepositoryDescriptors");if(!this.trashes){this._createTrashes();}},destroy:function(){_8.removeDelegateAspects(this.contentStore);},_getStore:function(){var _d=this.storeRegistry.get("epi.cms.content.light"),_e=this;var _f=_8.delegate(_d,{getChildren:function(_10,_11){var _12=_e.get("currentTrash"),_13=_e._createQueryOptions(_12);_4.mixin(_13.query,{referenceId:_10.contentLink});return this.query(_13.query,_13.options);},mayHaveChildren:function(_14){return _14.hasChildren;}},["notify"]);return _f;},_createTrashes:function(){_3.when(this.trashStore.query(),_4.hitch(this,function(_15){this.set("trashes",_4.clone(_15));}));},_setCurrentTrashAttr:function(_16){this._set("currentTrash",_16);if(_16.isRequireLoad){this.updateTrash(_16);_16.isRequireLoad=false;}},getEmptyTrashConfirmMessage:function(_17){var _18=_c.emptytrash.singleproviderdescription;if(this.trashes.length>1){_18=_c.emptytrash.description.replace("{0}",_17);}return _18;},updateTrash:function(_19){if(_19&&_19.active){this.set("queryOptions",this._createQueryOptions(_19));}else{this.set("queryOptions",null);}},_createQueryOptions:function(_1a){var _1b={referenceId:_1a.wasteBasketLink,query:"getchildren"};var _1c={ignore:["query"],comparers:this._createComparers()};if(this.showAllLanguages){_4.mixin(_1b,{allLanguages:this.showAllLanguages});_1c.ignore.push("allLanguages");}if(_1a.deletedBy){_4.mixin(_1b,{deletedBy:_1a.deletedBy});}if(_1a.isSearchable){_4.mixin(_1b,{isSearchable:_1a.isSearchable});_1c.ignore.push("isSearchable");}if(_1a.queryText){_4.mixin(_1b,{query:"searchdeletedcontent"});_4.mixin(_1b,{matchProvider:true});_4.mixin(_1b,{queryText:_1a.queryText});}return {query:_1b,options:_1c};},_createComparers:function(){return {referenceId:function(_1d,_1e){return _1d===_1e.parentLink;}};},emptyTrash:function(_1f){if(_1f){_3.when(this.trashStore.executeMethod("Empty",_1f),_4.hitch(this,function(_20){var _21=_1.filter(this.get("trashes"),function(_22){return _22&&_22.wasteBasketLink===_1f;});_1.forEach(_21,function(_23){_23.deletedByUsers=[];_23.isRequireLoad=true;_23.deletedByUsers=[];});this.isEmptyTrash=true;_5.publish("/epi/cms/trash/empty",_20.extraInformation);if(this.currentTrash.wasteBasketLink===_1f){this.set("currentTrash",this.currentTrash);}}),_4.hitch(this,function(_24){if(_24.status===403){this.set("actionResponse",_c.emptytrash.accessdenied);}}));}},restore:function(_25,_26){if(_25&&_25.contentLink&&_25.isDeleted&&_26){_3.when(this.contentStore.move(_25.contentLink,{targetId:_26}),_4.hitch(this,function(_27){if(_27){this.contentStore.refresh(_25.contentLink);if(_25.parentLink!==this.currentTrash.wasteBasketLink){this.contentStore.refresh(_25.parentLink).then(_4.hitch(this,function(){this.updateTrash(this.currentTrash);}));}var _28=this.contentStore.get(_26);if(_28&&!_28.hasChildren){this.contentStore.refresh(_26).then(function(_29){_5.publish("/epi/cms/contentdata/restored",_29);});}}}),_4.hitch(this,function(_2a){this.set("actionResponse",_2a.xhr?_7.fromJson(_2a.xhr.responseText):_c.restore.error);}));}},getOldParent:function(_2b){var df=new _3();_3.when(this.contentStore.query({referenceId:_2b,query:"getrestorepoint",allLanguages:true}),function(_2c){var _2d=_2c&&_4.isArray(_2c)&&_2c.length>0?_2c[0]:null;df.resolve(_2d);});return df;}});});