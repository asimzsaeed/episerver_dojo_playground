//>>built
define("epi-cms/widget/viewmodel/_UpdateableStoreModelMixin",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/Evented","dojo/json","dojo/topic","dojo/when","epi/dependency","epi-cms/ApplicationSettings","epi-cms/_ContentContextMixin","epi-cms/core/ContentReference"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _2(_5,{updateableStore:null,updateableStoreKey:"epi.cms.contentdata",currentContentService:null,propertyNames:{name:"icontent_name",nameInUrl:"iroutable_routesegment"},refreshTranslatedAncestors:true,onAddDelegate:null,postscript:function(){this._setupStore();this.currentContentService=new _b();},_setupStore:function(){if(!this.updateableStore&&this.updateableStoreKey){this.updateableStore=_9.resolve("epi.storeregistry").get(this.updateableStoreKey);}},rename:function(id,_d){var _e=this,_f=new _4();_8(_e.patch(id,{name:_d,nameInUrl:null}),function(_10){_8(_e.refreshTranslated(id),function(){_f.resolve(_10);},function(e){_f.reject(e);});},function(e){_f.reject(e);});return _f;},translate:function(_11){var _12=this,id=_12.getIdentity(_11),_13={masterLanguageVersionId:id,name:_11.name,contentTypeId:_11.contentTypeID};return _8(_12.updateableStore.put(_13),function(){_8(_12.store.refresh(id),function(){_8(_12.refreshTranslated(id),function(){_12.onSelect(id,true,_12.onAddDelegate);});});});},add:function(_14,_15){var _16=this;var def=new _4();_8(_16.updateableStore.add(_14),function(_17){var id=_16.getContentId(_17),_18=_16.getParentIdentity(_14),_19=null;_8(_16.updateableStore.get(id),function(_1a){if(_16.getParentIdentity(_1a)!==_18){_19=typeof _15=="function"&&_15();}_8(_19,function(){_8(_16._childrenChanged(_18),function(){_8(_16.refreshTranslated(id),function(){_16.onSelect(id,true,_16.onAddDelegate);def.resolve(_1a);});});});});});return def.promise;},patch:function(id,_1b){var _1c=this,_1d=new _4(),_1e={id:id,properties:{}};for(var key in _1b){if(_1b.hasOwnProperty(key)){_1e.properties[this._convertPropertyName(key)]=_6.stringify(_1b[key]);}}_8(_1c.updateableStore.patch(_1e,{id:_1e.id}),function(_1f){if(_1f&&_1f.successful){var _20={contentLink:id,properties:_1e.properties,capabilities:{supportsVersions:false}};_3.mixin(_20,_1b);_8(_1c.updateableStore.patchCache(_20),_1d.resolve,_1d.reject);}else{return _1d.reject(_1f&&_1f.validationErrors);}});return _1d;},_convertPropertyName:function(_21){return this.propertyNames[_21]||_21;},refreshTranslated:function(_22){var _23=this,_24=new _4(),_25;function _26(_27){var id=_23.getIdentity(_27),_28=_23.getParentIdentity(_27);if(_28===_23.root||id===_23.root||!_27.missingLanguageBranch){return false;}return true;};if(!_23.refreshTranslatedAncestors){return _24.resolve();}_8(_23.refreshAncestors(_22,_26),function(_29){if(!(_29 instanceof Array)||_29.length===0){_24.resolve();return;}_29.reverse();var _2a=_1.some(_29,function(_2b){if(!!_2b.missingLanguageBranch){_25=_23.getLabel(_2b);return true;}return false;});_8(_23.store.get(_22),function(_2c){if(_2a&&_2c&&!_2c.missingLanguageBranch){_23.emit("translationFailed",_25);}_24.resolve();});});return _24;},getContentId:function(_2d){return _c.toContentReference(_2d).id.toString();},_onPasteComplete:function(_2e,_2f,_30,_31,_32){if(!_2e){return;}if(!_30){this.refreshTranslated(this.getIdentity(_2e));}else{this.currentContentService.getCurrentContent().then(_3.hitch(this,function(_33){var _34=_c.compareIgnoreVersion(_2e,_33)&&_33.isDeleted;if(!_34){return;}var _35=this._createQuery({referenceId:this.getIdentity(_31),query:this.getChildrenQuery},true);_8(this.store.query(_35,this._queryOptions),_3.hitch(this,function(_36){var _37=_31?_31.contentLink:null;if(!_36||!(_36 instanceof Array)||_36.length<=0){_37=_a.startPage;}if(_37){var _38={uri:"epi.cms.contentdata:///"+_37};_7.publish("/epi/shell/context/request",_38);}}));})).otherwise(function(){});}}});});