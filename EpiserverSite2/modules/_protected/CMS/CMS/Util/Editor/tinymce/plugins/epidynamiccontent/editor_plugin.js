(function(e,t){e.dom.Event,e.PluginManager.requireLangPack("epidynamiccontent"),e.create("tinymce.plugins.epidynamiccontent",{_onInitCalled:!1,init:function(t,n){var i=this;if("undefined"!=typeof EPi&&"function"==typeof EPi.ResolveUrlFromUI){if("undefined"==typeof epiContentBlockUtilities){var o=e.baseURI.toAbsolute("plugins/epipersonalizedcontent/epicontentblockutilities.js");e.ScriptLoader.load(o,function(){this._init(t,n)},this),e.ScriptLoader.loadQueue()}else this._init(t,n);t.addButton("epidynamiccontent",{title:"epidynamiccontent.desc",cmd:"mceEPiDynamicContent"}),t.onInit.add(function(){i._onInitCalled=!0})}},_init:function(n,i){t.extend(this,epiContentBlockUtilities);var o,a=this;a._url=i,a.ed=n,a._disabled=!1,o=a._dynamicContentClass=n.getParam("epidynamiccontent_cssclass","epi_dc"),a._enabledControls=n.getParam("epidynamiccontent_enabledcontrols",""),n.addCommand("mceEPiDynamicContent",function(){var e=t.extend({},n.settings.epi_page_context);t(document).trigger("epi.loading.page_context",e);var i=EPi.ResolveUrlFromUI("Editor/Dialogs/DynamicContent.aspx")+"?"+t.param(e),o=null,r=function(e){var t=n.selection;if(!e)return n.windowManager.onClose.dispatch(),void 0;o&&t.select(o),n.getWin().focus();var i=a._getParentContentBlock(t.getNode());i&&n.dom.remove(i),i=e.match("^<div")?a._insertContent(e):a._insertInlineContent(e),a._moveToAdjacentNode(i,!0),a._onContentChanged(),n.windowManager.onClose.dispatch()},s=n.selection;o=a._getParentContentBlock(s.getStart());var l={width:600,height:640},d=a._getAllContentGroups(n);if(o){var c=EPi.ResolveUrlFromUtil("../App_Themes/Default/Styles/system.css"),u=o.getAttribute("data-groups"),m=u?u.replace(/"/g,"&quot;"):"",p=o.getAttribute("data-contentgroup"),g=p?p.replace(/"/g,"&quot;"):"",h='<html xmlns="http://www.w3.org/1999/xhtml"><head><link href="'+c+'" type="text/css" rel="stylesheet" /><title></title></head><body onload="document.forms[0].submit()">'+'<form action="'+i+'" method="post">'+'<input name="state" type="hidden" value="'+o.getAttribute("data-state").replace(/"/g,"&quot;")+'" />'+'<input name="hash" type="hidden" value="'+o.getAttribute("data-hash").replace(/"/g,"&quot;")+'" />'+'<input name="dynamicclass" type="hidden" value="'+o.getAttribute("data-dynamicclass").replace(/"/g,"&quot;")+'" />'+'<input name="groups" type="hidden" value="'+m+'" />'+'<input name="contentgroup" type="hidden" value="'+g+'" />'+'<input name="allcontentgroups" type="hidden" value="'+d+'" />'+"</form></body></html>";n.windowManager.onOpen.dispatch();var v=EPi.CreateDialog("",r,null,null,l);v._dialog.document.write(h),v._dialog.document.close()}else i+="&allcontentgroups="+d,n.windowManager.onOpen.dispatch(),EPi.CreateDialog(i,r,null,null,l)});var r=function(n){var i=t(n.getBody());i.length&&i.bind("drop",function(e){return t(e.target).closest("."+o).length?!1:void 0}),t(n.dom.doc).click(function(e){a._handleButtonsClick(e)}),n.onNodeChange.addToTop(function(t,n,i,o,r){var s=t.selection,l=null;if(l=s.isCollapsed()?a._getParentContentBlock(s.getNode()):a._getParentContentBlock(s.getStart())||a._getParentContentBlock(s.getEnd()),e.isIE&&!l&&s.isCollapsed()){var d=t.selection.getRng(!0),c=d.commonAncestorContainer;c&&1===c.nodeType&&t.dom.hasClass(c.childNodes[d.startOffset],a._dynamicContentClass)&&(l=c.childNodes[d.startOffset])}if(l){a._selectContentBlock(t,l),a._updateCommandState(!1),a._showButton(t,n,!0,!0),e.isIE&&o&&(t.dom.hasClass(i,"epi_dc_editBtn")||t.dom.hasClass(i,"epi_dc_previewBtn"))&&a._handleButtonsClick({target:i,button:0});var u=1===r.initial;return u||a._updateUndoRedoButtons(n),u}a._updateCommandState(!0),a._showButton(t,n,o,!1)}),n.onKeyDown.addToTop(function(t,n){if(!(37>n.keyCode||n.keyCode>40)||13==n.keyCode||8==n.keyCode||46==n.keyCode||32==n.keyCode){var i=t.selection,o=a._getParentContentBlock(i.getNode());if(8!=n.keyCode&&46!=n.keyCode){if(o){if(13==n.keyCode)return a._handleEnterKey(),void 0;if(n.keyCode>=37&&40>=n.keyCode){var r=39==n.keyCode||40==n.keyCode;return a._moveToAdjacentNode(o,r),e.dom.Event.cancel(n)}}}else if(a._handleDeleteKeys(o||a._getParentContentBlock(i.getEnd()),8===n.keyCode))return e.dom.Event.cancel(n)}})};a._onInitCalled?r(n):n.onInit.add(r)},_showButton:function(e,t,n,i){var o=e.dom.isHidden(e.container);t.setDisabled("epidynamiccontent",o||!n),t.setActive("epidynamiccontent",!o&&i)},_handleButtonsClick:function(n){return this.ed.dom.hasClass(n.target,"epi_dc_editBtn")&&0===n.button?(this._hidePreview(),this._focusSelection(n),tinyMCE.execCommand("mceEPiDynamicContent")):t(n.target).is(".epi_dc_previewBtn")&&0===n.button?(this._focusSelection(n),this._showPreview(n.target)):this._hidePreview(),e.dom.Event.cancel(n)},_focusSelection:function(t){(e.isIE||this.ed.selection.getRng().collapsed)&&this.ed.selection.collapse(),this.ed.focus();var n=this._getParentContentBlock(t.target);this.ed.selection.select(n)},_createNewNode:function(e){return e?this.ed.getDoc().createTextNode(""):this.ed.dom.create("p",null,'<br _mce_bogus="1" />')},_getParentContentBlock:function(e){return this._getParentNode(e,this._dynamicContentClass)},getInfo:function(){return{longname:"Dynamic content plugin",author:"EPiServer AB",authorurl:"http://www.episerver.com",infourl:"http://www.episerver.com",version:1.1}},_moveToAdjacentNode:function(e,n){nodeIsInline=!this.ed.dom.isBlock(e);var i;n?(nodeIsInline&&(i=e.nextSibling),i||(i=t(e).next()[0]),i&&"BR"!=i.tagName||(i=this._createNewNode(nodeIsInline),this.ed.dom.insertAfter(i,e)),this._moveSelection(i,!0)):(nodeIsInline&&(i=e.previousSibling),i||(i=t(e).prev()[0]),i||(i=this._createNewNode(nodeIsInline),e.parentNode.insertBefore(i,e)),this._moveSelection(i,!1))},_block:function(t,n){var i=n.keyCode;if(!(i>32&&41>i||i>111&&124>i||n.ctrlKey||n.metaKey)&&("keydown"!=n.type||13!=i&&46!=i&&8!=i))return e.dom.Event.cancel(n)},_handleEnterKey:function(){var e=this._getParentContentBlock(this.ed.selection.getNode());this._isNull(e)||(this._ensureInitialUndoLevel(),this._insertParagraphBefore(e),this._onContentChanged())},_handleDeleteKeys:function(e,t){if(!this._isNull(e))return this._ensureInitialUndoLevel(),this.ed.dom.remove(e),this._onContentChanged(),!0;if(!this.ed.selection.isCollapsed())return!1;var n=this.ed.selection.getRng(!0);if(t){var i=this._getCaretPosition(n.startContainer),o=this._getPreviousCaretNode(n.startContainer);if(0===i&&!this._isNull(o)&&this.ed.dom.hasClass(o,this._dynamicContentClass))return this._selectContentBlock(this.ed,o),!0}else{var i=this._getCaretPosition(n.endContainer),a=this._getNextCaretNode(n.endContainer,i);if(this._caretIsAtTheEnd(n.endContainer,i)&&!this._isNull(a)&&this.ed.dom.hasClass(a,this._dynamicContentClass))return 0==i&&this.ed.dom.remove(this.ed.selection.getNode()),this._selectContentBlock(this.ed,a),!0}return!1},_url:null,_previewedDynamicContent:null,_previewVisible:!1,_lastSelection:null,_showPreview:function(e){this._hidePreview()&&t(window["epi-dcPreview"].document.documentElement).remove();var n=t("<div/>",this.document).append(t(e).closest(".epi_dc").clone()).html();this._previewedDynamicContent=n;var i=this;setTimeout(function(){if(n===i._previewedDynamicContent){i._previewVisible=!0,i._lastSelection=e;var o=t("iframe",i.ed.container),a=i._getPositionInParentFrame(e,i.ed.contentWindow,o,window),r=i.ed.settings.editorwidth?i.ed.settings.editorwidth:i.ed.settings.width,s=i._createPopupIframe(a,"epi-dcPreview",r,[{onclick:function(){i._openEditDialog(i.ed),i._hidePreview()},text:i.ed.translate("epidynamiccontent.edit")},{onclick:function(){i._hidePreview()},text:i.ed.translate("epidynamiccontent.close")}]),l=i._getPreviewUrl(),d={DynamicContent:n};i._postFrameTo(s,l,d),t(window).bind("resize.dynamicContent",function(){var n=i._getPositionInParentFrame(e,i.ed.contentWindow,o,window),a=t("#epi-dcPreview");a.css(n)})}},250)},_getPreviewUrl:function(){var e="Editor/Dialogs/DynamicContentPreview.aspx",n=jQuery.extend({content_css:this.ed.settings.content_css},this.ed.settings.epi_page_context);return t(document).trigger("epi.loading.page_context",n),EPi.ResolveUrlFromUI(e+"?"+jQuery.param(n))},_openEditDialog:function(){this.ed.focus();var e=this._getParentContentBlock(this._lastSelection);this.ed.selection.select(e),tinyMCE.execCommand("mceEPiDynamicContent")},_hidePreview:function(){return this._previewedDynamicContent=null,this._previewVisible?(this._previewVisible=!1,this._lastSelection=null,t("#epi-dcPreview").hide(),t(window).unbind("resize.dynamicContent"),!0):!1},_getPositionInParentFrame:function(n,i,o,a){var r=t(o).offset(),s=t(n).position(),l={y:t(a).scrollTop(),x:t(a).scrollLeft()},d={y:Math.max(t(i.document.body).scrollTop(),t(i.document.documentElement).scrollTop()),x:t(i.document.body).scrollLeft()},c={top:r.top+s.top-l.y-d.y,left:r.left+s.left+Math.min(t(n).width()+10,t(o).width())-l.x-d.x};l.y>0&&(e.isGecko||e.isWebKit)&&(c.top+=d.y),e.isIE&&(c.top+=l.y);var u=t(a),m=c.top+300,p=l.y+u.height();m>p&&(c.top=Math.max(l.y,c.top-m+p));var g=this.ed.settings.editorwidth?this.ed.settings.editorwidth:this.ed.settings.width;m=c.left+parseInt(g,10)+24;var h=l.x+u.width();return m>h&&(c.left=Math.max(l.x,c.left-m+h)),c},_createPopupIframe:function(e,n,i,o){var a=this,r=t("#"+n).show();if(0===r.length&&(r=t("<div id='"+n+"' class='epi-dcPreviewBorder'><iframe frameborder='0' style='height:300px;' class='episystemiframe' name='"+n+"' src=''></iframe><div id='epi-dcPreviewButtons'></div><div id='epi-dcPreviewDescription'></div></div>").appendTo(window.document.body),t(window.document.body).mousedown(function(){a._hidePreview()})),r.css({position:"absolute",top:e.top,left:e.left,width:i}).children("iframe").css({height:"250px",width:"100%"}),o){t("#epi-dcPreviewButtons").html("");for(var s in o)t("<span class='epi-cmsButton'><input type='button' value='"+o[s].text+"'/></span>").appendTo("#epi-dcPreviewButtons").click(o[s].onclick)}var l=window[n];return l},_postFrameTo:function(e,t,n){var i='<html xmlns="http://www.w3.org/1999/xhtml" style="height:100%;background:#fff url('+EPi.ResolveUrlFromUtil("../App_Themes/Default/Images/General/AjaxLoader.gif")+') no-repeat 50% 50%"><head><title></title></head><body>';i+='<form action="'+t+'" method="post">';var o;for(o in n)i+='<input name="'+o+'" id="'+o+'" type="hidden" />';i+="</form></body></html>",e.document.write(i);for(o in n)e.document.getElementById(o).value=n[o];e.document.forms[0].submit()}}),e.PluginManager.add("epidynamiccontent",e.plugins.epidynamiccontent)})(tinymce,epiJQuery);