(function(e,t){e.create("tinymce.plugins.epilink",{init:function(n){"undefined"!=typeof EPi&&"function"==typeof EPi.ResolveUrlFromUI&&(n.addCommand("mceEPiLink",function(){var o="",r=n.selection,a=r.getNode(),s=n.dom,l=s.getParent(a,"A"),d={},c={},u=r.getRng();if(!r.isCollapsed()||l){e.isIE&&!l&&"P"===a.tagName&&1===a.childNodes.length&&"A"===a.childNodes[0].tagName&&(l=a.childNodes[0]),l&&(o=s.getAttrib(l,"href")),o.length&&(c.href=o,c.target=s.getAttrib(l,"target"),c.title=s.getAttrib(l,"title")),c.text="none";var m=n.settings.epi_page_context,g=t.extend({},m,{hideclearbutton:!0}),p=EPi.ResolveUrlFromUI("edit/FileManagerBrowser.aspx")+"?"+t.param(g);c.fileManagerBrowserUrl=p,c.parentWindow=window;var h=Array(),v=t("a",n.getDoc());v.each(function(){t(this).attr("name")!==void 0&&t(this).attr("name").length>0&&(t(this).attr("href")===void 0||0===t(this).attr("href").length)&&h.push(t(this).attr("name"))}),c.anchors=h.sort(),c.imageObject=d;var f=function(t){var o,a,d;if(t)if("-1"==t&&l)o=l.innerHTML,s.setOuterHTML(l,o),n.undoManager.add();else if(0!==t){a=t.isUpdated;var c={href:t.href,title:t.title,target:t.target?t.target:null};if(l)r.select(l),s.setAttribs(l,c),n.undoManager.add();else{for(r.setRng(u),n.getDoc().execCommand("unlink",!1,null),n.execCommand("CreateLink",!1,"#mce_temp_url#",{skip_undo:1}),d=e.grep(s.select("a"),function(e){return"#mce_temp_url#"==s.getAttrib(e,"href")}),i=0;d.length>i;i++)s.setAttribs(d[i],c);if(d.length>0){var m=n.dom.createRng();m.selectNodeContents(d[0]),n.selection.setRng(m)}n.undoManager.add()}}n.windowManager.onClose.dispatch()},y=EPi.ResolveUrlFromUI("editor/dialogs/HyperlinkProperties.aspx?diablecontentedit=true");y+="&url="+encodeURIComponent(o),n.windowManager.onOpen.dispatch(),EPi.CreateDialog(y,f,null,c,{width:800,height:650,scrollbars:"no"})}}),n.addButton("epilink",{title:"epilink.desc",cmd:"mceEPiLink","class":"mce_epilink"}),n.addShortcut("ctrl+k","epilink.desc","mceEPiLink"),n.onNodeChange.add(function(e,t,n,i){var o=e.dom.getParent(n,"a",e.getBody())||("A"===n.tagName?n:null);o&&o.innerHTML===e.selection.getContent()&&e.selection.select(o),t.setDisabled("epilink",i&&null===o),t.setActive("epilink",null!==o&&!o.name)}))},getInfo:function(){return{longname:"Link plugin",author:"EPiServer AB",authorurl:"http://www.episerver.com",infourl:"http://www.episerver.com",version:"1.0"}}}),e.PluginManager.add("epilink",e.plugins.epilink)})(tinymce,epiJQuery);