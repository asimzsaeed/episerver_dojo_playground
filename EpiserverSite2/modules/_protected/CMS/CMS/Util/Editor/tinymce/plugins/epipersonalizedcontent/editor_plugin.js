(function(e,t){e.create("tinymce.plugins.epipersonalizedcontent",{_onInitCalled:!1,init:function(t,n){var i=this;if("undefined"==typeof epiContentBlockUtilities){var o=e.baseURI.toAbsolute("plugins/epipersonalizedcontent/epicontentblockutilities.js");e.ScriptLoader.load(o,function(){this._init(t,n)},this),e.ScriptLoader.loadQueue()}else this._init(t,n);t.addButton("epipersonalizedcontent",{title:"epipersonalizedcontent.epipersonalizedcontent_desc",cmd:"epipersonalizedcontent","class":"mce_epipersonalizedcontent"}),t.onInit.add(function(){i._onInitCalled=!0})},_init:function(n){t.extend(this,epiContentBlockUtilities);var i=this;i._pcIsSelecting=!1,i._pcInClipboard=!1,i._pcDragging=!1,i._selectedPcHeader=null,i._activePcBlock=null,i._personalizedContentHeaderClass=n.getParam("epipersonalizedcontent_headercssclass","epi_pc_h"),i._personalizedContentFooterClass=n.getParam("epipersonalizedcontent_footercssclass","epi_pc_f"),i._personalizedContentClass=n.getParam("epipersonalizedcontent_cssclass","epi_pc"),i._personalizedContentHolderClass=n.getParam("epipersonalizedcontent_holdercssclass","epi_pc_content"),i.ed=n,i._disabled=!1,i._enabledControls=n.getParam("epipersonalizedcontent_enabledcontrols",""),n.addCommand("epipersonalizedcontent",function(){if(!i._validateAndCorrectSelection())return n.windowManager.alert(n.translate("epipersonalizedcontent.invalidselectionwarning")),void 0;var o=i._getParentContentBlock(i._getCommonAncestor()),r=function(e){if(!e)return n.windowManager.onClose.dispatch(),void 0;var r,a,s;if(e.removePersonalization)s=n.dom.select("."+i._personalizedContentHolderClass,o)[0],r=s.innerHTML,n.dom.setOuterHTML(o,r);else if(o)s=n.dom.select("."+i._personalizedContentHolderClass,o),r=t(s).html(),a=e.replace("[personalizedContentPlaceHolder]",r),n.dom.setOuterHTML(o,a);else{if(r=n.selection.getContent(),""===r)r='<p><br mce_bogus="1" /></p>';else{var l={content:r};n.onBeforeSetContent.dispatch(this,l),r=l.content}a=e.replace("[personalizedContentPlaceHolder]",r),a=a.replace(i._personalizedContentHolderClass,i._personalizedContentHolderClass+" mce_bogus"),i._insertContent(a),s=n.dom.select("div.mce_bogus")[0],i._normalizeContentNode(s),n.dom.removeClass(s,"mce_bogus");var d=t(s).children(":last")[0];n.onSetContent.dispatch(n),i._moveSelection(d,!1)}n.undoManager.add(),n.nodeChanged(),n.windowManager.onClose.dispatch()},a={width:600,height:450},s=EPi.ResolveUrlFromUI("Editor/Dialogs/PersonalizedContent.aspx"),l={allContentGroups:i._getAllContentGroups()};if(!e.isIE){var d=n.selection.getNode(),c="BODY"!==d.nodeName&&"LI"!==d.nodeName&&"TD"!==d.nodeName;c&&n.selection.getStart()===n.selection.getEnd()&&n.selection.select(d)}if(o)l.groups=n.dom.getAttrib(o,"data-groups",""),l.contentGroup=n.dom.getAttrib(o,"data-contentgroup","");else if(n.selection.isCollapsed())return;n.windowManager.onOpen.dispatch(),EPi.CreateDialog(s+"?"+t.param(l),r,null,null,a)});var o=function(n){var o=t(n.getBody());o.length&&(t(o).bind("drop",function(e){var r=e.srcElement||e.originalTarget;return r===o[0]&&r.ownerDocument.elementFromPoint&&(r=r.ownerDocument.elementFromPoint(e.clientX,e.clientY)),r===o[0]&&(r=n.selection.isCollapsed()?n.selection.getNode():r),t(r).closest("."+i._personalizedContentClass).length&&!t(r).closest("."+i._personalizedContentHolderClass).length?!1:i._pcDragging&&t(r).closest("."+i._personalizedContentClass).length?!1:void 0}),o.bind("dragstart",function(){i._pcDragging=i._selectionContainsPC()?!0:!1}),o.bind("dragend",function(){i._pcDragging&&(i._pcDragging=!1)}),o.bind("cut",function(){i._pcInClipboard=i._selectionContainsPC()?!0:!1}),o.bind("copy",function(){i._pcInClipboard=i._selectionContainsPC()?!0:!1}),o.bind("paste",function(e){return i._pcInClipboard&&t(e.srcElement||e.originalTarget).closest("."+i._personalizedContentClass).length?(i._toCancelPasting=!0,!1):void 0})),t(n.dom.doc).click(function(e){n.dom.hasClass(e.target,"epi_pc_editBtn")&&0===e.button&&i._handleButtonsClick(e)}),e.isIE?(t(n.getBody()).blur(function(){i._onEditorDeactivated()}),n.dom.bind(n.getDoc(),"controlselect",function(e){if(i._isIE9StandardMode())return!0;var t=e.target;return i._pcIsSelecting||!n.dom.getParent(t,"."+i._personalizedContentHeaderClass)&&!n.dom.getParent(t,"."+i._personalizedContentFooterClass)?void 0:(i._pcIsSelecting=!0,setTimeout(function(){var e=i._getParentContentBlock(t);e&&(i._handlePCSelection(e),i._pcIsSelecting=!1)},1),!1)})):t(n.dom.doc).blur(function(){i._onEditorDeactivated()})};i._onInitCalled?o(n):n.onInit.add(o),n.onPreProcess.add(function(e,t){t.get&&(e.dom.removeClass(e.dom.select("div.mceSelected"),"mceSelected"),e.dom.setAttrib(e.dom.select("div."+i._personalizedContentClass),"contentEditable",null))}),n.onNodeChange.addToTop(function(n,o,r,a,s){if(1===s.initial)return i._showButton(n,o,!1,!1),void 0;e.isIE&&a&&n.dom.hasClass(r,"epi_pc_editBtn")&&i._handleButtonsClick({target:r}),a||(r=i._getCommonAncestor());var l,d=n.selection,c=i._getParentContentBlock(d.getStart()),u=i._getParentContentBlock(d.getEnd()),m=!1,g=(c||u)&&c!==u,p=i._overlapsHeadingMargin(d);g||p?(l=c||u,r=l,m=!0):l=i._getParentContentBlock(r),l&&!i._pcIsSelecting&&(n.dom.hasClass(r,i._personalizedContentClass)&&(n.selection.isCollapsed()||"Control"==n.selection.getSel().type)||n.dom.getParent(r,"."+i._personalizedContentHeaderClass)||n.dom.getParent(r,"."+i._personalizedContentFooterClass)||m)&&(i._pcIsSelecting=!0,setTimeout(function(){if(m&&e.isIE){var t=c?d.getEnd():u?d.getStart():null;t&&n.selection.select(t)}i._handlePCSelection(l),i._pcIsSelecting=!1},1)),n.dom.hasClass(r,i._personalizedContentHolderClass)&&(i._normalizeContentNode(r),a&&i._moveSelection(t(r).children(":last")[0],!1));var h=i._getParentContentBlockHeader(r)||i._getPCContentBlockHeader(r);i._updateSelectedElements(r,l,h);var v=null===h;i._updateCommandState(null===h);var f=!i._isNull(l)||!a;return i._showButton(n,o,f,!i._isNull(l)),v||i._updateUndoRedoButtons(o),v}),n.onPaste.add(function(t,n){return i._toCancelPasting?(i._toCancelPasting=!1,e.dom.Event.cancel(n)):(setTimeout(function(){for(var e=t.dom.select(".mceSelected."+i._personalizedContentClass),n=0;e.length>n;n++)t.dom.removeClass(e[n],"mceSelected")},1),void 0)}),n.onKeyUp.addToTop(function(e,t){var n=t.keyCode;if(n>=37&&40>=n){var o=i._getCommonAncestor(),r=i._getParentContentBlock(o);if(r){var a=r===o?i._getCaretPosition(o):0,s=r===o&&0==a,l=r===o&&a>0;e.dom.getParent(o,"."+i._personalizedContentHeaderClass);var d=e.dom.getParent(o,"."+i._personalizedContentFooterClass);37==n||38==n?s?i._moveUp(r,!1):(l||d)&&i._moveUp(r,!0):(39==n||40==n)&&(l||d)&&i._moveDown(r,!1)}}}),n.onKeyDown.addToTop(function(t,n){var o=n.keyCode;if(o>=37&&40>=o||8==o||46==o||13==o){if(!(n.shiftKey&&o>=37&&40>=o)){var r,a=i._getCommonAncestor();if(t.selection.getRng()&&t.selection.getRng().item){var s=t.selection.getRng().item(0);r=t.dom.hasClass(s,i._personalizedContentClass)?s:null,r&&(r.removeAttribute("contentEditable"),document.selection&&document.selection.empty())}else r=i._getParentContentBlock(a);if(r){var l=!1;if(r!==a||39!=o&&40!=o)if(37==o||38==o){if(r===a)l=i._moveUp(r,!1);else if(e.isIE){var d=i._getPreviousCaretNode(a);t.dom.hasClass(d,i._personalizedContentHeaderClass)&&0==i._getCaretPosition(a)&&(i._moveSelection(d,!0),l=!0)}}else 46==o||8==o?l=i._handleDeletion(r,8==o):13==o&&(l=i._handleEnterKey(r));else l=i._moveDown(r,!0);return l?e.dom.Event.cancel(n):void 0}if(46==o||8==o){if(i._validateSelectionBeforeDeletion())return e.dom.Event.cancel(n);if(t.selection.isCollapsed()){var c=t.selection.getNode(),d=i._getPreviousCaretNode(c);if(8==o&&d&&t.dom.hasClass(d,i._personalizedContentClass)&&0==i._getCaretPosition(c))return i._moveUp(d,!0),e.dom.Event.cancel(n);var u=i._getNextCaretNode(c);if(46==o&&u&&t.dom.hasClass(u,i._personalizedContentClass)){var m=i._getCaretPosition(c);if(i._caretIsAtTheEnd(c,m))return i._moveDown(u,!0),0==m&&t.dom.remove(c),e.dom.Event.cancel(n)}}}}}else if(t.dom.getParent(t.selection.getStart(),"."+i._personalizedContentClass)&&!t.dom.getParent(t.selection.getStart(),"."+i._personalizedContentHolderClass)&&!n.ctrlKey&&!n.metaKey)return e.dom.Event.cancel(n)})},_showButton:function(e,t,n,i){var o=e.dom.isHidden(e.container);t.setDisabled("epipersonalizedcontent",o||!n),t.setActive("epipersonalizedcontent",!o&&i)},_handleButtonsClick:function(t){return this._focusSelection(t),tinyMCE.execCommand("epipersonalizedcontent"),e.dom.Event.cancel(t)},_focusSelection:function(t){if((e.isIE||this.ed.selection.getRng().collapsed)&&this.ed.selection.collapse(),this.ed.focus(),e.isIE){var n=this._getParentContentBlock(t.target);this.ed.selection.select(n)}else this.ed.selection.select(t.target)},_handlePCSelection:function(t){var n=this;n._selectContentBlock(n.ed,t);var i=function(o){if(n.ed.dom.unbind(n.ed.dom.doc,"click",i),t&&t.parentNode){n._deselectContentBlock(n.ed,t),n._updateSelectedElements(t,t,null),n._updateCommandState(!0);var r=o.originalTarget||o.srcElement;return n.ed.dom.getParent(r,"."+n._personalizedContentClass)?(n._moveDown(t,!0),e.dom.Event.cancel(o)):void 0}};n.ed.dom.unbind(n.ed.dom.doc,"click",i),n.ed.dom.bind(n.ed.dom.doc,"click",i)},_handleEnterKey:function(e){var t=this._getParentContentBlockHolder(this._getCommonAncestor());if(this._isNull(t)){if(pcHeader=this._getParentContentBlockHeader(this._getCommonAncestor())||this._getPCContentBlockHeader(this._getCommonAncestor()),!this._isNull(pcHeader))return this._ensureInitialUndoLevel(),this._insertParagraphBefore(e),this._onContentChanged(),!0}else this._normalizeContentNode(t);return!1},_onEditorDeactivated:function(){this._isNull(this._selectedPcHeader)||(this.ed.dom.removeClass(this._selectedPcHeader.parentNode,"mceSelected"),this._selectedPcHeader=null)},_updateSelectedElements:function(e,t,n){if(this._selectedPcHeader!==n){this._isNull(this._selectedPcHeader)||(this.ed.dom.removeClass(this._selectedPcHeader.parentNode,"mceSelected"),this._selectedPcHeader=null);var i=this._getParentContentBlockHolder(e);this._activePcBlock===i||(this._isNull(this._activePcBlock)||(this._normalizeContentNode(this._activePcBlock),this._activePcBlock=null),this._isNull(i)||(this._activePcBlock=i)),null!==n&&(this.ed.dom.addClass(t,"mceSelected"),this._selectedPcHeader=n)}},_validateAndCorrectSelection:function(){var e=this._getCommonAncestor(),t=this.ed.selection.getStart(),n=this.ed.selection.getEnd();if(t!==n&&(this._isInvalidPartialSelectionElement(t)||this._isInvalidPartialSelectionElement(n)))return"TR"==e.nodeName||"TH"==e.nodeName||"TBODY"==e.nodeName||"THEAD"==e.nodeName?(e=this.ed.dom.getParent(e,"table"),this.ed.selection.select(e),!0):"TABLE"==e.nodeName||"UL"==e.nodeName||"OL"==e.nodeName?(this.ed.selection.select(e),!0):!1;var e=this._getCommonAncestor();if(!this.ed.dom.isBlock(e)){var i=this;e=this.ed.dom.getParent(e,function(e){return i.ed.dom.isBlock(e)})}if(this._isNull(e))return null===this.ed.selection.getContent().match(this._personalizedContentClass);if(!this.ed.dom.hasClass(e,this._personalizedContentClass)){var o=tinyMCE.activeEditor.dom.select("div."+this._personalizedContentClass,e);if(o.length>0)return!1}return!0},_isInvalidPartialSelectionElement:function(e){return"TD"==e.nodeName||"TR"==e.nodeName||"TH"==e.nodeName||"TBODY"==e.nodeName||"THEAD"==e.nodeName||"LI"==e.nodeName},_selectionContainsPC:function(){var e=RegExp("<div.*"+this._personalizedContentClass+".*>(\\n|.)*<div.*"+this._personalizedContentHeaderClass+".*>(\\n|.)*<div.*"+this._personalizedContentHolderClass+".*>(\\n|.)*<div.*"+this._personalizedContentFooterClass+".*>");return this.ed.selection.getContent().match(e)},_getCommonAncestor:function(){if(e.isIE||this.ed.selection.getStart()==this.ed.selection.getEnd())return this.ed.selection.getStart();var t=this.ed.selection.getRng(!0).commonAncestorContainer;return this._isNull(t)||"HTML"==t.tagName?this.ed.getBody():t},_getParentContentBlock:function(e){return this._getParentNode(e,this._personalizedContentClass)},_overlapsHeadingMargin:function(n){var i=t(n.getStart()),o=t(n.getEnd()),r=1==i.closest(".epi_pc_h").length,a=1==o.closest(".epi_pc_h").length;if(e.isIE){var s=i.is(".epi_pc"),l=1==o.closest(".epi_pc_content").length;if(s&&l)return!0}return r&&!a||!r&&a},_getParentContentBlockHolder:function(e){return this._getParentNode(e,this._personalizedContentHolderClass)},_getPCContentBlockHolder:function(e){return this.ed.dom.hasClass(e,this._personalizedContentClass)?t(e).children("."+this._personalizedContentHolderClass)[0]:null},_getParentContentBlockHeader:function(e){return this._getParentNode(e,this._personalizedContentHeaderClass)},_getPCContentBlockHeader:function(e){return this.ed.dom.hasClass(e,this._personalizedContentClass)?t(e).children("."+this._personalizedContentHeaderClass)[0]:this.ed.dom.hasClass(e,this._personalizedContentFooterClass)?t(e.parentNode).children("."+this._personalizedContentHeaderClass)[0]:null},_handleDeletion:function(e,t){if(this._deletePersonalizedContent(e))return!0;var n=this.ed.selection.getNode();if(!t){var i=this._getNextCaretNode(n);if(this.ed.dom.hasClass(i,this._personalizedContentFooterClass)){var o=this._getCaretPosition(n);if(this._caretIsAtTheEnd(n,o))return this._moveDown(e,!1),0==o&&(this.ed.dom.hasClass(n.parentNode,this._personalizedContentHolderClass)&&1==n.parentNode.children.length||this.ed.dom.remove(n)),!0}}if(t){var r=this._getPreviousCaretNode(n);if(this.ed.dom.hasClass(r,this._personalizedContentHeaderClass)&&0==this._getCaretPosition(n))return this._moveUp(e,!1),!0}return this._blockContentBlockDeletion()},_deletePersonalizedContent:function(e){return this.ed.dom.hasClass(e,"mceSelected")?(this._ensureInitialUndoLevel(),this.ed.dom.remove(e),this._onContentChanged(),!0):!1},_blockContentBlockDeletion:function(){var e=this._getCommonAncestor(),n=this._getParentContentBlockHolder(e);if(this._isNull(n))return!1;var i=this._getChildren(n);if(0===i.length)return _normalizeContentNode(n),!0;if(i.length>1)return!1;if(t.trim(t(n).children().text()).length>0)return!1;var o=t(i[0]).children();return 0===o.length||"BR"==o[0].tagName?!0:!1},_validateSelectionBeforeDeletion:function(){if(this.ed.selection.isCollapsed())return!1;var e=this._getParentContentBlockHolder(this.ed.selection.getStart()),t=this._getParentContentBlockHolder(this.ed.selection.getEnd());return this._isNull(e)&&this._isNull(t)||e==t?!1:(this.ed.windowManager.alert(this.ed.translate("epipersonalizedcontent.invalidselectionondeletewarning")),!0)},_normalizeContentNode:function(e){var n=t(e);if(0===n.children().length){var i=n.html();0===i.length&&(i='<br mce_bogus="1" />'),n.html(""),this.ed.dom.add(e,"p",null,i)}else for(var o=0;e.childNodes.length>o;o++){var r=e.childNodes[o];this.ed.dom.isBlock(r)||3==r.nodeType&&!r.data.match(".")||t(r).wrap("<p />")}},_moveDown:function(e,n){if(n){var i=this._getPCContentBlockHolder(e);if(!i)return!1;var o=t(i).children()[0];return this._isNull(o)&&(o=i[0].firstChild),this._moveSelection(o,!0),!0}for(var r=this.ed.getBody().lastChild;r&&3==r.nodeType&&!r.nodeValue.length;)r=r.previousSibling;r&&r===e&&(r=this.ed.dom.add(this.ed.getBody(),"p",null,'<br mce_bogus="1" />'));var a=e.nextSibling||t(e).next().length?t(e).next()[0]:null;a&&this._moveSelection(a,!0)},_moveUp:function(e,n){if(!n){var i=t(e).prev()[0];return i===void 0&&(i=this.ed.dom.create("p",null,'<br _mce_bogus="1" />'),e.parentNode.insertBefore(i,e)),this._moveSelection(i,!1),!0}var o=this._getPCContentBlockHolder(e),r=t(o).children();r.length>0?this._moveSelection(r[r.length-1],!1):this._moveSelection(o,!1)},_block:function(t,n){return this._selectedPcHeader&&13==n.keyCode&&"keydown"==n.type||this._isSpecialKey(n.keyCode)||n.ctrlKey||n.metaKey?void 0:e.dom.Event.cancel(n)},_isSpecialKey:function(e){return e>32&&41>e||e>111&&124>e||46==e||8==e},getInfo:function(){return{longname:"EPiServer CMS Personalized Content Plug-in",author:"EPiServer AB",authorurl:"http://www.episerver.com",infourl:"http://www.episerver.com",version:"1.0"}}}),e.PluginManager.add("epipersonalizedcontent",e.plugins.epipersonalizedcontent)})(tinymce,epiJQuery);