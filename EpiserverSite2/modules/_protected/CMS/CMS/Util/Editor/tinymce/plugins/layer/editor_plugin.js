(function(){tinymce.create("tinymce.plugins.Layer",{init:function(e){var t=this;t.editor=e,e.addCommand("mceInsertLayer",t._insertLayer,t),e.addCommand("mceMoveForward",function(){t._move(1)}),e.addCommand("mceMoveBackward",function(){t._move(-1)}),e.addCommand("mceMakeAbsolute",function(){t._toggleAbsolute()}),e.addButton("moveforward",{title:"layer.forward_desc",cmd:"mceMoveForward"}),e.addButton("movebackward",{title:"layer.backward_desc",cmd:"mceMoveBackward"}),e.addButton("absolute",{title:"layer.absolute_desc",cmd:"mceMakeAbsolute"}),e.addButton("insertlayer",{title:"layer.insertlayer_desc",cmd:"mceInsertLayer"}),e.onInit.add(function(){tinymce.isIE&&e.getDoc().execCommand("2D-Position",!1,!0)}),e.onNodeChange.add(t._nodeChange,t),e.onVisualAid.add(t._visualAid,t)},getInfo:function(){return{longname:"Layer",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/layer",version:tinymce.majorVersion+"."+tinymce.minorVersion}},_nodeChange:function(e,t,n){var i,o;i=this._getParentLayer(n),o=e.dom.getParent(n,"DIV,P,IMG"),o?(t.setDisabled("absolute",0),t.setDisabled("moveforward",!i),t.setDisabled("movebackward",!i),t.setActive("absolute",i&&"absolute"==i.style.position.toLowerCase())):(t.setDisabled("absolute",1),t.setDisabled("moveforward",1),t.setDisabled("movebackward",1))},_visualAid:function(e,t,n){var i=e.dom;tinymce.each(i.select("div,p",t),function(e){/^(absolute|relative|static)$/i.test(e.style.position)&&(n?i.addClass(e,"mceItemVisualAid"):i.removeClass(e,"mceItemVisualAid"))})},_move:function(e){var t,n,i=this.editor,o=[],a=this._getParentLayer(i.selection.getNode()),r=-1,s=-1;for(n=[],tinymce.walk(i.getBody(),function(e){1==e.nodeType&&/^(absolute|relative|static)$/i.test(e.style.position)&&n.push(e)},"childNodes"),t=0;n.length>t;t++)o[t]=n[t].style.zIndex?parseInt(n[t].style.zIndex):0,0>r&&n[t]==a&&(r=t);if(0>e){for(t=0;o.length>t;t++)if(o[t]<o[r]){s=t;break}s>-1?(n[r].style.zIndex=o[s],n[s].style.zIndex=o[r]):o[r]>0&&(n[r].style.zIndex=o[r]-1)}else{for(t=0;o.length>t;t++)if(o[t]>o[r]){s=t;break}s>-1?(n[r].style.zIndex=o[s],n[s].style.zIndex=o[r]):n[r].style.zIndex=o[r]+1}i.execCommand("mceRepaint")},_getParentLayer:function(e){return this.editor.dom.getParent(e,function(e){return 1==e.nodeType&&/^(absolute|relative|static)$/i.test(e.style.position)})},_insertLayer:function(){var e=this.editor,t=e.dom.getPos(e.dom.getParent(e.selection.getNode(),"*"));e.dom.add(e.getBody(),"div",{style:{position:"absolute",left:t.x,top:t.y>20?t.y:20,width:100,height:100},"class":"mceItemVisualAid"},e.selection.getContent()||e.getLang("layer.content"))},_toggleAbsolute:function(){var e=this.editor,t=this._getParentLayer(e.selection.getNode());t||(t=e.dom.getParent(e.selection.getNode(),"DIV,P,IMG")),t&&("absolute"==t.style.position.toLowerCase()?(e.dom.setStyles(t,{position:"",left:"",top:"",width:"",height:""}),e.dom.removeClass(t,"mceItemVisualAid")):(""==t.style.left&&(t.style.left="20px"),""==t.style.top&&(t.style.top="20px"),""==t.style.width&&(t.style.width=t.width?t.width+"px":"100px"),""==t.style.height&&(t.style.height=t.height?t.height+"px":"100px"),t.style.position="absolute",e.addVisual(e.getBody())),e.execCommand("mceRepaint"),e.nodeChanged())}}),tinymce.PluginManager.add("layer",tinymce.plugins.Layer)})();