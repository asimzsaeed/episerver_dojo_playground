(function(){var e=tinymce.util.JSONRequest,t=tinymce.each,n=tinymce.DOM;tinymce.create("tinymce.plugins.SpellcheckerPlugin",{getInfo:function(){return{longname:"Spellchecker",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/spellchecker",version:tinymce.majorVersion+"."+tinymce.minorVersion}},init:function(e,n){var i=this;if(i.url=n,i.editor=e,i.rpcUrl=e.getParam("spellchecker_rpc_url","{backend}"),"{backend}"==i.rpcUrl){if(tinymce.isIE)return;i.hasSupport=!0,e.onContextMenu.addToTop(function(){return i.active?!1:void 0})}e.addCommand("mceSpellCheck",function(){return"{backend}"==i.rpcUrl?(i.editor.getBody().spellcheck=i.active=!i.active,void 0):(i.active?i._done():(e.setProgressState(1),i._sendRPC("checkWords",[i.selectedLang,i._getWords()],function(t){t.length>0?(i.active=1,i._markWords(t),e.setProgressState(0),e.nodeChanged()):(e.setProgressState(0),e.getParam("spellchecker_report_no_misspellings",!0)&&e.windowManager.alert("spellchecker.no_mpell"))})),void 0)}),e.onInit.add(function(){e.settings.content_css!==!1&&e.dom.loadCSS(n+"/css/content.css")}),e.onClick.add(i._showMenu,i),e.onContextMenu.add(i._showMenu,i),e.onBeforeGetContent.add(function(){i.active&&i._removeWords()}),e.onNodeChange.add(function(e,t){t.setActive("spellchecker",i.active)}),e.onSetContent.add(function(){i._done()}),e.onBeforeGetContent.add(function(){i._done()}),e.onBeforeExecCommand.add(function(e,t){"mceFullScreen"==t&&i._done()}),i.languages={},t(e.getParam("spellchecker_languages","+English=en,Danish=da,Dutch=nl,Finnish=fi,French=fr,German=de,Italian=it,Polish=pl,Portuguese=pt,Spanish=es,Swedish=sv","hash"),function(e,t){0===t.indexOf("+")&&(t=t.substring(1),i.selectedLang=e),i.languages[t]=e})},createControl:function(e,n){var i,o=this;return o.editor,"spellchecker"==e?"{backend}"==o.rpcUrl?(o.hasSupport&&(i=n.createButton(e,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:o})),i):(i=n.createSplitButton(e,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:o}),i.onRenderMenu.add(function(e,n){n.add({title:"spellchecker.langs","class":"mceMenuItemTitle"}).setDisabled(1),t(o.languages,function(e,t){var i,a={icon:1};a.onclick=function(){i.setSelected(1),o.selectedItem.setSelected(0),o.selectedItem=i,o.selectedLang=e},a.title=t,i=n.add(a),i.setSelected(e==o.selectedLang),e==o.selectedLang&&(o.selectedItem=i)})}),i):void 0},_walk:function(e,t){var n,i=this.editor.getDoc();if(i.createTreeWalker)for(n=i.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);null!=(e=n.nextNode());)t.call(this,e);else tinymce.walk(e,t,"childNodes")},_getSeparators:function(){var e,t="",n=this.editor.getParam("spellchecker_word_separator_chars",'\\s!"#$%&()*+,-./:;<=>?@[]^_{|}§©«®±¶·¸»¼½¾¿×÷¤”“');for(e=0;n.length>e;e++)t+="\\"+n.charAt(e);return t},_getWords:function(){var e=this.editor,n=[],i="",o={},a=[];return this._walk(e.getBody(),function(e){3==e.nodeType&&(i+=e.nodeValue+" ")}),e.getParam("spellchecker_word_pattern")?a=i.match("("+e.getParam("spellchecker_word_pattern")+")","gi"):(i=i.replace(RegExp("([0-9]|["+this._getSeparators()+"])","g")," "),i=tinymce.trim(i.replace(/(\s+)/g," ")),a=i.split(" ")),t(a,function(e){o[e]||(n.push(e),o[e]=1)}),n},_removeWords:function(e){var n=this.editor,i=n.dom,o=n.selection,a=o.getBookmark();t(i.select("span").reverse(),function(t){t&&(i.hasClass(t,"mceItemHiddenSpellWord")||i.hasClass(t,"mceItemHidden"))&&(e&&i.decode(t.innerHTML)!=e||i.remove(t,1))}),o.moveToBookmark(a)},_markWords:function(e){var n,i,o,a,r,s="",l=this.editor,c=this._getSeparators(),d=l.dom,m=[],u=l.selection,p=u.getBookmark();t(e,function(e){s+=(s?"|":"")+e}),n=RegExp("(["+c+"])("+s+")(["+c+"])","g"),i=RegExp("^("+s+")","g"),o=RegExp("("+s+")(["+c+"]?)$","g"),a=RegExp("^("+s+")(["+c+"]?)$","g"),r=RegExp("("+s+")(["+c+"])","g"),this._walk(this.editor.getBody(),function(e){3==e.nodeType&&m.push(e)}),t(m,function(e){var t;3==e.nodeType&&(t=e.nodeValue,(n.test(t)||i.test(t)||o.test(t)||a.test(t))&&(t=d.encode(t),t=t.replace(r,'<span class="mceItemHiddenSpellWord">$1</span>$2'),t=t.replace(o,'<span class="mceItemHiddenSpellWord">$1</span>$2'),d.replace(d.create("span",{"class":"mceItemHidden"},t),e)))}),u.moveToBookmark(p)},_showMenu:function(e,i){var o,a=this,e=a.editor,r=a._menu,s=e.dom,l=s.getViewPort(e.getWin()),c=i.target;return i=0,r||(o=n.getPos(e.getContentAreaContainer()),r=e.controlManager.createDropMenu("spellcheckermenu",{offset_x:o.x,offset_y:o.y,"class":"mceNoIcons"}),a._menu=r),s.hasClass(c,"mceItemHiddenSpellWord")?(r.removeAll(),r.add({title:"spellchecker.wait","class":"mceMenuItemTitle"}).setDisabled(1),a._sendRPC("getSuggestions",[a.selectedLang,s.decode(c.innerHTML)],function(n){var i;r.removeAll(),n.length>0?(r.add({title:"spellchecker.sug","class":"mceMenuItemTitle"}).setDisabled(1),t(n,function(t){r.add({title:t,onclick:function(){s.replace(e.getDoc().createTextNode(t),c),a._checkDone()}})}),r.addSeparator()):r.add({title:"spellchecker.no_sug","class":"mceMenuItemTitle"}).setDisabled(1),i=a.editor.getParam("spellchecker_enable_ignore_rpc",""),r.add({title:"spellchecker.ignore_word",onclick:function(){var t=c.innerHTML;s.remove(c,1),a._checkDone(),i&&(e.setProgressState(1),a._sendRPC("ignoreWord",[a.selectedLang,t],function(){e.setProgressState(0)}))}}),r.add({title:"spellchecker.ignore_words",onclick:function(){var t=c.innerHTML;a._removeWords(s.decode(t)),a._checkDone(),i&&(e.setProgressState(1),a._sendRPC("ignoreWords",[a.selectedLang,t],function(){e.setProgressState(0)}))}}),a.editor.getParam("spellchecker_enable_learn_rpc")&&r.add({title:"spellchecker.learn_word",onclick:function(){var t=c.innerHTML;s.remove(c,1),a._checkDone(),e.setProgressState(1),a._sendRPC("learnWord",[a.selectedLang,t],function(){e.setProgressState(0)})}}),r.update()}),e.selection.select(c),o=s.getPos(c),r.showMenu(o.x,o.y+c.offsetHeight-l.y),tinymce.dom.Event.cancel(i)):(r.hideMenu(),void 0)},_checkDone:function(){var e,n=this,i=n.editor,o=i.dom;t(o.select("span"),function(t){return t&&o.hasClass(t,"mceItemHiddenSpellWord")?(e=!0,!1):void 0}),e||n._done()},_done:function(){var e=this,t=e.active;e.active&&(e.active=0,e._removeWords(),e._menu&&e._menu.hideMenu(),t&&e.editor.nodeChanged())},_sendRPC:function(t,n,i){var o=this;e.sendRPC({url:o.rpcUrl,method:t,params:n,success:i,error:function(e,t){o.editor.setProgressState(0),o.editor.windowManager.alert(e.errstr||"Error response: "+t.responseText)}})}}),tinymce.PluginManager.add("spellchecker",tinymce.plugins.SpellcheckerPlugin)})();