(function(e){function t(e,t){var n,i=t.ownerDocument,o=i.createRange();return o.setStartBefore(t),o.setEnd(e.endContainer,e.endOffset),n=i.createElement("body"),n.appendChild(o.cloneContents()),0==n.innerHTML.replace(/<(br|img|object|embed|input|textarea)[^>]*>/gi,"-").replace(/<[^>]+>/g,"").length}function n(t,n,a){function r(e,t){return e=e.cloneNode(t),e.removeAttribute("id"),e}function l(){var e=0;T=[],o(["thead","tbody","tfoot"],function(i){var a=n.select("> "+i+" tr",t);o(a,function(t,a){a+=e,o(n.select("> td, > th",t),function(e,t){var n,o,r,l;if(T[a])for(;T[a][t];)t++;for(r=c(e,"rowspan"),l=c(e,"colspan"),o=a;a+r>o;o++)for(T[o]||(T[o]=[]),n=t;t+l>n;n++)T[o][n]={part:i,real:o==a&&n==t,elm:e,rowspan:r,colspan:l}})}),e+=a.length})}function s(e,t){var n;return n=T[t],n?n[e]:void 0}function c(e,t){return parseInt(e.getAttribute(t)||1)}function d(e){return n.hasClass(e.elm,"mceSelected")||e==L}function m(){var e=[];return o(t.rows,function(t){o(t.cells,function(i){return n.hasClass(i,"mceSelected")||i==L.elm?(e.push(t),!1):void 0})}),e}function u(){var e=n.createRng();e.setStartAfter(t),e.setEndAfter(t),a.setRng(e),n.remove(t)}function p(t){var i;return e.walk(t,function(a){var l;return 3==a.nodeType?(o(n.getParents(a.parentNode,null,t).reverse(),function(e){e=r(e,!1),i?l&&l.appendChild(e):i=l=e,l=e}),l&&(l.innerHTML=e.isIE?"&nbsp;":'<br _mce_bogus="1" />'),!1):void 0},"childNodes"),t=r(t,!1),t.rowSpan=t.colSpan=1,i?t.appendChild(i):e.isIE||(t.innerHTML='<br _mce_bogus="1" />'),t}function g(){var e=n.createRng();return o(n.select("tr",t),function(e){0==e.cells.length&&n.remove(e)}),0==n.select("tr",t).length?(e.setStartAfter(t),e.setEndAfter(t),a.setRng(e),n.remove(t),void 0):(o(n.select("thead,tbody,tfoot",t),function(e){0==e.rows.length&&n.remove(e)}),l(),row=T[Math.min(T.length-1,A.y)],row&&(a.select(row[Math.min(row.length-1,A.x)].elm,!0),a.collapse(!0)),void 0)}function h(e,t,i,o){var a,r,l,s,c;for(a=T[t][e].elm.parentNode,l=1;i>=l;l++)if(a=n.getNext(a,"tr")){for(r=e;r>=0;r--)if(c=T[t+l][r].elm,c.parentNode==a){for(s=1;o>=s;s++)n.insertAfter(p(c),c);break}if(-1==r)for(s=1;o>=s;s++)a.insertBefore(p(a.cells[0]),a.cells[0])}}function f(){o(T,function(e,t){o(e,function(e,i){var o,a,r;if(d(e)&&(e=e.elm,o=c(e,"colspan"),a=c(e,"rowspan"),o>1||a>1)){for(e.colSpan=e.rowSpan=1,r=0;o-1>r;r++)n.insertAfter(p(e),e);h(i,t,a-1,o)}})})}function _(t,i,a){var r,c,d,m,u,p,h,_,t,v;if(t?(pos=E(t),r=pos.x,c=pos.y,d=r+(i-1),m=c+(a-1)):(r=A.x,c=A.y,d=N.x,m=N.y),h=s(r,c),_=s(d,m),h&&_&&h.part==_.part){for(f(),l(),h=s(r,c).elm,h.colSpan=d-r+1,h.rowSpan=m-c+1,p=c;m>=p;p++)for(u=r;d>=u;u++)t=T[p][u].elm,t!=h&&(v=e.grep(t.childNodes),o(v,function(e,t){("BR"!=e.nodeName||t!=v.length-1)&&h.appendChild(e)}),n.remove(t));g()}}function v(e){var t,i,a,l,s,m,u,g;for(o(T,function(n,i){return o(n,function(n){return d(n)&&(n=n.elm,s=n.parentNode,m=r(s,!1),t=i,e)?!1:void 0}),e?!t:void 0}),l=0;T[0].length>l;l++)if(i=T[t][l].elm,i!=a){if(e){if(t>0&&T[t-1][l]&&(g=T[t-1][l].elm,rowSpan=c(g,"rowspan"),rowSpan>1)){g.rowSpan=rowSpan+1;continue}}else if(rowSpan=c(i,"rowspan"),rowSpan>1){i.rowSpan=rowSpan+1;continue}u=p(i),u.colSpan=i.colSpan,m.appendChild(u),a=i}m.hasChildNodes()&&(e?s.parentNode.insertBefore(m,s):n.insertAfter(m,s))}function b(e){var t,i;o(T,function(n){return o(n,function(n,i){return d(n)&&(t=i,e)?!1:void 0}),e?!t:void 0}),o(T,function(o,a){var r,l,s=o[t].elm;s!=i&&(l=c(s,"colspan"),r=c(s,"rowspan"),1==l?e?(s.parentNode.insertBefore(p(s),s),h(t,a,r-1,l)):(n.insertAfter(p(s),s),h(t,a,r-1,l)):s.colSpan++,i=s)})}function w(){var t=[];o(T,function(i){o(i,function(i,a){d(i)&&-1===e.inArray(t,a)&&(o(T,function(e){var t,i=e[a].elm;t=c(i,"colspan"),t>1?i.colSpan=t-1:n.remove(i)}),t.push(a))})}),g()}function C(){function e(e){var t,i,a;t=n.getNext(e,"tr"),o(e.cells,function(e){var t=c(e,"rowspan");t>1&&(e.rowSpan=t-1,i=E(e),h(i.x,i.y,1,1))}),i=E(e.cells[0]),o(T[i.y],function(e){var t;e=e.elm,e!=a&&(t=c(e,"rowspan"),1>=t?n.remove(e):e.rowSpan=t-1,a=e)})}var t;t=m(),o(t.reverse(),function(t){e(t)}),g()}function k(){var e=m();return n.remove(e),g(),e}function P(){var e=m();return o(e,function(t,n){e[n]=r(t,!0)}),e}function M(e,t){var a=m(),r=a[t?0:a.length-1],l=r.cells.length;o(T,function(e){var t;return l=0,o(e,function(e){e.real&&(l+=e.colspan),e.elm.parentNode==r&&(t=1)}),t?!1:void 0}),t||e.reverse(),o(e,function(e){var o,a=e.cells.length;for(i=0;a>i;i++)o=e.cells[i],o.colSpan=o.rowSpan=1;for(i=a;l>i;i++)e.appendChild(p(e.cells[a-1]));for(i=l;a>i;i++)n.remove(e.cells[i]);t?r.parentNode.insertBefore(e,r):n.insertAfter(e,r)})}function E(e){var t;return o(T,function(n,i){return o(n,function(n,o){return n.elm==e?(t={x:o,y:i},!1):void 0}),!t}),t}function S(e){A=E(e)}function I(){var e,t;return e=t=0,o(T,function(n,i){o(n,function(n,o){var a,r;d(n)&&(n=T[i][o],o>e&&(e=o),i>t&&(t=i),n.real&&(a=n.colspan-1,r=n.rowspan-1,a&&o+a>e&&(e=o+a),r&&i+r>t&&(t=i+r)))})}),{x:e,y:t}}function B(e){var t,i,o,a,r,l,s,c;if(N=E(e),A&&N){for(t=Math.min(A.x,N.x),i=Math.min(A.y,N.y),o=Math.max(A.x,N.x),a=Math.max(A.y,N.y),r=o,l=a,y=i;l>=y;y++)e=T[y][t],e.real||t>t-(e.colspan-1)&&(t-=e.colspan-1);for(x=t;r>=x;x++)e=T[i][x],e.real||i>i-(e.rowspan-1)&&(i-=e.rowspan-1);for(y=i;a>=y;y++)for(x=t;o>=x;x++)e=T[y][x],e.real&&(s=e.colspan-1,c=e.rowspan-1,s&&x+s>r&&(r=x+s),c&&y+c>l&&(l=y+c));for(n.removeClass(n.select("td.mceSelected,th.mceSelected"),"mceSelected"),y=i;l>=y;y++)for(x=t;r>=x;x++)n.addClass(T[y][x].elm,"mceSelected")}}var T,A,N,L;l(),L=n.getParent(a.getStart(),"th,td"),L&&(A=E(L),N=I(),L=s(A.x,A.y)),e.extend(this,{deleteTable:u,split:f,merge:_,insertRow:v,insertCol:b,deleteCols:w,deleteRows:C,cutRows:k,copyRows:P,pasteRows:M,getPos:E,setStartCell:S,setEndCell:B})}var o=e.each;e.create("tinymce.plugins.TablePlugin",{init:function(i,a){function r(e){var t=i.selection,o=i.dom.getParent(e||t.getNode(),"table");return o?new n(o,i.dom,t):void 0}function l(){i.getBody().style.webkitUserSelect="",i.dom.removeClass(i.dom.select("td.mceSelected,th.mceSelected"),"mceSelected")}var s,c;o([["table","table.desc","mceInsertTable",!0],["delete_table","table.del","mceTableDelete"],["delete_col","table.delete_col_desc","mceTableDeleteCol"],["delete_row","table.delete_row_desc","mceTableDeleteRow"],["col_after","table.col_after_desc","mceTableInsertColAfter"],["col_before","table.col_before_desc","mceTableInsertColBefore"],["row_after","table.row_after_desc","mceTableInsertRowAfter"],["row_before","table.row_before_desc","mceTableInsertRowBefore"],["row_props","table.row_desc","mceTableRowProps",!0],["cell_props","table.cell_desc","mceTableCellProps",!0],["split_cells","table.split_cells_desc","mceTableSplitCells",!0],["merge_cells","table.merge_cells_desc","mceTableMergeCells",!0]],function(e){i.addButton(e[0],{title:e[1],cmd:e[2],ui:e[3]})}),e.isIE||i.onClick.add(function(e,t){t=t.target,"TABLE"===t.nodeName&&e.selection.select(t)}),i.onNodeChange.add(function(e,t,n){var i;n=e.selection.getStart(),i=e.dom.getParent(n,"td,th,caption"),t.setActive("table","TABLE"===n.nodeName||!!i),i&&"CAPTION"===i.nodeName&&(i=0),t.setDisabled("delete_table",!i),t.setDisabled("delete_col",!i),t.setDisabled("delete_table",!i),t.setDisabled("delete_row",!i),t.setDisabled("col_after",!i),t.setDisabled("col_before",!i),t.setDisabled("row_after",!i),t.setDisabled("row_before",!i),t.setDisabled("row_props",!i),t.setDisabled("cell_props",!i),t.setDisabled("split_cells",!i),t.setDisabled("merge_cells",!i)}),i.onInit.add(function(n){function i(){var e;for(e=n.getBody().lastChild;e&&3==e.nodeType&&!e.nodeValue.length;e=e.previousSibling);e&&"TABLE"==e.nodeName&&n.dom.add(n.getBody(),"p",null,'<br mce_bogus="1" />')}var o,a,d,m=n.dom;s=n.windowManager,n.onMouseDown.add(function(e,t){2!=t.button&&(l(),a=m.getParent(t.target,"td,th"),o=m.getParent(a,"table"))}),m.bind(n.getDoc(),"mouseover",function(e){var t,i,l=e.target;!a||!d&&l==a||"TD"!=l.nodeName&&"TH"!=l.nodeName||(i=m.getParent(l,"table"),i==o&&(d||(d=r(i),d.setStartCell(a),n.getBody().style.webkitUserSelect="none"),d.setEndCell(l)),t=n.selection.getSel(),t.removeAllRanges?t.removeAllRanges():t.empty(),e.preventDefault())}),n.onMouseUp.add(function(t){function n(t,n){var o=new e.dom.TreeWalker(t,t);do{if(3==t.nodeType&&0!=e.trim(t.nodeValue).length)return n?i.setStart(t,0):i.setEnd(t,t.nodeValue.length),void 0;if("BR"==t.nodeName)return n?i.setStartBefore(t):i.setEndBefore(t),void 0}while(t=n?o.next():o.prev())}var i,r,l,s,c,u,p=t.selection;if(p.getSel(),a){if(d&&(t.getBody().style.webkitUserSelect=""),r=m.select("td.mceSelected,th.mceSelected"),r.length>0){i=m.createRng(),s=r[0],u=r[r.length-1],n(s,1),l=new e.dom.TreeWalker(s,m.getParent(r[0],"table"));do if("TD"==s.nodeName||"TH"==s.nodeName){if(!m.hasClass(s,"mceSelected"))break;c=s}while(s=l.next());n(c),p.setRng(i)}t.nodeChanged(),a=d=o=null}}),n.onKeyUp.add(function(){l()}),n&&n.plugins.contextmenu&&n.plugins.contextmenu.onContextMenu.add(function(e,t,i){var o,a=n.selection,r=a.getNode()||n.getBody();n.dom.getParent(i,"td")||n.dom.getParent(i,"th")||n.dom.select("td.mceSelected,th.mceSelected").length?(t.removeAll(),"A"!=r.nodeName||n.dom.getAttrib(r,"name")||(t.add({title:"advanced.link_desc",icon:"link",cmd:n.plugins.advlink?"mceAdvLink":"mceLink",ui:!0}),t.add({title:"advanced.unlink_desc",icon:"unlink",cmd:"UnLink"}),t.addSeparator()),"IMG"==r.nodeName&&-1==r.className.indexOf("mceItem")&&(t.add({title:"advanced.image_desc",icon:"image",cmd:n.plugins.advimage?"mceAdvImage":"mceImage",ui:!0}),t.addSeparator()),t.add({title:"table.desc",icon:"table",cmd:"mceInsertTable",value:{action:"insert"}}),t.add({title:"table.props_desc",icon:"table_props",cmd:"mceInsertTable"}),t.add({title:"table.del",icon:"delete_table",cmd:"mceTableDelete"}),t.addSeparator(),o=t.addMenu({title:"table.cell"}),o.add({title:"table.cell_desc",icon:"cell_props",cmd:"mceTableCellProps"}),o.add({title:"table.split_cells_desc",icon:"split_cells",cmd:"mceTableSplitCells"}),o.add({title:"table.merge_cells_desc",icon:"merge_cells",cmd:"mceTableMergeCells"}),o=t.addMenu({title:"table.row"}),o.add({title:"table.row_desc",icon:"row_props",cmd:"mceTableRowProps"}),o.add({title:"table.row_before_desc",icon:"row_before",cmd:"mceTableInsertRowBefore"}),o.add({title:"table.row_after_desc",icon:"row_after",cmd:"mceTableInsertRowAfter"}),o.add({title:"table.delete_row_desc",icon:"delete_row",cmd:"mceTableDeleteRow"}),o.addSeparator(),o.add({title:"table.cut_row_desc",icon:"cut",cmd:"mceTableCutRow"}),o.add({title:"table.copy_row_desc",icon:"copy",cmd:"mceTableCopyRow"}),o.add({title:"table.paste_row_before_desc",icon:"paste",cmd:"mceTablePasteRowBefore"}).setDisabled(!c),o.add({title:"table.paste_row_after_desc",icon:"paste",cmd:"mceTablePasteRowAfter"}).setDisabled(!c),o=t.addMenu({title:"table.col"}),o.add({title:"table.col_before_desc",icon:"col_before",cmd:"mceTableInsertColBefore"}),o.add({title:"table.col_after_desc",icon:"col_after",cmd:"mceTableInsertColAfter"}),o.add({title:"table.delete_col_desc",icon:"delete_col",cmd:"mceTableDeleteCol"})):t.add({title:"table.desc",icon:"table",cmd:"mceInsertTable"})}),e.isIE||(e.isGecko&&n.onKeyDown.add(function(e,n){var i,o,a=e.dom;(37==n.keyCode||38==n.keyCode)&&(i=e.selection.getRng(),o=a.getParent(i.startContainer,"table"),o&&e.getBody().firstChild==o&&t(i,o)&&(i=a.createRng(),i.setStartBefore(o),i.setEndBefore(o),e.selection.setRng(i),n.preventDefault()))}),n.onKeyUp.add(i),n.onSetContent.add(i),n.onVisualAid.add(i),n.onPreProcess.add(function(e,t){var n=t.node.lastChild;n&&1==n.childNodes.length&&"BR"==n.firstChild.nodeName&&e.dom.remove(n)}),i())}),o({mceTableSplitCells:function(e){e.split()},mceTableMergeCells:function(e){var t,n,o;o=i.dom.getParent(i.selection.getNode(),"th,td"),o&&(t=o.rowSpan,n=o.colSpan),i.dom.select("td.mceSelected,th.mceSelected").length?e.merge():s.open({url:a+"/merge_cells.htm",width:240+parseInt(i.getLang("table.merge_cells_delta_width",0)),height:110+parseInt(i.getLang("table.merge_cells_delta_height",0)),inline:1},{rows:t,cols:n,onaction:function(t){e.merge(o,t.cols,t.rows)},plugin_url:a})},mceTableInsertRowBefore:function(e){e.insertRow(!0)},mceTableInsertRowAfter:function(e){e.insertRow()},mceTableInsertColBefore:function(e){e.insertCol(!0)},mceTableInsertColAfter:function(e){e.insertCol()},mceTableDeleteCol:function(e){e.deleteCols()},mceTableDeleteRow:function(e){e.deleteRows()},mceTableCutRow:function(e){c=e.cutRows()},mceTableCopyRow:function(e){c=e.copyRows()},mceTablePasteRowBefore:function(e){e.pasteRows(c,!0)},mceTablePasteRowAfter:function(e){e.pasteRows(c)},mceTableDelete:function(e){e.deleteTable()}},function(e,t){i.addCommand(t,function(){var t=r();t&&(e(t),i.execCommand("mceRepaint"),l())})}),o({mceInsertTable:function(e){s.open({url:a+"/table.htm",width:400+parseInt(i.getLang("table.table_delta_width",0)),height:320+parseInt(i.getLang("table.table_delta_height",0)),inline:1},{plugin_url:a,action:e?e.action:0})},mceTableRowProps:function(){s.open({url:a+"/row.htm",width:400+parseInt(i.getLang("table.rowprops_delta_width",0)),height:295+parseInt(i.getLang("table.rowprops_delta_height",0)),inline:1},{plugin_url:a})},mceTableCellProps:function(){s.open({url:a+"/cell.htm",width:400+parseInt(i.getLang("table.cellprops_delta_width",0)),height:295+parseInt(i.getLang("table.cellprops_delta_height",0)),inline:1},{plugin_url:a})}},function(e,t){i.addCommand(t,function(t,n){e(n)})})}}),e.PluginManager.add("table",e.plugins.TablePlugin)})(tinymce);