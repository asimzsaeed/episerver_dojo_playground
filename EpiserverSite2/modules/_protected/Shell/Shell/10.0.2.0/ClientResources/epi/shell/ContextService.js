//>>built
define("epi/shell/ContextService",["dojo","dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/promise/all","dojo/topic","dijit/Destroyable","epi","epi/dependency","epi/shell/widget/dialog/Confirmation","epi/UriParser","epi/i18n!epi/shell/ui/nls/EPiServer.Shell.UI.Resources.ContextService"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){return _3([_8],{currentContext:null,_contextStore:null,_profile:null,_routes:{},res:_d,_requestQueue:null,_requestInterceptors:null,constructor:function(_e,_f){this._contextStore=_e;if(_f===undefined){this._profile=_a.resolve("epi.shell.Profile");}this._requestInterceptors=[];this._requestQueue=[];this._initialize();},_initialize:function(){this.own(_7.subscribe("/epi/shell/context/request",_4.hitch(this,this._handleContextChangeRequest)),_7.subscribe("/epi/shell/context/updateRequest",_4.hitch(this,this._handleContextUpdateRequest)),_7.subscribe("/epi/shell/context/requestcurrent",_4.hitch(this,this._handleRequestCurrentContext)));},registerRoute:function(_10,_11){this._routes[_10]=_11;},registerRequestInterceptor:function(_12){var _13=_2.indexOf(this._requestInterceptors,_12);if(_13===-1){this._requestInterceptors.push(_12);}return {remove:_4.hitch(this,function(){this.unregisterRequestInterceptor(_12);})};},unregisterRequestInterceptor:function(_14){var _15=_2.indexOf(this._requestInterceptors,_14);if(_15!==-1){this._requestInterceptors.splice(_15,1);return _14;}return null;},query:function(_16){return this._executeInterceptors(_16,{}).then(_4.hitch(this,function(){return this._getContextStore().query(_16);}));},_handleContextChangeRequest:function(_17,_18){if(_17===null){this.currentContext={};this._publishContextChanged(this.currentContext);return;}this._executeInterceptors(_17,_18).then(_4.hitch(this,function(){this._loadNewContext(_17,_18,this._publishContextChanged);})).otherwise(_4.hitch(this,function(){this._publishRequestFailed(_17,_18);}));},_executeInterceptors:function(_19,_1a){var _1b=_2.map(this._requestInterceptors,function(_1c){return _1c(_19,_1a);},this);var _1d=_6(_1b);_1d.otherwise(function(_1e){console.error("Failed to execute the context request interceptors:",_1e,_19,_1a);});return _1d;},_handleContextUpdateRequest:function(_1f,_20){if(_1f===null){return;}this._loadNewContext(_1f,_20,this._publishContextUpdated);},_handleRequestCurrentContext:function(_21){if(this.currentContext){_7.publish("/epi/shell/context/current",this.currentContext,_21);}},_loadNewContext:function(_22,_23,_24){var _25={success:null,request:null,response:null,contextParameters:_22,callerData:_23,callback:_24};var _26=_4.hitch(this,function(_27){_25.response=_27;_25.success=false;this._handleContextLoaded();});var _28=_4.hitch(this,function(_29){if(_29){_25.response=_29;_25.success=true;this._handleContextLoaded();}else{_26(_29);}});this._requestQueue.push(_25);var _2a=this._getContextStore();var rq=_2a.query(_22);rq.then(_28,_26);_25.request=rq;},_handleContextLoaded:function(){var _2b=(this._requestQueue.length>0)?this._requestQueue[0]:null;while(_2b&&_2b.success!==null){this._requestQueue.shift();var _2c=_2b.callback;var _2d=_2b.response;var _2e=_2b.contextParameters;var _2f=_2b.callerData;var _30=_2b.success;var _31=_2b.request;if(_30){var uri=new _c(_2d.uri);_2d.type=uri.getType();_2d.id=uri.getId();this.currentContext=_2b.response;if(this._routes&&this._routes[_2d.type]){this._routes[_2d.type](this.currentContext,_2f,uri);}if(_2c){_2c(_2d,_2f,_31);}}else{if(_2f&&!_2f.suppressFailure){this._contextLoadFailed(_2d,_2e,_2f);}else{this._publishRequestFailed(_2e,_2f);}}_2b=(this._requestQueue.length>0)?this._requestQueue[0]:null;}},_contextLoadFailed:function(_32,_33,_34){var _35=_4.hitch(this,function(_36){if(_36){this._loadNewContext(_33,_34,this._publishContextChanged);}else{this._publishRequestFailed(_33,_34);}});var _37=this.res.errors.couldnotloadcontext.description,_38=this.res.errors.couldnotloadcontext["descriptioncontent"+_32.status],_39=this.res.errors.couldnotloadcontext["description"+_32.status];if(_38&&_34.sender&&_34.sender.requestedContent){var _3a=_34.sender.requestedContent;_37=_4.replace(_38,[_3a.typeName,_3a.name]);}else{if(_39){_37=_4.replace(_39,[_33.uri||_33.url]);}}var _3b=new _b({title:this.res.errors.couldnotloadcontext.title,description:_37,confirmActionText:this.res.errors.couldnotloadcontext.retry,cancelActionText:_9.resources.action.ignore,onAction:_35});_3b.show();},_getContextStore:function(){if(!this._contextStore){var _3c=_a.resolve("epi.storeregistry");this._contextStore=_3c.get("epi.shell.context");}return this._contextStore;},_publishContextChanged:function(_3d,_3e,_3f){_7.publish("/epi/shell/context/changed",_3d,_3e,_3f);},_publishContextUpdated:function(_40,_41,_42){_7.publish("/epi/shell/context/updated",_40,_41,_42);},_publishRequestFailed:function(_43,_44){_7.publish("/epi/shell/context/requestfailed",this.currentContext,_43,_44);}});});