//>>built
define("epi/shell/XhrWrapper",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/when","epi","epi/shell/request/xhr","epi/shell/widget/dialog/Dialog","epi/shell/widget/LoginForm"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){var _b;var _c=_3(null,{xhrHandler:null,_headerKeys:{validation:"X-EpiRestAntiForgeryToken",loginScreen:"X-EPiLogOnScreen",postUrl:"X-EPiLogOnScreen-PostUrl",readOnlyMode:"X-EPiReadOnlyMode",readOnlyModeRedirectUrl:"X-EPiReadOnlyMode-RedirectUrl"},constructor:function(_d){_3.safeMixin(this,_d);if(!this.xhrHandler){this.xhrHandler=_8;}},xhr:function(_e,_f,_10){var _11=arguments;_f.headers=_f.headers||{};if(_f.xsrfProtection){var _12=new _5();_6(this._getXsrfHeader(_f.url),_4.hitch(this,function(_13){_f.headers=_4.mixin({},_f.headers,_13);_6(this._xhr.apply(this,_11),_12.resolve,_12.reject);}),_12.reject);return _12;}else{return this._xhr.apply(this,_11);}},xhrDelete:function(_14){return this.xhr("DELETE",_14);},xhrGet:function(_15){return this.xhr("GET",_15);},xhrPost:function(_16){return this.xhr("POST",_16,true);},xhrPut:function(_17){return this.xhr("PUT",_17,true);},_getXsrfHeader:function(_18){if(_c.sharedXsrfHeader){return _c.sharedXsrfHeader;}var _19={url:_18,handleAs:"json",headers:{}};_19.headers[this._headerKeys.validation]="_CreateToken_";var _1a=new _5();this.xhrGet(_19).then(_4.hitch(this,function(){_1a.resolve(_c.sharedXsrfHeader);}),_1a.reject);return _1a;},_xhr:function(_1b,_1c,_1d){var _1e=arguments;var _1f=_4.delegate({method:_1b,data:_1c.content||_1c.postData},_1c);var _20=this.xhrHandler(_1f.url,_1f,true);var _21=new _5();_21.ioArgs=_20.ioArgs;_6(_20,_4.hitch(this,function(_22){var _23=_20.ioArgs.xhr.getResponseHeader(this._headerKeys.validation);if(_23){if(!_c.sharedXsrfHeader){_c.sharedXsrfHeader={};}_c.sharedXsrfHeader[this._headerKeys.validation]=_23;}_21.ioArgs=_20.ioArgs;_21.resolve(_22);}),_4.hitch(this,function(err){var _24=_20.ioArgs.xhr.getResponseHeader(this._headerKeys.loginScreen);if(_24==="true"||_20.ioArgs.xhr.status===401){var _25={postUrl:_20.ioArgs.xhr.getResponseHeader(this._headerKeys.postUrl)};_c.sharedXsrfHeader=undefined;var _26=this._showLogin(_25);_6(_26,_4.hitch(this,function(){_6(this.xhr.apply(this,_1e),_21.resolve,_21.reject);}),function(){_21.reject(err);});}else{if(_20.ioArgs.xhr.status===503){var _27=_20.ioArgs.xhr.getResponseHeader(this._headerKeys.readOnlyMode);var _28=_20.ioArgs.xhr.getResponseHeader(this._headerKeys.readOnlyModeRedirectUrl);if(_27&&_28){this._redirect(_28);}else{_21.reject(err);}}else{_21.reject(err);}}}));return _21;},_redirect:function(url){window.top.location=url;},_showLogin:function(_29){if(!_b){_b=new _5();var _2a=new _a();var _2b=new _9({title:_7.resources.action.login,confirmActionText:_7.resources.action.login,content:_2a,dialogClass:"",_onAfterShow:function(){}});var _2c=[];var _2d=function(_2e){_1.forEach(_2c,_2.disconnect);_2a.destroyRecursive();_2b.hide();if(_2e){_b.resolve();}else{_b.reject();}_b=null;};_2b.addValidator(_4.hitch(this,function(){var _2f=new _5();var _30=_2a.serializeForm();var _31=this.xhr("POST",{url:_29.postUrl,content:_30,xsrfProtection:false,handleAs:"json"},true);_6(_31,function(_32){if(_32.authenticationSuccessful){_2d(true);_2f.resolve();}else{_2a.authenticationFailed();_2f.reject();}},function(){_2d(false);_2f.reject();});return _2f;}));_2b.show();_2c.push(_2.connect(_2b,"onCancel",function(){_2d(false);}));}return _b;}});_c.sharedXsrfHeader=undefined;return _c;});