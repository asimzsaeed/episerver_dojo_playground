//>>built
define("epi/shell/socket/MessageHub",["dojo/_base/declare","dojo/_base/lang","dojo/_base/url","dojo/Evented","dojo/on","./WebSocket"],function(_1,_2,_3,_4,on,_5){return _1(null,{maxConnectionAttempts:8,reconnectPause:5000,statusTopic:{open:"/epi/socket/open",error:"/epi/socket/error",reconnect:"/epi/socket/reconnect",connectionfailed:"/epi/socket/connectionfailed",message:"/epi/socket/message"},heartbeatInterval:3000,heartbeatMessage:"/epi/heartbeat",_path:null,_eventListeners:null,_topicHub:null,_connectionAttempts:0,_hasBeenConnected:false,_reconnectHandle:null,_heartbeatHandle:null,_outstandingHeartbeats:0,constructor:function(_6){this._topicHub=new _4();this._socketPathResolver=_6;this._eventListeners=[];},start:function(){var _7;if(this._socket&&this._socket.readyState!==_5.CLOSED){return;}_7=new _5(this._resolvePath());this._eventListeners.push(on(_7,"error",_2.hitch(this,"_onError")),on(_7,"open",_2.hitch(this,"_onOpen")),on(_7,"close",_2.hitch(this,"_onClose")),on(_7,"message",_2.hitch(this,"_onMessage")));this._socket=_7;},stop:function(){if(!this._socket){return;}this._reconnectHandle&&clearTimeout(this._reconnectHandle);this._reconnectHandle=null;this._socket.close();this._socket=null;this._eventListeners.forEach(function(_8){_8.remove();});this._eventListeners=[];},subscribe:function(_9,_a){return this._topicHub.on(_9,_a);},_resolvePath:function(){var _b=(document.baseURI||window.location.href).replace(/^http/i,"ws");return new _3(_b,this._socketPathResolver());},_publish:function(_c,_d){this._topicHub.emit(_c,_d);},_onMessage:function(_e){var _f;if(_e.data&&!this._handleHeartbeat(_e.data)){_f=JSON.parse(_e.data);this._publish(this.statusTopic.message,_f);if(_f&&_f.topic){this._publish(_f.topic,_f.data);}}},_onError:function(e){if(!this._hasBeenConnected&&this._socket.readyState===_5.CLOSED){this._connectionAttempts=this.maxConnectionAttempts;}this._publish(this.statusTopic.error,e);},_onOpen:function(e){this._hasBeenConnected=true;this._connectionAttempts=0;this._publish(this.statusTopic.open,e);this._resetHeartbeat();},_onClose:function(e){var _10,_11=function(_12){this._publish(_12,{connectionAttempts:this._connectionAttempts,lastAttempt:this._connectionAttempts>=this.maxConnectionAttempts,hasBeenConnected:this._hasBeenConnected});}.bind(this),_13=function(){_11(this.statusTopic.reconnect);this._reconnectHandle=null;this.stop();this.start();}.bind(this);this._heartbeatHandle&&clearTimeout(this._heartbeatHandle);this._heartbeatHandle=null;if(!this._socket){return;}if(!e.wasClean){this._connectionAttempts++;_11(this.statusTopic.connectionfailed);}if(this._connectionAttempts<=this.maxConnectionAttempts){_10=this.reconnectPause*Math.pow(this._connectionAttempts,2);this._reconnectHandle=setTimeout(_13,_10);}},_resetHeartbeat:function(){var _14=function(){if(this._outstandingHeartbeats>1){this._socket.close();}else{this._outstandingHeartbeats++;this._socket.send(this.heartbeatMessage);this._heartbeatHandle=setTimeout(_14,this.heartbeatInterval);}}.bind(this);if(this.heartbeatInterval===0){return;}this._outstandingHeartbeats=0;if(this._heartbeatHandle){clearTimeout(this._heartbeatHandle);this._heartbeatHandle=setTimeout(_14,this.heartbeatInterval);}else{_14();}},_handleHeartbeat:function(_15){this._resetHeartbeat();if(_15===this.heartbeatMessage){return true;}}});});