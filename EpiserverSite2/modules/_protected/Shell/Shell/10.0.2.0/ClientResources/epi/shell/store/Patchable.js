//>>built
define("epi/shell/store/Patchable",["dojo/_base/lang","dojo/aspect","dojo/promise/all","dojo/store/Cache","dojo/store/Observable","dojo/when","epi/shell/store/storeDelegate"],function(_1,_2,_3,_4,_5,_6,_7){return function(_8,_9,_a){var _b=_4(_8,_9,_a||{}),_c=[];var _d=function(_e,_f){if(typeof _e!==typeof _f){console.error("The store was queried with a ["+typeof _e+"] but the entity id is a ["+typeof _f+"]");}};var _10=function(_11,_12){if(typeof _12=="object"){_11[_13.idProperty]=_12[_13.idProperty];}else{_11[_13.idProperty]=_12;}};var _14=function(_15){if(_15._cached){_15._cached=new Date();}else{Object.defineProperty(_15,"_cached",{value:new Date(),enumerable:false});}return _15;};var _16=function(_17){if(!_17._cached){return false;}var now=new Date();now.setMinutes(now.getMinutes()-5);return now>_17._cached;};_b.get=function(id,_18){return _6(_9.get(id),function(_19){if(_19){if(_16(_19)){_b.evict(id,_18);_19=null;}}return _19||_6(_8.get(id,_18),function(_1a){if(_1a){_d(id,_1a[_8.idProperty]);_9.put(_14(_1a),{id:id});}return _1a;});});};_b.put=function(_1b,_1c){_9.remove((_1c&&_1c.id)||this.getIdentity(_1b));return _6(_8.put(_1b,_1c),function(_1d){_10(_1b,_1d);_9.put(typeof _1d=="object"?_14(_1d):_14(_1b),_1c);return _1d;});};_b.add=function(_1e,_1f){return _6(_8.add(_1e,_1f),function(_20){_10(_1e,_20);_9.add(typeof _20=="object"?_14(_20):_14(_1e),_1f);return _20;});};var _21=function(obj){return obj&&_1.isObject(obj)&&!_1.isArray(obj)&&!_1.isFunction(obj);};var _22=function(_23,_24){var _25,s,_26={};for(_25 in _24){s=_24[_25];if(_25 in _23&&(_23[_25]!==s&&(!(_25 in _26)||_26[_25]!==s))){if(_21(s)&&_21(_23[_25])){_22(_23[_25],s);}else{_23[_25]=s;}}}return _23;};var _27=_5(_b);var _13=_7(_27,{getCached:function(id){return _9.get(id);},refresh:function(id){return _6(this.evict(id),_1.hitch(this,function(){return _6(this.get(id),_1.hitch(this,function(_28){if(_28){this.notify(_28,id);this.updateDependentStores(_28);this.onItemChanged(id,_28);}return _28;}));}));},removeRange:function(ids){var _29=this;var _2a=ids.map(function(id){_29.evict(id);});var _2b=_3(_2a).then(function(){return _6(_29.executeMethod("DeleteRange","",ids));});_2b.then(function(){ids.forEach(function(id){_29.notify(undefined,id);});});return _2b;},patchCache:function(_2c){if(!_2c){return;}var id=this.getIdentity(_2c);return _6(this.get(id),_1.hitch(this,function(_2d){if(_2d){_2d=_22(_2d,_2c);_6(_9.put(_2d,{overwrite:true}),_1.hitch(this,function(){this.notify(_2d,id);this.updateDependentStores(_2c);this.onItemChanged(id,_2d);}));}return _2d;}));},addDependentStore:function(_2e,_2f){if(!_2e.patchCache){throw new Error("addDependentStore: The store must implement the patch method.");}_c.push({store:_2e,options:_2f||{}});},updateDependentStores:function(_30){for(var i=_c.length-1;i>=0;i--){var _31=_c[i].store;if(_c[i].options.refreshOnPatch){var _32=_c[i].options.refresh;if(typeof _32==="function"){_32(_30);}else{_31.refresh(this.getIdentity(_30));}}else{var _33=_c[i].options.transformDelegate;_31.patchCache(typeof _33==="function"?_33(_30):_30);}}},onItemChanged:function(id,_34){}});return _13;};});