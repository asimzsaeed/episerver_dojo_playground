//>>built
define("epi/shell/store/Realtime",["dojo/_base/lang","dojo/aspect","dojo/when","dojo/Deferred","dojo/promise/all","epi/shell/socket/hub","epi/shell/TaskQueue","epi/shell/store/storeDelegate"],function(_1,_2,_3,_4,_5,_6,_7,_8){return function(_9,_a){if(!_a||!_a.subscriptionKey){throw new Error("Realtime functionality can't be added to a store without providing realtimeInfo (i.e subscriptionKey & idProperty of the store)");}var _b=_9.idProperty;var _c=_9;function _d(){function _e(_f,_10){function _11(_12){if(!_10.modified){return _c.refresh(_f);}var _13=new Date(_10.modified).getTime();var _14=new Date(_12.modified).getTime();if(_13!==_14){return _c.refresh(_f);}else{_c.notify(_12,_f);}return true;};return _3(_c.getCached(_f),function(_15){if(!_15){return _c.refresh(_f);}else{return _11(_15);}});};function _16(_17){if(_17){if(!(_17 instanceof Array)){_17=[_17];}var _18=_17.map(function(_19){var id=_19[_b];var _1a=_19.action;switch(_1a){case 1:return _e(id,_19);case 2:return _3(_c.getCached(id),function(_1b){if(_1b){_c.evict(id);_c.notify(undefined,id);}});default:return true;}});return _5(_18);}return true;};var _1c=new _7(_16,{throttle:5});_6.subscribe(_a.subscriptionKey,_1c.enqueue);this.start=function(){_1c.start();};this.stop=function(){_1c.stop();};};var _1d=new _d();var _1e=function(_1f,_20){return function(){_1d.stop();var _21=_3(_1f[_20].apply(_1f,arguments));_21.always(function(){_1d.start();});return _21;};};var _22=_8(_c,{add:_1e(_9,"add"),put:_1e(_9,"put"),remove:_1e(_9,"remove"),removeRange:_1e(_9,"removeRange")});return _22;};});