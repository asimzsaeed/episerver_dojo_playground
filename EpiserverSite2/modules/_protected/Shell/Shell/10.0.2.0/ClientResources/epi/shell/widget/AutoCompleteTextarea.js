//>>built
define("epi/shell/widget/AutoCompleteTextarea",["dojo/_base/declare","dojo/_base/lang","dojo/keys","dojo/dom-style","dojo/dom-geometry","dijit/form/_FormValueWidget","dijit/_WidgetsInTemplateMixin","dijit/form/_TextBoxMixin","dgrid/OnDemandList","dgrid/Selection","dgrid/util/misc","put-selector/put","dijit/popup","epi/shell/dgrid/selection/Extensions","dijit/form/Textarea"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){var _f=_1([_9,_a,_e]);return _1([_6,_7],{templateString:"<div><div data-dojo-type='dijit/form/Textarea' data-dojo-attach-point='_textArea, focusNode'></div><div data-dojo-attach-point='_listNode'></div></div>",baseClass:"epi-autocomplete-textarea",value:null,store:null,placeholder:"",tagProperty:"",displayProperty:"",noDataMessage:"",_setIdAttr:"domNode",buildRendering:function(){this.inherited(arguments);var _10=this._textArea;this.own(_10.on("keyup",_2.hitch(this,"_onKeyUp")),_10.on("keydown",_2.hitch(this,"_onKeyDown")),_10.on("change",_2.hitch(this,"_handleOnChange")),this.on("blur",this._closePopup.bind(this)),this._selectList=new _f({className:"epi-autocomplete-list",selectionMode:"single",renderRow:this._renderRow.bind(this)},this._listNode),this._selectList.on(".dgrid-row:click",this._insertSelection.bind(this)),this._selectList.on("dgrid-refresh-complete",_2.hitch(this._selectList,"moveSelectionDown")));_d.moveOffScreen(this._selectList);},startup:function(){this.inherited(arguments);this._selectList.startup();},focus:function(){if(this.isFocusable()){this.inherited(arguments);}},setCaretLast:function(){if(this._textArea.value){_8.selectInputText(this._textArea.domNode,this._textArea.value.length);}},reset:function(){this._textArea.reset();},_setIntermediateChangesAttr:function(_11){this._set("intermediateChanges",_11);this._textArea.set("intermediateChanges",_11);},_setNoDataMessageAttr:function(_12){this._selectList.set("noDataMessage",_12);},_setPlaceholderAttr:function(_13){this._set("placeholder",_13);this._textArea.set("placeholder",_13);},_setValueAttr:function(_14){this._set("value",_14);this._textArea.set({value:_14,_resetValue:_14});},_getValueAttr:function(){return this._textArea.get("value");},_onKeyUp:function(e){if(!this.store){return;}var key=e.keyCode;switch(key){case _3.LEFT_ARROW:case _3.RIGHT_ARROW:case _3.HOME:case _3.END:case _3.UP_ARROW:case _3.DOWN_ARROW:case _3.CTRL:case _3.ALT:case _3.SHIFT:return;}var _15=this._textArea.textbox,_16=_15.selectionStart,_17=_15.value;if(_17[_16-1]==="@"&&(_16===1||/\s/.test(_17[_16-2]))){this._tagStart=_16-1;this._openPopup();}if(this._isPopupOpen){var _18=key===_3.ESCAPE,_19=typeof this._tagStart=="number"&&_17[this._tagStart]!=="@";if(_18||_19){this._closePopup();return;}if(key===_3.ENTER||key===_3.TAB){this._insertSelection();return;}this._tagEnd=_16;var _1a=_17.substring(this._tagStart+1,_16);this._setQuery(_1a);}},_setQuery:function(_1b){_1b=(_1b||"").trim();if(!_1b){return;}if(!this._queryFunction){var _1c=function(_1d){this._selectList.set("store",this.store,_1d);};this._queryFunction=_b.debounce(_1c.bind(this),null,200);}this._queryFunction({query:_1b});},_onKeyDown:function(e){var _1e=this._selectList,key=e.keyCode;if(this._isPopupOpen){switch(key){case _3.UP_ARROW:e.preventDefault();_1e.moveSelectionUp();break;case _3.DOWN_ARROW:e.preventDefault();_1e.moveSelectionDown();break;case _3.ESCAPE:case _3.ENTER:case _3.TAB:e.preventDefault();break;}return;}if(key===_3.ENTER&&!e.shiftKey){this.emit("save");e.preventDefault();}},_insertSelection:function(){var _1f=this._textArea.textbox,_20=this._selectList,_21=this._tagEnd,_22=_1f.value;var _23=null;for(var id in _20.selection){if(_20.selection[id]){_23=_20.row(id).data;break;}}if(!_23){this._closePopup();return;}var _24=_23[this.tagProperty];var _25="";var _26=0;(_22.charAt(_21)!==" "?_25=" ":_26=1);var _27=_22.slice(0,this._tagStart+1)+_24+_25;var _28=_27.length+_26;_27+=_22.slice(_21);_1f.value=_27;_1f.setSelectionRange(_28,_28);this._closePopup();},_renderRow:function(_29){return _c("div",""+_29[this.displayProperty]);},_openPopup:function(){var _2a=this._selectList,_2b=_5.getContentBox(this.domNode),_2c=this._closePopup.bind(this);_4.set(_2a.domNode,"width",_2b.w+"px");_d.open({parent:this,popup:_2a,around:this.domNode,onExecute:_2c,onCancel:_2c});this._isPopupOpen=true;},_closePopup:function(){this._isPopupOpen=false;this._tagStart=null;this._tagEnd=null;this._selectList.set("store",null);_d.close(this._selectList);}});});