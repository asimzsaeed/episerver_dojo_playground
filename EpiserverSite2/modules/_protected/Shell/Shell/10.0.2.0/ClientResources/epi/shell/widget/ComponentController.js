//>>built
define("epi/shell/widget/ComponentController",["dojo/_base/array","dojo/_base/declare","dojo/Deferred","dojo/_base/lang","dojo/aspect","dojo/has","dojo/promise/all","dojo/when","dojo/store/JsonRest","dojo/store/Memory","dijit/_WidgetBase","epi/dependency","epi/routes","require","epi/shell/ViewSettings","epi/shell/widget/WidgetFactory"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){return _2([_b],{moduleArea:null,widgetFactory:null,_componentsMemoryStore:null,_componentsStore:null,_componentsSortOrderStore:null,_saveComponentRequestQueue:[],_isSaveComponentRequestInProgress:false,postMixInProperties:function(){var _11;this.inherited(arguments);this.widgetFactory=this.widgetFactory||_c.resolve("epi.shell.widget.WidgetFactory");_11=_c.resolve("epi.storeregistry");this._componentsStore=this._componentsStore||_11.get("epi.shell.component");this._componentsSortOrderStore=this._componentsSortOrderStore||_11.get("epi.shell.componentsortorder");this._componentsMemoryStore=new _a();this.own(_5.after(this.widgetFactory,"onWidgetCreated",_4.hitch(this,this.onComponentCreated),true));},onComponentCreated:function(_12,_13){var cd=_4.clone(_13);cd._widgetId=_12.get("id");this._componentsMemoryStore.put(cd);},_queryComponentDefinitions:function(_14){return this._componentsMemoryStore.query(_14);},_runSaveComponentRequest:function(_15){var _16=this,_17;if(_15||!this._isSaveComponentRequestInProgress){this._isSaveComponentRequestInProgress=true;_17=this._saveComponentRequestQueue.shift();if(_17){this._componentsStore.executeMethod("save","",_17.items).then(function(_18){if(_17.promise){_17.promise.resolve(_18);}_16._runSaveComponentRequest(true);},function(_19){if(_17.promise){_17.promise.reject(_19);}_16._runSaveComponentRequest(true);});}else{this._isSaveComponentRequestInProgress=false;}}},getComponentDefinition:function(_1a){return this._queryComponentDefinitions({_widgetId:_1a})[0];},getComponentDefinitionById:function(id){return this._queryComponentDefinitions({id:id})[0];},getEmptyComponentDefinition:function(_1b,_1c){_8(this._componentsStore.query({componentTypeName:_1b}),_1c);},getComponentsForContainer:function(_1d){var _1e=this.getComponentDefinition(_1d.id).id;return this._componentsStore.query({viewName:_f.viewName,parentId:_1e});},getComponentsForView:function(_1f,_20){return this._componentsStore.query({viewName:_1f});},removeComponent:function(_21){var _22=this;return _8(this._componentsStore.remove(_21+"?viewName="+_f.viewName),function(){_22._componentsMemoryStore.remove(_21);});},saveComponents:function(_23){_23=_23.map(function(_24){var _25=_4.clone(_24);delete _25["components"];return _25;});var _26=new _3();if(_23.length<1){_26.resolve();return _26.promise;}this._saveComponentRequestQueue.push({items:_23,promise:_26});this._runSaveComponentRequest(false);return _26.promise;},sortComponents:function(_27,_28,_29){var _2a=this.getComponentDefinition(_27.id).id;_8(this._componentsSortOrderStore.put({id:_2a,viewName:_f.viewName,components:_28}),_29);},addComponent:function(_2b,_2c,_2d,_2e){var _2f=this.getComponentDefinition(_2b.id).id;var _30=_4.clone(_2c);delete _30["id"];_30.parentId=_2f;_30.viewName=_f.viewName;var _31=this;_8(this._componentsStore.put(_30),function(){if(_30.settings["routeData"]){_30.settings.routeData.gadgetId=_30.id;}if(_2d){_8(_31.createComponents([_30],_2b),function(def){if(def){if(typeof _2e=="function"){_2e(true,_30);}}});}},function(){alert("Error: could not add component");if(typeof _2e=="function"){_2e(false,_30);}});},loadComponents:function(_32){var _33=this,def=new _3();if(!(_32 instanceof Array)){_32=[_32];}_8(this.getComponentsForView(_f.viewName),function(_34){if(false){var _35=_e.timedGroup("ComponentController::loadComponents");}var _36=_33._convertListToHierarchyByMatchingParent(_34,"id","parentId","components");_8(_33.createComponents(_36,_32),function(_37){if(false){_35.end();}def.resolve(_37);},function(e){console.error(e.stack||e);def.reject(e);});},function(){def.reject();});return def;},_convertListToHierarchyByMatchingParent:function(_38,_39,_3a,_3b){var map={};var _3c=[];_1.forEach(_38,function(_3d){var id=_3d[_39];map[id]=_3d;});_1.forEach(_38,function(_3e){var _3f;var id=_3e[_39];var _40=_3e[_3a];if(!(_3b in _3e)){_3e[_3b]=[];}_3f=map[_40];if(!_3f||_3f===_3e){if(_1.indexOf(_3c,_3e)<0){_3c.push(_3e);}}else{if(!_3f[_3b]){_3f[_3b]=[];}_3f[_3b].push(_3e);}});return _3c;},createComponents:function(_41,_42){var _43=this.widgetFactory,_44=_41,_45,_46;if(_44 instanceof Array&&_44.length>0){if(_44[0] instanceof Array){var _47=[];for(var i=0;i<_44.length;i++){_45=_44[i];_47.push(_43.createWidgets(_42[i],_45));}return _7(_47);}else{_46=_42;if(_46 instanceof Array){_46=_46[0];}return _43.createWidgets(_46,_44);}}return [];}});});