//>>built
define("epi/shell/widget/GadgetWrapper",["epi","dojo","dijit","dijit/_Widget","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dojox/layout/ContentPane","epi/routes","epi/shell/Error","epi/clientResourcesLoader","dojo/NodeList-traverse","epi/i18n!epi/shell/ui/nls/EPiServer.Shell.UI.Resources.GadgetChrome","epi/i18n!epi/shell/nls/EPiServer.Shell.Resources.Texts"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){var $=epiJQuery,_e=epiJQuery;_1.gadget=(function(){var _f={};_f.gadgetIdHash={};_f.getByElement=function(_10){_10=(_10.jquery?_10.context:_10);var _11=_2.query(_10).closest("div.epi-gadgetInner");if(_11.length===1){var _12=_3.byNode(_11[0]);return _12.getInstance();}else{return null;}};_f.getById=function(_13){var _14=_f.gadgetIdHash[_13];if(!_14){console.error("Gadget with ID "+_13+" is not found in the epi.gadget.gadgetIdHash");return null;}var _15=_3.byId(_14);return _15.getInstance();};_f.loadView=function(_16,_17){_f.getByElement(_16).loadView(_17);};_f.visibilityChanged=function(_18,_19){_f.getByElement(_18).triggerVisibilityChanged();};_f.unload=function(_1a){_f.getByElement(_1a).triggerUnload();};return _f;})();return _2.declare([_4,_5,_6],{res:_2.mixin({},_d,_c),componentId:null,element:null,defaultRouteParams:null,routeData:null,templateString:"<div class=\"epi-gadgetInner\" data-dojo-attach-point=\"gadgetContainer\">                              <div class=\"epi-gadgetFeedback\" data-dojo-attach-point=\"gadgetFeedback\">&nbsp;</div>                              <div class=\"epi-gadgetContent\" ioArgs=\"{ preventCache: true }\" data-dojo-type=\"dojox/layout/ContentPane\" data-dojo-attach-point=\"gadgetContent\"></div>                          </div>",stylePaths:null,scriptPaths:null,constructor:function(){this.stylePaths=[];this.scriptPaths=[];},startup:function(){if(this._started){return;}this.inherited(arguments);if(!this.routeData){this.set("content","Missing route data");return;}this.defaultRouteParams={};for(var _1b in this.routeData){if(_1b[0]!=="_"){this.defaultRouteParams[_1b]=this.routeData[_1b];}}var _1c=_1.clientResourcesLoader.loadResources(this.stylePaths,this.scriptPaths);_2.when(_1c,_2.hitch(this,function(){_1.gadget.gadgetIdHash[this.componentId]=this.id;var _1d=this.getInstance();_1d.routeParams=_2.mixin(this.defaultRouteParams,{gadgetId:this.componentId});this.gadgetContent.set("id","gadget_"+_1d.id);$(_1d.element).bind("_epigadgetloadedinternal",_2.hitch(this,this._onEpiGadgetLoaded));try{if(typeof this.initMethod=="string"){var _1e=_2.getObject(this.initMethod);$(_1d.element).bind("epigadgetinit",_1e);}}catch(ex){this.setErrorMessage(ex.message);}$(_1d.element).trigger("epigadgetinit",_1d);this.connect(this.gadgetContent,"onDownloadEnd",function(){$(_1d.element).trigger("_epigadgetloadedinternal");});this.loadView(this.defaultRouteParams);}));},destroy:function(){delete _1.gadget.gadgetIdHash[this.componentId];this.inherited(arguments);},getInstance:function(){if(this.instance){return this.instance;}this.instance=this._gadgetInstance();return this.instance;},getId:function(){return this.componentId;},getActionPath:function(_1f){return _8.getActionPath(this._mergeRouteParameters(_1f),null);},_onEpiGadgetLoaded:function(){var _20=this.getInstance();$("form.epi-gadgetform",_20.element).validate({errorElement:"span"});$("form.epi-gadgetform",_20.element).bind("submit",_20,this._submitHandler);try{$(_20.element).trigger("epigadgetloaded",_20);}catch(err){this.setErrorMessage(this.res.gadgetinitfailed,{details:err.message,errorThrown:true});}},_mergeRouteParameters:function(_21){return _2.mixin({},this.defaultRouteParams,_21);},_submitHandler:function(e){var _22=e.data;var _23=this;if($(_23).valid()){var _24=_e.Event("epigadgetsubmit");_24.target=_23;$(_23).trigger(_24,_22);if(!_24.isDefaultPrevented()){var _25=$(_23).serializeArray();_25.push({name:"gadgetId",value:_22.id});_22.ajax({url:_23.action,dataType:"html",data:_25,success:function(_26){_22.routeParams={};_22.gadgetContent.set("content",_26.toString());$(_22.element).trigger("_epigadgetloadedinternal");}});}}e.preventDefault();},loadView:function(_27){this.isVisible=true;var _28=this.getInstance();if(_27){_28.routeParams=_27;}else{_28.routeParams=this.defaultRouteParams;}var url=_28.getActionPath(_28.routeParams);this.gadgetContent.set("href",url);},getIsVisible:function(){return this.isVisible;},setErrorMessage:function(_29,_2a){_2a=_2.mixin({details:"",status:0,errorThrown:false},_2a);var _2b=_2.query(".epi-gadgetError",this.gadgetContainer);if(_2b.length===0){_2b=_2.create("div",{"class":"epi-feedbackContent-error epi-feedbackContent epi-gadgetError"},this.gadgetContainer,"before");}_9.createErrorMessage(_2b,_29,_2a.details,_2a.status,true);_2.style(_2b,"display","block");},clearErrorMessage:function(){var _2c=_2.query(".epi-gadgetError",this.gadgetContainer);_2.style(_2c,"display","none");},setFeedbackMessage:function(_2d,_2e){_2e=_2.mixin({ajaxLoader:false,feedbackMessage:_2d,feedbackTitle:"",feedbackHideDelay:0,feedbackFadeOut:false},_2e);this.gadgetFeedback.innerHTML=_2e.feedbackMessage;_2.style(this.gadgetFeedback,"display","block");if(_2e.ajaxLoader){_2.addClass(this.gadgetFeedback,"epi-gadgetLoader");}if(_2e.feedbackHideDelay>0){var _2f=this;setTimeout(function(){_2f.clearFeedbackMessage(_2e);},_2e.feedbackHideDelay);}else{if(_2e.feedbackFadeOut){this.clearFeedbackMessage(_2e);}}},clearFeedbackMessage:function(_30){_2.removeClass(this.gadgetFeedback,"epi-gadgetLoader");if(_30&&_30.feedbackFadeOut&&_2.style(this.gadgetFeedback,"display")==="block"){var _31={node:this.gadgetFeedback,duration:4000,onEnd:_2.hitch(this,function(){_2.style(this.gadgetFeedback,"display","none");_2.style(this.gadgetFeedback,"opacity","1");})};_2.fadeOut(_31).play();}else{_2.style(this.gadgetFeedback,"display","none");}},triggerUnload:function(){$(this.getInstance().element).trigger("epigadgetunload",this.getInstance());},triggerVisibilityChanged:function(_32){this.isVisible=_32;$(this.getInstance().element).trigger("epigadgetvisibilitychanged",this.getInstance());},_gadgetInstance:function(){var _33=this;var pub={id:_33.componentId,element:_33.gadgetContainer,gadgetContent:_33.gadgetContent,routeParams:{}};pub.getActionPath=function(_34){return _33.getActionPath(_34);};pub.loadView=function(_35){_33.loadView(_35);};pub.isVisible=function(){return _33.getIsVisible();};pub.setErrorMessage=function(_36,_37){_33.setErrorMessage(_36,_37);};pub.clearErrorMessage=function(){_33.clearErrorMessage();};pub.setFeedbackMessage=function(_38,_39){_33.setFeedbackMessage(_38,_39);};pub.clearFeedbackMessage=function(){_33.clearFeedbackMessage();};pub.raiseErrorEvent=function(_3a){this.error=_3a;$(this.element).trigger("epigadgeterror",this);this.error=null;};pub.ajax=function(_3b){var _3c=this;var _3d={dataType:"json",feedbackMessage:"",cache:false,type:"POST",ajaxLoader:true,error:function(_3e,_3f,_40){_3c.clearFeedbackMessage();_3c.raiseErrorEvent({xmlHttpRequest:_3e,status:_3f,errorThrown:_40});_3c.setErrorMessage("<strong>"+_33.res.internalservererror+" ["+_3e.status+"]</strong>.",{details:_3e.responseText,status:_3f,errorThrown:_40});},success:function(_41){_3c.clearFeedbackMessage();}};var _42=$("input[name=__RequestVerificationToken]",this.element);if(_42.length>0){var _43={__RequestVerificationToken:_42.val()};if(_3b.data){if(!_3b.data.__RequestVerificationToken){_3b.data=$.extend(_3b.data,_43);}}else{_3b.data=_43;}}if($.isFunction(_3b.success)){var _44=_3b.success;_3b.success=function(_45,_46){_3c.clearFeedbackMessage();_44.call(this,_45,_46);};}if($.isFunction(_3b.error)){var _47=_3b.error;_3b.error=function(_48,_49,_4a){_3c.clearFeedbackMessage();_47.call(this,_48,_49,_4a);};}_3d=$.extend(_3d,_3b);_3c.setFeedbackMessage("",_3d);$.ajax(_3d);};return pub;}});});