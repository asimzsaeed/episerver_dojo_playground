//>>built
define("epi/shell/widget/WidgetFactory",["dojo/_base/array","dojo/_base/Deferred","dojo/_base/declare","dojo/_base/lang","dojo/_base/window","dojo/dom","dojo/promise/all","dojo/when","epi/dependency","dijit/_Widget","dijit/_Container","dojox/layout/GridContainerLite","epi/shell/widget/ToolbarDropDownButton","epi/shell/widget/ToolbarSet"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){return _3(null,{_domNodeName:"[domnode]",_handlers:null,moduleManager:null,messageService:undefined,onWidgetHierarchyCreated:null,onWidgetCreated:null,constructor:function(_a){_3.safeMixin(this,_a);this._handlers=[];this._addDefaultHandlers();this.messageService=this.messageService||_9.resolve("epi.shell.MessageService");this.moduleManager=this.moduleManager||_9.resolve("epi.ModuleManager");},createWidgets:function(_b,_c,_d){var _e,_f,_10=[],_11=[],_12=new _2(),_13;_d===false?_d=false:_d=true;if(typeof (_b)==="string"){_b=_6.byId(_b);}if(_c&&!_4.isArray(_c)){_c=[_c];}if(this.getHandler(_b).type===this._domNodeName){_e=_5.doc.createDocumentFragment();_e.tagName="documentFragment";}_f=_4.hitch(this,function(_14){if(_14 instanceof Array){for(var i in _14){_f(_14[i]);}}if(_14.components instanceof Array){_f(_14.components);}if(_14.moduleName){_11.push(this.moduleManager.startModules(_14.moduleName));}if(_14.widgetPackage){_10.push(_14.widgetPackage);}else{if(_14.widgetType){_10.push(_14.widgetType);}}});_f(_c);_13=require.on("error",function(_15){console.error(_15.stack||_15);_13.remove();_12.reject(_15);});_7(_11).then(_4.hitch(this,function(){require(_10,_4.hitch(this,function(){_13.remove();this._createWidgets(_e||_b,_c).then(function(_16){try{_e&&_b.appendChild(_e);if(_d){_1.forEach(_16,function(w){!w._started&&w.startup&&w.startup();});}_12.resolve(_16);}catch(err){_12.reject(err);}},_12.reject);}));}));return _12;},_createWidgets:function(_17,_18){var dfd=new _2(),_19=[],_1a=this.getHandler(_17),_1b;if(!_1a||!_4.isArray(_18)){dfd.resolve(_19);return dfd;}_1b=_1.map(_18,_4.hitch(this,function(_1c){var _1d=new _2(),_1e=this._createInternal(_17,_1c,_1a);_1e.then(function(_1f){if(_1f){_19.push(_1f);}_1d.resolve(_1f);},function(e){console.error(e.stack||e);_1d.reject(e);});return _1d;}));_7(_1b).then(function(){dfd.resolve(_19);},function(_20){console.error("WidgetFactory: Could not resolve one or more widgets");dfd.reject(_20);});return dfd;},_createInternal:function(_21,_22,_23){var _24=new _2();_8(_23.instantiateWidgetFunction(_22),_4.hitch(this,function(_25){if(_25){try{if(typeof this.onWidgetCreated=="function"){this.onWidgetCreated(_25,_22);}_23.addWidgetToRootFunction(_21,_25);}catch(e){_24.reject(e);return;}var _26=new _2();if(_22.components&&_4.isArray(_22.components)&&_22.components.length>0){_26=this._createWidgets(_25,_22.components);}else{_26.resolve();}_26.then(_4.hitch(this,function(){try{if(typeof this.onWidgetHierarchyCreated=="function"){this.onWidgetHierarchyCreated(_25,_22);}_24.resolve(_25);}catch(e){_24.reject(e);}}),_24.reject);}else{_24.reject();}}),function(_27){console.error(_27.stack||_27);_24.reject(_27);});return _24;},defaultWidgetInstantiator:function(_28){var def=new _2();var _29=_4.mixin({},_28.settings,{componentId:_28.id});var _2a=_28.widgetType;var _2b=_28.widgetPackage&&_4.getObject(_28.widgetType);var _2c=require.on("error",function(_2d){console.error(_2d.stack||_2d);_2c.remove();def.reject(_2d);});function _2e(_2f){var _30=new _2f(_29);if(_28.connections){for(var evt in _28.connections){if(_28.connections[evt]){_30.connect(_30,evt,_28.connections[evt]);}}}_2c.remove();def.resolve(_30);};if(_2b){_2e(_2b);}else{require([_2a],_4.hitch(this,_2e));}return def;},_notifyError:function(msg){if(this.messageService){this.messageService.put("error",msg);}},_addDefaultHandlers:function(){this.addHandler(this._domNodeName,function(_31,_32){_32.placeAt(_31);},null,function(){return true;});this.addHandler("dijit/_Widget",function(_33,_34){_33.set("content",_34);});this.addHandler("dijit/_Container",function(_35,_36){_35.addChild(_36);});this.addHandler("dojox/layout/GridContainerLite",function(_37,_38){_37.addChild(_38,_38.params.column);});this.addHandler("epi/shell/widget/ToolbarDropDownButton",function(_39,_3a){_39.addChild(_3a);});this.addHandler("epi/shell/widget/ToolbarSet",function(_3b,_3c){_3b.addChild(_3c);});},addHandler:function(_3d,_3e,_3f,_40){var _41=function(_42,_43){return _43&&_4.isFunction(_42.isInstanceOf)&&_42.isInstanceOf(_43);};var _44=_4.hitch(this,function(_45){var _46=this.getHandlerByTypeName(_3d);var _47=_40||_41;var _48=_46?true:false;if(!_48){_46={};}var _49=_3f||_4.hitch(this,this.defaultWidgetInstantiator);_46.type=_3d;_46.instantiateWidgetFunction=_49;_46.addWidgetToRootFunction=_3e;_46.widgetConstructor=_45;_46.canHandle=_47;if(!_48){this._handlers.push(_46);}});if(_3d!==this._domNodeName){require([_3d],_44);}else{_44();}},getHandler:function(_4a){var _4b=this._handlers;for(var i=_4b.length-1;i>=0;i--){if(_4b[i].canHandle(_4a,_4b[i].widgetConstructor)){return _4b[i];}}return null;},getHandlerByTypeName:function(_4c){var _4d=this._handlers;for(var i=0;i<_4d.length;i++){if(_4d[i].type===_4c){return _4d[i];}}return null;},removeHandler:function(_4e){var _4f=this._handlers;for(var i=0;i<_4f.length;i++){if(_4f[i].type===_4e){_4f.splice(i,1);}}},listHandlers:function(){var _50=this._handlers;return _1.map(_50,function(_51){return _51.type;});}});});