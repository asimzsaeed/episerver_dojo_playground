//>>built
define("epi/shell/widget/WidgetSwitcher",["dojo/_base/array","dojo/_base/declare","dojo/_base/kernel","dojo/_base/lang","dojo/Deferred","dojo/topic","dojo/when","epi/shell/_ContextMixin","epi/shell/layout/AnimatedCardContainer","epi/shell/TypeDescriptorManager"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _2([_9,_8],{componentConstructorArgs:null,supportedContextTypes:null,constructor:function(){this._viewHistory=[];},postMixInProperties:function(){this.inherited(arguments);if(this.supportedContextTypes){if(!_4.isArray(this.supportedContextTypes)){this.supportedContextTypes=[this.supportedContextTypes];}if(!_1.every(this.supportedContextTypes,function(_b){return typeof _b=="string";})){throw new Error("supportedContextTypes must be string, array of strings or null.");}}},postCreate:function(){this.inherited(arguments);_7(this.getCurrentContext(),_4.hitch(this,this.contextChanged));this.own(_6.subscribe("/epi/shell/action/changeview",_4.hitch(this,"viewComponentChangeRequested")),_6.subscribe("/epi/shell/action/changeview/back",_4.hitch(this,"_viewComponentBackRequested")),_6.subscribe("/epi/shell/action/changeview/updatestate",_4.hitch(this,"_changeViewState")));},contextChanged:function(_c,_d){if(!this._isContextTypeSupported(_c)){return;}var _e=_c.customViewType||(!!_d?_d.viewType:null);var _f=this._getCurrentWidgetInfo();if(_d&&_d.contextIdSyncChange&&_f){_e=_f.type;_d=_4.mixin({},_d,{viewName:_f.viewName,availableViews:_f.availableViews});}if(!_e&&_c.dataType){_e=_a.getValue(_c.dataType,"mainWidgetType");}if(_e){this._getObject(_e,null,_c,_d);}else{var _10=_a.getValue(_c.dataType,"defaultView"),_11=this._getAvailableViews(_c.dataType),_12=_d?_d.viewName:null;var _13=["view","sidebysidecompare","allpropertiescompare"];if(_f&&_13.indexOf(_f.viewName)>=0){_1.some(_11,function(_14){if(_14.key===_f.viewName){_10=_f.viewName;return true;}return false;});}var _15=this._getViewByKey(_12||_10,_11);if(!_15){throw "No default view found for "+_c.dataType;}this._loadViewComponentByConfiguration(_15,_11,null,_c,_d);}},_getViewByKey:function(key,_16){return _1.filter(_16,function(_17){return _17.key===key;})[0];},_getAvailableViews:function(_18){var _19=_a.getAndConcatenateValues(_18,"availableViews"),_1a=_a.getValue(_18,"disabledViews");var _1b=_1.filter(_19,function(_1c){return _1.every(_1a,function(_1d){return _1c.key!==_1d;});});return _1b.sort(function(x,y){return x.sortOrder<y.sortOrder?-1:1;});},_loadViewComponentByConfiguration:function(_1e,_1f,_20,_21,_22){_22=_4.mixin({},_22,{viewName:_1e.key,availableViews:_1f});this._getObject(_1e.controllerType,_20,_21,_22);},viewComponentChangeRequested:function(_23,_24,_25){_7(this.getCurrentContext(),_4.hitch(this,function(_26){var _27=_26?_26.dataType:null;if(!_23&&_27){_23=_a.getValue(_27,"defaultView");}var _28=this._getAvailableViews(_27),_29=this._getViewByKey(_23,_28);if(_29){this._loadViewComponentByConfiguration(_29,_28,_24,_26,_25);}else{this._getObject(_23,_24,_26,_25);}}));},_viewComponentBackRequested:function(_2a){var _2b=this._getPreviousWidgetInfo();if(_2b){if(typeof _2a==="undefined"){_2a=false;}var _2c={skipUpdateView:!_2a,availableViews:_2b.availableViews,viewName:_2b.viewName};_7(this.getCurrentContext(),_4.hitch(this,function(_2d){this._getObject(_2b.type,null,_2d,_2c);}));}},_changeViewState:function(_2e){var _2f=this._getCurrentWidgetInfo();if(_2f){_4.mixin(_2f,_2e);}},_getPreviousWidgetInfo:function(){var _30=this._viewHistory.length;var _31=this._viewHistory;var _32=(_31.length>1)?_31[_31.length-2]:null;this._viewHistory.splice(_30-1,1);return _32;},_getCurrentWidgetInfo:function(){var _33=this._viewHistory;return (_33.length>0)?_33[_33.length-1]:null;},_isContextTypeSupported:function(_34){if(!_34){return false;}if(!this.supportedContextTypes){return true;}return _1.some(this.supportedContextTypes,function(_35){return _34.type===_35;});},_getObject:function(_36,_37,_38,_39){if(!_36){return;}var _3a=this.selectedChildWidget;var _3b=_4.hitch(this,function(){_7(this._testComponentInstanceOf(_3a,_36),_4.hitch(this,function(_3c){if(_3c){this._updateHistory(_36,_39,_38);this._updateView(_3a,_38,_39);this._onViewChanged(_36,_37,_39);}else{this._changeViewComponent(_36,_37,_38,_39);}}));});if(_3a&&_3a.savePendingChanges){_7(_3a.savePendingChanges(),_3b);}else{_3b();}},_changeViewComponent:function(_3d,_3e,_3f,_40){_7(this._getChildByType(_3d),_4.hitch(this,function(_41){var _42=this.selectedChildWidget;if(_42){_42.set("isActive",false);}if(_41){_41.set("isActive",true);if(_40&&_40.treatAsSecondaryView){this.selectSecondaryChild(_41);}else{this.selectChild(_41);}this._updateHistory(_3d,_40,_3f);this._updateView(_41,_3f,_40,true);this._onViewChanged(_3d,_3e,_40);}else{require([_3d],_4.hitch(this,function(_43){var _44=_4.mixin(_4.mixin({},this.componentConstructorArgs),_3e);_41=new _43(_44);_41.fitContainer=true;this.addChild(_41);var _45;if(_40&&_40.treatAsSecondaryView){_45=this.selectSecondaryChild(_41);}else{_45=this.selectChild(_41);}_7(_45,_4.hitch(this,function(){this._updateHistory(_3d,_40,_3f);this._updateView(_41,_3f,_40,true);this._onViewChanged(_3d,_3e,_40);}));}));}}));},_updateView:function(_46,_47,_48,_49){if(_46&&!_46._started&&typeof _46.startup==="function"){_46.startup();}if(_46&&typeof _46.updateView==="function"){_46.updateView(_48,_47,{widgetResumed:_49});}},_getChildByType:function(_4a){var def=new _5();require([_4a],_4.hitch(this,function(_4b){var _4c=_1.filter(this.getChildren(),function(_4d){return _4d.constructor===_4b;},this);def.resolve(_4c.length?_4c[0]:null);}));return def;},_testComponentInstanceOf:function(_4e,_4f){var def=new _5();if(_4e){if(typeof _4f==="string"){require([_4f],function(_50){def.resolve(_4e&&_4e.constructor===_50);});}else{def.resolve(_4e&&_4e.constructor===_4f.constructor);}}else{def.resolve(false);}return def;},_onViewChanged:function(_51,_52,_53){_6.publish("/epi/shell/action/viewchanged",_51,_52,_53);},_updateHistory:function(_54,_55,_56){var _57=this._viewHistory,_58=_57.length,_59=this.createStoreItem(_54,_55,_56);if(_58&&_57[_58-1].id===_59.id){return;}if(_58===9){_57.shift();}_57.push(_59);},createStoreItem:function(_5a,_5b,_5c){var _5d={type:_5a,id:_5a};if(_5b){var _5e=_5b.availableViews||(_5c&&this._getAvailableViews(_5c.dataType));var _5f=_5b.viewName||this._getViewName(_5e,_5c);_5d=_4.mixin(_5d,{availableViews:_5e,viewName:_5f});_5d.id+="#"+_5f;}return _5d;},_getViewName:function(_60,_61){if(!_61){return null;}var _62=this._getViewByKey(_a.getValue(_61.dataType,"defaultView"),_60);if(!_62){return null;}return _62.key;}});});