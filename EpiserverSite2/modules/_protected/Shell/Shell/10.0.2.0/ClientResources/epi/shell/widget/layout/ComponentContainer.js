//>>built
define("epi/shell/widget/layout/ComponentContainer",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/when","dojo/dom-class","dojo/dom-geometry","dojo/dom-style","dojox/layout/GridContainer","dojox/layout/GridContainerLite","dijit/focus","dijit/registry","epi/dependency","epi/shell/widget/_ActionProvider","epi/shell/widget/ComponentSelectorDialog","epi/shell/widget/layout/_ComponentWrapper","epi/shell/widget/layout/ComponentTabContainer","epi/i18n!epi/shell/ui/nls/episerver.shell.ui.resources"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12){return _2([_9,_e],{containerUnlocked:false,isAutoOrganized:false,baseClass:"epi-componentContainer",numberOfColumns:1,hasResizableColumns:false,_componentSelectorDialog:null,_componentsController:null,postMixInProperties:function(){this.inherited(arguments);this.nbZones=this.numberOfColumns;this._componentsController=this._componentsController||_d.resolve("epi.shell.controller.Components");},resizeChildAfterDrop:function(_13,_14,_15){this.inherited(arguments);if(_c.getEnclosingWidget(_14.node)===this){this._onDndDrop();}},_persistComponentSettings:function(){var _16=[];this.getChildren().forEach(function(_17){var _18=this._componentsController.getComponentDefinitionById(_17.componentId);_18.settings=_3.mixin(_18.settings,_17.get("settings"));_18.settings.column=_17.get("column");_16.push(_18);},this);this._componentsController.saveComponents(_16);},buildRendering:function(){this.inherited(arguments);this.acceptTypes=[this.id];},postCreate:function(){this.inherited(arguments);this._setupDragManager();this.containerNode.removeAttribute("id");},_setupDragManager:function(){_4.before(this._dragManager,"_searchDragHandle",function(_19){if(_19&&_6.contains(_19,"dojoxDragHandle")){return _19;}});},startup:function(){if(this._started){return;}this.inherited(arguments);this.changeLockButtonState(false);},onShow:function(){if(this._disabled&&this.containerUnlocked){this.enableDnd();}},layout:function(){this._containerSize={h:this._contentBox.h-this._border.h,w:this._contentBox.w-this._border.w};this.layoutComponents();if(this.doLayout){_7.setContentSize(this.containerNode,{h:this._contentBox.h-this._border.h});_7.setContentSize(this.domNode,{w:this._contentBox.w-this._border.w});}},layoutComponents:function(){var _1a=_7.getContentBox(this.gridContainerDiv);var _1b={w:_1a.w/this.numberOfColumns};_1.forEach(this.getChildren(),function(_1c){if(_1c.resize&&_3.isFunction(_1c.resize)){_1c.resize(_1b);}});},_layoutChildren:function(_1d,_1e,_1f){_1d.resize({h:_1e});if(_1f){_1d.set("lastOpenHeight",_1e);this.layoutComponents();this._persistComponentSettings();}},addComponent:function(_20){this._componentSelectorDialog.hide();this._componentsController.addComponent(this,_20,true,_3.hitch(this,function(){this.layoutComponents();}));},_selectFocus:function(){var _21=_b.curNode;if(_21===null||_21.parentNode===null){return;}this.inherited(arguments);},addChild:function(_22,_23){var _24,_25=this._componentsController.getComponentDefinitionById(_22.componentId),id=_25?_25.id:_22.componentId,_26=this.containerUnlocked,_27={componentId:id,dndType:this.id,isRemovable:_25?_25.settings.isRemovable:_22.params.isRemovable,minHeight:_22.get("minHeight")||200,maxHeight:_22.get("maxHeight")||Infinity,dragRestriction:!_26,closable:_26,heading:_22.get("heading"),container:this},_28=_3.mixin(_27,_25.settings);if(!_22.isInstanceOf(_10)&&!_22.isInstanceOf(_11)){_24=new _10(_28);_24.addChild(_22);}else{_24=_22;for(var _29 in _28){_24.set(_29,_27[_29]);}}this.connect(_24,"onClosed",_3.hitch(this,this._gadgetClosed,_24));this._connect(_24.on("toggle",_3.hitch(this,function(){this._componentToggle(_24);})));if(_23>=this.numberOfColumns){_23=this.numberOfColumns-1;}var _2a=this.inherited(arguments,[_24,_23]);if(_26&&_3.isFunction(_2a.disableResize)){_2a.disableResize();}this._onCompontentsChanged();return _2a;},_componentToggle:function(_2b){_2b.resize();this.layoutComponents();this._persistComponentSettings();},_gadgetClosed:function(_2c){var _2d=_2c.componentId;_5(this._componentsController.removeComponent(_2d),_3.hitch(this,function(){_2c.destroyRecursive();this._onCompontentsChanged();this._persistComponentSettings();this.layoutComponents();}));},_onCompontentsChanged:function(){this.layoutComponents();},showComponentSelector:function(){if(this._componentSelectorDialog===null){this._componentSelectorDialog=new _f();this.own(this._componentSelectorDialog);this.connect(this._componentSelectorDialog,"onComponentSelected",this.addComponent);}this._componentSelectorDialog.show();},changeLockButtonState:function(_2e){this.containerUnlocked=_2e;_1.forEach(this.getChildren(),_3.hitch(this,function(_2f){_2f.set("dragRestriction",!_2e);_2f.set("closable",_2e);}));this.containerUnlocked?this.enableDnd():this.disableDnd();},_saveComponentOrder:function(_30,_31){var _32=_1.map(_30,function(_33){return {id:_33.componentId,column:_33.get("column")};});this._componentsController.sortComponents(this,_32,_31);},_onDndDrop:function(){var _34=this.getChildren();this._saveComponentOrder(_34);this._onCompontentsChanged();this.layoutComponents();},_reloadGadgets:function(){var _35=this.getChildren();var _36=_35.length;var _37=this;_1.forEach(_35,function(_38){_37.removeChild(_38);_37.addChild(_38,_38.get("column"),_36);});this._onCompontentsChanged();},_reloadContainer:function(_39,_3a){this.numberOfColumns=_3a;if(_39){this._reloadGadgets();}},setColumns:function(_3b){var _3c=this.getChildren();var _3d=this;if(_3c.length<=0){this._reloadContainer(false,_3b);}else{_1.forEach(_3c,function(_3e){if(_3e.column>=_3b){_3e.set("column",_3b-1);}});this._saveComponentOrder(_3c,_3.hitch(this,function(_3f){this._reloadContainer(_3f,_3b);}));}this.inherited(arguments);this.resize();},_organizeChildrenManually:function(){var _40=_a.superclass.getChildren.call(this),_41=_40.length,_42;for(var i=0;i<_41;i++){_42=_40[i];try{this._insertChild(_42,_42.column);}catch(e){console.error("Unable to insert child in GridContainer",e);}}},_connect:function(_43){this._connects.push(_43);},getActions:function(){var _44=this,_45=this.inherited(arguments),_46={parent:"settings",name:"addGadgets",label:_12.componentselection.addgadgetstitle,type:"menuitem",action:_3.hitch(this,this.showComponentSelector)},_47={parent:"settings",name:"rearrangeGadgets",label:_12.componentselection.rearrangegadgets,type:"checkedmenuitem",action:function(){_3.hitch(this,_44.changeLockButtonState(this.checked));}};_45.splice(_45.length,0,_46);_45.splice(_45.length,0,_47);return _45;}});});