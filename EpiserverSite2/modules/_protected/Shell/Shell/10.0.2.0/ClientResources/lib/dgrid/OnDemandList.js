//>>built
define("dgrid/OnDemandList",["./List","./_StoreMixin","dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/dom","dojo/on","./util/misc","put-selector/put"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){return _3([_1,_2],{minRowsPerPage:25,maxRowsPerPage:250,maxEmptySpace:Infinity,bufferRows:10,farOffRemoval:2000,queryRowsOverlap:0,pagingMethod:"debounce",pagingDelay:_8.defaultDelay,keepScrollPosition:false,rowHeight:22,postCreate:function(){this.inherited(arguments);var _a=this;_7(this.bodyNode,"scroll",_8[this.pagingMethod](function(_b){_a._processScroll(_b);},null,this.pagingDelay));},renderQuery:function(_c,_d){var _e=this,_f=(_d&&_d.container)||this.contentNode,_10={query:_c,count:0,options:_d},_11,_12=this.preload,_13;var _14={node:_9(_f,"div.dgrid-preload",{rowIndex:0}),count:0,query:_c,next:_10,options:_d};_14.node.style.height="0";_10.node=_11=_9(_f,"div.dgrid-preload");_10.previous=_14;_11.rowIndex=this.minRowsPerPage;if(_12){if((_10.next=_12.next)&&_11.offsetTop>=_12.node.offsetTop){_10.previous=_12;}else{_10.next=_12;_10.previous=_12.previous;}_10.previous.next=_10;_10.next.previous=_10;}else{this.preload=_10;}var _15=_9(_11,"-div.dgrid-loading"),_16=_9(_15,"div.dgrid-below");_16.innerHTML=this.loadingMessage;function _17(err){_9(_15,"!");if(err){if(_e._refreshDeferred){_e._refreshDeferred.reject(err);delete _e._refreshDeferred;}throw err;}};_d=_4.mixin(this.get("queryOptions"),_d,{start:0,count:this.minRowsPerPage},"level" in _c?{queryLevel:_c.level}:null);this._trackError(function(){return _13=_c(_d);});if(typeof _13==="undefined"){_17();return;}_5.when(_e.renderArray(_13,_11,_d),function(trs){var _18=typeof _13.total==="undefined"?_13.length:_13.total;return _5.when(_18,function(_19){var _1a=trs.length,_1b=_11.parentNode,_1c=_e.noDataNode;_9(_15,"!");if(!("queryLevel" in _d)){_e._total=_19;}if(_19===0){if(_1c){_9(_1c,"!");delete _e.noDataNode;}_e.noDataNode=_1c=_9("div.dgrid-no-data");_1b.insertBefore(_1c,_e._getFirstRowSibling(_1b));_1c.innerHTML=_e.noDataMessage;}var _1d=0;for(var i=0;i<_1a;i++){_1d+=_e._calcRowHeight(trs[i]);}if(_1a&&_1d){_e.rowHeight=_1d/_1a;}_19-=_1a;_10.count=_19;_11.rowIndex=_1a;if(_19){_11.style.height=Math.min(_19*_e.rowHeight,_e.maxEmptySpace)+"px";}else{_11.style.display="none";_d.count++;}if(_e._previousScrollPosition){_e.scrollTo(_e._previousScrollPosition);delete _e._previousScrollPosition;}_e._processScroll();if(_e._refreshDeferred){_e._refreshDeferred.resolve(_13);delete _e._refreshDeferred;}return trs;},_17);},_17);return _13;},refresh:function(_1e){var _1f=this,_20=(_1e&&_1e.keepScrollPosition),dfd,_21;if(typeof _20==="undefined"){_20=this.keepScrollPosition;}if(_20){this._previousScrollPosition=this.getScrollPosition();}this.inherited(arguments);if(this.store){dfd=this._refreshDeferred=new _5();_21=_1f.renderQuery(function(_22){return _1f.store.query(_1f.query,_22);});if(typeof _21==="undefined"){dfd.reject();}return dfd.then(function(_23){setTimeout(function(){_7.emit(_1f.domNode,"dgrid-refresh-complete",{bubbles:true,cancelable:false,grid:_1f,results:_23});},0);delete _1f._refreshDeferred;return _23;},function(err){delete _1f._refreshDeferred;throw err;});}},resize:function(){this.inherited(arguments);this._processScroll();},_getFirstRowSibling:function(_24){return _24.lastChild;},_calcRowHeight:function(_25){var _26=_25.nextSibling;if(_26&&!/\bdgrid-preload\b/.test(_26.className)){return _26.offsetTop-_25.offsetTop;}return _25.offsetHeight;},lastScrollTop:0,_processScroll:function(evt){var _27=this,_28=_27.bodyNode,_29=(evt&&evt.scrollTop)||this.getScrollPosition().y,_2a=_28.offsetHeight+_29,_2b,_2c,_2d=_27.preload,_2e=_27.lastScrollTop,_2f=_27.bufferRows*_27.rowHeight,_30=_2f-_27.rowHeight,_31,_32,_33,_34=true;var _35=1;_27.lastScrollTop=_29;function _36(_37,_38,_39,_3a){var _3b=_27.farOffRemoval,_2c=_37.node;if(_38>2*_3b){var row,_3c=_2c[_39];var _3d=0;var _3e=0;var _3f=[];while((row=_3c)){var _40=_27._calcRowHeight(row);if(_3d+_40+_3b>_38||(_3c.className.indexOf("dgrid-row")<0&&_3c.className.indexOf("dgrid-loading")<0)){break;}var _3c=row[_39];_3d+=_40;_3e+=row.count||1;_27.removeRow(row,true);_3f.push(row);}_37.count+=_3e;if(_3a){_2c.rowIndex-=_3e;_41(_37);}else{_2c.style.height=(_2c.offsetHeight+_3d)+"px";}var _42=_9("div",_3f);setTimeout(function(){_9(_42,"!");},1);}};function _41(_43,_44){_43.node.style.height=Math.min(_43.count*_27.rowHeight,_44?Infinity:_27.maxEmptySpace)+"px";};function _45(_46,_47){do{_46=_47?_46.next:_46.previous;}while(_46&&!_46.node.offsetWidth);return _46;};while(_2d&&!_2d.node.offsetWidth){_2d=_2d.previous;}while(_2d&&_2d!=_2b){_2b=_27.preload;_27.preload=_2d;_2c=_2d.node;var _48=_2c.offsetTop;var _49;if(_2a+_35+_30<_48){_2d=_45(_2d,(_34=false));}else{if(_29-_35-_30>(_48+(_49=_2c.offsetHeight))){_2d=_45(_2d,(_34=true));}else{var _4a=((_2c.rowIndex?_29-_2f:_2a)-_48)/_27.rowHeight;var _4b=(_2a-_29+2*_2f)/_27.rowHeight;var _4c=Math.max(Math.min((_29-_2e)*_27.rowHeight,_27.maxRowsPerPage/2),_27.maxRowsPerPage/-2);_4b+=Math.min(Math.abs(_4c),10);if(_2c.rowIndex==0){_4a-=_4b;}_4a=Math.max(_4a,0);if(_4a<10&&_4a>0&&_4b+_4a<_27.maxRowsPerPage){_4b+=Math.max(0,_4a);_4a=0;}_4b=Math.min(Math.max(_4b,_27.minRowsPerPage),_27.maxRowsPerPage,_2d.count);if(_4b==0){_2d=_45(_2d,_34);continue;}_4b=Math.ceil(_4b);_4a=Math.min(Math.floor(_4a),_2d.count-_4b);var _4d=_4.mixin(_27.get("queryOptions"),_2d.options);_2d.count-=_4b;var _4e=_2c,_4f,_50=_27.queryRowsOverlap,_51=(_2c.rowIndex>0||_2c.offsetTop>_29)&&_2d;if(_51){var _52=_2d.previous;if(_52){_36(_52,_29-(_52.node.offsetTop+_52.node.offsetHeight),"nextSibling");if(_4a>0&&_52.node==_2c.previousSibling){_4a=Math.min(_2d.count,_4a);_2d.previous.count+=_4a;_41(_2d.previous,true);_2c.rowIndex+=_4a;_50=0;}else{_4b+=_4a;}_2d.count-=_4a;}_4d.start=_2c.rowIndex-_50;_4d.count=Math.min(_4b+_50,_27.maxRowsPerPage);_2c.rowIndex=_4d.start+_4d.count;}else{if(_2d.next){_36(_2d.next,_2d.next.node.offsetTop-_2a,"previousSibling",true);var _4e=_2c.nextSibling;if(_4e==_2d.next.node){_2d.next.count+=_2d.count-_4a;_2d.next.node.rowIndex=_4a+_4b;_41(_2d.next);_2d.count=_4a;_50=0;}else{_4f=true;}}_4d.start=_2d.count;_4d.count=Math.min(_4b+_50,_27.maxRowsPerPage);}if(_4f&&_4e&&_4e.offsetWidth){_4f=_4e.offsetTop;}_41(_2d);if("level" in _2d.query){_4d.queryLevel=_2d.query.level;}if(!("queryLevel" in _4d)&&(_4d.start>_27._total||_4d.count<0)){continue;}var _53=_9(_4e,"-div.dgrid-loading[style=height:"+_4b*_27.rowHeight+"px]"),_54=_9(_53,"div.dgrid-"+(_51?"below":"above"));_54.innerHTML=_27.loadingMessage;_53.count=_4b;var _55=_2d.query(_4d),_56=_27._trackError(function(){return _55;});if(_56===undefined){_9(_53,"!");return;}(function(_57,_58,_59,_5a){_33=_5.when(_27.renderArray(_5a,_57,_4d),function(_5b){_32=_5a;_4e=_57.nextSibling;_9(_57,"!");if(_59&&_4e&&_4e.offsetWidth){var pos=_27.getScrollPosition();_27.scrollTo({x:pos.x,y:pos.y+_4e.offsetTop-_59,preserveMomentum:true});}_5.when(_5a.total||_5a.length,function(_5c){if(!("queryLevel" in _4d)){_27._total=_5c;}if(_58){_58.count=_5c-_58.node.rowIndex;if(_58.count===0){_4d.count++;}_41(_58);}});_27._processScroll();return _5b;},function(e){_9(_57,"!");throw e;});}).call(this,_53,_51,_4f,_55);_2d=_2d.previous;}}}if(_33&&(_31=this._refreshDeferred)){delete this._refreshDeferred;_5.when(_33,function(){_31.resolve(_32);});}},removeRow:function(_5d,_5e){function _5f(_60,_61){return _60!=null?_60:_61;};if(_5d){var _62=_5d.previousSibling,_63=_5d.nextSibling,_64=_62&&_5f(_62.observerIndex,_62.previousObserverIndex),_65=_63&&_5f(_63.observerIndex,_63.nextObserverIndex),_66=_5d.observerIndex;_5d.observerIndex=undefined;if(_5e){_5d.nextObserverIndex=_65;_5d.previousObserverIndex=_64;}if(this.cleanEmptyObservers&&_66>-1&&_66!==_64&&_66!==_65){var _67=this.observers;var _68=_67[_66];if(_68){if(!_5e){var _69=_68.rows;for(var i=0;i<_69.length;i++){if(_69[i]!=_5d&&_6.isDescendant(_69[i],this.domNode)){return this.inherited(arguments);}}}_68.cancel();this._numObservers--;_67[_66]=0;}}}this.inherited(arguments);}});});