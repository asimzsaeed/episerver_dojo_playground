//>>built
define("dgrid/Selection",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/Deferred","dojo/on","dojo/has","dojo/aspect","./List","dojo/has!touch?./util/touch","put-selector/put","dojo/query","dojo/_base/sniff"],function(_1,_2,_3,on,_4,_5,_6,_7,_8){_4.add("dom-comparedocumentposition",function(_9,_a,_b){return !!_b.compareDocumentPosition;});_4.add("pointer",function(_c){return "PointerEvent" in _c?"pointer":"MSPointerEvent" in _c?"MSPointer":false;});_4.add("css-user-select",function(_d,_e,_f){var _10=_f.style,_11=["Khtml","O","ms","Moz","Webkit"],i=_11.length,_12="userSelect";do{if(typeof _10[_12]!=="undefined"){return _12;}}while(i--&&(_12=_11[i]+"UserSelect"));return false;});_4.add("dom-selectstart",typeof document.onselectstart!=="undefined");var _13=_4("mac")?"metaKey":"ctrlKey",_14=_4("css-user-select"),_15=_4("pointer"),_16=_15&&_15.slice(0,2)==="MS",_17=_15?_15+(_16?"Down":"down"):"mousedown",_18=_15?_15+(_16?"Up":"up"):"mouseup";function _19(_1a,_1b){var _1c=_1a.unselectable=_1b?"on":"",_1d=_1a.getElementsByTagName("*"),i=_1d.length;while(--i){if(_1d[i].tagName==="INPUT"||_1d[i].tagName==="TEXTAREA"){continue;}_1d[i].unselectable=_1c;}};function _1e(_1f,_20){var _21=_1f.bodyNode,_22=_20?"text":_4("ff")<21?"-moz-none":"none";if(_14&&_14!=="msUserSelect"){_21.style[_14]=_22;}else{if(_4("dom-selectstart")){if(!_20&&!_1f._selectstartHandle){_1f._selectstartHandle=on(_21,"selectstart",function(evt){var tag=evt.target&&evt.target.tagName;if(tag!=="INPUT"&&tag!=="TEXTAREA"){evt.preventDefault();}});}else{if(_20&&_1f._selectstartHandle){_1f._selectstartHandle.remove();delete _1f._selectstartHandle;}}}else{_19(_21,!_20);if(!_20&&!_1f._unselectableHandle){_1f._unselectableHandle=_5.after(_1f,"renderRow",function(row){_19(row,true);return row;});}else{if(_20&&_1f._unselectableHandle){_1f._unselectableHandle.remove();delete _1f._unselectableHandle;}}}}};return _2(null,{selectionDelegate:".dgrid-row",selectionEvents:_17+","+_18+",dgrid-cellfocusin",selectionTouchEvents:_4("touch")?_7.tap:null,deselectOnRefresh:true,allowSelectAll:false,selection:{},selectionMode:"extended",allowTextSelection:undefined,_selectionTargetType:"rows",create:function(){this.selection={};return this.inherited(arguments);},postCreate:function(){this.inherited(arguments);this._initSelectionEvents();var _23=this.selectionMode;this.selectionMode="";this._setSelectionMode(_23);},destroy:function(){this.inherited(arguments);if(this._selectstartHandle){this._selectstartHandle.remove();}if(this._unselectableHandle){this._unselectableHandle.remove();}if(this._removeDeselectSignals){this._removeDeselectSignals();}},_setSelectionMode:function(_24){if(_24==this.selectionMode){return;}this.clearSelection();this.selectionMode=_24;this._selectionHandlerName="_"+_24+"SelectionHandler";this._setAllowTextSelection(this.allowTextSelection);},setSelectionMode:function(_25){_1.deprecated("setSelectionMode(...)","use set(\"selectionMode\", ...) instead","dgrid 0.4");this.set("selectionMode",_25);},_setAllowTextSelection:function(_26){if(typeof _26!=="undefined"){_1e(this,_26);}else{_1e(this,this.selectionMode==="none");}this.allowTextSelection=_26;},_handleSelect:function(_27,_28){if(!this[this._selectionHandlerName]||!this.allowSelect(this.row(_28))||(_27.type==="dgrid-cellfocusin"&&_27.parentType==="mousedown")||(_27.type===_18&&_28!=this._waitForMouseUp)){return;}this._waitForMouseUp=null;this._selectionTriggerEvent=_27;if(!_27.keyCode||!_27.ctrlKey||_27.keyCode==32){if(!_27.shiftKey&&_27.type===_17&&this.isSelected(_28)){this._waitForMouseUp=_28;}else{this[this._selectionHandlerName](_27,_28);}}this._selectionTriggerEvent=null;},_singleSelectionHandler:function(_29,_2a){var _2b=_29.keyCode?_29.ctrlKey:_29[_13];if(this._lastSelected===_2a){this.select(_2a,null,!_2b||!this.isSelected(_2a));}else{this.clearSelection();this.select(_2a);this._lastSelected=_2a;}},_multipleSelectionHandler:function(_2c,_2d){var _2e=this._lastSelected,_2f=_2c.keyCode?_2c.ctrlKey:_2c[_13],_30;if(!_2c.shiftKey){_30=_2f?null:true;_2e=null;}this.select(_2d,_2e,_30);if(!_2e){this._lastSelected=_2d;}},_extendedSelectionHandler:function(_31,_32){if(_31.button===2?!this.isSelected(_32):!(_31.keyCode?_31.ctrlKey:_31[_13])){this.clearSelection(null,true);}this._multipleSelectionHandler(_31,_32);},_toggleSelectionHandler:function(_33,_34){this.select(_34,null,null);},_initSelectionEvents:function(){var _35=this,_36=this.contentNode,_37=this.selectionDelegate;this._selectionEventQueues={deselect:[],select:[]};if(_4("touch")&&!_4("pointer")&&this.selectionTouchEvents){on(_36,_7.selector(_37,this.selectionTouchEvents),function(evt){_35._handleSelect(evt,this);_35._ignoreMouseSelect=this;});on(_36,on.selector(_37,this.selectionEvents),function(_38){if(_35._ignoreMouseSelect!==this){_35._handleSelect(_38,this);}else{if(_38.type===_18){_35._ignoreMouseSelect=null;}}});}else{on(_36,on.selector(_37,this.selectionEvents),function(_39){_35._handleSelect(_39,this);});}if(this.addKeyHandler){this.addKeyHandler(32,function(_3a){_35._handleSelect(_3a,_3a.target);});}if(this.allowSelectAll){this.on("keydown",function(_3b){if(_3b[_13]&&_3b.keyCode==65&&!/\bdgrid-input\b/.test(_3b.target.className)){_3b.preventDefault();_35[_35.allSelected?"clearSelection":"selectAll"]();}});}if(this._setStore){_5.after(this,"_setStore",function(){_35._updateDeselectionAspect();});}this._updateDeselectionAspect();},_updateDeselectionAspect:function(){var _3c=this,_3d=this.store,_3e,_3f;function _40(_41,_42,_43){var id=_42||(_41&&_41[_3c.idProperty||"id"]);if(id!=null){var row=_3c.row(id),_44=row&&_3c.selection[row.id];if(_44){_3c[_43](row,null,_44);}}};if(this._removeDeselectSignals){this._removeDeselectSignals();}if(_3d&&_3d.notify){_3e=_5.before(_3d,"notify",function(_45,_46){if(!_45){_40(_45,_46,"deselect");}});_3f=_5.after(_3d,"notify",function(_47,_48){_40(_47,_48,"select");},true);this._removeDeselectSignals=function(){_3e.remove();_3f.remove();};}else{_3e=_5.before(this,"removeRow",function(_49,_4a){var row;if(!_4a){row=this.row(_49);if(row&&(row.id in this.selection)){this.deselect(row);}}});this._removeDeselectSignals=function(){_3e.remove();};}},allowSelect:function(row){return true;},_fireSelectionEvent:function(_4b){var _4c=this._selectionEventQueues[_4b],_4d=this._selectionTriggerEvent,_4e;_4e={bubbles:true,grid:this};if(_4d){_4e.parentType=_4d.type;}_4e[this._selectionTargetType]=_4c;on.emit(this.contentNode,"dgrid-"+_4b,_4e);this._selectionEventQueues[_4b]=[];},_fireSelectionEvents:function(){var _4f=this._selectionEventQueues,_50;for(_50 in _4f){if(_4f[_50].length){this._fireSelectionEvent(_50);}}},_select:function(row,_51,_52){var _53,_54,_55,_56,_57;if(typeof _52==="undefined"){_52=true;}if(!row.element){row=this.row(row);}if(_52===false||this.allowSelect(row)){_53=this.selection;_54=!!_53[row.id];if(_52===null){_52=!_54;}_55=row.element;if(!_52&&!this.allSelected){delete this.selection[row.id];}else{_53[row.id]=_52;}if(_55){if(_52){_8(_55,".dgrid-selected"+(this.addUiClasses?".ui-state-active":""));}else{_8(_55,"!dgrid-selected!ui-state-active");}}if(_52!==_54&&_55){this._selectionEventQueues[(_52?"":"de")+"select"].push(row);}if(_51){if(!_51.element){_51=this.row(_51);}if(!_51){this._lastSelected=_55;console.warn("The selection range has been reset because the "+"beginning of the selection is no longer in the DOM. "+"If you are using OnDemandList, you may wish to increase "+"farOffRemoval to avoid this, but note that keeping more nodes "+"in the DOM may impact performance.");return;}_56=_51.element;if(_56){_57=this._determineSelectionDirection(_55,_56);if(!_57){_56=document.getElementById(_56.id);_57=this._determineSelectionDirection(_55,_56);}while(row.element!=_56&&(row=this[_57](row))){this._select(row,null,_52);}}}}},_determineSelectionDirection:_4("dom-comparedocumentposition")?function(_58,to){var _59=to.compareDocumentPosition(_58);if(_59&1){return false;}return _59===2?"down":"up";}:function(_5a,to){if(to.sourceIndex<1){return false;}return to.sourceIndex>_5a.sourceIndex?"down":"up";},select:function(row,_5b,_5c){this._select(row,_5b,_5c);this._fireSelectionEvents();},deselect:function(row,_5d){this.select(row,_5d,false);},clearSelection:function(_5e,_5f){this.allSelected=false;for(var id in this.selection){if(_5e!==id){this._select(id,null,false);}}if(!_5f){this._lastSelected=null;}this._fireSelectionEvents();},selectAll:function(){this.allSelected=true;this.selection={};for(var i in this._rowIdToObject){var row=this.row(this._rowIdToObject[i]);this._select(row.id,null,true);}this._fireSelectionEvents();},isSelected:function(_60){if(typeof _60==="undefined"||_60===null){return false;}if(!_60.element){_60=this.row(_60);}return (_60.id in this.selection)?!!this.selection[_60.id]:this.allSelected&&(!_60.data||this.allowSelect(_60));},refresh:function(){if(this.deselectOnRefresh){this.clearSelection();}this._lastSelected=null;return this.inherited(arguments);},renderArray:function(){var _61=this,_62=this.inherited(arguments);_3.when(_62,function(_63){var _64=_61.selection,i,row,_65;for(i=0;i<_63.length;i++){row=_61.row(_63[i]);_65=row.id in _64?_64[row.id]:_61.allSelected;if(_65){_61._select(row,null,_65);}}_61._fireSelectionEvents();});return _62;}});});