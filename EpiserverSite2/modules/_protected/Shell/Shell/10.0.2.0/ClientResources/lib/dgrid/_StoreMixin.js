//>>built
define("dgrid/_StoreMixin",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/on","dojo/aspect","put-selector/put"],function(_1,_2,_3,_4,_5,_6,_7){function _8(_9){return _9;};function _a(_b){if(typeof _b!=="object"){_b=new Error(_b);}else{if(_b.dojoType==="cancel"){return;}}_b.grid=this;if(_5.emit(this.domNode,"dgrid-error",{grid:this,error:_b,cancelable:true,bubbles:true})){console.error(_b);}};return _2(null,{store:null,query:null,queryOptions:null,getBeforePut:true,noDataMessage:"",loadingMessage:"",constructor:function(){this.query={};this.queryOptions={};this.dirty={};this._updating={};this._columnsWithSet={};_6.before(this,"configStructure",_3.hitch(this,function(){this._columnsWithSet={};}));},postCreate:function(){this.inherited(arguments);if(this.store){this._updateNotifyHandle(this.store);}},destroy:function(){this.inherited(arguments);if(this._notifyHandle){this._notifyHandle.remove();}},_configColumn:function(_c){if(_c.set){this._columnsWithSet[_c.field]=_c;}this.inherited(arguments);},_updateNotifyHandle:function(_d){if(this._notifyHandle){this._notifyHandle.remove();delete this._notifyHandle;}if(_d&&typeof _d.notify==="function"){this._notifyHandle=_6.after(_d,"notify",_3.hitch(this,"_onNotify"),true);var _e=this.get("sort");if(!_e||!_e.length){console.warn("Observable store detected, but no sort order specified. "+"You may experience quirks when adding/updating items.  "+"These can be resolved by setting a sort order on the list or grid.");}}},_setStore:function(_f,_10,_11){this._updateNotifyHandle(_f);this.store=_f;this.dirty={};this.set("query",_10,_11);},_setQuery:function(_12,_13){var _14=_13&&_13.sort;this.query=_12!==undefined?_12:this.query;this.queryOptions=_13||this.queryOptions;_14?this.set("sort",_14):this.refresh();},setStore:function(_15,_16,_17){_1.deprecated("setStore(...)","use set(\"store\", ...) instead","dgrid 0.4");this.set("store",_15,_16,_17);},setQuery:function(_18,_19){_1.deprecated("setQuery(...)","use set(\"query\", ...) instead","dgrid 0.4");this.set("query",_18,_19);},_getQueryOptions:function(){var _1a=_3.delegate(this.queryOptions,{});if(typeof (this._sort)==="function"||this._sort.length){_1a.sort=this._sort;}return _1a;},_getQuery:function(){var q=this.query;return typeof q=="object"&&q!=null?_3.delegate(q,{}):q;},_setSort:function(_1b,_1c){if(this.store){this._lastCollection=null;}this.inherited(arguments);},_onNotify:function(_1d,_1e){this.inherited(arguments);if(_1d&&this._numObservers<1){this.refresh({keepScrollPosition:true});}},refresh:function(){var _1f=this.inherited(arguments);if(!this.store){this.noDataNode=_7(this.contentNode,"div.dgrid-no-data");this.noDataNode.innerHTML=this.noDataMessage;}return _1f;},renderArray:function(){var _20=this;var _21=this.inherited(arguments);if(!this.store){_4.when(_21,function(_22){if(_22.length&&_20.noDataNode){_7(_20.noDataNode,"!");}});}return _21;},insertRow:function(_23,_24,_25,i,_26){var _27=this.store,_28=this.dirty,id=_27&&_27.getIdentity(_23),_29;if(id in _28&&!(id in this._updating)){_29=_28[id];}if(_29){_23=_3.delegate(_23,_29);}return this.inherited(arguments);},updateDirty:function(id,_2a,_2b){var _2c=this.dirty,_2d=_2c[id];if(!_2d){_2d=_2c[id]={};}_2d[_2a]=_2b;},setDirty:function(id,_2e,_2f){_1.deprecated("setDirty(...)","use updateDirty() instead","dgrid 0.4");this.updateDirty(id,_2e,_2f);},save:function(){var _30=this,_31=this.store,_32=this.dirty,dfd=new _4(),_33=dfd.promise,_34=function(id){var _35;return (_30.getBeforePut||!(_35=_30.row(id).data))?function(){return _31.get(id);}:function(){return _35;};};function _36(id,_37){return function(_38){var _39=_30._columnsWithSet,_3a=_30._updating,key,_3b;if(typeof _38.set==="function"){_38.set(_37);}else{for(key in _37){_38[key]=_37[key];}}for(key in _39){_3b=_39[key].set(_38);if(_3b!==undefined){_38[key]=_3b;}}_3a[id]=true;return _4.when(_31.put(_38),function(){delete _32[id];delete _3a[id];});};};for(var id in _32){var put=_36(id,_32[id]);_33=_33.then(_34(id)).then(put);}dfd.resolve();return _33;},revert:function(){this.dirty={};this.refresh();},_trackError:function(_3c){var _3d;if(typeof _3c=="string"){_3c=_3.hitch(this,_3c);}try{_3d=_3c();}catch(err){_a.call(this,err);}return _4.when(_3d,_8,_3.hitch(this,_a));},newRow:function(){var row=this.inherited(arguments);if(this.noDataNode){_7(this.noDataNode,"!");delete this.noDataNode;}return row;},removeRow:function(_3e,_3f){var row={element:_3e};if(!_3f&&this.noDataMessage&&(this.up(row).element===_3e)&&(this.down(row).element===_3e)){this.noDataNode=_7(this.contentNode,"div.dgrid-no-data");this.noDataNode.innerHTML=this.noDataMessage;}return this.inherited(arguments);}});});