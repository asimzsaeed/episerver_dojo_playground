//>>built
define("dgrid/editor",["dojo/_base/kernel","dojo/_base/lang","dojo/_base/array","dojo/_base/Deferred","dojo/on","dojo/aspect","dojo/has","dojo/query","dojo/when","./Grid","put-selector/put","dojo/_base/sniff"],function(_1,_2,_3,_4,on,_5,_6,_7,_8,_9,_a){function _b(_c,_d){_c.value=_d;if(_c.type=="radio"||_c.type=="checkbox"){_c.checked=_c.defaultChecked=!!_d;}};function _e(_f,_10){if(typeof _10=="number"){_f=isNaN(_f)?_f:parseFloat(_f);}else{if(typeof _10=="boolean"){_f=_f=="true"?true:_f=="false"?false:_f;}else{if(_10 instanceof Date){var _11=new Date(_f);_f=isNaN(_11.getTime())?_f:_11;}}}return _f;};function _12(_13,cmp){if(typeof cmp.get=="function"){return _e(cmp.get("value"));}else{return _e(cmp[cmp.type=="checkbox"||cmp.type=="radio"?"checked":"value"]);}};function _14(_15,_16,_17,_18,_19){var _1a,row,_1b,_1c;if((_17&&_17.valueOf())!=(_18&&_18.valueOf())){_1a=_16.element;row=_16.row;_1b=_16.column;if(_1b.field&&row){_1c={grid:_15,cell:_16,rowId:row.id,oldValue:_17,value:_18,bubbles:true,cancelable:true};if(_19&&_19.type){_1c.parentType=_19.type;}if(on.emit(_1a,"dgrid-datachange",_1c)){if(_15.updateDirty){_15.updateDirty(row.id,_1b.field,_18);_1b.autoSave&&setTimeout(function(){_15._trackError("save");},0);}else{row.data[_1b.field]=_18;}}else{var cmp;if((cmp=_1a.widget)){cmp._dgridIgnoreChange=true;cmp.set("value",_17);setTimeout(function(){cmp._dgridIgnoreChange=false;},0);}else{if((cmp=_1a.input)){_b(cmp,_17);}}return _17;}}}return _18;};function _1d(_1e,cmp,_1f){var _20=_1e.cell(cmp.domNode||cmp),_21=_20.column,_22,id,_23,_24=_1e._activeCell;if(!cmp.isValid||cmp.isValid()){_22=_14(_1e,_20,_24?_1e._activeValue:cmp._dgridLastValue,_12(_21,cmp),_1f);if(_24){_1e._activeValue=_22;}else{cmp._dgridLastValue=_22;}if(cmp.type==="radio"&&cmp.name&&!_21.editOn&&_21.field){_23=_1e.row(cmp);_7("input[type=radio][name="+cmp.name+"]",_1e.contentNode).forEach(function(_25){var row=_1e.row(_25);if(_25!==cmp&&_25._dgridLastValue){_25._dgridLastValue=false;if(_1e.updateDirty){_1e.updateDirty(row.id,_21.field,false);}else{row.data[_21.field]=false;}}});for(id in _1e.dirty){if(_23.id!==id&&_1e.dirty[id][_21.field]){_1e.updateDirty(id,_21.field,false);}}}}};function _26(_27){var _28=_27.editor,_29=_27.editOn,_2a=_27.grid,_2b=typeof _28!="string",_2c,cmp,_2d,_2e,_2f;_2c=_27.editorArgs||{};if(typeof _2c=="function"){_2c=_2c.call(_2a,_27);}if(_2b){cmp=new _28(_2c);_2d=cmp.focusNode||cmp.domNode;_2d.className+=" dgrid-input";cmp.connect(cmp,_29?"onBlur":"onChange",function(){if(!cmp._dgridIgnoreChange){_1d(_2a,this,{type:"widget"});}});}else{_2f=function(evt){var _30=evt.target;if("_dgridLastValue" in _30&&_30.className.indexOf("dgrid-input")>-1){_1d(_2a,_30,evt);}};if(!_27.grid._hasInputListener){_2a._hasInputListener=true;_2a.on("change",function(evt){_2f(evt);});}_2e=_28=="textarea"?"textarea":"input[type="+_28+"]";cmp=_2d=_a(_2e+".dgrid-input",_2.mixin({name:_27.field,tabIndex:isNaN(_27.tabIndex)?-1:_27.tabIndex},_2c));if(_6("ie")<9||(_6("ie")&&_6("quirks"))){if(_28=="radio"||_28=="checkbox"){on(cmp,"click",function(evt){_2f(evt);});}else{on(cmp,"change",function(evt){_2f(evt);});}}}return cmp;};function _31(_32,_33){var cmp=_26(_32),_34=_32.grid,_35=cmp.domNode,_36=cmp.domNode||cmp,_37=cmp.focusNode||_36,_38=_35?function(){cmp.set("value",cmp._dgridLastValue);}:function(){_b(cmp,cmp._dgridLastValue);_1d(_32.grid,cmp);},_39;function _3a(){var _3b=_34._activeCell;_37.blur();if(typeof _34.focus==="function"){setTimeout(function(){_34.focus(_3b);},_35&&_6("ie")<9?15:0);}};function _3c(){var _3d=_36.parentNode,i=_3d.children.length-1,_3e={alreadyHooked:true},_3f=_34.cell(_36);on.emit(_3f.element,"dgrid-editor-hide",{grid:_34,cell:_3f,column:_32,editor:cmp,bubbles:true,cancelable:false});_32._editorBlurHandle.pause();_3d.removeChild(_36);if(_3f.row){_a(_3f.element,"!dgrid-cell-editing");while(i--){_a(_3d.firstChild,"!");}_9.appendIfNode(_3d,_32.renderCell(_32.grid.row(_3d).data,_34._activeValue,_3d,_34._activeOptions?_2.delegate(_3e,_34._activeOptions):_3e));}_34._focusedEditorCell=_34._activeCell=_34._activeValue=_34._activeOptions=null;};function _40(evt){var key=evt.keyCode||evt.which;if(key==27){_38();_34._activeValue=cmp._dgridLastValue;_3a();}else{if(key==13&&_32.dismissOnEnter!==false){_3a();}}};_39=on(_37,"keydown",_40);(_32._editorBlurHandle=on.pausable(cmp,"blur",_3c)).pause();return cmp;};function _41(cmp,_42,_43,_44){var _45=cmp.domNode;if(!_45){_b(cmp,_44);}_43.innerHTML="";_a(_43,".dgrid-cell-editing");_a(_43,cmp.domNode||cmp);if(_45&&!_42.editOn){_42.grid._editorsPendingStartup.push([cmp,_42,_43,_44]);}else{_46(cmp,_42,_43,_44);}};function _46(cmp,_47,_48,_49){var _4a=_47.grid;if(cmp.domNode){if(!cmp._started){cmp.startup();}cmp._dgridIgnoreChange=true;cmp.set("value",_49);setTimeout(function(){cmp._dgridIgnoreChange=false;},0);}cmp._dgridLastValue=_49;if(_4a._activeCell){_4a._activeValue=_49;on.emit(_48,"dgrid-editor-show",{grid:_4a,cell:_4a.cell(_48),column:_47,editor:cmp,bubbles:true,cancelable:false});}};function _4b(_4c){var _4d=_4c._editorsPendingStartup;for(var i=_4d.length;i--;){_46.apply(null,_4d[i]);}_4c._editorsPendingStartup=[];};function _4e(_4f){var row,_50,_51,_52,_53,_54,cmp,dfd,_55,_56=this;function _57(dfd){_50.grid._activeCell=_51;_41(_50.editorInstance,_50,_51,_54);_50._editTimer=setTimeout(function(){if(cmp.focus){cmp.focus();}if(_50._editorBlurHandle){_50._editorBlurHandle.resume();}_50._editTimer=null;dfd.resolve(cmp);},0);};if(!_4f.column){_4f=this.cell(_4f);}if(!_4f||!_4f.element){return null;}_50=_4f.column;_53=_50.field;_51=_4f.element.contents||_4f.element;if((cmp=_50.editorInstance)){if(_50.grid._activeCell!=_51){row=_4f.row;_52=this.dirty&&this.dirty[row.id];_54=(_52&&_53 in _52)?_52[_53]:_50.get?_50.get(row.data):row.data[_53];if(!_50.canEdit||_50.canEdit(_4f.row.data,_54)){dfd=new _4();_55=cmp.domNode||cmp;if(_55.offsetWidth){_55.blur();setTimeout(function(){_57(dfd);},0);}else{_57(dfd);}return dfd.promise;}}}else{if(_50.editor){cmp=_51.widget||_51.input;if(cmp){dfd=new _4();if(cmp.focus){cmp.focus();}dfd.resolve(cmp);return dfd.promise;}}}return null;};return function(_58,_59,_5a){var _5b=_58.renderCell||_9.defaultRenderCell,_5c=[],_5d;function _5e(_5f){var _60=_5f.grid,_61,_62;if(!_60.edit){_60.edit=_4e;_60._editorsPendingStartup=[];_5c.push(on(_60.domNode,".dgrid-input:focusin",function(){_60._focusedEditorCell=_60.cell(this);}));_61=_60._editorFocusoutHandle=on.pausable(_60.domNode,".dgrid-input:focusout",function(){_60._focusedEditorCell=null;});_5c.push(_61);_5c.push(_5.before(_60,"removeRow",function(row){var _63=_60._focusedEditorCell;row=_60.row(row);if(_63&&_63.row.id===row.id){_62=_63;_61.pause();setTimeout(function(){_61.resume();_62=null;},0);}}));_5c.push(_5.after(_60,"insertRow",function(_64){var row=_60.row(_64);if(_62&&_62.row.id===row.id){_60.edit(_60.cell(row,_62.column.id));}return _64;}));_5c.push(_5.after(_60,"renderArray",function(_65){_8(_65,function(_66){if(_66.length){_4b(_60);}else{_60._editorsPendingStartup=[];}});return _65;}));_5c.push(_5.after(_60,"_onNotification",function(){_4b(_60);}));}};if(!_58){_58={};}_58.editor=_59=_59||_58.editor||"text";_58.editOn=_5a=_5a||_58.editOn;_5d=typeof _59!="string";if(_58.widgetArgs){_1.deprecated("column.widgetArgs","use column.editorArgs instead","dgrid 0.4");_58.editorArgs=_58.widgetArgs;}_5.after(_58,"init",_5a?function(){_5e(_58);_58.editorInstance=_31(_58,_5b);}:function(){var _67=_58.grid;_5e(_58);if(_5d){_5c.push(_5.before(_67,"removeRow",function(_68){var _69=_67.cell(_68,_58.id).element,_6a=_69&&(_69.contents||_69).widget;if(_6a){_67._editorFocusoutHandle.pause();_6a.destroyRecursive();}}));}});_5.after(_58,"destroy",function(){_3.forEach(_5c,function(l){l.remove();});if(_58._editorBlurHandle){_58._editorBlurHandle.remove();}if(_58._editTimer){clearTimeout(_58._editTimer);}if(_5a&&_5d){_58.editorInstance.destroyRecursive();}_58.grid.edit=null;_58.grid._editorsPendingStartup=null;});_58.renderCell=_5a?function(_6b,_6c,_6d,_6e){var _6f=_58.grid;if(!_6e||!_6e.alreadyHooked){on(_6d.tagName=="TD"?_6d:_6d.parentNode,_5a,function(){_6f._activeOptions=_6e;_6f.edit(this);});}return _5b.call(_58,_6b,_6c,_6d,_6e);}:function(_70,_71,_72,_73){if(!_58.canEdit||_58.canEdit(_70,_71)){var cmp=_26(_58);_41(cmp,_58,_72,_71);_72[_5d?"widget":"input"]=cmp;}else{return _5b.call(_58,_70,_71,_72,_73);}};return _58;};});