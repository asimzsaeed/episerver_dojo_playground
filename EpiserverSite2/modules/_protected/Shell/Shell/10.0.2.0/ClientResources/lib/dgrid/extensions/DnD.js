//>>built
define("dgrid/extensions/DnD",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/Deferred","dojo/aspect","dojo/on","dojo/topic","dojo/has","dojo/dnd/Source","dojo/dnd/Manager","dojo/_base/NodeList","put-selector/put","../Selection","dojo/has!touch?../util/touch","dojo/has!touch?./_DnD-touch-autoscroll","xstyle/css!dojo/resources/dnd.css"],function(_1,_2,_3,_4,_5,on,_6,_7,_8,_9,_a,_b,_c,_d){var _e=_1(_8,{grid:null,getObject:function(_f){var _10=this.grid;return _10.store.get(_f.id.slice(_10.id.length+5));},_legalMouseDown:function(evt){var _11=this.inherited(arguments);return _11&&evt.target!=this.grid.bodyNode;},onDrop:function(_12,_13,_14){var _15=this,_16=this._targetAnchor=this.targetAnchor,_17=this.grid,_18=_17.store;if(!this.before&&_16){_16=_16.nextSibling;}_16=_16&&_17.row(_16);_4.when(_16&&_18.get(_16.id),function(_19){if(_15!=_12){_15.onDropExternal(_12,_13,_14,_19);}else{_15.onDropInternal(_13,_14,_19);}});},onDropInternal:function(_1a,_1b,_1c){var _1d=this.grid,_1e=_1d.store,_1f=this,_20=_1f._targetAnchor,_21,_22;if(_20){_21=this.before?_20.previousSibling:_20.nextSibling;}_22=_1d.row(_1a[0]);if(!_1b&&(_21===_1a[0]||(!_1c&&_22&&_1d.down(_22).element==_1a[0]))){return;}_1a.forEach(function(_23){_4.when(_1f.getObject(_23),function(_24){var id=_1e.getIdentity(_24);_1e[_1b&&_1e.copy?"copy":"put"](_24,{before:_1c});if(_1f._selectedNodes[id]){_1f._selectedNodes[id]=_1d.row(id).element;}});});},onDropExternal:function(_25,_26,_27,_28){var _29=this.grid.store,_2a=_25.grid;_26.forEach(function(_2b,i){_4.when(_25.getObject(_2b),function(_2c){if(!_27){if(_2a){_4.when(_2a.store.getIdentity(_2c),function(id){!i&&_25.selectNone();_25.delItem(_2b.id);_2a.store.remove(id);});}else{_25.deleteSelectedNodes();}}_29[_29.copy?"copy":"put"](_2c,{before:_28});});});},onDndStart:function(_2d,_2e,_2f){this.inherited(arguments);if(_2d==this){if(this.grid.cancelTouchScroll){this.grid.cancelTouchScroll();}_9.manager().avatar.node.style.width=this.grid.domNode.offsetWidth/2+"px";}},onMouseDown:function(evt){if(_7("touch")&&this.isDragging&&_d.countCurrentTouches(evt,this.grid.touchNode)>1){_6.publish("/dnd/cancel");_9.manager().stopDrag();}else{this.inherited(arguments);}},onMouseMove:function(evt){if(!_7("touch")||_d.countCurrentTouches(evt,this.grid.touchNode)<=1){this.inherited(arguments);}},checkAcceptance:function(_30,_31){return _30.getObject&&_8.prototype.checkAcceptance.apply(this,arguments);},getSelectedNodes:function(){if(!this.grid.selection){return this.inherited(arguments);}var t=new _a(),id;for(id in this.grid.selection){t.push(this._selectedNodes[id]);}return t;}});var DnD=_1(_c,{dndSourceType:"dgrid-row",dndParams:null,dndConstructor:_e,postMixInProperties:function(){this.inherited(arguments);this.dndParams=_2.mixin({accept:[this.dndSourceType]},this.dndParams);},postCreate:function(){this.inherited(arguments);this.dndSource=new (this.dndConstructor||_e)(this.bodyNode,_2.mixin(this.dndParams,{grid:this,dropParent:this.contentNode}));var _32=this.dndSource._selectedNodes={};function _33(row){_32[row.id]=row.element;};function _34(row){delete _32[row.id];_b(row.element,"!dojoDndItemSelected!dojoDndItemAnchor");};this.on("dgrid-select",function(_35){_3.forEach(_35.rows,_33);});this.on("dgrid-deselect",function(_36){_3.forEach(_36.rows,_34);});_5.after(this,"destroy",function(){delete this.dndSource._selectedNodes;_32=null;this.dndSource.destroy();},true);},insertRow:function(_37){var row=this.inherited(arguments),_38=typeof this.getObjectDndType=="function"?this.getObjectDndType(_37):[this.dndSourceType];_b(row,".dojoDndItem");this.dndSource.setItem(row.id,{data:_37,type:_38 instanceof Array?_38:[_38]});return row;},removeRow:function(_39){this.dndSource.delItem(this.row(_39));this.inherited(arguments);}});DnD.GridSource=_e;return DnD;});